!function(e,t){var n=function(){return function(a){"use strict";var v={version:"1.7.1",metadataVersion:"1.0.5"},M=e(Object.prototype.hasOwnProperty),D=e(Array.prototype.slice),r=function(){try{return!(!Object.getPrototypeOf||!Object.defineProperty({},"x",{}))}catch(e){return!1}}();function P(e,t){for(var n in e)M(e,n)&&t(n,e[n])}function g(e,t){var n=[];for(var r in e)if(M(e,r)){var a=t?t(r,e[r]):e[r];void 0!==a&&n.push(a)}return n}function s(e,t){for(var n in e)if(M(e,n)){var r=e[n];if(t(n,r))return{key:n,value:r}}return null}function c(e,t){if(!r)return null;if(e.hasOwnProperty(t))return Object.getOwnPropertyDescriptor(e,t);var n=Object.getPrototypeOf(e);return null==n?null:c(n,t)}function l(t,n){return function(e){return e[t]===n}}function d(t){return function(e){return e[t]}}function w(e){var t=[];for(var n in e)M(e,n)&&t.push(e[n]);return t}function k(t,n,e){if(!n)return t;if(e)e.forEach(function(e){t[e]=n[e]});else for(var r in n)M(n,r)&&(t[r]=n[r]);return t}function T(e,t){for(var n in t)void 0===e[n]&&(e[n]=t[n]);return e}function i(e,t){return t.defaultInstance=T(new t(e),t.defaultInstance),e}function y(n,e,r){for(var t in r=r||{},e){var a=t.split(","),i=e[t];a.some(function(e){if(!(e in n))return!1;var t=n[e];return"function"!=typeof t&&(t==i||(!(!Array.isArray(t)||0!==t.length)||("function"==typeof i?t=i(t):"object"==typeof t&&t&&t.parentEnum&&(t=t.name),void 0===t||(r[a[0]]=t),!0)))})}return r}function o(e,t){if("entityAspect"!==e&&"complexAspect"!==e&&"entityType"!==e&&"complexType"!==e&&"constructor"!==e&&"_"!==e.charAt(0)&&"$"!==e.charAt(0))return t}function N(e,t){if(e!==Object(e))return e;if(!e._$visited){if(t=t||o,e.toJSON){var n=e.toJSON();if(n!==Object(n))return n;if(n!==e)return N(n,t);e=n}var r;if(e._$visited=!0,e instanceof Array)r=e.map(function(e){return N(e,t)});else if("function"==typeof e)r=void 0;else for(var a in r={},e)if("_$visited"!==a){var i=e[a];t&&void 0===(i=t(a,i))||void 0!==(i=N(i,t))&&(r[a]=i)}return delete e._$visited,r}}function u(a,e){var i={},o=a.length;return e.forEach(function(e){for(var t=0;t<o;t++){var n=a[t];if(n){var r=n[e];if(void 0!==r){i[e]=r;break}}}}),i}function _(e){return null==e?[]:Array.isArray(e)?e:[e]}function b(e,r,a){return a=null==a||a,null==e?e:(Array.isArray(e)?(i=[],e.forEach(function(e,t){var n=r(e,t);(null!=n||a)&&(i[t]=n)})):i=r(e),i);var i}function O(e,t){for(var n=0,r=e.length;n<r;n++)if(t(e[n]))return e[n];return null}function f(e,t){for(var n=0,r=e.length;n<r;n++)if(t(e[n]))return n;return-1}function h(e,t){var n=e.indexOf(t);-1===n&&e.push(t)}function A(e,t,n){for(var r=j(t)?t:void 0,a=e.length-1,i=!1,o=a;0<=o;o--)if((r?r(e[o]):e[o]===t)&&(e.splice(o,1),i=!0,!n))return!0;return i}function C(e,t,n){for(var r=[],a=Math.min(e.length,t.length),i=0;i<a;++i)r.push(n(e[i],t[i]));return r}function m(e,t,n){if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(Array.isArray(e[r])){if(!m(e[r],t[r]))return!1}else if(n){if(!n(e[r],t[r]))return!1}else if(e[r]!==t[r])return!1;return!0}function x(e,t){var n=e[t];return n||(n=[],e[t]=n),n}function p(e){var t=a.window;if(t){var n=t[e];if(n)return n;var r=t.require;if(r){if(r.defined)return r.defined(e)?r(e):void 0;try{return r(e)}catch(e){return}}}}function F(e,t,n,r){var a=e[t];if(n===a)return r();e[t]=n;try{return r()}finally{void 0===a?delete e[t]:e[t]=a}}function I(e,t,n){var r;try{return r=e(),n()}catch(e){throw"object"==typeof r&&(r.error=e),e}finally{t(r)}}function E(a){return function(){for(var e=D(arguments),t="",n=e.length,r=null;n--;)r=e[n],t+=r===Object(r)?JSON.stringify(r):r,a.memoize||(a.memoize={});return t in a.memoize?a.memoize[t]:a.memoize[t]=a.apply(this,e)}}function S(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function V(e){if("string"!=typeof e)throw new Error("Invalid ISO8601 duration '"+e+"'");var t=/^P((\d+Y)?(\d+M)?(\d+D)?)?(T(\d+H)?(\d+M)?(\d+S)?)?$/.exec(e);if(!t)throw new Error("Invalid ISO8601 duration '"+e+"'");for(var n=[2,3,4,6,7,8],r=[31104e3,2592e3,86400,3600,60,1],a=0,i=0;i<6;i++){var o=t[n[i]];o=o?+o.replace(/[A-Za-z]+/g,""):0,a+=o*r[i]}return a}function R(){}function n(e){return e}function t(e){return null===e?"null":void 0===e?"undefined":Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function K(e){return"date"===t(e)&&!isNaN(e.getTime())}function j(e){return"function"===t(e)}function B(e){return"string"==typeof e}function z(e){return"string"==typeof e&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(e)}function L(e){return"string"==typeof e&&/^(-|)?P[T]?[\d\.,\-]+[YMDTHS]/.test(e)}function q(e){if(null==e)return!0;for(var t in e)if(M(e,t))return!1;return!0}function U(e,t){return!!e&&(""==t||null==t||0===e.indexOf(t,0))}function $(e,t){return!!e&&(""==t||null==t||-1!==e.indexOf(t,e.length-t.length))}function G(e){var n=arguments,t=RegExp("%([1-"+(arguments.length-1)+"])","g");return e.replace(t,function(e,t){return n[t]})}var J=/([A-Z](?=[A-Z][a-z])|[^A-Z](?=[A-Z])|[a-zA-Z](?=[^a-zA-Z]))/g;function e(e){var t=Function.call;return function(){return t.apply(e,arguments)}}Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Q={};Q.__isES5Supported=r,Q.objectForEach=P,Q.extend=k,Q.propEq=l,Q.pluck=d,Q.arrayEquals=m,Q.arrayFirst=O,Q.arrayIndexOf=f,Q.arrayRemoveItem=A,Q.arrayZip=C,Q.requireLib=function(e,t){for(var n=e.split(";"),r=0,a=n.length;r<a;r++){var i=p(n[r]);if(i)return i}if(t)throw new Error("Unable to initialize "+e+".  "+t)},Q.using=F,Q.memoize=E,Q.getUuid=S,Q.durationToSeconds=V,Q.isDate=K,Q.isGuid=z,Q.isDuration=L,Q.isFunction=j,Q.isEmpty=q,Q.isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},Q.stringStartsWith=U,Q.stringEndsWith=$,Q.formatString=G,Q.titleCase=function(e){return e=(e=e.replace(J,"$1 ")).charAt(0).toUpperCase()+e.slice(1)},Q.getPropertyDescriptor=c,Q.toJSONSafe=N,Q.toJSONSafeReplacer=o,(Q.parent=v).core=Q;var Z=function(){var e=function(e,t){this.v=e,this.name=t,this._contexts=[null]},t=e.prototype;function n(e,t){return null!=t&&("string"==typeof t&&0<t.length)}function r(e,t){return null!=t&&typeof t===e.typeName}function a(e,t){return null!=t&&t instanceof e.type}function i(e,t){return null!=t&&void 0!==t[e.propertyName]}function o(e,t){return null!=t&&e.enumType.contains(t)}function s(e,t){return e.allowNull?void 0!==t:null!=t}function u(e,t){if(null==t)return!0;var n=e.prevContext;return!n||n.fn(n,t)}function p(e,t){var n=e.prevContext,r=n?" or it "+y(n,t):"";return"is optional"+r}function c(e,t){if(!Array.isArray(t))return!1;if(e.mustNotBeEmpty&&0===t.length)return!1;var n=e.prevContext;return!n||t.every(function(e){return n.fn(n,e)})}function l(e,t){var n=e.mustNotBeEmpty?"a nonEmpty array":"an array",r=e.prevContext,a=r?" where each element "+y(r,t):"";return" must be "+n+a}function y(e,t){var n=e.msg;return"function"==typeof n&&(n=n(e,t)),n}function f(e,t){if(e._context){for(var n=e._context;null!=n.prevContext;)n=n.prevContext;if(null===n.prevContext)return n.prevContext=t,e;if(null!=t.prevContext)throw new Error("Illegal construction - use 'or' to combine checks");t.prevContext=e._context}return a=t,(r=e)._contexts[r._contexts.length-1]=a,r._context=a,r;var r,a}function h(e,t){throw new Error(G("Error configuring an instance of '%1'. %2",e&&e._$typeName||"object",t))}return t.isObject=function(){return this.isTypeOf("object")},t.isBoolean=function(){return this.isTypeOf("boolean")},t.isString=function(){return this.isTypeOf("string")},t.isNonEmptyString=function(){return f(this,{fn:n,msg:"must be a nonEmpty string"})},t.isNumber=function(){return this.isTypeOf("number")},t.isFunction=function(){return this.isTypeOf("function")},t.isTypeOf=function(e){return f(this,{fn:r,typeName:e,msg:"must be a '"+e+"'"})},t.isInstanceOf=function(e,t){return t=t||e.prototype._$typeName,f(this,{fn:a,type:e,typeName:t,msg:"must be an instance of '"+t+"'"})},t.hasProperty=function(e){return f(this,{fn:i,propertyName:e,msg:"must have a '"+e+"' property"})},t.isEnumOf=function(e){return f(this,{fn:o,enumType:e,msg:"must be an instance of the '"+e.name+"' enumeration"})},t.isRequired=function(e){return f(this,{fn:s,allowNull:e,msg:"is required"})},t.isOptional=function(){var e={fn:u,prevContext:null,msg:p};return f(this,e)},t.isNonEmptyArray=function(){return this.isArray(!0)},t.isArray=function(e){var t={fn:c,mustNotBeEmpty:e,prevContext:null,msg:l};return f(this,t)},t.or=function(){return this._contexts.push(null),this._context=null,this},t.check=function(e){var t=function(t){var e=t._contexts;null==e[e.length-1]&&e.pop();if(0===e.length)return;return e.some(function(e){return e.fn(e,t.v)})}(this);if(void 0!==t){if(!t)throw new Error(this.getMessage());return void 0!==this.v?this.v:e}},t._addContext=function(e){return f(this,e)},t.getMessage=function(){var t=this,e=this._contexts.map(function(e){return y(e,t.v)}).join(", or it ");return G(this.MESSAGE_PREFIX,this.name)+" "+e},t.withDefault=function(e){return this.defaultValue=e,this},t.whereParam=function(e){return this.parent.whereParam(e)},t.applyAll=function(t,n){var e=t._$typeName,r=e&&this.parent.config._$typeName===e,a=k({},this.parent.config);if(this.parent.params.forEach(function(e){r||delete a[e.name];try{e.check()}catch(e){h(t,e.message)}!n&&e._applyOne(t)}),!r)for(var i in a)void 0!==a[i]&&h(t,G("Unknown property: '%1'.",i))},t._applyOne=function(e){void 0!==this.v?e[this.name]=this.v:void 0!==this.defaultValue&&(e[this.name]=this.defaultValue)},t.MESSAGE_PREFIX="The '%1' parameter ",e}(),H=function(e,t){return new Z(e,t)},Y=(X=function(e){if("object"!=typeof e)throw new Error("Configuration parameter should be an object, instead it is a: "+typeof e);this.config=e,this.params=[]},ee=X.prototype,ee.whereParam=function(e){var t=new Z(this.config[e],e);return(t.parent=this).params.push(t),t},X),W=function(e){return new Y(e)};var X,ee;Q.Param=Z,Q.assertParam=H,Q.assertConfig=W;var te=function(){var e=function(e,t){this.name=e;var n=new r(t);(n.parentEnum=this)._symbolPrototype=n,t&&Object.keys(t).forEach(function(e){n[e]=t[e]})},t=e.prototype;function r(){}return e.isSymbol=function(e){return e instanceof r},t.fromName=function(e){return this[e]},t.addSymbol=function(t){var n=Object.create(this._symbolPrototype);return t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),setTimeout(function(){n.getName()},0),n},t.resolveSymbols=function(){this.getSymbols().forEach(function(e){return e.getName()})},t.getSymbols=function(){return this.getNames().map(function(e){return this[e]},this)},t.getNames=function(){var e=[];for(var t in this)this.hasOwnProperty(t)&&("name"===t||"_"===t.substr(0,1)||j(this[t])||e.push(t));return e},t.contains=function(e){return e instanceof r&&this[e.getName()]===e},r.prototype.getName=function(){if(!this.name){var t=this;this.name=O(this.parentEnum.getNames(),function(e){return t.parentEnum[e]===t})}return this.name},r.prototype.toString=function(){return this.getName()},r.prototype.toJSON=function(){return{_$typeName:this.parentEnum.name,name:this.name}},e}();Q.Enum=te;var ne=function(){var r={},n=1,i=function(e,t,n){H(e,"eventName").isNonEmptyString().check(),H(t,"publisher").isObject().check(),this.name=e,r[e]=!0,this.publisher=t,n&&(this._defaultErrorCallback=n)},e=i.prototype;function a(t,n,r){var e=t._subscribers;if(!e)return!0;e.forEach(function(e){try{e.callback(n)}catch(e){e.context="unable to publish on topic: "+t.name,r?r(e):t._defaultErrorCallback&&t._defaultErrorCallback(e)}})}return e.publish=function(e,t,n){return!!i._isEnabled(this.name,this.publisher)&&(!0===t?setTimeout(a,0,this,e,n):a(this,e,n),!0)},e.publishAsync=function(e,t){this.publish(e,!0,t)},e.subscribe=function(e){this._subscribers||(this._subscribers=[]);var t=n;return this._subscribers.push({unsubKey:t,callback:e}),++n,t},e.unsubscribe=function(t){if(!this._subscribers)return!1;var e=this._subscribers,n=f(e,function(e){return e.unsubKey===t});return-1!==n&&(e.splice(n,1),0===e.length&&(this._subscribers=null),!0)},e.clear=function(){this._subscribers=null},i.bubbleEvent=function(e,t){e._getEventParent=t},i.enable=function(e,t,n){H(e,"eventName").isNonEmptyString().check(),H(t,"obj").isObject().check(),H(n,"isEnabled").isBoolean().isOptional().or().isFunction().check(),t._$eventMap||(t._$eventMap={}),t._$eventMap[e]=n},i.isEnabled=function(e,t){if(H(e,"eventName").isNonEmptyString().check(),H(t,"obj").isObject().check(),void 0===t._getEventParent)throw new Error("This object does not support event enabling/disabling");return i._isEnabled(e,t)},i._isEnabled=function(e,t){var n=null,r=t._$eventMap;if(r&&(n=r[e]),null!=n)return"function"==typeof n?n(t):!!n;var a=t._getEventParent&&t._getEventParent();return!a||i._isEnabled(e,a)},i}();Q.Event=ne;var re=function(){var a={functionRegistry:{},typeRegistry:{},objectRegistry:{}};a.interfaceInitialized=new ne("interfaceInitialized",a);var e=function(e){this.name=e,this.defaultInstance=null,this._implMap={}};function i(e,t,n){var r=t.defaultInstance;return r||(r=new t.ctor,(t.defaultInstance=r)._$impl=t),r.initialize(),n&&(e.defaultInstance=r),a.interfaceInitialized.publish({interfaceName:e.name,instance:r,isDefault:!0}),r.checkForRecomposition&&a.interfaceInitialized.subscribe(function(e){r.checkForRecomposition(e)}),r}function o(e){var n=e.toLowerCase(),t=s(a.interfaceRegistry||{},function(e,t){return e.toLowerCase()===n});if(!t)throw new Error("Unknown interface name: "+e);return t.value}return e.prototype.registerCtor=function(e,t){this._implMap[e.toLowerCase()]={ctor:t,defaultInstance:null}},e.prototype.getImpl=function(e){return this._implMap[e.toLowerCase()]},e.prototype.getFirstImpl=function(){var e=s(this._implMap,function(){return!0});return e?e.value:null},a.interfaceRegistry={ajax:new e("ajax"),modelLibrary:new e("modelLibrary"),dataService:new e("dataService"),uriBuilder:new e("uriBuilder")},a.interfaceRegistry.modelLibrary.getDefaultInstance=function(){if(!this.defaultInstance)throw new Error("Unable to locate the default implementation of the '"+this.name+"' interface.  Possible options are 'ko', 'backingStore' or 'backbone'. See the breeze.config.initializeAdapterInstances method.");return this.defaultInstance},a.setProperties=function(e){W(e).whereParam("remoteAccessImplementation").isOptional().whereParam("trackingImplementation").isOptional().whereParam("ajaxImplementation").isOptional().applyAll(e),e.remoteAccessImplementation&&a.initializeAdapterInstance("dataService",e.remoteAccessImplementation),e.trackingImplementation&&a.initializeAdapterInstance("modelLibrary",e.trackingImplementation),e.ajaxImplementation&&a.initializeAdapterInstance("ajax",e.ajaxImplementation)},a.registerAdapter=function(e,t){H(e,"interfaceName").isNonEmptyString().check(),H(t,"adapterCtor").isFunction().check();var n=new t,r=n.name;if(!r)throw new Error("Unable to locate a 'name' property on the constructor passed into the 'registerAdapter' call.");var a=o(e);a.registerCtor(r,t)},a.getAdapter=function(e,t){var n=o(e);if(t){var r=n.getImpl(t);return r?r.ctor:null}return n.defaultInstance?n.defaultInstance._$impl.ctor:null},a.initializeAdapterInstances=function(e){return W(e).whereParam("dataService").isOptional().whereParam("modelLibrary").isOptional().whereParam("ajax").isOptional().whereParam("uriBuilder").isOptional().applyAll(this,!1),g(e,a.initializeAdapterInstance)},a.initializeAdapterInstance=function(e,t,n){n=void 0===n||n,H(e,"interfaceName").isNonEmptyString().check(),H(t,"adapterName").isNonEmptyString().check(),H(n,"isDefault").isBoolean().check();var r=o(e),a=r.getImpl(t);if(!a)throw new Error("Unregistered adapter.  Interface: "+e+" AdapterName: "+t);return i(r,a,n)},a.getAdapterInstance=function(e,t){var n,r=o(e),a=null==t||""==t;if(a){if(r.defaultInstance)return r.defaultInstance;n=r.getFirstImpl()}else n=r.getImpl(t);return n?n.defaultInstance?n.defaultInstance:i(r,n,a):null},a.registerFunction=function(e,t){H(e,"fn").isFunction().check(),H(t,"fnName").isString().check(),e.prototype._$fnName=t,a.functionRegistry[t]=e},a.getRegisteredFunction=function(e){return a.functionRegistry[e]},a._storeObject=function(e,t,n){var r=("string"==typeof t?t:t.prototype._$typeName)+"."+n;a.objectRegistry[r]=e},a._fetchObject=function(e,t){if(t){var n=("string"==typeof e?e:e.prototype._$typeName)+"."+t,r=a.objectRegistry[n];if(!r)throw new Error("Unable to locate a registered object by the name: "+n);return r}},a.registerType=function(e,t){H(e,"ctor").isFunction().check(),H(t,"typeName").isString().check(),e.prototype._$typeName=t,a.typeRegistry[t]=e},a.stringifyPad="",a}(),ae=re.interfaceRegistry.modelLibrary;Q.config=re,v.config=re;var ie=function(){var e={};function r(e,t){e._processAdds(t),n(e,"arrayChanged",{array:e,added:t})}function a(e,t){e._processRemoves(t),n(e,"arrayChanged",{array:e,removed:t})}function n(e,t,n){var r=e._getPendingPubs();r?e._pendingArgs?function(e,t){for(var n in t)if("array"!==n&&e.hasOwnProperty(n)){var r=t[n],a=e[n];if(a){if(!Array.isArray(a))throw new Error("Cannot combine non array args");Array.prototype.push.apply(a,r)}else e[n]=r}}(e._pendingArgs,n):(e._pendingArgs=n,r.push(function(){e[t].publish(e._pendingArgs),e._pendingArgs=null})):e[t].publish(n)}return e.push=function(){if(this._inProgress)return-1;var e=this._getGoodAdds(D(arguments));if(!e.length)return this.length;this._beforeChange();var t=Array.prototype.push.apply(this,e);return r(this,e),t},e._push=function(){if(this._inProgress)return-1;var e=D(arguments);this._beforeChange();var t=Array.prototype.push.apply(this,e);return r(this,e),t},e.unshift=function(){var e=this._getGoodAdds(D(arguments));if(!e.length)return this.length;this._beforeChange();var t=Array.prototype.unshift.apply(this,e);return r(this,D(e)),t},e.pop=function(){this._beforeChange();var e=Array.prototype.pop.apply(this);return a(this,[e]),e},e.shift=function(){this._beforeChange();var e=Array.prototype.shift.apply(this);return a(this,[e]),e},e.splice=function(){var e=this._getGoodAdds(D(arguments,2)),t=D(arguments,0,2).concat(e);this._beforeChange();var n=Array.prototype.splice.apply(this,t);return a(this,n),e.length&&r(this,e),n},e.getEntityAspect=function(){return this.parent.entityAspect||this.parent.complexAspect.getEntityAspect()},e._getEventParent=function(){return this.getEntityAspect()},e._getPendingPubs=function(){var e=this.getEntityAspect().entityManager;return e&&e._pendingPubs},e._beforeChange=function(){},{mixin:e,publish:n,updateEntityState:function(e){var t=e.getEntityAspect();t.entityState.isUnchanged()&&t.setModified();t.entityState.isModified()&&!e._origValues&&(e._origValues=e.slice(0))},initializeParent:function(e,t,n){e.parent=t,e.parentProperty=n}}}(),oe=function(){var r={displayName:function(e){return e.property?e.property.resolveProperty("displayName")||e.propertyName||e.property.name:"Value"}},i=function(e,t,n){this._baseContext=n||{},this._baseContext.name=e,(n=k(Object.create(r),this._baseContext)).messageTemplate=n.messageTemplate||i.messageTemplates[e],this.name=e,this.valFn=t,this.context=n},e=i.prototype;function t(e,t,n,r){n&&(i.messageTemplates[e]=n);var a="string"==typeof t?new RegExp(t):t;return new i(e,function(e){return null==e||""===e||"string"==typeof e&&a.test(e)},r)}function n(e,n,r,t){t=t||{},void 0!==n&&(t.min=n),void 0!==r&&(t.max=r);var a=t.messageTemplate||i.messageTemplates[e];return a||(i.messageTemplates[e]=G("'%displayName%' must be an integer between the values of %1 and %2",n,r)),function(){return new i(e,function(e,t){if(null==e)return!0;"string"==typeof e&&t&&t.allowString&&(e=parseInt(e,0));return"number"==typeof e&&!isNaN(e)&&Math.floor(e)===e&&(!(null!=n&&e<n)&&!(null!=r&&r<e))},t)}}return e._$typeName="Validator",e.validate=function(e,t){var n;n=t?k(Object.create(this.context),t):this.context,this.currentContext=n;try{return this.valFn(e,n)?null:(n.value=e,new se(this,n,this.getMessage()))}catch(e){return new se(this,n,"Exception occured while executing this validator: "+this.name)}},e.getMessage=function(){try{var e=this.currentContext,t=e.message;return t?"function"==typeof t?t(e):t:e.messageTemplate?(n=e.messageTemplate,(r=e)?n.replace(/%([^%]+)%/g,function(e,t){var n;return null!=(n=a?r.hasOwnProperty(t)?r[t]:"":r[t])?j(n)?n(r):n:""}):n):"invalid value: "+(this.name||"{unnamed validator}")}catch(e){return"Unable to format error message"+e.toString()}var n,r,a},e.toJSON=function(){return this._baseContext},i.fromJSON=function(e){if(Array.isArray(e))return e.map(function(e){return i.fromJSON(e)});var t="Validator."+e.name,n=re.getRegisteredFunction(t);if(!n)throw new Error("Unable to locate a validator named:"+e.name);return n(e)},i.register=function(e){re.registerFunction(function(){return e},"Validator."+e.name)},i.registerFactory=function(e,t){re.registerFunction(e,"Validator."+t)},i.messageTemplates={bool:"'%displayName%' must be a 'true' or 'false' value",creditCard:"The %displayName% is not a valid credit card number",date:"'%displayName%' must be a date",duration:"'%displayName%' must be a ISO8601 duration string, such as 'P3H24M60S'",emailAddress:"The %displayName% '%value%' is not a valid email address",guid:"'%displayName%' must be a GUID",integer:"'%displayName%' must be an integer",integerRange:"'%displayName%' must be an integer between the values of %minValue% and %maxValue%",maxLength:"'%displayName%' must be a string with %maxLength% characters or less",number:"'%displayName%' must be a number",phone:"The %displayName% '%value%' is not a valid phone number",regularExpression:"The %displayName% '%value%' does not match '%expression%'",required:"'%displayName%' is required",string:"'%displayName%' must be a string",stringLength:"'%displayName%' must be a string with between %minLength% and %maxLength% characters",url:"The %displayName% '%value%' is not a valid url"},i.required=function(e){return new i("required",function(e,t){return"string"==typeof e?!(!t||!t.allowEmptyStrings)||0<e.length:null!=e},e)},i.maxLength=function(e){return new i("maxLength",function(e,t){return null==e||"string"==typeof e&&e.length<=t.maxLength},e)},i.stringLength=function(e){return new i("stringLength",function(e,t){return!(null!=e&&("string"!=typeof e||null!=t.minLength&&e.length<t.minLength||null!=t.maxLength&&e.length>t.maxLength))},e)},i.string=function(){return new i("string",function(e){return null==e||"string"==typeof e})},i.guid=function(){return new i("guid",function(e){return null==e||z(e)})},i.duration=function(){return new i("duration",function(e){return null==e||L(e)})},i.number=i.double=i.single=function(e){return new i("number",function(e,t){if(null==e)return!0;"string"==typeof e&&t&&t.allowString&&(e=parseFloat(e,10));return"number"==typeof e&&!isNaN(e)},e)},i.integer=i.int64=function(e){return new i("integer",function(e,t){if(null==e)return!0;"string"==typeof e&&t&&t.allowString&&(e=parseInt(e,10));return"number"==typeof e&&!isNaN(e)&&Math.floor(e)===e},e)},i.int32=function(e){return n("int32",-2147483648,2147483647,e)()},i.int16=function(e){return n("int16",-32768,32767,e)()},i.byte=function(e){return n("byte",0,255,e)()},i.bool=function(){return new i("bool",function(e){return null==e||!0===e||!1===e})},i.none=function(){return new i("none",function(e){return!0})},i.date=function(){return new i("date",function(e){if(null==e)return!0;{if("string"!=typeof e)return K(e);try{return!isNaN(Date.parse(e))}catch(e){return!1}}})},i.creditCard=function(e){return new i("creditCard",function(e){return null==e||""===e||"string"==typeof e&&!(!(e=e.replace(/(\-|\s)/g,""))||/\D/.test(e))&&function(e,t,n,r,a){for(r=+e[t=e.length-1],a=0;t--;)n=+e[t],r+=++a%2?2*n%10+(4<n):n;return!(r%10)}(e)},e)},i.regularExpression=function(e){return new i("regularExpression",function(e,t){if(null==e||""===e)return!0;if("string"!=typeof e)return!1;try{var n=new RegExp(t.expression)}catch(e){throw new Error("Missing or invalid expression parameter to regExp validator")}return n.test(e)},e)},i.emailAddress=function(e){return t("emailAddress",/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,null,e)},i.phone=function(e){return t("phone",/^((\+|(0(\d+)?[-/.\s]?))[1-9]\d{0,2}[-/.\s]?)?((\(\d{1,6}\)|\d{1,6})[-/.\s]?)?(\d+[-/.\s]?)+\d+$/,null,e)},i.url=function(e){return t("url",/^(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|([a-zA-Z][\-a-zA-Z0-9]*)|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/,null,e)},i.makeRegExpValidator=t,P(i,function(e,t){"function"==typeof t&&"fromJSON"!==e&&"register"!==e&&"registerFactory"!==e&&"makeRegExpValidator"!==e&&re.registerFunction(t,"Validator."+e)}),i}(),se=(ue=function e(t,n,r,a){H(t,"validator").isOptional().isInstanceOf(oe).check(),H(r,"errorMessage").isNonEmptyString().check(),H(a,"key").isOptional().isNonEmptyString().check(),this.validator=t,n=n||{},this.context=n,this.errorMessage=r,this.property=n.property,this.propertyName=n.propertyName||n.property&&n.property.name,this.key=a||e.getKey(t||r,this.propertyName),this.isServerError=!1},ue.getKey=function(e,t){return(e.name||e)+(t?":"+t:"")},ue);var ue;v.Validator=oe,v.ValidationError=se;var pe=function(){var e=function(e){n(this,e)},t=e.prototype;function n(e,t){return t&&W(t).whereParam("validateOnAttach").isBoolean().isOptional().whereParam("validateOnSave").isBoolean().isOptional().whereParam("validateOnQuery").isBoolean().isOptional().whereParam("validateOnPropertyChange").isBoolean().isOptional().applyAll(e),e}return t._$typeName="ValidationOptions",t.using=function(e){if(!e)return this;var t=new pe(this);return n(t,e),t},t.setAsDefault=function(){return i(this,e)},e.defaultInstance=new e({validateOnAttach:!0,validateOnSave:!0,validateOnQuery:!1,validateOnPropertyChange:!0}),e}();v.ValidationOptions=pe,v.makeComplexArray=function(){var r={};function n(e,t){var n=e.complexAspect;return n.parent!==t.parent?null:(n.parent=null,n.parentProperty=null,n)}return r._getGoodAdds=function(e){return t=this,e.filter(function(e){return e.parent!==t.parent});var t},r._beforeChange=function(){ie.updateEntityState(this)},r._processAdds=function(e){var r;r=this,e.forEach(function(e){if(null!=e.parent)throw new Error("The complexObject is already attached. Either clone it or remove it from its current owner");var t,n;t=r,(n=e.complexAspect).parent!==t.parent&&(n.parent=t.parent,n.parentProperty=t.parentProperty)})},r._processRemoves=function(e){var t;t=this,e.forEach(function(e){n(e,t)})},r._rejectChanges=function(){if(this._origValues){var t=this;this.forEach(function(e){n(e,t)}),this.length=0,this._origValues.forEach(function(e){t.push(e)})}},r._acceptChanges=function(){this._origValues=null},function(e,t,n){return ie.initializeParent(e,t,n),e.arrayChanged=new ne("arrayChanged",e),k(e,ie.mixin),k(e,r)}}();var ce=(le=new te("EntityAction",{isAttach:function(){return!!this.isAttach},isDetach:function(){return!!this.isDetach},isModification:function(){return!!this.isModification}}),le.Attach=le.addSymbol({isAttach:!0}),le.AttachOnQuery=le.addSymbol({isAttach:!0}),le.AttachOnImport=le.addSymbol({isAttach:!0}),le.Detach=le.addSymbol({isDetach:!0}),le.MergeOnQuery=le.addSymbol({isModification:!0}),le.MergeOnImport=le.addSymbol({isModification:!0}),le.MergeOnSave=le.addSymbol({isModification:!0}),le.PropertyChange=le.addSymbol({isModification:!0}),le.EntityStateChange=le.addSymbol(),le.AcceptChanges=le.addSymbol(),le.RejectChanges=le.addSymbol({isModification:!0}),le.Clear=le.addSymbol({isDetach:!0}),le.resolveSymbols(),le);var le;v.EntityAction=ce;var ye=function(){var e=function e(t){if(null===t){var n=e._nullInstance;if(n)return n;e._nullInstance=this}else{if(void 0===t)throw new Error("The EntityAspect ctor requires an entity as its only argument.");if(t.entityAspect)return t.entityAspect}if(!(this instanceof e))return new e(t);if(this.entity=t,this.entityGroup=null,this.entityManager=null,this.entityState=ve.Detached,this.isBeingSaved=!1,this.originalValues={},this.hasValidationErrors=!1,this._validationErrors={},this.validationErrorsChanged=new ne("validationErrorsChanged",this),this.propertyChanged=new ne("propertyChanged",this),null!=t){t.entityAspect=this;var r=t.entityType||t._$entityType;if(!r){var a=t.prototype._$typeName;throw a?new Error("Metadata for this entityType has not yet been resolved: "+a):new Error("This entity is not registered as a valid EntityType")}var i=r.getEntityCtor();ae.getDefaultInstance().startTracking(t,i.prototype)}},t=e.prototype;function i(n){var e=n.entityAspect||n.complexAspect,t=n.entityType||n.complexType,r=e.originalValues;for(var a in r)n.setProperty(a,r[a]);t.complexProperties.forEach(function(e){var t=n.getProperty(e.name);e.isScalar?i(t):(t._rejectChanges(),t.forEach(i))})}function o(n){var e=n.entityAspect||n.complexAspect;e.originalValues={};var t=n.entityType||n.complexType;t.complexProperties.forEach(function(e){var t=n.getProperty(e.name);e.isScalar?o(t):(t._acceptChanges(),t.forEach(o))})}function u(r,e){var a=!0,t=r.entityType||r.complexType,i=r.entityAspect||r.complexAspect,o=r.entityAspect||r.complexAspect.getEntityAspect(),s={entity:o.entity};return void 0!==e&&(s.index=e),t.getProperties().forEach(function(e){var t=r.getProperty(e.name),n=e.getAllValidators();0<n.length&&(s.property=e,s.propertyName=i.getPropertyPath(e.name),a=o._validateProperty(t,s)&&a),e.isComplexProperty&&(a=e.isScalar?u(t)&&a:t.reduce(function(e,t,n){return u(t,n)&&e},a))}),t.getAllValidators().forEach(function(e){a=p(o,e,r)&&a}),a}function s(e,t){var n=t.isDeleted();n?r(e):F(e.entityAspect.entityManager,"isLoading",!0,function(){r(e)})}function r(a){a.entityType.navigationProperties.forEach(function(e){var t=e.getInverse(),n=a.getProperty(e.name);if(e.isScalar){if(n){if(t)if(t.isScalar)n.setProperty(t.name,null);else{var r=n.getProperty(t.name);r.length&&A(r,a)}a.setProperty(e.name,null)}}else t&&n.slice(0).forEach(function(e){t.isScalar&&e.setProperty(t.name,null)}),n.length=0})}function p(e,t,n,r){var a=t.validate(n,r);if(a)return e._addValidationError(a),!1;var i=se.getKey(t,r?r.propertyName:null);return e._removeValidationError(i),!0}return ne.bubbleEvent(t,function(){return this.entityManager}),t.getKey=function(e){if((e=H(e,"forceRefresh").isBoolean().isOptional().check(!1))||!this._entityKey){var t=this.entity.entityType,n=t.keyProperties,r=n.map(function(e){return this.entity.getProperty(e.name)},this);this._entityKey=new me(t,r)}return this._entityKey},t.acceptChanges=function(){this._checkOperation("acceptChanges");var e=this.entityManager;this.entityState.isDeleted()?e.detachEntity(this.entity):this.setUnchanged(),e.entityChanged.publish({entityAction:ce.AcceptChanges,entity:this.entity})},t.rejectChanges=function(){this._checkOperation("rejectChanges");var e=this.entity,t=this.entityManager;F(t,"isRejectingChanges",!0,function(){i(e)}),this.entityState.isAdded()?(t.detachEntity(e),t._notifyStateChange(e,!1)):(this.entityState.isDeleted()&&this.entityManager._linkRelatedEntities(e),this.setUnchanged(),this.propertyChanged.publish({entity:e,propertyName:null}),this.entityManager.entityChanged.publish({entityAction:ce.RejectChanges,entity:e}))},t.getPropertyPath=function(e){return e},t.setAdded=function(){return this.setEntityState(ve.Added)},t.setUnchanged=function(){return this.setEntityState(ve.Unchanged)},t.setModified=function(){return this.setEntityState(ve.Modified)},t.setDeleted=function(){return this.setEntityState(ve.Deleted)},t.setDetached=function(){return this.setEntityState(ve.Detached)},t.setEntityState=function(e){if(this.entityState===e)return!1;if(this._checkOperation("setEntityState"),this.entityState.isDetached())throw new Error("You cannot set the 'entityState' of an entity when it is detached - except by first attaching it to an EntityManager");var t=this.entity,n=this.entityManager,r=!0;if(e===ve.Unchanged)o(t),delete this.hasTempKey,r=!1;else if(e===ve.Added)o(t);else if(e===ve.Deleted){if(this.entityState.isAdded())return this.setEntityState(ve.Detached),!0;this.entityState=ve.Deleted,s(t,ve.Deleted)}else if(e===ve.Modified);else if(e===ve.Detached){var a=this.entityGroup;if(!a)return!1;a.detachEntity(t),this.entityState=e,s(t,ve.Detached),this._detach(),n.entityChanged.publish({entityAction:ce.Detach,entity:t}),r=!1}return this.entityState=e,n._notifyStateChange(t,r),!0},t.loadNavigationProperty=function(e,t,n){var r=this.entity,a=r.entityType._checkNavProperty(e),i=Xe.fromEntityNavigation(r,a),o=r.entityAspect.entityManager.executeQuery(i),s=this;return o.then(function(e){return s._markAsLoaded(a.name),t&&t(e),Oe.resolve(e)},function(e){return n&&n(e),Oe.reject(e)})},t.markNavigationPropertyAsLoaded=function(e){var t=this.entity.entityType._checkNavProperty(e);this._markAsLoaded(t.name)},t.isNavigationPropertyLoaded=function(e){var t=this.entity.entityType._checkNavProperty(e);return!(!t.isScalar||null==this.entity.getProperty(t.name))||this._loadedNps&&0<=this._loadedNps.indexOf(t.name)},t._markAsLoaded=function(e){this._loadedNps=this._loadedNps||[],h(this._loadedNps,e)},t.validateEntity=function(){var t=!0;return this._processValidationOpAndPublish(function(e){t=u(e.entity)}),t},t.validateProperty=function(e,t){var n=this.getPropertyValue(e);return n&&n.complexAspect?u(n):((t=t||{}).entity=this.entity,"string"==typeof e?(t.property=this.entity.entityType.getProperty(e,!0),t.propertyName=e):(t.property=e,t.propertyName=e.name),this._validateProperty(n,t))},t.getValidationErrors=function(e){H(e,"property").isOptional().isEntityProperty().or().isString().check();var t=w(this._validationErrors);if(e){var n="string"==typeof e?e:e.name;t=t.filter(function(e){return e.property&&(e.property.name===n||-1!=n.indexOf(".")&&e.propertyName==n)})}return t},t.addValidationError=function(t){H(t,"validationError").isInstanceOf(se).check(),this._processValidationOpAndPublish(function(e){e._addValidationError(t)})},t.removeValidationError=function(e){H(e,"validationErrorOrKey").isString().or().isInstanceOf(se).or().isInstanceOf(oe).check();var t="string"==typeof e?e:e.key;this._processValidationOpAndPublish(function(e){e._removeValidationError(t)})},t.clearValidationErrors=function(){this._processValidationOpAndPublish(function(n){P(n._validationErrors,function(e,t){t&&(delete n._validationErrors[e],n._pendingValidationResult.removed.push(t))}),n.hasValidationErrors=!q(n._validationErrors)})},t.getParentKey=function(e){var t=e.foreignKeyNames;if(0===t.length)return null;var n=this,r=t.map(function(e){return n.entity.getProperty(e)});return new me(e.entityType,r)},t.getPropertyValue=function(e){var t;if(H(e,"property").isString().or().isEntityProperty().check(),"string"==typeof e){var n=e.trim().split("."),r=n.shift();for(t=(t=this.entity).getProperty(r);0<n.length;)r=n.shift(),t=t.getProperty(r)}else{if(!(e.parentType instanceof xe))throw new Error("The validateProperty method does not accept a 'property' parameter whose parentType is a ComplexType; Pass a 'property path' string as the 'property' parameter instead ");t=this.entity.getProperty(e.name)}return t},t._checkOperation=function(e){if(this.isBeingSaved)throw new Error("Cannot perform a '"+e+"' on an entity that is in the process of being saved");return this},t._detach=function(){this.entityGroup=null,this.entityManager=null,this.entityState=ve.Detached,this.originalValues={},this._validationErrors={},this.hasValidationErrors=!1,this.validationErrorsChanged.clear(),this.propertyChanged.clear()},t._validateProperty=function(n,r){var a=!0;return this._processValidationOpAndPublish(function(t){r.property.getAllValidators().forEach(function(e){a=p(t,e,n,r)&&a})}),a},t._processValidationOpAndPublish=function(e){if(this._pendingValidationResult)e(this);else try{this._pendingValidationResult={entity:this.entity,added:[],removed:[]},e(this),(0<this._pendingValidationResult.added.length||0<this._pendingValidationResult.removed.length)&&(this.validationErrorsChanged.publish(this._pendingValidationResult),this.entityManager&&this.entityManager.validationErrorsChanged.publish(this._pendingValidationResult))}finally{this._pendingValidationResult=void 0}},t._addValidationError=function(e){this._validationErrors[e.key]=e,this.hasValidationErrors=!0,this._pendingValidationResult.added.push(e)},t._removeValidationError=function(e){var t=this._validationErrors[e];t&&(delete this._validationErrors[e],this.hasValidationErrors=!q(this._validationErrors),this._pendingValidationResult.removed.push(t))},e}(),fe=(he=function e(t,n,r){if(!t)throw new Error("The  ComplexAspect ctor requires an entity as its only argument.");if(t.complexAspect)return t.complexAspect;if(!(this instanceof e))return new e(t,n,r);((this.complexObject=t).complexAspect=this).originalValues={},null!=n&&(this.parent=n,this.parentProperty=r);var a=t.complexType;if(!a){var i=t.prototype._$typeName;throw i?new Error("Metadata for this complexType has not yet been resolved: "+i):new Error("This entity is not registered as a valid ComplexType")}var o=a.getCtor();ae.getDefaultInstance().startTracking(t,o.prototype)},de=he.prototype,de.getEntityAspect=function(){var e=this.parent;if(!e)return new ye(null);for(var t=e.entityAspect;e&&!t;)e=e.complexAspect&&e.complexAspect.parent,t=e&&e.entityAspect;return t||new ye(null)},de.getPropertyPath=function(e){var t=this.parent;if(!t)return null;var n=t.complexAspect||t.entityAspect;return n.getPropertyPath(this.parentProperty.name+"."+e)},he);var he,de;v.EntityAspect=ye,v.ComplexAspect=fe;var me=function(){var t=":::",e=function(e,n){H(e,"entityType").isInstanceOf(xe).check();var t=e.getSelfAndSubtypes();1<t.length&&(this._subtypes=t.filter(function(e){return!1===e.isAbstract})),Array.isArray(n)||(n=D(arguments,1)),(this.entityType=e).keyProperties.forEach(function(e,t){e.dataType===Ne.Guid&&(n[t]=n[t]&&n[t].toLowerCase())}),this.values=n,this._keyInGroup=r(n)};e._$typeName="EntityKey";var n=e.prototype;function r(e){return e.join(t)}return n.toJSON=function(){return{entityType:this.entityType.name,values:this.values}},e.fromJSON=function(e,t){var n=t._getEntityType(e.entityType,!0);return new me(n,e.values)},n.equals=function(e){return e instanceof me&&(this.entityType===e.entityType&&m(this.values,e.values))},n.toString=function(e){return(e||this.entityType).name+"-"+this._keyInGroup},e.equals=function(e,t){return e instanceof me&&e.equals(t)},n._isEmpty=function(){return 0===this.values.join("").length},e.createKeyString=r,e}();v.EntityKey=me;var ve=(ge={isUnchanged:function(){return this===we.Unchanged},isAdded:function(){return this===we.Added},isModified:function(){return this===we.Modified},isDeleted:function(){return this===we.Deleted},isDetached:function(){return this===we.Detached},isUnchangedOrModified:function(){return this===we.Unchanged||this===we.Modified},isAddedModifiedOrDeleted:function(){return this===we.Added||this===we.Modified||this===we.Deleted}},we=new te("EntityState",ge),we.Unchanged=we.addSymbol(),we.Added=we.addSymbol(),we.Modified=we.addSymbol(),we.Deleted=we.addSymbol(),we.Detached=we.addSymbol(),we.resolveSymbols(),we);var ge,we;function Ee(e,t,n){void 0===t&&(t=null);var r=n(),a=e.dataType;if(a&&a.parse&&(t=Array.isArray(t)&&!e.isScalar?t.map(function(e){return a.parse(e,typeof e)}):a.parse(t,typeof t)),!(t===r||a&&a.normalize&&t&&r&&a.normalize(t)===a.normalize(r))){var i,o=this.entityAspect;if(o)i=e.name;else{var s=this.complexAspect;if(!s)return void n(t);o=s.getEntityAspect(),i=s.getPropertyPath(e.name)}var u=o._inProcess=o._inProcess||[];if(!(0<=u.indexOf(e))){u.push(e);try{var p={parent:this,property:e,newValue:t,oldValue:r,propertyName:i,entityAspect:o};e.isComplexProperty?function(e,t){var n=e.property,r=e.oldValue,a=e.newValue,i=n.dataType;{if(!n.isScalar)throw new Error(G("You cannot set the non-scalar complex property: '%1' on the type: '%2'.Instead get the property and use array functions like 'push' or 'splice' to change its contents.",n.name,n.parentType.name));if(!a)throw new Error(G("You cannot set the '%1' property to null because it's datatype is the ComplexType: '%2'",n.name,n.dataType.name));if(!r){var o=i.getCtor();r=new o,t(r)}i.dataProperties.forEach(function(e){var t=e.name,n=a.getProperty(t);r.setProperty(t,n)})}}(p,n):e.isDataProperty?function(e,t){var i=e.parent,n=e.property,r=e.entityAspect,a=e.oldValue,o=e.newValue,s=r.entityManager,u=i.entityType;if(!n.isScalar)throw new Error("Nonscalar data properties are readonly - items may be added or removed but the collection may not be changed.");if(r.entityState.isUnchangedOrModified()){var p=n.name,c=i.entityAspect||i.complexAspect;void 0===c.originalValues[p]&&(c.originalValues[p]=void 0!==a?a:n.defaultValue)}if(n.isPartOfKey&&s&&!s.isLoading){var l=u.keyProperties,y=l.map(function(e){return e===n?o:i.getProperty(e.name)}),f=new me(u,y);if(s.findEntityByKey(f))throw new Error("An entity with this key is already in the cache: "+f.toString());var h=i.entityAspect.getKey(),d=s._findEntityGroup(u);d._replaceKey(h,f)}var m=n.relatedNavigationProperty;if(m&&s)if(null!=o){var v=new me(m.entityType,[o]),g=s.findEntityByKey(v);g?i.setProperty(m.name,g):(s._unattachedChildrenMap.addChild(v,m,i),i.setProperty(m.name,null))}else i.setProperty(m.name,null);else if(n.inverseNavigationProperty&&s&&!s._inKeyFixup){var w=n.inverseNavigationProperty;if(null!=a&&(v=new me(w.parentType,[a]),g=s.findEntityByKey(v)))if(w.isScalar)g.setProperty(w.name,null);else{var E=g.getProperty(w.name);E.splice(E.indexOf(i),1)}null!=o&&(v=new me(w.parentType,[o]),(g=s.findEntityByKey(v))?w.isScalar?g.setProperty(w.name,i):g.getProperty(w.name).push(i):s._unattachedChildrenMap.addChild(v,w,i))}if(t(o),Se(e),n.isPartOfKey){var S=u.keyProperties.indexOf(n);if(u.navigationProperties.forEach(function(e){var t=e.getInverse(),n=t?t.foreignKeyNames:e.invForeignKeyNames;if(0!==n.length){var r=i.getProperty(e.name);if(r){var a=n[S];e.isScalar?r.setProperty(a,o):r.forEach(function(e){e.setProperty(a,o)})}}}),s){for(var P=u.inverseForeignKeyProperties,T=u.baseEntityType;T;)P=P.concat(T.inverseForeignKeyProperties),T=T.baseEntityType;P.forEach(function(e){null==e.relatedNavigationProperty.inverse&&s._updateFkVal(e,a,o)})}r.getKey(!0)}}(p,n):function(e,t){var a=e.parent,i=e.property,n=e.entityAspect,r=e.oldValue,o=e.newValue;if(!i.isScalar)throw new Error("Nonscalar navigation properties are readonly - entities can be added or removed but the collection may not be changed.");var s=n.entityManager,u=i.getInverse();if(null!=o){var p=o.entityAspect;if(s){if(p.entityState.isDetached())s.isLoading||s.attachEntity(o,ve.Added);else if(p.entityManager!==s)throw new Error("An Entity cannot be attached to an entity in another EntityManager. One of the two entities must be detached first.")}else p&&p.entityManager&&((s=p.entityManager).isLoading||s.attachEntity(n.entity,ve.Added))}if(u)if(u.isScalar)null!=r&&r.setProperty(u.name,null),null!=o&&o.setProperty(u.name,a);else{if(null!=r){var c=r.getProperty(u.name),l=c.indexOf(a);-1!==l&&c.splice(l,1)}if(null!=o){var y=o.getProperty(u.name);y.push(a)}}else if(i.invForeignKeyNames&&s&&!s._inKeyFixup){var f=i.invForeignKeyNames;if(null!=o){var h=a.entityAspect.getKey().values;f.forEach(function(e,t){o.setProperty(e,h[t])})}else null!=r&&f.forEach(function(e){var t=r.entityType.getProperty(e);t.isPartOfKey||r.setProperty(e,null)})}if(t(o),Se(e),i.relatedDataProperties){var d=n.entityState;if(null==o&&(d.isDetached()||r.entityAspect.entityState.isDetached()))return;if(d.isDeleted())return;var m=i.entityType.keyProperties;m.forEach(function(e,t){var n=i.relatedDataProperties[t];if(o||!n.isPartOfKey){var r=o?o.getProperty(e.name):n.defaultValue;a.setProperty(n.name,r)}})}}(p,n),l=(c=p).entityAspect,y=l.entityManager,f=l.entity,h={entity:f,parent:c.parent,property:c.property,propertyName:c.propertyName,oldValue:c.oldValue,newValue:c.newValue},y?y.isLoading||y.isRejectingChanges||(l.propertyChanged.publish(h),y.entityChanged.publish({entityAction:ce.PropertyChange,entity:f,args:h})):l.propertyChanged.publish(h)}finally{u.pop()}var c,l,y,f,h}}}function Se(e){var t=e.entityAspect,n=t.entityManager;if(null!=n&&!n.isLoading){var r=e.property;t.entityState.isUnchanged()&&!r.isUnmapped&&t.setModified(),n.validationOptions.validateOnPropertyChange&&t._validateProperty(e.newValue,{entity:t.entity,property:r,propertyName:e.propertyName,oldValue:e.oldValue})}}v.EntityState=ve,v.makePrimitiveArray=(Te={},Te._getGoodAdds=function(e){return e},Te._beforeChange=function(){var e=this.getEntityAspect();e.entityState.isUnchanged()&&e.setModified(),e.entityState.isModified()&&!this._origValues&&(this._origValues=this.slice(0))},Te._processAdds=function(e){},Te._processRemoves=function(e){},Te._rejectChanges=function(){this._origValues&&(this.length=0,Array.prototype.push.apply(this,this._origValues))},Te._acceptChanges=function(){this._origValues=null},function(e,t,n){return ie.initializeParent(e,t,n),e.arrayChanged=new ne("arrayChanged",e),k(e,ie.mixin),k(e,Te)}),v.makeRelationArray=(Pe={},Pe.load=function(e,t){var n=this.parentEntity,r=Xe.fromEntityNavigation(this.parentEntity,this.navigationProperty),a=n.entityAspect.entityManager;return a.executeQuery(r,e,t)},Pe._getEventParent=function(){return this.parentEntity.entityAspect},Pe._getPendingPubs=function(){var e=this.parentEntity.entityAspect.entityManager;return e&&e._pendingPubs},Pe._getGoodAdds=function(e){return function(t,e){var n=function(n,e){var t,o=n.parentEntity,r=n.navigationProperty,a=r.getInverse();if(a)t=e.filter(function(e){if(0<=n._addsInProcess.indexOf(e))return!1;var t=e.getProperty(a.name);return t!==o});else{var s=r.invForeignKeyNames;r.baseProperty&&!s.length&&(s=r.baseProperty.invForeignKeyNames);var u=o.entityType.keyProperties;t=e.filter(function(i){return!(0<=n._addsInProcess.indexOf(i))&&s.some(function(e,t){var n=u[t].name,r=o.getProperty(n),a=i.getProperty(e);return r!==a})})}return t}(t,e);if(!n.length)return n;var r=t.parentEntity.entityAspect.entityManager;return r&&!r.isLoading&&n.forEach(function(e){if(e.entityAspect.entityState.isDetached()){t._inProgress=!0;try{r.attachEntity(e,ve.Added)}finally{t._inProgress=!1}}}),n}(this,e)},Pe._processAdds=function(e){!function(e,t){var a=e.parentEntity,i=e.navigationProperty,o=e._addsInProcess,s=i.getInverse(),n=o.length;try{t.forEach(function(n){if(o.push(n),s)n.setProperty(s.name,a);else{var r=a.entityType.keyProperties;i.invForeignKeyNames.forEach(function(e,t){n.setProperty(e,a.getProperty(r[t].name))})}})}finally{o.splice(n,t.length)}}(this,e)},Pe._processRemoves=function(e){var t,n;t=e,(n=this.navigationProperty.getInverse())&&t.forEach(function(e){e.setProperty(n.name,null)})},function(e,t,n){return e.parentEntity=t,e.navigationProperty=n,e.arrayChanged=new ne("arrayChanged",e),e._addsInProcess=[],k(e,ie.mixin),k(e,Pe)});var Pe;var Te;var Ne=function(){var t,e=function(){t={stringPrefix:"K_",nextNumber:-1,nextNumberIncrement:-1}};e();var n=function(){var e=t.nextNumber;return t.nextNumber+=t.nextNumberIncrement,e},r=function(){return new Date},a=function(e){for(var t=new Date,n=new Date;t.getTime()===n.getTime();)n=new Date;return n},i=function(e,t){if("string"===t){var n=e.trim();if(""===n)return null;var r=parseInt(n,10);return isNaN(r)?e:r}return"number"===t?Math.round(e):e},o=function(e,t){if("string"===t){var n=e.trim();if(""===n)return null;var r=parseFloat(n);return isNaN(r)?e:r}return e},s=function(e,t){var n;if("string"===t){var r=e.trim();return""===r?null:K(n=new Date(Date.parse(r)))?n:e}return"number"===t&&K(n=new Date(e))?n:e},u=function(e){return null==e?null:"string"==typeof e?parseInt(e,10):e},p=function(t){return function(e){return null==e?null:("string"==typeof e&&(e=parseFloat(e)),e+t)}};function c(e,t){throw e=G(e,t),new Error(e)}var l=function(e){return K(e)||(e=y.parseDateFromServer(e)),e},y=new te("DataType",{});y.String=y.addSymbol({defaultValue:"",parse:function(e,t){return null==e?e:e.toString()},fmtOData:function(e){return null==e?null:"'"+e.replace(/'/g,"''")+"'"},getNext:function(){return t.stringPrefix+n().toString()}}),y.Int64=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,quoteJsonOData:!0,parse:i,fmtOData:p("L"),getNext:n}),y.Int32=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:i,fmtOData:u,getNext:n}),y.Int16=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:i,fmtOData:u,getNext:n}),y.Byte=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:i,fmtOData:u}),y.Decimal=y.addSymbol({defaultValue:0,isNumeric:!0,quoteJsonOData:!0,isFloat:!0,parse:o,fmtOData:p("m"),getNext:n}),y.Double=y.addSymbol({defaultValue:0,isNumeric:!0,isFloat:!0,parse:o,fmtOData:p("d"),getNext:n}),y.Single=y.addSymbol({defaultValue:0,isNumeric:!0,isFloat:!0,parse:o,fmtOData:p("f"),getNext:n}),y.DateTime=y.addSymbol({defaultValue:new Date(1900,0,1),isDate:!0,parse:s,parseRawValue:l,normalize:function(e){return e&&e.getTime&&e.getTime()},fmtOData:function(t){if(null==t)return null;try{return"datetime'"+t.toISOString()+"'"}catch(e){c("'%1' is not a valid dateTime",t)}},getNext:r,getConcurrencyValue:a}),y.DateTimeOffset=y.addSymbol({defaultValue:new Date(1900,0,1),isDate:!0,parse:s,parseRawValue:l,normalize:function(e){return e&&e.getTime&&e.getTime()},fmtOData:function(t){if(null==t)return null;try{return"datetimeoffset'"+t.toISOString()+"'"}catch(e){c("'%1' is not a valid dateTime",t)}},getNext:r,getConcurrencyValue:a}),y.Time=y.addSymbol({defaultValue:"PT0S",fmtOData:function(e){if(null==e)return null;L(e)||c("'%1' is not a valid ISO 8601 duration",e);return"time'"+e+"'"},parseRawValue:y.parseTimeFromServer}),y.Boolean=y.addSymbol({defaultValue:!1,parse:function(e,t){if("string"===t){var n=e.trim().toLowerCase();return"false"!==n&&""!==n&&("true"===n||e)}return e},fmtOData:function(e){if(null==e)return null;return"string"==typeof e?"true"===e.trim().toLowerCase():!!e}}),y.Guid=y.addSymbol({defaultValue:"00000000-0000-0000-0000-000000000000",parse:function(e,t){if("string"===t)return e.trim().toLowerCase();return e},fmtOData:function(e){if(null==e)return null;z(e)||c("'%1' is not a valid guid",e);return"guid'"+e+"'"},getNext:function(){return S()},parseRawValue:function(e){return e.toLowerCase()},getConcurrencyValue:S}),y.Binary=y.addSymbol({defaultValue:null,fmtOData:function(e){return null==e?e:"binary'"+e+"'"},parseRawValue:function(e){e&&void 0!==e.$value&&(e=e.$value);return e}}),y.Undefined=y.addSymbol({defaultValue:void 0,fmtOData:function(e){return e}}),y.resolveSymbols(),y.getComparableFn=function(e){return e&&e.normalize?e.normalize:e===y.Time?function(e){return e&&V(e)}:function(e){return e}},y.fromEdmDataType=function(e){var t=null,n=e.split(".");if(1<n.length){var r=n[1];t="image"===r?y.Byte:2===n.length?y.fromName(r)||y.Undefined:y.String}return t},y.fromValue=function(e){if(K(e))return y.DateTime;switch(typeof e){case"string":return z(e)?y.Guid:L(e)&&3<e.length?y.Time:"string"==typeof(t=e)&&/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/.test(t)?y.DateTime:y.String;case"boolean":return y.Boolean;case"number":return y.Double}var t;return y.Undefined};var f=/.\d{3}$/;return y.parseTimeFromServer=function(e){if("string"==typeof e)return e;if(e&&"Edm.Time"===e.__edmType){var t=Math.floor(e.ms/1e3);return"PT"+t+"S"}return e},y.parseDateAsUTC=function(e){if("string"==typeof e){var t=f.test(e);e=t?e+"Z":e}return e=new Date(Date.parse(e))},y.parseDateFromServer=y.parseDateAsUTC,y.parseRawValue=function(e,t){if(void 0!==e)return e&&t&&t.parseRawValue&&(e=t.parseRawValue(e)),e},y.constants=t,y._resetConstants=e,y.getSymbols().forEach(function(e){e.validatorCtor=function(e){switch(e){case y.String:return oe.string;case y.Int64:return oe.int64;case y.Int32:return oe.int32;case y.Int16:return oe.int16;case y.Decimal:case y.Double:case y.Single:return oe.number;case y.DateTime:case y.DateTimeOffset:return oe.date;case y.Boolean:return oe.bool;case y.Guid:return oe.guid;case y.Byte:return oe.byte;case y.Binary:return oe.none;case y.Time:return oe.duration;case y.Undefined:return oe.none}}(e)}),y}();v.DataType=Ne;var _e=function(){var e=function(e){n(this,e)},t=e.prototype;function n(e,t){return t&&(W(t).whereParam("serviceName").isOptional().whereParam("adapterName").isString().isOptional().whereParam("uriBuilderName").isString().isOptional().whereParam("hasServerMetadata").isBoolean().isOptional().whereParam("jsonResultsAdapter").isInstanceOf(be).isOptional().whereParam("useJsonp").isBoolean().isOptional().applyAll(e),e.serviceName=e.serviceName&&_e._normalizeServiceName(e.serviceName),e.adapterInstance=e.adapterName&&re.getAdapterInstance("dataService",e.adapterName),e.uriBuilder=e.uriBuilderName&&re.getAdapterInstance("uriBuilder",e.uriBuilderName)),e}return t._$typeName="DataService",t.using=function(e){if(!e)return this;var t=new _e(this);return n(t,e)},e.resolve=function(e){e.push({hasServerMetadata:!0,useJsonp:!1});var t=new _e(u(e,["serviceName","adapterName","uriBuilderName","hasServerMetadata","jsonResultsAdapter","useJsonp"]));if(!t.serviceName)throw new Error("Unable to resolve a 'serviceName' for this dataService");return t.adapterInstance=t.adapterInstance||re.getAdapterInstance("dataService",t.adapterName),t.jsonResultsAdapter=t.jsonResultsAdapter||t.adapterInstance.jsonResultsAdapter,t.uriBuilder=t.uriBuilder||re.getAdapterInstance("uriBuilder",t.uriBuilderName),t},e._normalizeServiceName=function(e){return"/"!==(e=e.trim()).substr(-1)?e+"/":e},t.toJSON=function(){return y(this,{serviceName:null,adapterName:null,uriBuilderName:null,hasServerMetadata:null,jsonResultsAdapter:function(e){return e&&e.name},useJsonp:null})},e.fromJSON=function(e){return e.jsonResultsAdapter=re._fetchObject(be,e.jsonResultsAdapter),new _e(e)},t.qualifyUrl=function(e){var t=this.serviceName;return Q.stringEndsWith(t,"/")&&(t=t.substr(0,t.length-1)),e="/"+e,Q.stringEndsWith(t,e)||(t+=e),t},e}(),be=function(){var e=function(e){if(1!==arguments.length)throw new Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.");W(e).whereParam("name").isNonEmptyString().whereParam("extractResults").isFunction().isOptional().withDefault(n).whereParam("extractSaveResults").isFunction().isOptional().withDefault(r).whereParam("extractKeyMappings").isFunction().isOptional().withDefault(a).whereParam("extractDeletedKeys").isFunction().isOptional().withDefault(i).whereParam("visitNode").isFunction().applyAll(this),re._storeObject(this,t._$typeName,this.name)},t=e.prototype;function n(e){return e.results}function r(e){return e.entities||e.Entities||[]}function a(e){return e.keyMappings||e.KeyMappings||[]}function i(e){return e.deletedKeys||e.DeletedKeys||[]}return t._$typeName="JsonResultsAdapter",e}();v.DataService=_e,v.JsonResultsAdapter=be;var Oe=Q.requireLib("Q;q");Oe||((Oe=function(){throw new Error("Q is undefined. Are you missing Q.js? See https://github.com/kriskowal/q")}).defer=Oe.resolve=Oe.reject=Oe);v.config.setQ=function(e){v.Q=Oe=e},v.Q=Oe;var Ae=function(){var t=0,e=function(e){W(e=e||{}).whereParam("namingConvention").isOptional().isInstanceOf(Ze).withDefault(Ze.defaultInstance).whereParam("localQueryComparisonOptions").isOptional().isInstanceOf(Ge).withDefault(Ge.defaultInstance).whereParam("serializerFn").isOptional().isFunction().applyAll(this),this.dataServices=[],this._resourceEntityTypeMap={},this._structuralTypeMap={},this._shortNameMap={},this._ctorRegistry={},this._incompleteTypeMap={},this._incompleteComplexTypeMap={},this._id=t++,this.metadataFetched=new ne("metadataFetched",this)},n=e.prototype;function s(r,e){e&&e.forEach(function(e){var t=e.name;if(!t){if(!e.nameOnServer)throw new Error("Unable to complete 'importMetadata' - cannot locate a 'name' or 'nameOnServer' for one of the imported property nodes");t=r.metadataStore.namingConvention.serverPropertyNameToClient(e.nameOnServer,{})}if(e.custom){var n=r.getProperty(t,!0);n.custom=e.custom}})}function u(t,e,n){e.validators&&(n.validators=e.validators.map(oe.fromJSON)),e.dataProperties.forEach(function(e){n._addPropertyCore(Me.fromJSON(e))});var r=!e.isComplexType;r&&e.navigationProperties&&e.navigationProperties.forEach(function(e){n._addPropertyCore(De.fromJSON(e))}),t.addEntityType(n);var a=t._deferredTypes,i=a[n.name];i&&(i.forEach(function(e){u(t,e.json,e.stype)}),delete a[n.name])}function p(e,t,n){if(Le(t))return t;var r=e._shortNameMap[t];if(!r&&n)throw new Error("Unable to locate 'entityTypeName' of: "+t);return r}return n._$typeName="MetadataStore",ne.bubbleEvent(n,null),e.ANONTYPE_PREFIX="_IB_",e.normalizeTypeName=E(function(e){return e&&Be(e).typeName}),n.setProperties=function(e){W(e).whereParam("name").isString().isOptional().whereParam("serializerFn").isFunction().isOptional().applyAll(this)},n.addDataService=function(e,t){H(e,"dataService").isInstanceOf(_e).check(),H(t,"shouldOverwrite").isBoolean().isOptional().check();var n=this._getDataServiceIndex(e.serviceName);if(0<=n){if(!t)throw new Error("A dataService with this name '"+e.serviceName+"' already exists in this MetadataStore");this.dataServices[n]=e}else this.dataServices.push(e)},n._getDataServiceIndex=function(t){return f(this.dataServices,function(e){return e.serviceName===t})},n.addEntityType=function(t){if(t instanceof xe||t instanceof Fe||(t=t.isComplexType?new Fe(t):new xe(t)),!t.isComplexType){if(t.baseTypeName&&!t.baseEntityType){var e=this._getEntityType(t.baseTypeName,!0);t._updateFromBase(e)}if(0===t.keyProperties.length&&!t.isAbstract)throw new Error("Unable to add "+t.name+" to this MetadataStore.  An EntityType must have at least one property designated as a key property - See the 'DataProperty.isPartOfKey' property.")}if(t.metadataStore=this,!t.isAnonymous){if(this._structuralTypeMap[t.name])throw new Error("Type "+t.name+" already exists in this MetadataStore.");this._structuralTypeMap[t.name]=t,this._shortNameMap[t.shortName]=t.name}if(t.getProperties().forEach(function(e){t._updateNames(e),e.isUnmapped||t._mappedPropertiesCount++}),t._updateCps(),!t.isComplexType){t._updateNps();var n=t.defaultResourceName||t.baseEntityType&&t.baseEntityType.defaultResourceName;n&&!this.getEntityTypeNameForResourceName(n)&&this.setEntityTypeForResourceName(n,t.name),t.defaultResourceName=n,t.getEntityCtor()}},n.exportMetadata=function(){var e=JSON.stringify({metadataVersion:v.metadataVersion,name:this.name,namingConvention:this.namingConvention.name,localQueryComparisonOptions:this.localQueryComparisonOptions.name,dataServices:this.dataServices,structuralTypes:g(this._structuralTypeMap),resourceEntityTypeMap:this._resourceEntityTypeMap},null,re.stringifyPad);return e},n.importMetadata=function(e,t){H(t,"allowMerge").isOptional().isBoolean().check(),this._deferredTypes={};var n="string"==typeof e?JSON.parse(e):e;if(n.schema)return Ce.parse(this,n.schema,n.altMetadata);if(n.metadataVersion&&n.metadataVersion!==v.metadataVersion){var r=G("Cannot import metadata with a different 'metadataVersion' (%1) than the current 'breeze.metadataVersion' (%2) ",n.metadataVersion,v.metadataVersion);throw new Error(r)}var a=n.namingConvention,i=n.localQueryComparisonOptions;if(this.isEmpty())this.namingConvention=re._fetchObject(Ze,a)||this.namingConvention,this.localQueryComparisonOptions=re._fetchObject(Ge,i)||this.localQueryComparisonOptions;else{if(a&&this.namingConvention.name!==a)throw new Error("Cannot import metadata with a different 'namingConvention' from the current MetadataStore");if(i&&this.localQueryComparisonOptions.name!==i)throw new Error("Cannot import metadata with different 'localQueryComparisonOptions' from the current MetadataStore")}var o=this;n.dataServices&&n.dataServices.forEach(function(e){e=_e.fromJSON(e),o.addDataService(e,!0)});this._structuralTypeMap;return n.structuralTypes&&n.structuralTypes.forEach(function(e){!function(e,t,n){var r=qe(t.shortName,t.namespace),a=e._getEntityType(r,!0);if(a)return n&&function(e,t){t.custom&&(e.custom=t.custom);s(e,t.dataProperties),s(e,t.navigationProperties)}(a,t);var i={shortName:t.shortName,namespace:t.namespace,isAbstract:t.isAbstract,autoGeneratedKeyType:ke.fromName(t.autoGeneratedKeyType),defaultResourceName:t.defaultResourceName,custom:t.custom};if(a=t.isComplexType?new Fe(i):new xe(i),t.baseTypeName){a.baseTypeName=t.baseTypeName;var o=e._getEntityType(t.baseTypeName,!0);o?u(e,t,a):x(e._deferredTypes,t.baseTypeName).push({json:t,stype:a})}else u(e,t,a)}(o,e,t)}),k(this._resourceEntityTypeMap,n.resourceEntityTypeMap),k(this._incompleteTypeMap,n.incompleteTypeMap),this},e.importMetadata=function(e){var t=new Ae;return t.importMetadata(e),t},n.hasMetadataFor=function(e){return!!this.getDataService(e)},n.getDataService=function(t){return H(t,"serviceName").isString().check(),t=_e._normalizeServiceName(t),O(this.dataServices,function(e){return e.serviceName===t})},n.fetchMetadata=function(t,n,r){try{if(H(t,"dataService").isString().or().isInstanceOf(_e).check(),H(n,"callback").isFunction().isOptional().check(),H(r,"errorCallback").isFunction().isOptional().check(),"string"==typeof t&&(t=this.getDataService(t)||new _e({serviceName:t})),t=_e.resolve([t]),this.hasMetadataFor(t.serviceName))throw new Error("Metadata for a specific serviceName may only be fetched once per MetadataStore. ServiceName: "+t.serviceName);var a=this;return t.adapterInstance.fetchMetadata(this,t).then(function(e){return a.metadataFetched.publish({metadataStore:a,dataService:t,rawMetadata:e}),n&&n(e),Oe.resolve(e)},function(e){return r&&r(e),Oe.reject(e)})}catch(e){return Oe.reject(e)}},n.trackUnmappedType=function(e,t){H(e,"entityCtor").isFunction().check(),H(t,"interceptor").isFunction().isOptional().check();var n=new xe(this);n._setCtor(e,t)},n.registerEntityTypeCtor=function(e,t,n,r){H(e,"structuralTypeName").isString().check(),H(t,"aCtor").isFunction().isOptional().check(),H(n,"initFn").isOptional().isFunction().or().isString().check(),H(r,"noTrackingFn").isOptional().isFunction().check();var a=p(this,e,!1),i=a||e;if(t&&(t._$typeName&&t._$typeName!=i&&console.warn("Registering a constructor for "+i+" that is already used for "+t._$typeName+"."),t._$typeName=i),this._ctorRegistry[i]={ctor:t,initFn:n,noTrackingFn:r},a){var o=this._structuralTypeMap[a];o&&o.getCtor(!0)}},n.isEmpty=function(){return q(this._structuralTypeMap)},n.getEntityType=function(e,t){return H(e,"structuralTypeName").isString().check(),H(t,"okIfNotFound").isBoolean().isOptional().check(!1),this._getEntityType(e,t)},n._getEntityType=function(e,t){var n=p(this,e,!1),r=this._structuralTypeMap[n];if(!r){if(t)return null;var a=G("Unable to locate a 'Type' by the name: '%1'. Be sure to execute a query or call fetchMetadata first.",e);throw new Error(a)}if(r.length){var i=r.join(",");throw new Error("There are multiple types with this 'shortName': "+i)}return r},n.getEntityTypes=function(){return function(e){var t=[];for(var n in e){var r=e[n];n===r.name&&t.push(e[n])}return t}(this._structuralTypeMap)},n.getIncompleteNavigationProperties=function(){return g(this._incompleteTypeMap,function(e,t){return t})},n.getEntityTypeNameForResourceName=function(e){return H(e,"resourceName").isString().check(),this._resourceEntityTypeMap[e]},n.setEntityTypeForResourceName=function(e,t){var n;H(e,"resourceName").isString().check(),H(t,"entityTypeOrName").isInstanceOf(xe).or().isString().check(),n=t instanceof xe?t.name:p(this,t,!0),this._resourceEntityTypeMap[e]=n;var r=this._getEntityType(n,!0);r&&!r.defaultResourceName&&(r.defaultResourceName=e)},n._checkEntityType=function(e){if(!e.entityType){var t=e.prototype._$typeName;if(!t)throw new Error("This entity has not been registered. See the MetadataStore.registerEntityTypeCtor method");var n=this._getEntityType(t);n&&(e.entityType=n)}},e}(),Ce=function(){function c(t,e,n,r,a){var i=e.key?_(e.key.propertyRef).map(d("name")):[];_(e.property).forEach(function(e){p(t,e,n,i)}),_(e.navigationProperty).forEach(function(e){!function(e,t,n,r){var a=function(e,t,n){var r=E(e.relationship,t),a=r.namespace,i=O(n,function(e){return e.namespace===a});if(!i)return null;var o=r.shortTypeName,s=i.association;if(!s)return null;Array.isArray(s)||(s=[s]);return O(s,function(e){return e.name===o})}(t,n,r);if(!a)throw new Error("Unable to resolve Foreign Key Association: "+t.relationship);var i=O(a.end,function(e){return e.role===t.toRole}),o="*"!==i.multiplicity,s=E(i.type,n).typeName,u=a.referentialConstraint;if(!u&&"*"==a.end[0].multiplicity&&"*"==a.end[1].multiplicity)return;var p={nameOnServer:t.name,entityTypeName:s,isScalar:o,associationName:a.name};if(u){var c=u.principal,l=u.dependent,y=_(l.propertyRef),f=y.map(d("name"));t.fromRole===c.role?p.invForeignKeyNamesOnServer=f:p.foreignKeyNamesOnServer=f}var h=new De(p);e._addPropertyCore(h)}(t,e,n,r)}),a.addEntityType(t),t.defaultResourceName=a._entityTypeResourceMap[t.name];var o=a._deferredTypes,s=o[t.name];s&&(s.forEach(function(e){c(e.entityType,e.csdlEntityType,n,r,a)}),delete o[t.name])}function p(e,t,n,r){var a,i,o,s,u,p,c,l,y,f,h,d,m,v,g=t.type.split(".");return"Edm"===g[0]&&2===g.length?a=w(e,t,r):(u=t,((p=n).enumType?(h=u,d=_(p.enumType),m=h.type.split("."),v=m[m.length-1],d.some(function(e){return e.name===v})):p.extensions&&(c=u,l=p.extensions.filter(function(e){return"EnumType"===e.name}),y=c.type.split("."),f=y[y.length-1],l.some(function(e){return e.attributes.some(function(e){return"Name"===e.name&&e.value===f})})))?(a=w(e,t,r))&&(a.enumType=t.type):(o=n,s=E((i=t).type,o).typeName,a=new Me({nameOnServer:i.name,complexTypeName:s,isNullable:!1}))),a&&(e._addPropertyCore(a),function(e){var t;e.isNullable||e.validators.push(oe.required());if(e.isComplexProperty)return;if(e.dataType===Ne.String)if(e.maxLength){var n={maxLength:e.maxLength};t=oe.maxLength(n)}else t=oe.string();else t=e.dataType.validatorCtor();e.validators.push(t)}(a)),a}function w(e,t,n){var r=Ne.fromEdmDataType(t.type);if(null==r)return e.warnings.push("Unable to recognize DataType for property: "+t.name+" DateType: "+t.type),null;var a="true"===t.nullable||null==t.nullable,i=null!=n&&0<=n.indexOf(t.name);i&&e.autoGeneratedKeyType===ke.None&&function(e){var t=O(Object.keys(e),function(e){return 0<=e.indexOf("StoreGeneratedPattern")});{if(t)return"Identity"===e[t];var n=e.extensions;if(!n)return!1;var r=O(n,function(e){return"StoreGeneratedPattern"===e.name&&"Identity"===e.value});return!!r}}(t)&&(e.autoGeneratedKeyType=ke.Identity);var o=t.maxLength;o=null==o||"Max"===o?null:parseInt(o,10);var s=new Me({nameOnServer:t.name,dataType:r,isNullable:a,isPartOfKey:i,maxLength:o,defaultValue:t.defaultValue,concurrencyMode:t.concurrencyMode});return r===Ne.Undefined&&(s.rawTypeName=t.type),s}function E(e,t){var n=Be(e);if(t&&t.cSpaceOSpaceMapping){var r=l(n.shortTypeName,t);r&&(n=ze(n.shortTypeName,r))}return n}function l(e,t){var n,r=t.cSpaceOSpaceMapping;if(r){var a=r[t.namespace+"."+e];if(n=a&&a.substr(0,a.length-(e.length+1)))return n}return t.entityType||"Default"!=t.namespace?t.namespace:null}return{parse:function(u,n,e){u._entityTypeResourceMap={},(n=_(n)).forEach(function(s){if(s.cSpaceOSpaceMapping){var e=JSON.parse(s.cSpaceOSpaceMapping),t={};e.forEach(function(e){t[e[0]]=e[1]}),s.cSpaceOSpaceMapping=t}s.entityContainer&&_(s.entityContainer).forEach(function(e){_(e.entitySet).forEach(function(e){var t=E(e.entityType,s).typeName;u.setEntityTypeForResourceName(e.name,t),u._entityTypeResourceMap[t]=e.name})}),s.complexType&&_(s.complexType).forEach(function(e){var t,n,r,a,i,o;n=s,r=u,a=(t=e).name,i=l(a,n),o=new Fe({shortName:a,namespace:i}),_(t.property).forEach(function(e){p(o,e,n)}),r.addEntityType(o)}),s.entityType&&_(s.entityType).forEach(function(e){!function(e,t,n,r){var a=e.name,i=l(a,t),o=new xe({shortName:a,namespace:i,isAbstract:e.abstract&&"true"===e.abstract});if(e.baseType){var s=E(e.baseType,t).typeName;o.baseTypeName=s;var u=r._getEntityType(s,!0);if(u)c(o,e,t,n,r);else{var p=r._deferredTypes[s];p||(p=[],r._deferredTypes[s]=p),p.push({entityType:o,csdlEntityType:e})}}else c(o,e,t,n,r)}(e,s,n,u)})});var t=u.getIncompleteNavigationProperties();if(0<t.length){var r=t.map(function(e){return Array.isArray(e)?e.map(function(e){return e.parentType.name+":"+e.name}).join(", "):e.parentType.name+":"+e.name}).join(", ");throw new Error("Incomplete navigation properties: "+r)}e&&u.importMetadata(e,!0);return u}}}(),xe=function(){var t=0,e=function(e){if(1<arguments.length)throw new Error("The EntityType ctor has a single argument that is either a 'MetadataStore' or a configuration object.");"MetadataStore"===e._$typeName?(this.metadataStore=e,this.shortName="Anon_"+ ++t,this.namespace="",this.isAnonymous=!0):W(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("baseTypeName").isString().isOptional().whereParam("isAbstract").isBoolean().isOptional().withDefault(!1).whereParam("autoGeneratedKeyType").isEnumOf(ke).isOptional().withDefault(ke.None).whereParam("defaultResourceName").isNonEmptyString().isOptional().withDefault(null).whereParam("dataProperties").isOptional().whereParam("navigationProperties").isOptional().whereParam("serializerFn").isOptional().isFunction().whereParam("custom").isOptional().applyAll(this),this.name=qe(this.shortName,this.namespace),this.dataProperties=[],this.navigationProperties=[],this.complexProperties=[],this.keyProperties=[],this.foreignKeyProperties=[],this.inverseForeignKeyProperties=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.validators=[],this.warnings=[],this._mappedPropertiesCount=0,this.subtypes=[],Ue(this,e.dataProperties,Me),Ue(this,e.navigationProperties,De)},n=e.prototype,u=Ne.parseRawValue;function r(e,t){return e.entityAspect||e.complexAspect?e.getProperty(t.name):e[t.name]}function p(a,i){var e=a.complexAspect.parentProperty.dataType.dataProperties,t=e.every(function(e){if(!e.isSettable)return!0;var t=a.getProperty(e.name),n=i.getProperty(e.name);if(e.isComplexProperty&&e.isScalar)return p(t,n);if(e.isComplexProperty&&!e.isScalar)return m(t,n,p);var r=e.dataType;return t===n||r&&r.normalize&&t&&n&&r.normalize(t)===r.normalize(n)});return t}function a(e){return e.filter(function(e){return null==e.baseProperty})}function i(r,a,e){var t=e+"OnServer",n=a[e];if(n&&n.length){var i=_(n).map(function(e){var t=r.clientPropertyNameToServer(e,a),n=r.serverPropertyNameToClient(t,a);if(e!==n)throw new Error("NamingConvention for this client property name does not roundtrip properly:"+e+"--\x3e"+n);return t});a[t]=Array.isArray(n)?i:i[0]}else{var o=a[t];if(!o||0===o.length)return;var s=_(o).map(function(e){var t=r.serverPropertyNameToClient(e,a),n=r.clientPropertyNameToServer(t,a);if(e!==n)throw new Error("NamingConvention for this server property name does not roundtrip properly:"+e+"--\x3e"+n);return t});a[e]=Array.isArray(o)?s:s[0]}}function o(e,t){var n=t._getEntityType(e.complexTypeName,!0);if(!n)return!1;if(!(n instanceof Fe))throw new Error("Unable to resolve ComplexType with the name: "+e.complexTypeName+" for the property: "+property.name);return e.dataType=n,e.defaultValue=null,!0}function s(e,t){if(e.entityType)return!0;var n=t._getEntityType(e.entityTypeName,!0);if(n)e.entityType=n,e._resolveNp();else{var r=x(t._incompleteTypeMap,e.entityTypeName);h(r,e)}return!!n}return n._$typeName="EntityType",e.qualifyTypeName=qe,n.setProperties=function(e){W(e).whereParam("autoGeneratedKeyType").isEnumOf(ke).isOptional().whereParam("defaultResourceName").isString().isOptional().whereParam("serializerFn").isFunction().isOptional().whereParam("custom").isOptional().applyAll(this),e.defaultResourceName&&(this.defaultResourceName=e.defaultResourceName)},n.isSubtypeOf=function(e){H(e,"entityType").isInstanceOf(xe).check();var t=this;do{if(t===e)return!0;t=t.baseEntityType}while(t);return!1},n.getSelfAndSubtypes=function(){var n=[this];return this.subtypes.forEach(function(e){var t=e.getSelfAndSubtypes();n.push.apply(n,t)}),n},n.getAllValidators=function(){for(var e=this.validators.slice(0),t=this.baseEntityType;t;)e.push.apply(e,t.validators),t=t.baseEntityType;return e},n.addProperty=function(t){H(t,"property").isInstanceOf(Me).or().isInstanceOf(De).check();var e=this._addPropertyCore(t,!0);if(this.subtypes&&this.subtypes.length){var n=this;n.getSelfAndSubtypes().forEach(function(e){e!==n&&(t.isNavigationProperty?e._addPropertyCore(new De(t),!0):e._addPropertyCore(new Me(t),!0))})}return e},n._updateFromBase=function(e){this.baseEntityType=e,this.autoGeneratedKeyType===ke.None&&(this.autoGeneratedKeyType=e.autoGeneratedKeyType),e.dataProperties.forEach(function(e){var t=new Me(e);t.validators=[],t.baseProperty=e,this._addPropertyCore(t)},this),e.navigationProperties.forEach(function(e){var t=new De(e);t.validators=[],t.baseProperty=e,this._addPropertyCore(t)},this),e.subtypes.push(this)},n._addPropertyCore=function(e,t){if(this.isFrozen)throw new Error("The '"+this.name+"' EntityType/ComplexType has been frozen. You can only add properties to an EntityType/ComplexType before any instances of that type have been created and attached to an entityManager.");var n=e.parentType;if(n){if(n!==this)throw new Error("This property: "+e.name+" has already been added to "+e.parentType.name);return this}var r=(e.parentType=this).metadataStore;if(e.isDataProperty?this._addDataProperty(e):(this._addNavigationProperty(e),t&&r&&s(e,r)),!r||e.name&&e.nameOnServer||i(r.namingConvention,e,"name"),r&&this._extra&&this._extra.alreadyWrappedProps){var a=this._ctor.prototype;ae.getDefaultInstance().initializeEntityPrototype(a)}return this},n.createEntity=function(i){if(i&&i._$eref&&!i._$eref.entityAspect.entityManager)return i._$eref;var o=this._createInstanceCore();return i&&(this.keyProperties.every(function(e){return null!=i[e.name]})&&(i._$eref=o),this._updateTargetFromRaw(o,i,r),this.navigationProperties.forEach(function(e){var t,n=i[e.name];if(null!=n){var r=e.entityType;if(e.isScalar)t=n.entityAspect?n:r.createEntity(n),o.setProperty(e.name,t);else{var a=o.getProperty(e.name);n.forEach(function(e){t=e.entityAspect?e:r.createEntity(e),a.push(t)})}}})),this._initializeInstance(o),o},n._createInstanceCore=function(){var e=this.getEntityCtor(),t=new e;return new ye(t),t},n._initializeInstance=function(n){this.baseEntityType&&this.baseEntityType._initializeInstance(n);var e=this.initFn;e&&("string"==typeof e&&(e=n[e]),e(n)),this.complexProperties&&this.complexProperties.forEach(function(t){var e=n.getProperty(t.name);Array.isArray(e)?e.forEach(function(e){t.dataType._initializeInstance(e)}):t.dataType._initializeInstance(e)}),n.entityAspect&&(n.entityAspect._initialized=!0)},n.getCtor=n.getEntityCtor=function(e){if(this._ctor&&!e)return this._ctor;var t,n=this.metadataStore._ctorRegistry,r=n[this.name]||n[this.shortName]||{},a=r.ctor||this._ctor,i=a&&a.prototype&&(a.prototype.entityType||a.prototype.complexType);if(i&&i.metadataStore!==this.metadataStore)throw new Error("Cannot register the same constructor for "+this.name+" in different metadata stores.  Please define a separate constructor for each metadata store.");if(r.ctor&&e&&(this._extra=void 0),!a){var o=ae.getDefaultInstance().createCtor;a=o?o(this):(t=this.name.replace(/\W/g,"_"),Function("return function "+t+"(){}")())}return this.initFn=r.initFn,this.noTrackingFn=r.noTrackingFn,a.prototype._$typeName=this.name,this._setCtor(a),a},n._setCtor=function(e,t){var n=e.prototype;this._extra=this._extra||{};var i,o,s,r=new e;o=r,s=(i=this).getPropertyNames(),ae.getDefaultInstance().getTrackablePropertyNames(o).forEach(function(e){if(-1===s.indexOf(e)){var t=o[e];try{"function"==typeof t&&(t=t())}catch(e){}var n=Ne.fromValue(t),r=new Me({name:e,dataType:n,isNullable:!0,isUnmapped:!0});r.isSettable=null==(a=c(o,e))||!(!a.writable&&!a.set),i.subtypes&&i.subtypes.length?i.getSelfAndSubtypes().forEach(function(e){e._addPropertyCore(new Me(r))}):i._addPropertyCore(r)}var a}),"EntityType"===this._$typeName?n.entityType=this:n.complexType=this,n._$interceptor=t||Ee,ae.getDefaultInstance().initializeEntityPrototype(n),this._ctor=e},n.addValidator=function(e,t){H(e,"validator").isInstanceOf(oe).check(),H(t,"property").isOptional().isString().or().isEntityProperty().check(),t?("string"==typeof t&&(t=this.getProperty(t,!0)),t.validators.push(e)):this.validators.push(e)},n.getProperties=function(){return this.dataProperties.concat(this.navigationProperties)},n.getPropertyNames=function(){return this.getProperties().map(d("name"))},n.getDataProperty=function(e){return O(this.dataProperties,l("name",e))},n.getNavigationProperty=function(e){return O(this.navigationProperties,l("name",e))},n.getProperty=function(e,t){var n=this.getPropertiesOnPath(e,!1,t);return n?n[n.length-1]:null},n.getPropertiesOnPath=function(e,t,n){n=n||!1;var r=Array.isArray(e)?e:e.trim().split("."),a=!0,i=this,o=t?"nameOnServer":"name",s=r.map(function(e){var t=O(i.getProperties(),l(o,e));if(t)i=t.isNavigationProperty?t.entityType:t.dataType;else{if(n)throw new Error("unable to locate property: "+e+" on entityType: "+i.name);a=!1}return t});return a?s:null},n.clientPropertyPathToServer=function(e,t){var n,t=t||".";if(this.isAnonymous){var r=this.metadataStore.namingConvention.clientPropertyNameToServer;n=e.split(".").map(function(e){return r(e)})}else n=this.getPropertiesOnPath(e,!1,!0).map(function(e){return e.nameOnServer});return n.join(t)},n.getEntityKeyFromRawEntity=function(n,r){var e=this.keyProperties.map(function(e){var t=r(n,e);return u(t,e.dataType)});return new me(this,e)},n._updateTargetFromRaw=function(i,o,s){this.dataProperties.forEach(function(n){if(n.isSettable){var e=s(o,n);if(void 0!==e){var t,r=n.dataType;if(n.isComplexProperty){if(null===e)return;if(t=i.getProperty(n.name),n.isScalar)r._updateTargetFromRaw(t,e,s);else if(Array.isArray(e)){var a=e.map(function(e){var t=r._createInstanceCore(i,n);return r._updateTargetFromRaw(t,e,s),r._initializeInstance(t),t});m(t,a,p)||(t.length=0,a.forEach(function(e){t.push(e)}))}else t.length=0}else{if(n.isScalar){var a=u(e,r);i.setProperty(n.name,a)}else if(t=i.getProperty(n.name),Array.isArray(e)){var a=e.map(function(e){return u(e,r)});m(t,a)||(t.length=0,a.forEach(function(e){t.push(e)}))}else t.length=0}}}});var e=o.entityAspect||o.complexAspect;if(e){var t=i.entityAspect||i.complexAspect;e.originalValuesMap&&(t.originalValues=e.originalValuesMap),e.extraMetadata&&(t.extraMetadata=e.extraMetadata)}},n.toString=function(){return this.name},n.toJSON=function(){return y(this,{shortName:null,namespace:null,baseTypeName:null,isAbstract:!1,autoGeneratedKeyType:null,defaultResourceName:null,dataProperties:a,navigationProperties:a,validators:null,custom:null})},n._updateNames=function(e){var t=this.metadataStore.namingConvention;i(t,e,"name"),e.isNavigationProperty&&(i(t,e,"foreignKeyNames"),i(t,e,"invForeignKeyNames"))},n._checkNavProperty=function(e){if(e.isNavigationProperty){if(e.parentType!==this)throw new Error(G("The navigationProperty '%1' is not a property of entity type '%2'",e.name,this.name));return e}if("string"==typeof e){var t=this.getProperty(e);if(t&&t.isNavigationProperty)return t}throw new Error("The 'navigationProperty' parameter must either be a NavigationProperty or the name of a NavigationProperty")},n._addDataProperty=function(e){this.dataProperties.push(e),e.isPartOfKey&&this.keyProperties.push(e),e.isComplexProperty&&this.complexProperties.push(e),e.concurrencyMode&&"None"!==e.concurrencyMode&&this.concurrencyProperties.push(e),e.isUnmapped&&this.unmappedProperties.push(e)},n._addNavigationProperty=function(e){this.navigationProperties.push(e),Le(e.entityTypeName)||(e.entityTypeName=qe(e.entityTypeName,this.namespace))},n._updateCps=function(){var t=this.metadataStore,n=t._incompleteComplexTypeMap;this.complexProperties.forEach(function(e){e.complexType||o(e,t)||x(n,e.complexTypeName).push(e)}),this.isComplexType&&((n[this.name]||[]).forEach(function(e){o(e,t)}),delete n[this.name])},n._updateNps=function(){var t=this.metadataStore;this.navigationProperties.forEach(function(e){s(e,t)});var e=t._incompleteTypeMap;(e[this.name]||[]).forEach(function(e){s(e,t)}),delete e[this.name]},e}(),Fe=(Ke=function(e){if(1<arguments.length)throw new Error("The ComplexType ctor has a single argument that is a configuration object.");W(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("dataProperties").isOptional().whereParam("isComplexType").isOptional().isBoolean().whereParam("custom").isOptional().applyAll(this),this.name=qe(this.shortName,this.namespace),this.isComplexType=!0,this.dataProperties=[],this.complexProperties=[],this.validators=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.navigationProperties=[],this.keyProperties=[],Ue(this,e.dataProperties,Me)},je=Ke.prototype,je.setProperties=function(e){W(e).whereParam("custom").isOptional().applyAll(this)},je.getAllValidators=function(){return this.validators},je._createInstanceCore=function(e,t){var n=this.getCtor(),r=new n;return new fe(r,e,t),r},je.addProperty=function(e){return H(e,"dataProperty").isInstanceOf(Me).check(),this._addPropertyCore(e)},je.getProperties=function(){return this.dataProperties},(je=k(je,xe.prototype,["addValidator","getProperty","getPropertiesOnPath","getPropertyNames","_addPropertyCore","_addDataProperty","_updateNames","_updateCps","_initializeInstance","_updateTargetFromRaw","_setCtor"])).createInstance=xe.prototype.createEntity,je.getCtor=xe.prototype.getEntityCtor,je.toJSON=function(){return y(this,{shortName:null,namespace:null,isComplexType:null,dataProperties:null,validators:null,custom:null})},je._$typeName="ComplexType",Ke),Me=(Ve=function(e){W(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("dataType").isEnumOf(Ne).isOptional().or().isString().or().isInstanceOf(Fe).whereParam("complexTypeName").isOptional().whereParam("isNullable").isBoolean().isOptional().withDefault(!0).whereParam("isScalar").isOptional().withDefault(!0).whereParam("defaultValue").isOptional().whereParam("isPartOfKey").isBoolean().isOptional().whereParam("isUnmapped").isBoolean().isOptional().whereParam("isSettable").isBoolean().isOptional().withDefault(!0).whereParam("concurrencyMode").isString().isOptional().whereParam("maxLength").isNumber().isOptional().whereParam("validators").isInstanceOf(oe).isArray().isOptional().withDefault([]).whereParam("displayName").isOptional().whereParam("enumType").isOptional().whereParam("rawTypeName").isOptional().whereParam("custom").isOptional().applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw new Error("A DataProperty must be instantiated with either a 'name' or a 'nameOnServer' property");if(this.complexTypeName)this.isComplexProperty=!0,this.dataType=null;else if("string"==typeof this.dataType){var n=Ne.fromName(this.dataType);if(!n)throw new Error("Unable to find a DataType enumeration by the name of: "+this.dataType);this.dataType=n}else this.dataType||(this.dataType=Ne.String);if(null==this.defaultValue){if(this.isNullable)this.defaultValue=null;else if(this.isComplexProperty);else if(this.dataType===Ne.Binary)this.defaultValue="AAAAAAAAJ3U=";else if(this.defaultValue=this.dataType.defaultValue,null==this.defaultValue)throw new Error("A nonnullable DataProperty cannot have a null defaultValue. Name: "+(this.name||this.nameOnServer))}else this.dataType.isNumeric&&"string"==typeof this.defaultValue&&(this.defaultValue=parseFloat(this.defaultValue));this.isComplexProperty&&(this.isScalar=null==this.isScalar||!0===this.isScalar)},Re=Ve.prototype,Re._$typeName="DataProperty",Ve.getRawValueFromServer=function(e,t){if(t.isUnmapped)return e[t.nameOnServer||t.name];var n=e[t.nameOnServer];return void 0!==n?n:t.defaultValue},Ve.getRawValueFromClient=function(e,t){var n=e[t.name];return void 0!==n?n:t.defaultValue},Re.isDataProperty=!0,Re.isNavigationProperty=!1,Re.resolveProperty=function(e){for(var t=this[e],n=this.baseProperty;null==t&&null!=n;)t=n[e],n=n.baseProperty;return t},Re.formatName=function(){return this.parentType.name+"--"+this.name},Re.setProperties=function(e){W(e).whereParam("displayName").isOptional().whereParam("custom").isOptional().applyAll(this)},Re.getAllValidators=function(){for(var e=this.validators.slice(0),t=this.baseProperty;t;)e.push.apply(e,t.validators),t=t.baseProperty;return e},Re.toJSON=function(){return y(this,{name:null,dataType:function(e){return e&&e.parentEnum?e.name:void 0},complexTypeName:null,isNullable:!0,defaultValue:null,isPartOfKey:!1,isUnmapped:!1,isSettable:!0,concurrencyMode:null,maxLength:null,validators:null,displayName:null,enumType:null,rawTypeName:null,isScalar:!0,custom:null})},Ve.fromJSON=function(e){return e.dataType=Ne.fromName(e.dataType),e.defaultValue&&e.dataType&&e.dataType.parse&&(e.defaultValue=e.dataType.parse(e.defaultValue,typeof e.defaultValue)),e.validators&&(e.validators=e.validators.map(oe.fromJSON)),new Me(e)},Ve),De=function(){var e=function(e){W(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("entityTypeName").isString().whereParam("isScalar").isBoolean().isOptional().withDefault(!0).whereParam("associationName").isString().isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("foreignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("validators").isInstanceOf(oe).isArray().isOptional().withDefault([]).whereParam("displayName").isOptional().whereParam("custom").isOptional().applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw new Error("A Navigation property must be instantiated with either a 'name' or a 'nameOnServer' property")},t=e.prototype;function n(e,t){throw new Error("Cannot set the inverse property for: "+e.formatName()+". "+t)}function r(e,t){throw new Error("Cannot create inverse for: "+e.formatName()+". The entityType for this navigation property "+t)}return t._$typeName="NavigationProperty",t.isDataProperty=!1,t.isNavigationProperty=!0,k(t,Me.prototype,["formatName","getAllValidators","resolveProperty"]),t.setProperties=function(e){if(!this.parentType)throw new Error("Cannot call NavigationProperty.setProperties until the parent EntityType of the NavigationProperty has been set.");var t=e.inverse;t&&delete e.inverse,W(e).whereParam("displayName").isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("custom").isOptional().applyAll(this),this.parentType._updateNames(this),this._resolveNp(),t&&this.setInverse(t)},t.getInverse=function(){for(var e=this;!e.inverse&&e.baseProperty;)e=e.baseProperty;return e.inverse},t.setInverse=function(e){var t;if(!(t="string"==typeof e?this.entityType.getNavigationProperty(e):e))throw n(this,"Unable to find inverse property: "+invNpName);(this.inverse||t.inverse)&&n(this,"It has already been set on one side or the other."),t.entityType!=this.parentType&&n(this,t.formatName+" is not a valid inverse property for this."),this.associationName?t.associationName=this.associationName:(t.associationName||(t.associationName=this.formatName()+"_"+t.formatName()),this.associationName=t.associationName),this._resolveNp(),t._resolveNp()},t.createInverse=function(e){this.entityType||r(this,"has not yet been defined."),this.entityType.isFrozen&&r(this,"is frozen.");var t=this.entityType.metadataStore;null==t&&r(this,"has not yet been added to the metadataStore."),e.entityTypeName=this.parentEntityType.name,e.associationName=this.associationName;var n=new De(e);return this.parentEntityType.addNavigationProperty(n),n},t.toJSON=function(){return y(this,{name:null,entityTypeName:null,isScalar:null,associationName:null,validators:null,displayName:null,foreignKeyNames:null,invForeignKeyNames:null,custom:null})},e.fromJSON=function(e){return e.validators&&(e.validators=e.validators.map(oe.fromJSON)),new De(e)},t._resolveNp=function(){var r=this,a=r.entityType,e=O(a.navigationProperties,function(e){return e.associationName===r.associationName&&(e.name!==r.name||e.entityTypeName!==r.entityTypeName)});(r.inverse=e)||r.invForeignKeyNames.forEach(function(e){var t=a.getDataProperty(e);if(!t)throw new Error("EntityType '"+r.entityTypeName+"' has no foreign key matching '"+e+"'");var n=r.parentType;t.inverseNavigationProperty=O(n.navigationProperties,function(e){return e.invForeignKeyNames&&0<=e.invForeignKeyNames.indexOf(t.name)&&e.entityType===t.parentType}),h(a.foreignKeyProperties,t)}),function(t){var e=t.foreignKeyNames;if(0===e.length)return;var n=t.parentType,r=e.map(function(e){return n.getDataProperty(e)}),a=n.foreignKeyProperties;r.forEach(function(e){h(a,e),h((e.relatedNavigationProperty=t).entityType.inverseForeignKeyProperties,e),t.relatedDataProperties?h(t.relatedDataProperties,e):t.relatedDataProperties=[e]})}(r)},e}(),ke=(Ie=new te("AutoGeneratedKeyType"),Ie.None=Ie.addSymbol(),Ie.Identity=Ie.addSymbol(),Ie.KeyGenerator=Ie.addSymbol(),Ie.resolveSymbols(),Ie);var Ie;var Ve,Re;var Ke,je;function Be(e){if(!e)return null;var t=e.split(":#");if(1<t.length)return ze(t[0],t[1]);if(U(e,Ae.ANONTYPE_PREFIX)){var n=ze(e);return n.isAnonymous=!0,n}var r=e.split(",")[0],t=r.split(".");if(1<t.length){var a=t[t.length-1],i=t.slice(0,t.length-1),o=i.join(".");return ze(a,o)}return ze(e)}function ze(e,t){return{shortTypeName:e,namespace:t,typeName:qe(e,t)}}function Le(e){return 0<=e.indexOf(":#")}function qe(e,t){return t&&0<t.length?e+":#"+t:e}function Ue(e,t,n){if(t)if(Array.isArray(t))t.forEach(e._addPropertyCore.bind(e));else{if("object"!=typeof t)throw new Error("The 'dataProperties' or 'navigationProperties' values must be either an array of data/nav properties or an object where each property defines a data/nav property");for(var r in t)if(M(t,r)){var a=t[r];a.name=r;var i=new n(a);e._addPropertyCore(i)}}}(function(){var e=Z.prototype;function t(e,t){return null!=t&&void 0!==t.entityType}function n(e,t){return null!=t&&(t.isDataProperty||t.isNavigationProperty)}e.isEntity=function(){return this._addContext({fn:t,msg:" must be an entity"})},e.isEntityProperty=function(){return this._addContext({fn:n,msg:" must be either a DataProperty or a NavigationProperty"})}})(),v.MetadataStore=Ae,v.EntityType=xe,v.ComplexType=Fe,v.DataProperty=Me,v.NavigationProperty=De,v.AutoGeneratedKeyType=ke;var $e=function(){var e=function(){this._tempIdMap={}},t=e.prototype;function s(e,t,n){var r=t.name+".."+t.parentType.name,a=e._tempIdMap[r];return a||n&&(a={entityType:t.parentType,propertyName:t.name,keyMap:{}},e._tempIdMap[r]=a),a}return t.generateTempKeyValue=function(e,t){var n=e.keyProperties;if(1<n.length)throw new Error("Ids can not be autogenerated for entities with multipart keys");var r,a=n[0],i=s(this,a,!0);if(null!=t&&(i.keyMap[t.toString()]||(r=t)),void 0===r){var o=a.dataType;if(!o.getNext)throw new Error("Cannot use a property with a dataType of: "+o.toString()+" for id generation");for(r=o.getNext(this);null!=i.keyMap[r.toString()];)r=o.getNext(this)}return i.keyMap[r.toString()]=!0,r},t.getTempKeys=function(){var e=[];for(var t in this._tempIdMap){var n=this._tempIdMap[t],r=n.entityType;for(var a in n.keyMap)e.push(new me(r,[a]))}return e},t.isTempKey=function(e){var t=e.entityType.keyProperties;if(1<t.length)return!1;var n=t[0],r=s(this,n);return!!r&&void 0!==r.keyMap[e.values[0].toString()]},re.registerType(e,"KeyGenerator"),e}();v.KeyGenerator=$e;var Ge=(Je=function(e){W(e||{}).whereParam("name").isOptional().isString().whereParam("isCaseSensitive").isOptional().isBoolean().whereParam("usesSql92CompliantStringComparison").isBoolean().applyAll(this),this.name||(this.name=S()),re._storeObject(this,Qe._$typeName,this.name)},Qe=Je.prototype,Qe._$typeName="LocalQueryComparisonOptions",Je.caseInsensitiveSQL=new Je({name:"caseInsensitiveSQL",isCaseSensitive:!1,usesSql92CompliantStringComparison:!0}),Je.defaultInstance=new Je(Je.caseInsensitiveSQL),Qe.setAsDefault=function(){return i(this,Je)},Je);var Je,Qe;v.LocalQueryComparisonOptions=Ge;var Ze=(He=function(e){W(e||{}).whereParam("name").isOptional().isString().whereParam("serverPropertyNameToClient").isFunction().whereParam("clientPropertyNameToServer").isFunction().applyAll(this),this.name||(this.name=S()),re._storeObject(this,Ye._$typeName,this.name)},Ye=He.prototype,Ye._$typeName="NamingConvention",He.none=new He({name:"noChange",serverPropertyNameToClient:function(e){return e},clientPropertyNameToServer:function(e){return e}}),He.camelCase=new He({name:"camelCase",serverPropertyNameToClient:function(e){return e.substr(0,1).toLowerCase()+e.substr(1)},clientPropertyNameToServer:function(e){return e.substr(0,1).toUpperCase()+e.substr(1)}}),He.defaultInstance=new He(He.none),Ye.setAsDefault=function(){return i(this,He)},He);var He,Ye;v.NamingConvention=Ze;var We=function(){var e,t,n,r,a,i,o,s,u,p,c,l,y,f=function(){var e=function(){if(0!==arguments.length){if(1===arguments.length){var e=arguments[0];return Array.isArray(e)?1===e.length?f(e[0]):a(e):e instanceof f?e:"string"==typeof e?new h(e):o(e)}return a(Array.prototype.slice.call(arguments,0))}},t=e.prototype;function n(e,t){var n=t[0];return n instanceof f?n=D(t):Array.isArray(n)||(n=[f(D(t))]),[e].concat(n)}function i(t,e,n){var r=e.toLowerCase();n.key=r,(t[r]=n).aliases&&n.aliases.forEach(function(e){t[e.toLowerCase()]=n})}function a(e){var t={},n={};t[e[0]]=n;var r=e[1];return r=r.operator||r,3==e.length?n[r]=e[2]:n[r]=a(e.splice(2)),o(t)}function o(t){if(t instanceof f)return t;if("object"!=typeof t)throw new Error("Unable to convert to a Predicate: "+t);var e=Object.keys(t),n=e.map(function(e){return function(e,n){if(v.prototype._resolveOp(e,!0))return new v(e,n);if(d.prototype._resolveOp(e,!0))return new d(e,n);{if("object"!=typeof n||null==n||K(n))return new m("eq",e,n);if(M(n,"value"))return new m("eq",e,n)}if(Array.isArray(n))throw new Error("Unable to resolve predicate after the phrase: "+e);var r=e,t=Object.keys(n).map(function(e){if(g.prototype._resolveOp(e,!0))return new g(e,r,n[e]);if(m.prototype._resolveOp(e,!0))return new m(e,r,n[e]);if(M(n[e],"value"))return new m("eq",r,n[e]);var t=G("Unable to resolve predicate after the phrase: '%1' for operator: '%2'  and value: '%3'",r,e,n[e]);throw new Error(t)});return 1===t.length?t[0]:new v("and",t)}(e,t[e])});return 1===n.length?n[0]:new v("and",n)}return(e.create=e).and=function(){var e=new v("and",D(arguments));return e.op&&e},e.or=function(){var e=new v("or",D(arguments));return e.op&&e},e.not=function(e){return e.not()},e.extendBinaryPredicateFn=function(e,t){var a=x.binaryPredicate;for(var n in e||{}){var r=e[n];r.visitorFn=t,i(m.prototype.aliasMap,n,e[n])}x.isExtended||(x.binaryPredicate=function(e,t,n){var r=this.aliasMap[this.op.key].visitorFn;return r?r(e,t,n):a(e,t,n)},x.isExtended=!0)},t.and=function(){return new v("and",n(this,arguments))},t.or=function(){return new v("or",n(this,arguments))},t.not=function(){return new d("not",this)},t.toJSON=function(){return this.toJSONExt({entityType:this._entityType})},t.toJSONExt=function(e){return this.visit(e,F)},t.toFunction=function(e){return this.visit(e,x)},t.toString=function(){return JSON.stringify(this)},t.visit=function(e,t){if(q(e))e={entityType:null};else if(e instanceof xe)e={entityType:e};else if(!M(e,"entityType"))throw new Error("All visitor methods must be called with a context object containing at least an 'entityType' property");t?e.visitor=t:t=e.visitor;var n=t[this.visitorMethodName];if(null==n)throw new Error("Unable to locate method: "+this.visitorMethodName+" on visitor");var r=e.entityType;(this._validate&&null==r||this._entityType!==r)&&(this._validate(r,e.usesNameOnServer),this._entityType=r);Array.prototype.slice.call(arguments,1);return n.call(this,e)},t._initialize=function(e,t){this.visitorMethodName=e;var n=this.aliasMap={};for(var r in t||{})i(n,r,t[r])},t._resolveOp=function(e,t){e=e.operator||e;var n=this.aliasMap[e.toLowerCase()];if(!n&&!t)throw new Error("Unable to resolve operator: "+e);return n},e}(),h=((t=(e=function(e){this.value=e}).prototype=new f)._initialize("passthruPredicate"),t._validate=R,e),d=((r=(n=function(e,t){this.op=this._resolveOp(e),this.pred=f(t)}).prototype=new f)._initialize("unaryPredicate",{not:{aliases:["!","~"]}}),r._validate=function(e,t){this.pred._validate(e,t)},n),m=((i=(a=function(e,t,n){this.op=this._resolveOp(e),this.expr1Source=t,this.expr2Source=n}).prototype=new f)._initialize("binaryPredicate",{eq:{aliases:["==","equals"]},ne:{aliases:["!=","~=","notequals"]},lt:{aliases:["<","lessthan"]},le:{aliases:["<=","lessthanorequal"]},gt:{aliases:[">","greaterthan"]},ge:{aliases:[">=","greaterthanorequal"]},startswith:{isFunction:!0},endswith:{isFunction:!0},contains:{aliases:["substringof"],isFunction:!0},in:{}}),i._validate=function(e,t){var n={entityType:e,usesNameOnServer:t};if(this.expr1=O(this.expr1Source,n),null==this.expr1)throw new Error("Unable to validate 1st expression: "+this.expr1Source);if(this.expr1 instanceof E)throw new Error("The left hand side of a binary predicate cannot be a literal expression, it must be a valid property or functional predicate expression: "+this.expr1Source);if("in"==this.op.key&&!Array.isArray(this.expr2Source))throw new Error("The 'in' operator requires that its right hand argument be an array");var r=k(n,{isRHS:!0,dataType:this.expr1.dataType});if(this.expr2=O(this.expr2Source,r),null==this.expr2)throw new Error("Unable to validate 2nd expression: "+this.expr2Source);null==this.expr1.dataType&&(this.expr1.dataType=this.expr2.dataType)},a),v=((s=(o=function(e,t){if(this.op=this._resolveOp(e),1==t.length&&Array.isArray(t[0])&&(t=t[0]),this.preds=t.filter(function(e){return null!=e}).map(function(e){return f(e)}),0==this.preds.length&&(this.op=null),1==this.preds.length)return this.preds[0]}).prototype=new f)._initialize("andOrPredicate",{and:{aliases:["&&"]},or:{aliases:["||"]}}),s._validate=function(t,n){this.preds.every(function(e){e._validate(t,n)})},o),g=((p=(u=function(e,t,n){this.op=this._resolveOp(e),this.exprSource=t,this.pred=f(n)}).prototype=new f)._initialize("anyAllPredicate",{any:{aliases:["some"]},all:{aliases:["every"]}}),p._validate=function(e,t){this.expr=O(this.exprSource,{entityType:e,usesNameOnServer:t}),(null==e||e.isAnonymous)&&(this.expr.dataType=null),this.pred._validate(this.expr.dataType,t)},u),w=function(e){this.visitorMethodName=e,this.visit=f.prototype.visit,this._validate=R},E=(((c=function(e,t,n){(t=(t=function(e){if(null==e)return e;if(Ne.contains(e))return e;if(B(e)){var t=Ne.fromName(e);if(t)return t;throw new Error("Unable to resolve a dataType named: "+e)}throw new Error("The dataType parameter passed into this literal expression is not a 'DataType'"+e)}(t))||Ne.fromValue(e))&&t.parse?Array.isArray(e)?this.value=e.map(function(e){return t.parse(e,typeof e)}):this.value=t.parse(e,typeof e):this.value=e,this.dataType=t,this.hasExplicitDataType=n}).prototype=new w("litExpr")).toString=function(){return" LitExpr - value: "+this.value.toString()+" dataType: "+this.dataType.toString()},c),S=((y=(l=function(e){this.propertyPath=e}).prototype=new w("propExpr")).toString=function(){return" PropExpr - "+this.propertyPath},y._validate=function(e,t){if(null!=e&&!e.isAnonymous){var n=e.getPropertiesOnPath(this.propertyPath,t,!1);if(!n){var r=G("Unable to resolve propertyPath.  EntityType: '%1'   PropertyPath: '%2'",e.name,this.propertyPath);throw new Error(r)}var a=n[n.length-1];a.isDataProperty?this.dataType=a.dataType:this.dataType=a.entityType}},l),P=function(){var e=function(e,t){this.fnName=e,this.exprs=t;var n=r[e];if(null==n)throw new Error("Unknown function: "+e);this.localFn=n.fn,this.dataType=n.dataType},t=e.prototype=new w("fnExpr");t.toString=function(){var e=this.exprs.map(function(e){e.toString()}).toString();return"FnExpr - "+this.fnName+"("+e+")"},t._validate=function(t,n){this.exprs.forEach(function(e){e._validate(t,n)})};var r=e.funcMap={toupper:{fn:function(e){return e.toUpperCase()},dataType:Ne.String},tolower:{fn:function(e){return e.toLowerCase()},dataType:Ne.String},substring:{fn:function(e,t,n){return e.substring(t,n)},dataType:Ne.String},substringof:{fn:function(e,t){return 0<=t.indexOf(e)},dataType:Ne.Boolean},length:{fn:function(e){return e.length},dataType:Ne.Int32},trim:{fn:function(e){return e.trim()},dataType:Ne.String},concat:{fn:function(e,t){return e.concat(t)},dataType:Ne.String},replace:{fn:function(e,t,n){return e.replace(t,n)},dataType:Ne.String},startswith:{fn:function(e,t){return U(e,t)},dataType:Ne.Boolean},endswith:{fn:function(e,t){return $(e,t)},dataType:Ne.Boolean},indexof:{fn:function(e,t){return e.indexOf(t)},dataType:Ne.Int32},round:{fn:function(e){return Math.round(e)},dataType:Ne.Int32},ceiling:{fn:function(e){return Math.ceil(e)},dataType:Ne.Int32},floor:{fn:function(e){return Math.floor(e)},dataType:Ne.Int32},second:{fn:function(e){return e.getSeconds()},dataType:Ne.Int32},minute:{fn:function(e){return e.getMinutes()},dataType:Ne.Int32},day:{fn:function(e){return e.getDate()},dataType:Ne.Int32},month:{fn:function(e){return e.getMonth()+1},dataType:Ne.Int32},year:{fn:function(e){return e.getFullYear()},dataType:Ne.Int32}};return e}(),T=/^[a-z_][\w.$]*$/i,N=/('[^']*'|[^,]+)/g,_=/("[^"]*"|[^,]+)/g,b=String.fromCharCode(191);function O(e,t){var n=t.entityType;if(Array.isArray(e)){if(!t.isRHS)throw new Error("Array expressions are only permitted on the right hand side of a BinaryPredicate");return new E(e,t.dataType)}if(!B(e)){if(null==e||"object"!=typeof e||e.toISOString)return new E(e,t.dataType);if(void 0===e.value)throw new Error("Unable to resolve an expression for: "+e+" on entityType: "+n.name);return e.isProperty?new S(e.value):new E(e.value,e.dataType||t.dataType,!0)}if(t.isRHS)return null==n||n.isAnonymous?new E(e,t.dataType):C(e,t);for(var r,a=/\([^()]*\)/,i=[],o=0;r=a.exec(e);){var s=r[0];i.push(s);var u=b+o++;e=e.replace(s,u)}var p=A(e,i,t);return p._validate(n,t.usesNameOnServer),p}function A(e,t,n){var r=e.split(b);return 1===r.length?C(r[0],n):function(e,t,n,r){try{var a=t[0].trim().toLowerCase(),i=n[t[1]].trim();"("===i.substr(0,1)&&(i=i.substr(1,i.length-2));var o=0<=e.indexOf("'")?N:_,s=i.match(o),u=k({},r);u.dataType=Ne.Undefined,u.isFnArg=!0;var p=s.map(function(e){return A(e,n,u)});return new P(a,p)}catch(e){return null}}(e,r,t,n)}function C(e,t){var n=(e=e.trim()).substr(0,1),r=("'"===n||'"'===n)&&1<e.length&&e.substr(e.length-1)===n;if(r){var a=e.substr(1,e.length-2);return new E(a,t.dataType||Ne.String)}var i=t.entityType;if(null==i||i.isAnonymous)return new S(e);var o=T.test(e);return o&&null!=i.getPropertiesOnPath(e,t.usesNameOnServer,!1)?new S(e):new E(e,t.dataType)}var x=function(){var e={passthruPredicate:function(){throw new Error("Cannot execute an PassthruPredicate expression against the local cache: "+this.value)},unaryPredicate:function(e){var t=this.pred.visit(e);switch(this.op.key){case"not":return function(e){return!t(e)};default:throw new Error("Invalid unary operator:"+this.op.key)}},binaryPredicate:function(e){var t=this.expr1.visit(e),n=this.expr2.visit(e),r=this.expr1.dataType||this.expr2.dataType,a=e.entityType.metadataStore.localQueryComparisonOptions,i=function(e,t,n){var r,a=e.op,i=Ne.getComparableFn(t);switch(a.key){case"eq":r=function(e,t){return e&&"string"==typeof e?o(e,t,n):i(e)==i(t)};break;case"ne":r=function(e,t){return e&&"string"==typeof e?!o(e,t,n):i(e)!=i(t)};break;case"gt":r=function(e,t){return i(e)>i(t)};break;case"ge":r=function(e,t){return i(e)>=i(t)};break;case"lt":r=function(e,t){return i(e)<i(t)};break;case"le":r=function(e,t){return i(e)<=i(t)};break;case"startswith":r=function(e,t){return function(e,t,n){n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase());return U(e,t)}(e,t,n)};break;case"endswith":r=function(e,t){return function(e,t,n){n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase());return $(e,t)}(e,t,n)};break;case"contains":r=function(e,t){return function(e,t,n){n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase());return 0<=e.indexOf(t)}(e,t,n)};break;case"in":r=function(e,t){return e=i(e),0<=(t=t.map(function(e){return i(e)})).indexOf(e)};break;default:return null}return r}(this,r,a);if(null==i)throw new Error("Invalid binaryPredicate operator:"+this.op.key);return function(e){return i(t(e),n(e))}},andOrPredicate:function(t){var r=this.preds.map(function(e){return e.visit(t)});switch(this.op.key){case"and":return function(n){var e=r.reduce(function(e,t){return e&&t(n)},!0);return e};case"or":return function(n){var e=r.reduce(function(e,t){return e||t(n)},!1);return e};default:throw new Error("Invalid boolean operator:"+op.key)}},anyAllPredicate:function(e){var t=this.expr.visit(e),n=k({},e);n.entityType=this.expr.dataType;var r=this.pred.visit(n),a=function(e){switch(e.key){case"any":return function(e,t){return e.some(function(e){return t(e)})};case"all":return function(e,t){return e.every(function(e){return t(e)})};default:throw new Error("Unknown operator: "+e.key)}}(this.op);return function(e){return a(t(e),r)}},litExpr:function(){var t=this.value;return function(e){return t}},propExpr:function(){var t=this.propertyPath,n=t.split(".");return 1===n.length?function(e){return e.getProperty(t)}:function(e){return ct(e,n)}},fnExpr:function(t){var r=this.exprs.map(function(e){return e.visit(t)}),a=this;return function(n){var e=r.map(function(e){var t=e(n);return t}),t=a.localFn.apply(null,e);return t}}};function o(e,t,n){return null!=t&&("string"!=typeof t&&(t=t.toString()),n.usesSql92CompliantStringComparison&&(e=(e||"").trim(),t=(t||"").trim()),n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),e===t)}return e}(),F=function(){var e={passthruPredicate:function(){return this.value},unaryPredicate:function(e){var t=this.pred.visit(e),n={};return n[this.op.key]=t,n},binaryPredicate:function(e){var t=this.expr1.visit(e),n=this.expr2.visit(e),r={};if(this.expr2 instanceof S&&(n={value:n,isProperty:!0}),"eq"===this.op.key)r[t]=n;else{var a={};(r[t]=a)[this.op.key]=n}return r},andOrPredicate:function(t){var e,n=this.preds.map(function(e){return e.visit(t)});return n&&n.length?("and"!==this.op.key||2!==n.length||n.some(B)||(e=n.reduce(r)),null==e&&((e={})[this.op.key]=n),e):{}},anyAllPredicate:function(e){var t=this.expr.visit(e),n=k({},e);n.entityType=this.expr.dataType;var r=this.pred.visit(n),a={},i={};return i[this.op.key]=r,a[t]=i,a},litExpr:function(e){return this.hasExplicitDataType||e.useExplicitDataType?{value:this.value,dataType:this.dataType.name}:this.value},propExpr:function(e){return e.toNameOnServer?e.entityType.clientPropertyPathToServer(this.propertyPath):this.propertyPath},fnExpr:function(t){var e=this.exprs.map(function(e){return e.visit(t)});return this.fnName+"("+e.join(",")+")"}};function r(t,n){var e=Object.keys(n).every(function(e){if(t.hasOwnProperty(e)){if("object"!=typeof n[e])return!1;if(null==r(t[e],n[e]))return!1}else t[e]=n[e];return!0});return e?t:null}return e}();return f}();v.Predicate=We;var Xe=function(){var e=function(e){if(null!=e&&!B(e))return y(e,{"resourceName,from":null,"resultEntityType,toType":null,"wherePredicate,where":function(e){return e?new We(e):void 0},"orderByClause,orderBy":function(e){return e?new tt(e):void 0},"selectClause,select":function(e){return e?new nt(e):void 0},"expandClause,expand":function(e){return e?new rt(e):void 0},"skipCount,skip":null,"takeCount,take":null,parameters:function(e){return q(e)?void 0:e},"inlineCountEnabled,inlineCount":!1,"noTrackingEnabled,noTracking":!1,queryOptions:function(e){return e?ft.fromJSON(e):void 0}},t=this),t;var t;this.resourceName=e,this.fromEntityType=null,this.wherePredicate=null,this.orderByClause=null,this.selectClause=null,this.skipCount=null,this.takeCount=null,this.expandClause=null,this.parameters={},this.inlineCountEnabled=!1,this.noTrackingEnabled=!1,this.entityManager=null},t=e.prototype;function r(e,t,n){if(t&&e[t]===n)return e;var r=k(new Xe,e,["resourceName","fromEntityType","wherePredicate","orderByClause","selectClause","skipCount","takeCount","expandClause","inlineCountEnabled","noTrackingEnabled","usesNameOnServer","queryOptions","entityManager","dataService","resultEntityType"]);return r.parameters=k({},e.parameters),t&&(r[t]=n),r}function a(e){return H(e,"propertyPaths").isOptional().isString().or().isArray().isString().check(),"string"==typeof e&&(e=e.split(",")),e=e.map(function(e){return e.trim()})}function u(e){var t=e.entityType.keyProperties,n=C(t,e.values,function(e,t){return We.create(e.name,et.Equals,t)}),r=We.and(n);return r}return t._$typeName="EntityQuery",t.from=function(e){return H(e,"resourceName").isString().check(),r(this,"resourceName",e)},e.from=function(e){return H(e,"resourceName").isString().check(),new Xe(e)},t.toType=function(e){return H(e,"entityType").isString().or().isInstanceOf(xe).check(),r(this,"resultEntityType",e)},t.where=function(e){return null!=e&&(e=We.create(D(arguments)),this.fromEntityType&&e._validate(this.fromEntityType),this.wherePredicate&&(e=this.wherePredicate.and(e))),r(this,"wherePredicate",e)},t.orderBy=function(e,t){var n=null==e?null:new tt(a(e),t);return this.orderByClause&&n&&(n=new tt([this.orderByClause,n])),r(this,"orderByClause",n)},t.orderByDesc=function(e){return this.orderBy(e,!0)},t.select=function(e){var t=null==e?null:new nt(a(e));return r(this,"selectClause",t)},t.skip=function(e){return H(e,"count").isOptional().isNumber().check(),r(this,"skipCount",null==e?null:e)},t.top=function(e){return this.take(e)},t.take=function(e){return H(e,"count").isOptional().isNumber().check(),r(this,"takeCount",null==e?null:e)},t.expand=function(e){var t=null==e?null:new rt(a(e));return r(this,"expandClause",t)},t.withParameters=function(e){return H(e,"parameters").isObject().check(),r(this,"parameters",e)},t.inlineCount=function(e){return H(e,"enabled").isBoolean().isOptional().check(),r(this,"inlineCountEnabled",e=void 0===e||!!e)},t.useNameOnServer=function(e){return H(e,"usesNameOnServer").isBoolean().isOptional().check(),r(this,"usesNameOnServer",e=void 0===e||!!e)},t.noTracking=function(e){return H(e,"enabled").isBoolean().isOptional().check(),r(this,"noTrackingEnabled",e=void 0===e||!!e)},t.using=function(e){if(!e)return this;var t=r(this);return function n(r,a,e,t){var i=e._$typeName||e.parentEnum&&e.parentEnum.name;var o=i&&i.substr(0,1).toLowerCase()+i.substr(1);if(t&&o!=t)throw new Error("Invalid value for property: "+t);if(o){var s=a[o];if(void 0===s)throw new Error("Invalid config property: "+o);null===s?r[o]=e:s(r,e)}else P(e,function(e,t){n(r,a,t,e)})}(t,{entityManager:null,dataService:null,queryOptions:null,fetchStrategy:function(e,t){e.queryOptions=(e.queryOptions||new ft).using(t)},mergeStrategy:function(e,t){e.queryOptions=(e.queryOptions||new ft).using(t)},jsonResultsAdapter:function(e,t){e.dataService=(e.dataService||new _e).using({jsonResultsAdapter:t})}},e),t},t.execute=function(e,t){if(!this.entityManager)throw new Error("An EntityQuery must have its EntityManager property set before calling 'execute'");return this.entityManager.executeQuery(this,e,t)},t.executeLocally=function(){if(!this.entityManager)throw new Error("An EntityQuery must have its EntityManager property set before calling 'executeLocally'");return this.entityManager.executeQueryLocally(this)},t.toJSON=function(){return this.toJSONExt()},t.toJSONExt=function(t){(t=t||{}).entityType=t.entityType||this.fromEntityType,t.propertyPathFn=t.toNameOnServer?t.entityType.clientPropertyPathToServer.bind(t.entityType):n;var e=function(e){return e?e.toJSONExt(t):void 0};return y(this,{"from,resourceName":null,"toType,resultEntityType":function(e){return e?B(e)?e:e.name:void 0},"where,wherePredicate":e,"orderBy,orderByClause":e,"select,selectClause":e,"expand,expandClause":e,"skip,skipCount":null,"take,takeCount":null,parameters:function(e){return q(e)?void 0:e},"inlineCount,inlineCountEnabled":!1,"noTracking,noTrackingEnabled":!1,queryOptions:null})},e.fromEntities=function(e){H(e,"entities").isEntity().or().isNonEmptyArray().isEntity().check(),Array.isArray(e)||(e=D(arguments));var t=e[0],n=t.entityType;if(e.some(function(e){return e.entityType!==n}))throw new Error("All 'fromEntities' must be the same type; at least one is not of type "+n.name);var r=new Xe(n.defaultResourceName),a=e.map(function(e){return n=(t=e).entityType.keyProperties.map(function(e){return We.create(e.name,et.Equals,t.getProperty(e.name))}),We.and(n);var t,n}),i=We.or(a);r=r.where(i);var o=t.entityAspect.entityManager;return o&&(r=r.using(o)),r},e.fromEntityKey=function(e){H(e,"entityKey").isInstanceOf(me).check();var t=new Xe(e.entityType.defaultResourceName),n=u(e);return t=t.where(n).toType(e.entityType)},e.fromEntityNavigation=function(e,t){H(e,"entity").isEntity().check();var n=e.entityType._checkNavProperty(t),r=new Xe(n.entityType.defaultResourceName),a=function(t,e){{if(e.isScalar){if(0===e.foreignKeyNames.length)return null;var n=e.foreignKeyNames.map(function(e){return t.getProperty(e)}),r=new me(e.entityType,n);return u(r)}var a=e.getInverse(),i=a?a.foreignKeyNames:e.invForeignKeyNames;if(0===i.length)return null;var o=t.entityAspect.getKey().values,s=C(i,o,function(e,t){return We.create(e,et.Equals,t)});return We.and(s)}}(e,n);r=r.where(a);var i=e.entityAspect.entityManager;return i?r.using(i):r},t._getFromEntityType=function(e,t){var n=this.fromEntityType;if(n)return n;var r=this.resourceName;if(!r)throw new Error("There is no resourceName for this query");if(e.isEmpty()){if(t)throw new Error("There is no metadata available for this query. Are you querying the local cache before you've fetched metadata?");return null}var a=e.getEntityTypeNameForResourceName(r);if(!(n=a?e._getEntityType(a):this._getToEntityType(e,!0))){if(t)throw new Error(G("Cannot find an entityType for resourceName: '%1'.  Consider adding an 'EntityQuery.toType' call to your query or calling the MetadataStore.setEntityTypeForResourceName method to register an entityType for this resourceName.",r));return null}return this.fromEntityType=n},t._getToEntityType=function(e,t){return this.resultEntityType instanceof xe?this.resultEntityType:this.resultEntityType?(this.resultEntityType=e._getEntityType(this.resultEntityType,!1),this.resultEntityType):t?null:!this.selectClause&&this._getFromEntityType(e,!1)},t._toUri=function(e){var t=_e.resolve([e.dataService]);return t.uriBuilder.buildUri(this,e.metadataStore)},e}(),et=(pt=new te("FilterQueryOp"),pt.Equals=pt.addSymbol({operator:"eq"}),pt.NotEquals=pt.addSymbol({operator:"ne"}),pt.GreaterThan=pt.addSymbol({operator:"gt"}),pt.LessThan=pt.addSymbol({operator:"lt"}),pt.GreaterThanOrEqual=pt.addSymbol({operator:"ge"}),pt.LessThanOrEqual=pt.addSymbol({operator:"le"}),pt.Contains=pt.addSymbol({operator:"contains"}),pt.StartsWith=pt.addSymbol({operator:"startswith"}),pt.EndsWith=pt.addSymbol({operator:"endswith"}),pt.Any=pt.addSymbol({operator:"any"}),pt.All=pt.addSymbol({operator:"all"}),pt.In=pt.addSymbol({operator:"in"}),pt.IsTypeOf=pt.addSymbol({operator:"isof"}),pt.resolveSymbols(),pt),tt=(ut=new te("BooleanQueryOp"),ut.And=ut.addSymbol({operator:"and"}),ut.Or=ut.addSymbol({operator:"or"}),ut.Not=ut.addSymbol({operator:"not"}),ut.resolveSymbols(),function(){var e=function(e,t){if(1<e.length){if(e[0]instanceof tt)return void(this.items=Array.prototype.concat.apply(e[0].items,e.slice(1).map(d("items"))));var n=e.map(function(e){return new r(e,t)})}else var n=[new r(e[0],t)];this.items=n},t=e.prototype;t.validate=function(t){null==t||t.isAnonymous||this.items.forEach(function(e){e.validate(t)})},t.getComparer=function(t){var a=this.items.map(function(e){return e.getComparer(t)});return function(e,t){for(var n=0;n<a.length;n++){var r=a[n](e,t);if(0!==r)return r}return 0}},t.toJSONExt=function(t){return this.items.map(function(e){return t.propertyPathFn(e.propertyPath)+(e.isDesc?" desc":"")})};var r=function(e,t){if("string"!=typeof e)throw new Error("propertyPath is not a string");var n=(e=e.trim()).split(" ");if(1<n.length&&!0!==t&&!1!==t&&!(t=U(n[1].toLowerCase(),"desc"))){var r=U(n[1].toLowerCase(),"asc");if(!r)throw new Error("the second word in the propertyPath must begin with 'desc' or 'asc'")}this.propertyPath=n[0],this.isDesc=t},n=r.prototype;return n.validate=function(e){null==e||e.isAnonymous||(this.lastProperty=e.getProperty(this.propertyPath,!0))},n.getComparer=function(e){if(this.lastProperty||this.validate(e),this.lastProperty)var o=this.lastProperty.dataType,s=this.lastProperty.parentType.metadataStore.localQueryComparisonOptions.isCaseSensitive;var u=this.propertyPath,p=this.isDesc;return function(e,t){var n=ct(e,u),r=ct(t,u),a=o||n&&Ne.fromValue(n)||Ne.fromValue(r);if(a===Ne.String)s?(n=n||"",r=r||""):(n=(n||"").toLowerCase(),r=(r||"").toLowerCase());else{var i=Ne.getComparableFn(a);n=i(n),r=i(r)}return n===r?0:r<n||void 0===r?p?-1:1:p?1:-1}},e}()),nt=(ot=function(e){this.propertyPaths=e,this._pathNames=e.map(function(e){return e.replace(".","_")})},st=ot.prototype,st.validate=function(t){null==t||t.isAnonymous||this.propertyPaths.forEach(function(e){t.getProperty(e,!0)})},st.toFunction=function(){var a=this;return function(n){var r={};return a.propertyPaths.forEach(function(e,t){r[a._pathNames[t]]=ct(n,e)}),r}},st.toJSONExt=function(t){return this.propertyPaths.map(function(e){return t.propertyPathFn(e)})},ot),rt=(at=function(e){this.propertyPaths=e},it=at.prototype,it.toJSONExt=function(t){return this.propertyPaths.map(function(e){return t.propertyPathFn(e)})},at);var at,it;var ot,st;var ut;var pt;function ct(e,t){var n=Array.isArray(t)?t:t.split(".");if(1===n.length)return e.getProperty(t);var r=e;return n.some(function(e){return null==(r=r.getProperty(e))}),r}v.FilterQueryOp=et,v.EntityQuery=Xe,v.OrderByClause=tt;var lt=(dt=new te("MergeStrategy"),dt.PreserveChanges=dt.addSymbol(),dt.OverwriteChanges=dt.addSymbol(),dt.SkipMerge=dt.addSymbol(),dt.Disallowed=dt.addSymbol(),dt.resolveSymbols(),dt),yt=(ht=new te("FetchStrategy"),ht.FromServer=ht.addSymbol(),ht.FromLocalCache=ht.addSymbol(),ht.resolveSymbols(),ht),ft=function(){var e=function(e){n(this,e)},t=e.prototype;function n(e,t){return t&&W(t).whereParam("fetchStrategy").isEnumOf(yt).isOptional().whereParam("mergeStrategy").isEnumOf(lt).isOptional().whereParam("includeDeleted").isBoolean().isOptional().applyAll(e),e}return t._$typeName="QueryOptions",e.resolve=function(e){return new ft(u(e,["fetchStrategy","mergeStrategy","includeDeleted"]))},e.defaultInstance=new e({fetchStrategy:yt.FromServer,mergeStrategy:lt.PreserveChanges,includeDeleted:!1}),t.using=function(e){if(!e)return this;var t=new ft(this);return lt.contains(e)?e={mergeStrategy:e}:yt.contains(e)&&(e={fetchStrategy:e}),n(t,e)},t.setAsDefault=function(){return i(this,e)},t.toJSON=function(){return y(this,{fetchStrategy:null,mergeStrategy:null,includeDeleted:!1})},e.fromJSON=function(e){return new ft({fetchStrategy:yt.fromName(e.fetchStrategy),mergeStrategy:lt.fromName(e.mergeStrategy),includeDeleted:!0===e.includeDeleted})},e}();var ht;var dt;v.QueryOptions=ft,v.FetchStrategy=yt,v.MergeStrategy=lt;var mt=(gt=function(e,t){this.entityManager=e,this.entityType=t,this.entityType.isFrozen=!0,this._indexMap={},this._entities=[],this._emptyIndexes=[]},wt=gt.prototype,wt.attachEntity=function(e,t,n){var r=e.entityAspect;r._initialized||this.entityType._initializeInstance(e),delete r._initialized;var a=r.getKey()._keyInGroup,i=this._indexMap[a];if(0<=i){var o=this._entities[i],s=o.entityAspect.entityState,u=s.isUnchanged();if(o===e)r.entityState=t;else{if(n===lt.Disallowed)throw new Error("A MergeStrategy of 'Disallowed' does not allow you to attach an entity when an entity with the same key is already attached: "+r.getKey());if(n===lt.OverwriteChanges||n===lt.PreserveChanges&&u){var p=this.entityManager.helper.unwrapInstance(e);this.entityType._updateTargetFromRaw(o,p,Me.getRawValueFromServer),o.entityAspect.setEntityState(t)}}return o}return 0===this._emptyIndexes.length?i=this._entities.push(e)-1:(i=this._emptyIndexes.pop(),this._entities[i]=e),this._indexMap[a]=i,r.entityState=t,r.entityGroup=this,r.entityManager=this.entityManager,e},wt.detachEntity=function(e){var t=e.entityAspect,n=t.getKey()._keyInGroup,r=this._indexMap[n];if(void 0===r)throw new Error("internal error - entity cannot be found in group");return delete this._indexMap[n],this._emptyIndexes.push(r),this._entities[r]=null,e},wt.findEntityByKey=function(e){var t;t=e instanceof me?e._keyInGroup:me.createKeyString(e);var n=this._indexMap[t];return void 0!==n?this._entities[n]:null},wt.hasChanges=function(){for(var e=this._entities,t=ve.Unchanged,n=0,r=e.length;n<r;n++){var a=e[n];if(a&&a.entityAspect.entityState!==t)return!0}return!1},wt.getChanges=function(){for(var e=this._entities,t=ve.Unchanged,n=[],r=0,a=e.length;r<a;r++){var i=e[r];i&&i.entityAspect.entityState!==t&&n.push(i)}return n},wt.getEntities=function(e){var t=function(t){if(t){if(1===t.length){var n=t[0];return function(e){return!!e&&e.entityAspect.entityState===n}}return function(e){return!!e&&-1!==t.indexOf(e.entityAspect.entityState)}}return function(e){return!!e}}(e);return this._entities.filter(t)},wt._checkOperation=function(t){return this._entities.forEach(function(e){e&&e.entityAspect._checkOperation(t)}),this},wt._clear=function(){this._entities.forEach(function(e){null!=e&&e.entityAspect._detach()}),this._entities=null,this._indexMap=null,this._emptyIndexes=null},wt._updateFkVal=function(e,t,n){var r=e.name;this._entities.forEach(function(e){null!=e&&e.getProperty(r)==t&&e.setProperty(r,n)})},wt._fixupKey=function(e,t){var n=this._indexMap[e];if(void 0===n)throw new Error("Internal Error in key fixup - unable to locate entity");var r=this._entities[n],a=r.entityType.keyProperties[0].name;r.setProperty(a,t),delete r.entityAspect.hasTempKey,delete this._indexMap[e],this._indexMap[t]=n},wt._replaceKey=function(e,t){var n=this._indexMap[e._keyInGroup];delete this._indexMap[e._keyInGroup],this._indexMap[t._keyInGroup]=n},gt),vt=function(){var t=function(e){if(1<arguments.length)throw new Error("The EntityManager ctor has a single optional argument that is either a 'serviceName' or a configuration object.");0===arguments.length?e={serviceName:""}:"string"==typeof e&&(e={serviceName:e}),n(this,e,!0),this.entityChanged=new ne("entityChanged",this),this.validationErrorsChanged=new ne("validationErrorsChanged",this),this.hasChangesChanged=new ne("hasChangesChanged",this),this.clear()},e=t.prototype;function n(e,t,n){var r=n?ft.defaultInstance:e.queryOptions,a=n?St.defaultInstance:e.saveOptions,i=n?pe.defaultInstance:e.validationOptions,o=W(t).whereParam("serviceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(_e).whereParam("queryOptions").isInstanceOf(ft).isOptional().withDefault(r).whereParam("saveOptions").isInstanceOf(St).isOptional().withDefault(a).whereParam("validationOptions").isInstanceOf(pe).isOptional().withDefault(i).whereParam("keyGeneratorCtor").isFunction().isOptional();n&&(o=o.whereParam("metadataStore").isInstanceOf(Ae).isOptional().withDefault(new Ae)),o.applyAll(e),T(e.queryOptions,r),T(e.saveOptions,a),T(e.validationOptions,i),t.serviceName&&(e.dataService=new _e({serviceName:e.serviceName})),e.serviceName=e.dataService&&e.dataService.serviceName,e.keyGeneratorCtor=e.keyGeneratorCtor||$e,(n||t.keyGeneratorCtor)&&(e.keyGenerator=new e.keyGeneratorCtor)}function p(e,t){H(t,"query").isInstanceOf(Xe).check();var n,r=e.metadataStore,a=t._getFromEntityType(r,!0),i=(n=e,a.getSelfAndSubtypes().map(function(e){return S(n,e)})),o=t.wherePredicate&&t.wherePredicate.toFunction({entityType:a}),s=ft.resolve([t.queryOptions,e.queryOptions,ft.defaultInstance]),u=!0===s.includeDeleted,p=function(e){return e&&(u||!e.entityAspect.entityState.isDeleted())&&(!o||o(e))},c=[];i.forEach(function(e){var t=e._entities.filter(p);t.length&&(c=c.length?c.concat(t):t)});var l=t.orderByClause&&t.orderByClause.getComparer(a);if(l&&c.sort(l),t.inlineCountEnabled)var y=c.length;var f=t.skipCount;f&&(c=c.slice(f));var h=t.takeCount;h&&(c=c.slice(0,h));var d=t.selectClause;if(d){var m=d.toFunction();c=c.map(m)}return{results:c,inlineCount:y}}function r(e,t){var n,r=s(e,t),a=r.entityKey,i=0!==r.remainingArgs.length&&!!r.remainingArgs[0],o=!1;return i&&(n=e.getEntityByKey(a),(o=!!n)&&!e.queryOptions.includeDeleted&&n.entityAspect.entityState.isDeleted()&&(n=null,o=e.queryOptions.mergeStrategy!==lt.OverwriteChanges)),o?Oe.resolve({entity:n,entityKey:a,fromCache:!0}):Xe.fromEntityKey(a).using(e).execute().then(function(e){return n=0===e.results.length?null:e.results[0],Oe.resolve({entity:n,entityKey:a,fromCache:!1})})}function i(t,e){return H(e,"entityTypes").isString().isOptional().or().isNonEmptyArray().isString().or().isInstanceOf(xe).or().isNonEmptyArray().isInstanceOf(xe).check(),"string"==typeof e?e=t.metadataStore._getEntityType(e,!1):Array.isArray(e)&&"string"==typeof e[0]&&(e=e.map(function(e){return t.metadataStore._getEntityType(e,!1)})),e}function a(e,t){var n,r=o(e,t);return r.forEach(function(e){if(e){var t=e.getChanges();n=n&&n.length?n.concat(t):t}}),n||[]}function s(e,t){try{if(t[0]instanceof me)return{entityKey:t[0],remainingArgs:D(t,1)};if(2<=t.length){var n="string"==typeof t[0]?e.metadataStore._getEntityType(t[0],!1):t[0];return{entityKey:new me(n,t[1]),remainingArgs:D(t,2)}}}catch(e){}throw new Error("Must supply an EntityKey OR an EntityType name or EntityType followed by a key value or an array of key values.")}function y(e,t){e.forEach(function(e){e.entityAspect.isBeingSaved=t})}function E(e,t){var n=e[t.toString()];if(n)return n;var r=t._subtypes;if(!r)return null;for(var a=0,i=r.length;a<i;a++)if(n=e[t.toString(r[a])])return n;return null}function u(e,t,n){return e=e.then(function(e){return t&&t(e),Oe.resolve(e)},function(e){return n&&n(e),Oe.reject(e)})}function o(e,t){var n=e._entityGroupMap;return t?_(t).map(function(e){if(e instanceof xe)return n[e.name];throw new Error("The EntityManager.getChanges() 'entityTypes' parameter must be either an entityType or an array of entityTypes or null")}):w(n)}function c(r,a,e,i){try{var o,t=r.metadataStore;if(t.isEmpty()&&i.hasServerMetadata)throw new Error("cannot execute _executeQueryCore until metadataStore is populated.");if(e.fetchStrategy===yt.FromLocalCache)try{var n=p(r,a);return Oe.resolve({results:n.results,entityManager:r,inlineCount:n.inlineCount,query:a})}catch(e){return Oe.reject(e)}var s=new Et({query:a,entityManager:r,dataService:i,mergeOptions:{mergeStrategy:e.mergeStrategy,noTracking:!!a.noTrackingEnabled,includeDeleted:e.includeDeleted}}),u=r.validationOptions.validateOnQuery;return i.adapterInstance.executeQuery(s).then(function(n){var e=I(function(){var e={isLoading:r.isLoading};return r.isLoading=!0,r._pendingPubs=[],e},function(e){r.isLoading=e.isLoading,r._pendingPubs.forEach(function(e){e()}),r._pendingPubs=null,r._hasChangesAction&&r._hasChangesAction(),s=a=null,e.error&&Oe.reject(e.error)},function(){var e=i.jsonResultsAdapter.extractResults(n);e=_(e),o=s.visitAndMerge(e,{nodeType:"root"}),u&&o.forEach(function(e){e.entityAspect&&e.entityAspect.validateEntity()}),s.processDeferred(),function(n,e){if(e.noTrackingEnabled)return;var t=e.expandClause;if(null==t)return;t.propertyPaths.forEach(function(e){var t=e.split(".");!function r(e,a){var i=a[0];e.forEach(function(e){var t=e.entityAspect;if(t&&(t._markAsLoaded(i),1!==a.length)){var n=e.getProperty(i);n&&(n.arrayChanged||(n=[n]),r(n,a.slice(1)))}})}(n,t)})}(o,a);var t=g(s.refMap);return{results:o,query:a,entityManager:r,httpResponse:n.httpResponse,inlineCount:n.inlineCount,retrievedEntities:t}});return Oe.resolve(e)},function(e){return e&&(e.query=a,e.entityManager=r),Oe.reject(e)})}catch(e){return e&&(e.query=a),Oe.reject(e)}}function S(e,t){var n=e._entityGroupMap[t.name];return n||(n=new mt(e,t),e._entityGroupMap[t.name]=n),n}function l(n,r){var a={},e=n.entityType||n.complexType,i=d(e),o={};return e.dataProperties.forEach(function(e){if(e.isComplexProperty)a[e.nameOnServer]=b(n.getProperty(e.name),function(e){return l(e,r)});else{var t=n.getProperty(e.name);if(void 0===(t=r?r(e,t):t))return;void 0!==(t=i?i(e,t):t)&&(e.isUnmapped?o[e.nameOnServer]=N(t):a[e.nameOnServer]=t)}}),q(o)||(a.__unmapped=o),a}function f(e,t){var n=e.getProperty(t.name);return t.isScalar?h(n):!!n._origValues||n.some(function(e){return h(e)})}function h(t){return!q(t.complexAspect.originalValues)||t.complexType.complexProperties.some(function(e){return f(t,e)})}function d(e){return e.serializerFn||e.metadataStore&&e.metadataStore.serializerFn}function m(){this.map={}}return e._$typeName="EntityManager",ne.bubbleEvent(e,null),e.setProperties=function(e){n(this,e,!1)},e.createEntity=function(e,t,n,r){var a;return H(e,"entityType").isString().or().isInstanceOf(xe).check(),H(n,"entityState").isEnumOf(ve).isOptional().check(),H(r,"mergeStrategy").isEnumOf(lt).isOptional().check(),"string"==typeof e&&(e=this.metadataStore._getEntityType(e)),n=n||ve.Added,F(this,"isLoading",!0,function(){a=e.createEntity(t)}),n!==ve.Detached&&(a=this.attachEntity(a,n,r)),a},t.importEntities=function(e,t){var n=new vt;return n.importEntities(e,t),n},e.acceptChanges=function(){this.getChanges().map(function(e){return e.entityAspect._checkOperation("acceptChanges")}).forEach(function(e){e.acceptChanges()})},e.exportEntities=function(e,t){H(e,"entities").isArray().isEntity().or().isNonEmptyArray().isInstanceOf(xe).or().isNonEmptyArray().isString().or().isOptional().check(),H(t,"config").isObject().or().isBoolean().or().isOptional().check(),null==t?t={includeMetadata:!0,asString:!0}:"boolean"==typeof t&&(t={includeMetadata:t,asString:!0}),W(t).whereParam("asString").isBoolean().isOptional().withDefault(!0).whereParam("includeMetadata").isBoolean().isOptional().withDefault(!0).applyAll(t);var n=function(n,e){var r,t=e&&e[0];if(t)if(r={},t.entityType)e.forEach(function(e){if(e.entityAspect.entityState==ve.Detached)throw new Error("Unable to export an entity with an EntityState of 'Detached'");var t=r[e.entityType.name];t||((t={}).entityType=e.entityType,t._entities=[],r[e.entityType.name]=t),t._entities.push(e)});else{var a=i(n,e);a.forEach(function(e){var t=n._entityGroupMap[e.name];t&&t._entities.length&&(r[e.name]=t)})}else r=e&&0===e.length?{}:n._entityGroupMap;var p=[],c={};return P(r,function(e,t){var n,r,a,i,o,s,u;c[e]=(r=p,a={},i=(n=t).entityType,o=i.dataProperties,s=d(i),u=[],n._entities.forEach(function(e){if(e){var t=function a(i,e,o,t){var n,r,s,u,p,c,l={};if(e.forEach(function(e){var t=e.name,n=i.getProperty(t);if(null!=n||null!=e.defaultValue){if(n&&e.isComplexProperty){var r=e.dataType.dataProperties;n=b(n,function(e){return a(e,r,o)})}else n=o?o(e,n):n,e.isUnmapped&&(n=N(n));void 0!==n&&(l[t]=n)}}),i.entityAspect){var y=(n=i.entityAspect).entityState;r={tempNavPropNames:(s=n,u=t,c=s.entity,s.hasTempKey&&u.push(s.getKey().toJSON()),c.entityType.navigationProperties.forEach(function(e){if(e.relatedDataProperties){var t=c.getProperty(e.name);t&&t.entityAspect.hasTempKey&&(p=p||[]).push(e.name)}}),p),entityState:y.name},n.extraMetadata&&(r.extraMetadata=n.extraMetadata),(y.isModified()||y.isDeleted())&&(r.originalValuesMap=n.originalValues),l.entityAspect=r}else n=i.complexAspect,r={},n.originalValues&&!q(n.originalValues)&&(r.originalValuesMap=n.originalValues),l.complexAspect=r;return l}(e,o,s,r);u.push(t)}}),a.entities=u,a)}),{entityGroupMap:c,tempKeys:p}}(this,e),r=k({},n,["tempKeys","entityGroupMap"]);t.includeMetadata?(r=k(r,this,["dataService","saveOptions","queryOptions","validationOptions"])).metadataStore=this.metadataStore.exportMetadata():(r.metadataVersion=v.metadataVersion,r.metadataStoreName=this.metadataStore.name);var a=t.asString?JSON.stringify(r,null,re.stringifyPad):r;return a},e.importEntities=function(e,v){W(v=v||{}).whereParam("mergeStrategy").isEnumOf(lt).isOptional().withDefault(this.queryOptions.mergeStrategy).whereParam("metadataVersionFn").isFunction().isOptional().whereParam("mergeAdds").isBoolean().isOptional().applyAll(v);var g=this,t="string"==typeof e?JSON.parse(e):e;t.metadataStore?(this.metadataStore.importMetadata(t.metadataStore),this.dataService=t.dataService&&_e.fromJSON(t.dataService)||new _e({serviceName:t.serviceName}),this.saveOptions=new St(t.saveOptions),this.queryOptions=ft.fromJSON(t.queryOptions),this.validationOptions=new pe(t.validationOptions)):v.metadataVersionFn&&v.metadataVersionFn({metadataVersion:t.metadataVersion,metadataStoreName:t.metadataStoreName});var n={};t.tempKeys.forEach(function(e){var t=me.fromJSON(e,g.metadataStore);n[t.toString()]=new me(t.entityType,g.keyGenerator.generateTempKeyValue(t.entityType,t.values[0]))});var w=[];return v.tempKeyMap=n,I(function(){g._pendingPubs=[]},function(e){g._pendingPubs.forEach(function(e){e()}),g._pendingPubs=null,g._hasChangesAction&&g._hasChangesAction()},function(){P(t.entityGroupMap,function(e,t){var o,n,r,s,u,p,c,l,y,f,h,d,a=g.metadataStore._getEntityType(e,!0),i=S(g,a),m=(o=i,n=t,s=(r=v).tempKeyMap,u=o.entityType,p=r.mergeStrategy,c=r.mergeAdds,l=null,y=o.entityManager,f=y.entityChanged,h=[],d=Me.getRawValueFromClient,n.entities.forEach(function(e){var t=e.entityAspect,n=u.getEntityKeyFromRawEntity(e,d),r=ve.fromName(t.entityState);if(!r||r==ve.Detached)throw new Error("Only entities with a non detached entity state may be imported.");var a=!c&&r.isAdded()&&E(s,n);if(l=a?null:o.findEntityByKey(n))if(p===lt.SkipMerge);else{if(p===lt.Disallowed)throw new Error("A MergeStrategy of 'Disallowed' prevents "+n.toString()+" from being merged");var i=l.entityAspect.entityState.isUnchanged();(p===lt.OverwriteChanges||i)&&(u._updateTargetFromRaw(l,e,d),l.entityAspect.setEntityState(r),f.publish({entityAction:ce.MergeOnImport,entity:l}))}else l=u._createInstanceCore(),u._updateTargetFromRaw(l,e,d),a&&(l.entityAspect.hasTempKey=!0,l.setProperty(u.keyProperties[0].name,a.values[0]),t.tempNavPropNames&&t.tempNavPropNames.forEach(function(e){var t=u.getNavigationProperty(e),n=t.relatedDataProperties[0].name,r=l.getProperty(n),a=new me(t.entityType,[r]),i=E(s,a);l.setProperty(n,i.values[0])})),l=o.attachEntity(l,r),f.publish({entityAction:ce.AttachOnImport,entity:l}),r.isUnchanged()||y._notifyStateChange(l,!0);h.push(l)}),h);m&&m.length&&(w=w.concat(m))}),w.forEach(function(e){e.entityAspect.entityState.isDeleted()||g._linkRelatedEntities(e)})}),{entities:w,tempKeyMapping:n}},e.clear=function(){g(this._entityGroupMap,function(e,t){return t._checkOperation()}).forEach(function(e){e._clear()}),this._entityGroupMap={},this._unattachedChildrenMap=new m,this.keyGenerator=new this.keyGeneratorCtor,this.entityChanged.publish({entityAction:ce.Clear}),this._setHasChanges(!1)},e.createEmptyCopy=function(){var e=new t(k({},this,["dataService","metadataStore","queryOptions","saveOptions","validationOptions","keyGeneratorCtor"]));return e},e.addEntity=function(e){return this.attachEntity(e,ve.Added)},e.attachEntity=function(e,t,o){if(H(e,"entity").isRequired().check(),this.metadataStore._checkEntityType(e),t=H(t,"entityState").isEnumOf(ve).isOptional().check(ve.Unchanged),o=H(o,"mergeStrategy").isEnumOf(lt).isOptional().check(lt.Disallowed),e.entityType.metadataStore!==this.metadataStore)throw new Error("Cannot attach this entity because the EntityType ("+e.entityType.name+") and MetadataStore associated with this entity does not match this EntityManager's MetadataStore.");var s=e.entityAspect;if(s){if(s._inProcessEntity)return s._inProcessEntity}else s=new ye(e);var n=s.entityManager;if(n){if(n===this)return e;throw new Error("This entity already belongs to another EntityManager")}var u,p=this;return F(this,"isLoading",!0,function(){t.isAdded()&&function(e,t){var n=t.entityAspect.getKey(),r=C(t.entityType.keyProperties,n.values,function(e,t){return e.defaultValue===t?e:null}).filter(function(e){return null!==e});if(r.length)if(t.entityType.autoGeneratedKeyType!==ke.None)e.generateTempKeyValue(t);else if(r.length===n.values.length)throw new Error("Cannot attach an object of type  ("+t.entityType.name+") to an EntityManager without first setting its key or setting its entityType 'AutoGeneratedKeyType' property to something other than 'None'")}(p,e),u=p._attachEntityCore(e,t,o),s._inProcessEntity=u;try{n=p,a=t,i=o,(r=e).entityType.navigationProperties.forEach(function(e){var t=r.getProperty(e.name);if(e.isScalar){if(!t)return;n.attachEntity(t,a,i)}else t.forEach(function(e){n.attachEntity(e,a,i)})})}finally{s._inProcessEntity=null}var n,r,a,i}),this.validationOptions.validateOnAttach&&u.entityAspect.validateEntity(),t.isUnchanged()||this._notifyStateChange(u,!0),this.entityChanged.publish({entityAction:ce.Attach,entity:u}),u},e.detachEntity=function(e){H(e,"entity").isEntity().check();var t=e.entityAspect;if(!t)return!1;if(t.entityManager!==this)throw new Error("This entity does not belong to this EntityManager.");return t.setDetached()},e.fetchMetadata=function(e,t,n){"function"==typeof e?(n=t,t=e,e=null):(H(e,"dataService").isInstanceOf(_e).isOptional().check(),H(t,"callback").isFunction().isOptional().check(),H(n,"errorCallback").isFunction().isOptional().check());var r=this.metadataStore.fetchMetadata(e||this.dataService);return u(r,t,n)},e.executeQuery=function(e,t,n){var r;H(e,"query").isInstanceOf(Xe).or().isString().check(),H(t,"callback").isFunction().isOptional().check(),H(n,"errorCallback").isFunction().isOptional().check();var a=ft.resolve([e.queryOptions,this.queryOptions,ft.defaultInstance]),i=_e.resolve([e.dataService,this.dataService]);if(!i.hasServerMetadata||this.metadataStore.hasMetadataFor(i.serviceName))r=c(this,e,a,i);else{var o=this;r=this.fetchMetadata(i).then(function(){return c(o,e,a,i)})}return u(r,t,n)},e.executeQueryLocally=function(e){return p(this,e).results},e.saveChanges=function(e,t,n,r){H(e,"entities").isOptional().isArray().isEntity().check(),H(t,"saveOptions").isInstanceOf(St).isOptional().check(),H(n,"callback").isFunction().isOptional().check(),H(r,"errorCallback").isFunction().isOptional().check(),t=t||this.saveOptions||St.defaultInstance;var a=function(t,e){var n;n=e?e.filter(function(e){if(e.entityAspect.entityManager!==t)throw new Error("Only entities in this entityManager may be saved");return!e.entityAspect.entityState.isDetached()}):t.getChanges();return n}(this,e);if(0===a.length){var i={entities:[],keyMappings:[]};return n&&n(i),Oe.resolve(i)}if(!t.allowConcurrentSaves){var o=a.some(function(e){return e.entityAspect.isBeingSaved});if(o){var s=new Error("Concurrent saves not allowed - SaveOptions.allowConcurrentSaves is false");return r&&r(s),Oe.reject(s)}}a.forEach(function(e){var n=[],t=e.entityAspect;P(t._validationErrors,function(e,t){t.isServerError&&n.push(e)}),0!==n.length&&t._processValidationOpAndPublish(function(){n.forEach(function(e){t._removeValidationError(e)})})});var u=this.saveChangesValidateOnClient(a);if(u)return r&&r(u),Oe.reject(u);var p=_e.resolve([t.dataService,this.dataService]),c={entityManager:this,dataService:p,processSavedEntities:function(e){var t=e.entities,n=e.deletedKeys||[];if(0===t.length&&0==n.length)return[];var r=e.keyMappings,a=c.entityManager;return i=a,o=r,i._inKeyFixup=!0,o.forEach(function(e){var t=i._entityGroupMap[e.entityTypeName];if(!t)throw new Error("Unable to locate the following fully qualified EntityType name: "+e.entityTypeName);t._fixupKey(e.tempValue,e.realValue)}),i._inKeyFixup=!1,F(a,"isLoading",!0,function(){var e=new Et({query:null,entityManager:a,mergeOptions:{mergeStrategy:lt.OverwriteChanges},dataService:p});t=e.visitAndMerge(t,{nodeType:"root"})}),n.forEach(function(e){var t=a.metadataStore._getEntityType(e.entityTypeName),n=new me(t,e.keyValues),r=a.findEntityByKey(n);r&&r.entityAspect.setDetached()}),t;var i,o},resourceName:t.resourceName||this.saveOptions.resourceName||"SaveChanges"},l={entities:a,saveOptions:t};try{return function(e){var t=e.filter(function(e){return e.entityAspect.isBeingSaved=!0,e.entityAspect.entityState.isModified()&&0<e.entityType.concurrencyProperties.length});if(0===t.length)return;t.forEach(function(t){t.entityType.concurrencyProperties.forEach(function(e){!function(e,t){if(e.entityAspect.originalValues[t.name])return;var n=e.getProperty(t.name);n||(n=t.dataType.defaultValue);if(t.dataType.isNumeric)e.setProperty(t.name,n+1);else{if(!t.dataType.getConcurrencyValue){if(t.dataType===Ne.Binary)return;throw new Error("Unable to update the value of concurrency property before saving: "+t.name)}var r=t.dataType.getConcurrencyValue(n);e.setProperty(t.name,r)}}(t,e)})})}(a),p.adapterInstance.saveChanges(c,l).then(function(e){var t=c.entityManager;y(a,!1);e.entities=c.processSavedEntities(e);t._setHasChanges(null),n&&n(e);return Oe.resolve(e)}).then(null,function(e){y(a,!1),function(e,t){var n=t.entityErrors;if(n){var u=e.entityManager,p=u.metadataStore;t.entityErrors=n.map(function(e){var t=null;if(e.keyValues){var n=p._getEntityType(e.entityTypeName),r=new me(n,e.keyValues);t=u.findEntityByKey(r)}if(t){var a=e.propertyName?{propertyName:e.propertyName,property:n.getProperty(e.propertyName)}:{},i=se.getKey(e.errorName||e.errorMessage,e.propertyName),o=new se(null,a,e.errorMessage,i);o.isServerError=!0,t.entityAspect.addValidationError(o)}var s=k({entity:t,isServerError:!0},e,["errorName","errorMessage","propertyName"]);return s})}}(c,e),r&&r(e);return Oe.reject(e)})}catch(s){return y(a,!1),r&&r(s),Oe.reject(s)}},e.saveChangesValidateOnClient=function(e){if(this.validationOptions.validateOnSave){var t=e.filter(function(e){var t=e.entityAspect,n=t.entityState.isDeleted()||t.validateEntity();return!n});if(0<t.length){var n=new Error("Client side validation errors encountered - see the entityErrors collection on this object for more detail");return n.entityErrors=(a=[],t.forEach(function(r){P(r.entityAspect._validationErrors,function(e,t){var n=k({entity:r,errorName:t.validator.name},t,["errorMessage","propertyName","isServerError"]);a.push(n)})}),a),n}}var a;return null},e._findEntityGroup=function(e){return this._entityGroupMap[e.name]},e.getEntityByKey=function(){var n=s(this,arguments).entityKey,e=n._subtypes||[n.entityType],r=null;return e.some(function(e){var t=this._findEntityGroup(e);return r=t&&t.findEntityByKey(n)},this),r},e.fetchEntityByKey=function(){var e=_e.resolve([this.dataService]);if(!e.hasServerMetadata||this.metadataStore.hasMetadataFor(e.serviceName))return r(this,arguments);var t=this,n=arguments;return this.fetchMetadata(e).then(function(){return r(t,n)})},e.findEntityByKey=function(e){return this.getEntityByKey(e)},e.generateTempKeyValue=function(e){H(e,"entity").isEntity().check();var t=e.entityType,n=this.keyGenerator.generateTempKeyValue(t),r=t.keyProperties[0];return e.setProperty(r.name,n),e.entityAspect.hasTempKey=!0,n},e.hasChanges=function(e){return!!this._hasChanges&&(void 0===e?this._hasChanges:this._hasChangesCore(e))},e._hasChangesCore=function(e){var t=o(this,e=i(this,e));return t.some(function(e){return e&&e.hasChanges()})},e.getChanges=function(e){return a(this,e=i(this,e))},e.rejectChanges=function(){if(!this._hasChanges)return[];var e=a(this,null),t=e.map(function(e){return e.entityAspect._checkOperation("rejectChanges")});return this._hasChanges=!1,t.forEach(function(e){e.rejectChanges()}),this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}),e},e.getEntities=function(e,t){var n,r,a;return e=i(this,e),H(t,"entityStates").isOptional().isEnumOf(ve).or().isNonEmptyArray().isEnumOf(ve).check(),t=t&&((n=t)?((n=_(n)).forEach(function(e){if(!ve.contains(e))throw new Error("The EntityManager.getChanges() 'entityStates' parameter must either be null, an entityState or an array of entityStates")}),n):null),r=t,o(this,e).forEach(function(e){if(e){var t=e.getEntities(r);a=a&&a.length?a.concat(t):t}}),a||[]},e._notifyStateChange=function(e,t){var n={entityAction:ce.EntityStateChange,entity:e};if(t)this._hasChanges||this._setHasChanges(!0);else if(this._hasChanges){if(this.isLoading)return void(this._hasChangesAction=this._hasChangesAction||function(){this._setHasChanges(null),this.entityChanged.publish(n)}.bind(this));this._setHasChanges(null)}this.entityChanged.publish(n)},e._setHasChanges=function(e){null==e&&(e=this._hasChangesCore());var t=this._hasChanges;(this._hasChanges=e)!=t&&this.hasChangesChanged.publish({entityManager:this,hasChanges:e}),this._hasChangesAction=null},e._linkRelatedEntities=function(p){var i=this,a=p.entityAspect;F(i,"isLoading",!0,function(){for(var s=i._unattachedChildrenMap,e=a.getKey(),t=e.entityType;t;){var u=e.toString(t),n=s.getTuplesByString(u);n&&n.length&&n.slice(0).forEach(function(e){var t,n,r=e.children.filter(function(e){return e.entityAspect.entityState!==ve.Detached}),a=e.navigationProperty;if(a.getInverse())if((n=(t=a).getInverse()).isScalar){var i=r[0];p.setProperty(n.name,i),i.setProperty(t.name,p)}else{var o=p.getProperty(n.name);r.forEach(function(e){o.push(e),e.setProperty(t.name,p)})}else if(a.isScalar)t=a,r.forEach(function(e){e.setProperty(t.name,p)});else{n=a;var o=p.getProperty(n.name);r.forEach(function(e){o._push(e)})}s.removeChildrenByString(u,t)}),t=t.baseEntityType}p.entityType.navigationProperties.forEach(function(e){if(e.isScalar){var t=p.getProperty(e.name);if(t)return}var n=a.getParentKey(e);if(n){if(n._isEmpty())return;var r=i.findEntityByKey(n);r?p.setProperty(e.name,r):s.addChild(n,e,p)}}),p.entityType.foreignKeyProperties.forEach(function(e){var t=e.inverseNavigationProperty;if(t){var n=p.getProperty(e.name),r=new me(t.parentType,[n]),a=i.findEntityByKey(r);a?t.isScalar?a.setProperty(t.name,p):i.isLoading?a.getProperty(t.name)._push(p):a.getProperty(t.name).push(p):s.addChild(r,t,p)}})})},e._attachEntityCore=function(e,t,n){var r=S(this,e.entityType),a=r.attachEntity(e,t,n);return this._linkRelatedEntities(a),a},e._updateFkVal=function(e,t,n){var r=this._entityGroupMap[e.parentType.name];r&&r._updateFkVal(e,t,n)},e.helper={unwrapInstance:l,unwrapOriginalValues:function a(i,o,s){var r=i.entityType||i.complexType;var e=i.entityAspect||i.complexAspect;var u=o.namingConvention.clientPropertyNameToServer;var p={};P(e.originalValues,function(e,t){var n=r.getProperty(e);void 0!==(t=s?s(n,t):t)&&(p[u(e,n)]=t)});r.complexProperties.forEach(function(e){var t=i.getProperty(e.name);if(e.isScalar){var n=a(t,o,s);q(n)||(p[u(e.name,e)]=n)}else{var r=t.map(function(e){return a(e,o,s)});p[u(e.name,e)]=r}});return p},unwrapChangedValues:function(a,e,i){var o=a.entityType,s=d(o),u=e.namingConvention.clientPropertyNameToServer,p={};return P(a.entityAspect.originalValues,function(e,t){var n=o.getProperty(e),r=a.getProperty(e);void 0!==(r=i?i(n,r):r)&&void 0!==(r=s?s(n,r):r)&&(p[u(e,n)]=r)}),o.complexProperties.forEach(function(e){if(f(a,e)){var t=a.getProperty(e.name);p[u(e.name,e)]=b(t,function(e){return l(e,i)})}}),p}},m.prototype.addChild=function(e,t,n){var r=this.getTuple(e,t);r||(r={navigationProperty:t,children:[]},x(this.map,e.toString()).push(r)),r.children.push(n)},m.prototype.removeChildrenByString=function(e,t){var n=this.map[e];n&&(A(n,function(e){return e.navigationProperty===t}),n.length||delete this.map[e])},m.prototype.getTuple=function(e,t){var n=this.getTuples(e);if(!n)return null;var r=O(n,function(e){return e.navigationProperty===t});return r},m.prototype.getTuples=function(e){var t=[],n=this.map[e.toString()];n&&(t=t.concat(n));for(var r=e.entityType;r.baseEntityType;){r=r.baseEntityType;var a=e.toString(r);(n=this.map[a])&&(t=t.concat(n))}return t.length?t:void 0},m.prototype.getTuplesByString=function(e){return this.map[e]},t}();var gt,wt;v.EntityManager=vt;var Et=function(){var e=function(e){k(this,e,["query","entityManager","dataService","mergeOptions"]),this.refMap={},this.deferredFns=[],this.jsonResultsAdapter=this.dataService.jsonResultsAdapter,this.metadataStore=this.entityManager.metadataStore,this.rawValueFn=Me.getRawValueFromServer},t=e.prototype,i=Ne.parseRawValue;function u(e,t,n,r){if(n.ignore||null==t)return null;if(n.nodeRefId){var a=(c=e,l=n.nodeRefId,void 0===(y=c.refMap[l])?function(){return c.refMap[l]}:y);return"function"==typeof a&&null!=r?void e.deferredFns.push(function(){r(a)}):a}if(n.entityType){var i=n.entityType;return e.mergeOptions.noTracking?(t=f(e,i,t),i.noTrackingFn&&(t=i.noTrackingFn(t,i)),n.nodeId&&(e.refMap[n.nodeId]=t),t):i.isComplexType?f(e,i,t):function(e,t,n){t._$meta=n;var r=e.entityManager,a=n.entityType;"string"==typeof a&&(a=e.metadataStore._getEntityType(a,!1));t.entityType=a;var i=e.mergeOptions.mergeStrategy,o=null==e.query,s=a.getEntityKeyFromRawEntity(t,e.rawValueFn),u=r.findEntityByKey(s);if(u){if(o&&u.entityAspect.entityState.isDeleted())return r.detachEntity(u),u;var p=u.entityAspect.entityState;if(i===lt.Disallowed)throw new Error("A MergeStrategy of 'Disallowed' prevents "+s.toString()+" from being merged");if(i===lt.SkipMerge)m(e,u,t);else if(i===lt.OverwriteChanges||p.isUnchanged()){v(e,u,t),u.entityAspect.wasLoaded=!0,n.extraMetadata&&(u.entityAspect.extraMetadata=n.extraMetadata),u.entityAspect.entityState=ve.Unchanged,d(u),u.entityAspect.propertyChanged.publish({entity:u,propertyName:null});var c=o?ce.MergeOnSave:ce.MergeOnQuery;r.entityChanged.publish({entityAction:c,entity:u}),p.isUnchanged()||r._notifyStateChange(u,!1)}else{if(p==ve.Deleted&&!e.mergeOptions.includeDeleted)return null;m(e,u,t)}}else u=a._createInstanceCore(),v(e,u,t),n.extraMetadata&&(u.entityAspect.extraMetadata=n.extraMetadata),r._attachEntityCore(u,ve.Unchanged,i),u.entityAspect.wasLoaded=!0,r.entityChanged.publish({entityAction:ce.AttachOnQuery,entity:u});return u}(e,t,n)}return n.passThru||"object"!=typeof t||K(t)||(s=t,u=(o=e).metadataStore.namingConvention.serverPropertyNameToClient,p={},P(s,function(e,t){var n=u(e);h(t,o,{nodeType:"anonProp",propertyName:n},p,n)}),t=p),n.nodeId&&(e.refMap[n.nodeId]=t),t;var o,s,u,p,c,l,y}function f(n,e,r){var a={};return e.dataProperties.forEach(function(t){t.isComplexProperty?a[t.name]=b(r[t.nameOnServer],function(e){return f(n,t.dataType,e)}):a[t.name]=i(r[t.nameOnServer],t.dataType)}),e.navigationProperties&&e.navigationProperties.forEach(function(e){var t={nodeType:"navProp",navigationProperty:e};h(r[e.nameOnServer],n,t,a,e.name)}),a}function h(e,n,r,a,i){var o=n.jsonResultsAdapter,s=o.visitNode(e,n,r)||{};if(e=s.node||e,!s.ignore)return s.passThru?e:void(Array.isArray(e)?(r.nodeType=r.nodeType+"Item",a[i]=e.map(function(e,t){return s=o.visitNode(e,n,r)||{},e=s.node||e,u(n,e,s,function(e){a[i][t]=e()})})):a[i]=u(n,e,s,function(e){a[i]=e()}))}function a(e,t,n){var r=n._$meta.nodeId;!r&&n._$meta.extraMetadata&&(r=n._$meta.extraMetadata.uriKey),null!=r&&(e.refMap[r]=t)}function d(n){var e=n.entityAspect||n.complexAspect;e.originalValues={};var t=n.entityType||n.complexType;t.complexProperties.forEach(function(e){var t=n.getProperty(e.name);e.isScalar?d(t):(t._acceptChanges(),t.forEach(d))})}function m(t,e,n){a(t,e,n),n.entityType.navigationProperties.forEach(function(e){e.isScalar?o(t,n,e):s(t,n,e)})}function v(t,n,r){a(t,n,r);var e=n.entityType;e._updateTargetFromRaw(n,r,t.rawValueFn),e.navigationProperties.forEach(function(e){e.isScalar?function(e,t,n,r){var a=o(e,r,t);if(null==a)return;"function"==typeof a?e.deferredFns.push(function(){p(a=a(),n,t)}):p(a,n,t)}(t,e,n,r):function(t,e,n,r){var a=s(t,r,e);if(null==a)return;var i=e.getInverse();if(!i)return;var o=n.getProperty(e.name);o.wasLoaded=!0,a.forEach(function(e){"function"==typeof e?t.deferredFns.push(function(){e=e(),c(t,e,o,n,i)}):c(t,e,o,n,i)})}(t,e,n,r)})}function o(e,t,n){var r=t[n.nameOnServer];if(!r)return null;var a=e.visitAndMerge(r,{nodeType:"navProp",navigationProperty:n});return a}function s(e,t,n){var r=t[n.nameOnServer];if(!r)return null;if(!Array.isArray(r)&&!(r=r.results))return null;var a=e.visitAndMerge(r,{nodeType:"navPropItem",navigationProperty:n});return a}function p(e,t,n){if(e){var r=n.name,a=t.getProperty(r);if(a!==e){t.setProperty(r,e);var i=n.getInverse();if(!i)return;if(i.isScalar)e.setProperty(i.name,t);else{var o=e.getProperty(i.name);o.push(t)}}}}function c(e,t,n,r,a){if(t){if(t.entityAspect.entityState===ve.Modified&&e.mergeOptions.mergeStrategy===lt.PreserveChanges){var i=t.entityAspect.originalValues,o=a.relatedDataProperties.some(function(e){return null!=i[e.name]});if(o)return}var s=t.getProperty(a.name);s!==r&&(n.push(t),t.setProperty(a.name,r))}}return t._$typeName="MappingContext",t.getUrl=function(){var e,t=this.query;if(!t)throw new Error("query cannot be empty");if("string"==typeof t)e=t;else{if(!(t instanceof Xe))throw new Error("unable to recognize query parameter as either a string or an EntityQuery");e=this.dataService.uriBuilder.buildUri(t,this.metadataStore)}return this.dataService.qualifyUrl(e)},t.visitAndMerge=function(e,n){var r=this.query,a=this.jsonResultsAdapter;n=n||{};var i=this;return b(e,function(e){if(null==r&&e.entityAspect)return e.entityAspect.entityState.isDeleted()?i.entityManager.detachEntity(e):e.entityAspect.acceptChanges(),e;var t=a.visitNode(e,i,n)||{};return e=t.node||e,r&&"root"===n.nodeType&&!t.entityType&&(t.entityType=r._getToEntityType&&r._getToEntityType(i.metadataStore)),u(i,e,t)},this.mergeOptions.includeDeleted)},t.processDeferred=function(){0<this.deferredFns.length&&this.deferredFns.forEach(function(e){e()})},e}(),St=function(){var e=function(e){n(this,e)},t=e.prototype;function n(e,t){return t&&W(t).whereParam("resourceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(_e).whereParam("allowConcurrentSaves").isBoolean().isOptional().whereParam("tag").isOptional().applyAll(e),e}return t._$typeName="SaveOptions",t.setAsDefault=function(){return i(this,e)},t.using=function(e){return n(this,e)},e.defaultInstance=new e({allowConcurrentSaves:!1}),e}();return v.SaveOptions=St,v.AbstractDataServiceAdapter=function(){var p,e=function(){},a=e.prototype;function u(e,t){this.getRequest=function(e,t,n){return e},this.done=function(e){}}function c(e,t,n){var r=function(e){var t=new Error;t.httpResponse=e,t.status=e.status;var n=e.data;if(!n)return t.message=e.error&&e.error.toString(),t;if("string"==typeof n)try{n=JSON.parse(n)}catch(e){return t.message=n,t}var r,a,i=e.saveContext;if(o=n.Message||n.ExceptionMessage||n.EntityErrors||n.Errors){for(var o=n;r=o.ExceptionMessage||o.Message,o=o.InnerException;);a=(a=n.Errors||n.EntityErrors)&&a.map(function(e){return{errorName:e.ErrorName,entityTypeName:Ae.normalizeTypeName(e.EntityTypeName),keyValues:e.KeyValues,propertyName:e.PropertyName,errorMessage:e.ErrorMessage}})}else r=n.message,a=n.errors||n.entityErrors;if(i&&a){var s=i.entityManager.metadataStore.namingConvention.serverPropertyNameToClient;a.forEach(function(e){e.propertyName=e.propertyName&&s(e.propertyName)}),t.entityErrors=a}return t.message=r||"Server side errors encountered - see the entityErrors collection on this object for more detail",t}(t);return a._catchNoConnectionError(r),n&&(r.message=n+"; "+r.message),e.reject(r)}return a.checkForRecomposition=function(e){"ajax"===e.interfaceName&&e.isDefault&&this.initialize()},a.initialize=function(){if(!(p=v.config.getAdapterInstance("ajax"))||!p.ajax)throw new Error("Unable to find ajax adapter for dataservice adapter '"+(this.name||"")+"'.")},a.fetchMetadata=function(a,i){var o=i.serviceName,s=i.qualifyUrl("Metadata"),u=Oe.defer();return p.ajax({type:"GET",url:s,dataType:"json",success:function(t){if(a.hasMetadataFor(o))return u.resolve("already fetched");var e=t.data;try{var n="string"==typeof e?JSON.parse(e):e;a.importMetadata(n)}catch(e){var r="Unable to either parse or import metadata: "+e.message;return c(u,t,"Metadata query failed for: "+s+". "+r)}return a.hasMetadataFor(o)||a.addDataService(i),u.resolve(n)},error:function(e){c(u,e,"Metadata query failed for: "+s)}}),u.promise},a.executeQuery=function(e){e.adapter=this;var a=Oe.defer(),t={type:"GET",url:e.getUrl(),params:e.query.parameters,dataType:"json",success:function(t){var e=t.data;try{var n,r=e&&(e.results||e.Results);n=r?{results:r,inlineCount:e.inlineCount||e.InlineCount,httpResponse:t}:{results:e,httpResponse:t},a.resolve(n)}catch(e){e instanceof Error?a.reject(e):c(a,t)}},error:function(e){c(a,e)}};return e.dataService.useJsonp&&(t.dataType="jsonp",t.crossDomain=!0),p.ajax(t),a.promise},a.saveChanges=function(r,e){var a=r.adapter=this,i=Oe.defer();e=a._prepareSaveBundle(r,e);var t=JSON.stringify(e),n=r.dataService.qualifyUrl(r.resourceName);return p.ajax({type:"POST",url:n,dataType:"json",contentType:"application/json",data:t,success:function(e){e.saveContext=r;var t=e.data;if(t.Errors||t.errors)c(i,e);else{var n=a._prepareSaveResult(r,t);n.httpResponse=e,i.resolve(n)}},error:function(e){e.saveContext=r,c(i,e)}}),i.promise},a._prepareSaveBundle=function(){throw new Error("Need a concrete implementation of _prepareSaveBundle")},a.changeRequestInterceptor=u,a._createChangeRequestInterceptor=function(e,t){var n=e.adapter,r=n.changeRequestInterceptor,a=j;if(a(r)){var i=n.name+" DataServiceAdapter's ChangeRequestInterceptor",o=" is missing or not a function.",s=new r(e,t);if(!a(s.getRequest))throw new Error(i+".getRequest"+o);if(!a(s.done))throw new Error(i+".done"+o);return s}return new u(e,t)},a._prepareSaveResult=function(){throw new Error("Need a concrete implementation of _prepareSaveResult")},a.jsonResultsAdapter=new be({name:"noop",visitNode:function(){return{}}}),a._catchNoConnectionError=function(e){0==e.status&&null==e.message&&(e.message="HTTP response status 0 and no message.  Likely did not or could not reach server. Is the server running?")},e}(),v}(e)};"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):breeze=n()}(this);