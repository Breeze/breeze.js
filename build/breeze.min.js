!function(e,t){var r=function(){return function(a){"use strict";var v={version:"1.7.1",metadataVersion:"1.0.5"},M=e(Object.prototype.hasOwnProperty),k=e(Array.prototype.slice),n=function(){try{return!(!Object.getPrototypeOf||!Object.defineProperty({},"x",{}))}catch(e){return!1}}();function T(e,t){for(var r in e)M(e,r)&&t(r,e[r])}function g(e,t){var r=[];for(var n in e)if(M(e,n)){var a=t?t(n,e[n]):e[n];void 0!==a&&r.push(a)}return r}function s(e,t){for(var r in e)if(M(e,r)){var n=e[r];if(t(r,n))return{key:r,value:n}}return null}function c(e,t){if(!n)return null;if(e.hasOwnProperty(t))return Object.getOwnPropertyDescriptor(e,t);var r=Object.getPrototypeOf(e);return null==r?null:c(r,t)}function l(t,r){return function(e){return e[t]===r}}function d(t){return function(e){return e[t]}}function w(e){var t=[];for(var r in e)M(e,r)&&t.push(e[r]);return t}function D(t,r,e){if(!r)return t;if(e)e.forEach(function(e){t[e]=r[e]});else for(var n in r)M(r,n)&&(t[n]=r[n]);return t}function P(e,t){for(var r in t)void 0===e[r]&&(e[r]=t[r]);return e}function i(e,t){return t.defaultInstance=P(new t(e),t.defaultInstance),e}function y(r,e,n){for(var t in n=n||{},e){var a=t.split(","),i=e[t];a.some(function(e){if(!(e in r))return!1;var t=r[e];return"function"!=typeof t&&(t==i||(!(!Array.isArray(t)||0!==t.length)||("function"==typeof i?t=i(t):"object"==typeof t&&t&&t.parentEnum&&(t=t.name),void 0===t||(n[a[0]]=t),!0)))})}return n}function o(e,t){if("entityAspect"!==e&&"complexAspect"!==e&&"entityType"!==e&&"complexType"!==e&&"constructor"!==e&&"_"!==e.charAt(0)&&"$"!==e.charAt(0))return t}function b(e,t){if(e!==Object(e))return e;if(!e._$visited){if(t=t||o,e.toJSON){var r=e.toJSON();if(r!==Object(r))return r;if(r!==e)return b(r,t);e=r}var n;if(e._$visited=!0,e instanceof Array)n=e.map(function(e){return b(e,t)});else if("function"==typeof e)n=void 0;else for(var a in n={},e)if("_$visited"!==a){var i=e[a];t&&void 0===(i=t(a,i))||void 0!==(i=b(i,t))&&(n[a]=i)}return delete e._$visited,n}}function u(a,e){var i={},o=a.length;return e.forEach(function(e){for(var t=0;t<o;t++){var r=a[t];if(r){var n=r[e];if(void 0!==n){i[e]=n;break}}}}),i}function _(e){return null==e?[]:Array.isArray(e)?e:[e]}function N(e,n,a){return a=null==a||a,null==e?e:(Array.isArray(e)?(i=[],e.forEach(function(e,t){var r=n(e,t);(null!=r||a)&&(i[t]=r)})):i=n(e),i);var i}function O(e,t){for(var r=0,n=e.length;r<n;r++)if(t(e[r]))return e[r];return null}function f(e,t){for(var r=0,n=e.length;r<n;r++)if(t(e[r]))return r;return-1}function h(e,t){var r=e.indexOf(t);-1===r&&e.push(t)}function A(e,t,r){for(var n=K(t)?t:void 0,a=e.length-1,i=!1,o=a;0<=o;o--)if((n?n(e[o]):e[o]===t)&&(e.splice(o,1),i=!0,!r))return!0;return i}function C(e,t,r){for(var n=[],a=Math.min(e.length,t.length),i=0;i<a;++i)n.push(r(e[i],t[i]));return n}function m(e,t,r){if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(Array.isArray(e[n])){if(!m(e[n],t[n]))return!1}else if(r){if(!r(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1;return!0}function x(e,t){var r=e[t];return r||(r=[],e[t]=r),r}function p(e){var t=a.window;if(t){var r=t[e];if(r)return r;var n=t.require;if(n){if(n.defined)return n.defined(e)?n(e):void 0;try{return n(e)}catch(e){return}}}}function F(e,t,r,n){var a=e[t];if(r===a)return n();e[t]=r;try{return n()}finally{void 0===a?delete e[t]:e[t]=a}}function I(e,t,r){var n;try{return n=e(),r()}catch(e){throw"object"==typeof n&&(n.error=e),e}finally{t(n)}}function S(a){return function(){for(var e=k(arguments),t="",r=e.length,n=null;r--;)n=e[r],t+=n===Object(n)?JSON.stringify(n):n,a.memoize||(a.memoize={});return t in a.memoize?a.memoize[t]:a.memoize[t]=a.apply(this,e)}}function E(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,r="x"==e?t:3&t|8;return r.toString(16)})}function V(e){if("string"!=typeof e)throw new Error("Invalid ISO8601 duration '"+e+"'");var t=/^P((\d+Y)?(\d+M)?(\d+D)?)?(T(\d+H)?(\d+M)?(\d+S)?)?$/.exec(e);if(!t)throw new Error("Invalid ISO8601 duration '"+e+"'");for(var r=[2,3,4,6,7,8],n=[31104e3,2592e3,86400,3600,60,1],a=0,i=0;i<6;i++){var o=t[r[i]];o=o?+o.replace(/[A-Za-z]+/g,""):0,a+=o*n[i]}return a}function j(){}function r(e){return e}function t(e){return null===e?"null":void 0===e?"undefined":Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function R(e){return"date"===t(e)&&!isNaN(e.getTime())}function K(e){return"function"===t(e)}function q(e){return"string"==typeof e}function z(e){return"string"==typeof e&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(e)}function U(e){return"string"==typeof e&&/^(-|)?P[T]?[\d\.,\-]+[YMDTHS]/.test(e)}function B(e){if(null==e)return!0;for(var t in e)if(M(e,t))return!1;return!0}function $(e,t){return!!e&&(""==t||null==t||0===e.indexOf(t,0))}function L(e,t){return!!e&&(""==t||null==t||-1!==e.indexOf(t,e.length-t.length))}function G(e){var r=arguments,t=RegExp("%([1-"+(arguments.length-1)+"])","g");return e.replace(t,function(e,t){return r[t]})}var J=/([A-Z](?=[A-Z][a-z])|[^A-Z](?=[A-Z])|[a-zA-Z](?=[^a-zA-Z]))/g;function e(e){var t=Function.call;return function(){return t.apply(e,arguments)}}Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Q={};Q.__isES5Supported=n,Q.objectForEach=T,Q.extend=D,Q.propEq=l,Q.pluck=d,Q.arrayEquals=m,Q.arrayFirst=O,Q.arrayIndexOf=f,Q.arrayRemoveItem=A,Q.arrayZip=C,Q.requireLib=function(e,t){for(var r=e.split(";"),n=0,a=r.length;n<a;n++){var i=p(r[n]);if(i)return i}if(t)throw new Error("Unable to initialize "+e+".  "+t)},Q.using=F,Q.memoize=S,Q.getUuid=E,Q.durationToSeconds=V,Q.isDate=R,Q.isGuid=z,Q.isDuration=U,Q.isFunction=K,Q.isEmpty=B,Q.isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},Q.stringStartsWith=$,Q.stringEndsWith=L,Q.formatString=G,Q.titleCase=function(e){return e=(e=e.replace(J,"$1 ")).charAt(0).toUpperCase()+e.slice(1)},Q.getPropertyDescriptor=c,Q.toJSONSafe=b,Q.toJSONSafeReplacer=o,(Q.parent=v).core=Q;var H=function(){var e=function(e,t){this.v=e,this.name=t,this._contexts=[null]},t=e.prototype;function r(e,t){return null!=t&&("string"==typeof t&&0<t.length)}function n(e,t){return null!=t&&typeof t===e.typeName}function a(e,t){return null!=t&&t instanceof e.type}function i(e,t){return null!=t&&void 0!==t[e.propertyName]}function o(e,t){return null!=t&&e.enumType.contains(t)}function s(e,t){return e.allowNull?void 0!==t:null!=t}function u(e,t){if(null==t)return!0;var r=e.prevContext;return!r||r.fn(r,t)}function p(e,t){var r=e.prevContext,n=r?" or it "+y(r,t):"";return"is optional"+n}function c(e,t){if(!Array.isArray(t))return!1;if(e.mustNotBeEmpty&&0===t.length)return!1;var r=e.prevContext;return!r||t.every(function(e){return r.fn(r,e)})}function l(e,t){var r=e.mustNotBeEmpty?"a nonEmpty array":"an array",n=e.prevContext,a=n?" where each element "+y(n,t):"";return" must be "+r+a}function y(e,t){var r=e.msg;return"function"==typeof r&&(r=r(e,t)),r}function f(e,t){if(e._context){for(var r=e._context;null!=r.prevContext;)r=r.prevContext;if(null===r.prevContext)return r.prevContext=t,e;if(null!=t.prevContext)throw new Error("Illegal construction - use 'or' to combine checks");t.prevContext=e._context}return a=t,(n=e)._contexts[n._contexts.length-1]=a,n._context=a,n;var n,a}function h(e,t){throw new Error(G("Error configuring an instance of '%1'. %2",e&&e._$typeName||"object",t))}return t.isObject=function(){return this.isTypeOf("object")},t.isBoolean=function(){return this.isTypeOf("boolean")},t.isString=function(){return this.isTypeOf("string")},t.isNonEmptyString=function(){return f(this,{fn:r,msg:"must be a nonEmpty string"})},t.isNumber=function(){return this.isTypeOf("number")},t.isFunction=function(){return this.isTypeOf("function")},t.isTypeOf=function(e){return f(this,{fn:n,typeName:e,msg:"must be a '"+e+"'"})},t.isInstanceOf=function(e,t){return t=t||e.prototype._$typeName,f(this,{fn:a,type:e,typeName:t,msg:"must be an instance of '"+t+"'"})},t.hasProperty=function(e){return f(this,{fn:i,propertyName:e,msg:"must have a '"+e+"' property"})},t.isEnumOf=function(e){return f(this,{fn:o,enumType:e,msg:"must be an instance of the '"+e.name+"' enumeration"})},t.isRequired=function(e){return f(this,{fn:s,allowNull:e,msg:"is required"})},t.isOptional=function(){var e={fn:u,prevContext:null,msg:p};return f(this,e)},t.isNonEmptyArray=function(){return this.isArray(!0)},t.isArray=function(e){var t={fn:c,mustNotBeEmpty:e,prevContext:null,msg:l};return f(this,t)},t.or=function(){return this._contexts.push(null),this._context=null,this},t.check=function(e){var t=function(t){var e=t._contexts;null==e[e.length-1]&&e.pop();if(0===e.length)return;return e.some(function(e){return e.fn(e,t.v)})}(this);if(void 0!==t){if(!t)throw new Error(this.getMessage());return void 0!==this.v?this.v:e}},t._addContext=function(e){return f(this,e)},t.getMessage=function(){var t=this,e=this._contexts.map(function(e){return y(e,t.v)}).join(", or it ");return G(this.MESSAGE_PREFIX,this.name)+" "+e},t.withDefault=function(e){return this.defaultValue=e,this},t.whereParam=function(e){return this.parent.whereParam(e)},t.applyAll=function(t,r){var e=t._$typeName,n=e&&this.parent.config._$typeName===e,a=D({},this.parent.config);if(this.parent.params.forEach(function(e){n||delete a[e.name];try{e.check()}catch(e){h(t,e.message)}!r&&e._applyOne(t)}),!n)for(var i in a)void 0!==a[i]&&h(t,G("Unknown property: '%1'.",i))},t._applyOne=function(e){void 0!==this.v?e[this.name]=this.v:void 0!==this.defaultValue&&(e[this.name]=this.defaultValue)},t.MESSAGE_PREFIX="The '%1' parameter ",e}(),Z=function(e,t){return new H(e,t)},W=(X=function(e){if("object"!=typeof e)throw new Error("Configuration parameter should be an object, instead it is a: "+typeof e);this.config=e,this.params=[]},ee=X.prototype,ee.whereParam=function(e){var t=new H(this.config[e],e);return(t.parent=this).params.push(t),t},X),Y=function(e){return new W(e)};var X,ee;Q.Param=H,Q.assertParam=Z,Q.assertConfig=Y;var te=function(){var e=function(e,t){this.name=e;var r=new n(t);(r.parentEnum=this)._symbolPrototype=r,t&&Object.keys(t).forEach(function(e){r[e]=t[e]})},t=e.prototype;function n(){}return e.isSymbol=function(e){return e instanceof n},t.fromName=function(e){return this[e]},t.addSymbol=function(t){var r=Object.create(this._symbolPrototype);return t&&Object.keys(t).forEach(function(e){r[e]=t[e]}),setTimeout(function(){r.getName()},0),r},t.resolveSymbols=function(){this.getSymbols().forEach(function(e){return e.getName()})},t.getSymbols=function(){return this.getNames().map(function(e){return this[e]},this)},t.getNames=function(){var e=[];for(var t in this)this.hasOwnProperty(t)&&("name"===t||"_"===t.substr(0,1)||K(this[t])||e.push(t));return e},t.contains=function(e){return e instanceof n&&this[e.getName()]===e},n.prototype.getName=function(){if(!this.name){var t=this;this.name=O(this.parentEnum.getNames(),function(e){return t.parentEnum[e]===t})}return this.name},n.prototype.toString=function(){return this.getName()},n.prototype.toJSON=function(){return{_$typeName:this.parentEnum.name,name:this.name}},e}();Q.Enum=te;var re=function(){var n={},r=1,i=function(e,t,r){Z(e,"eventName").isNonEmptyString().check(),Z(t,"publisher").isObject().check(),this.name=e,n[e]=!0,this.publisher=t,r&&(this._defaultErrorCallback=r)},e=i.prototype;function a(t,r,n){var e=t._subscribers;if(!e)return!0;e.forEach(function(e){try{e.callback(r)}catch(e){e.context="unable to publish on topic: "+t.name,n?n(e):t._defaultErrorCallback&&t._defaultErrorCallback(e)}})}return e.publish=function(e,t,r){return!!i._isEnabled(this.name,this.publisher)&&(!0===t?setTimeout(a,0,this,e,r):a(this,e,r),!0)},e.publishAsync=function(e,t){this.publish(e,!0,t)},e.subscribe=function(e){this._subscribers||(this._subscribers=[]);var t=r;return this._subscribers.push({unsubKey:t,callback:e}),++r,t},e.unsubscribe=function(t){if(!this._subscribers)return!1;var e=this._subscribers,r=f(e,function(e){return e.unsubKey===t});return-1!==r&&(e.splice(r,1),0===e.length&&(this._subscribers=null),!0)},e.clear=function(){this._subscribers=null},i.bubbleEvent=function(e,t){e._getEventParent=t},i.enable=function(e,t,r){Z(e,"eventName").isNonEmptyString().check(),Z(t,"obj").isObject().check(),Z(r,"isEnabled").isBoolean().isOptional().or().isFunction().check(),t._$eventMap||(t._$eventMap={}),t._$eventMap[e]=r},i.isEnabled=function(e,t){if(Z(e,"eventName").isNonEmptyString().check(),Z(t,"obj").isObject().check(),void 0===t._getEventParent)throw new Error("This object does not support event enabling/disabling");return i._isEnabled(e,t)},i._isEnabled=function(e,t){var r=null,n=t._$eventMap;if(n&&(r=n[e]),null!=r)return"function"==typeof r?r(t):!!r;var a=t._getEventParent&&t._getEventParent();return!a||i._isEnabled(e,a)},i}();Q.Event=re;var ne=function(){var a={functionRegistry:{},typeRegistry:{},objectRegistry:{}};a.interfaceInitialized=new re("interfaceInitialized",a);var e=function(e){this.name=e,this.defaultInstance=null,this._implMap={}};function i(e,t,r){var n=t.defaultInstance;return n||(n=new t.ctor,(t.defaultInstance=n)._$impl=t),n.initialize(),r&&(e.defaultInstance=n),a.interfaceInitialized.publish({interfaceName:e.name,instance:n,isDefault:!0}),n.checkForRecomposition&&a.interfaceInitialized.subscribe(function(e){n.checkForRecomposition(e)}),n}function o(e){var r=e.toLowerCase(),t=s(a.interfaceRegistry||{},function(e,t){return e.toLowerCase()===r});if(!t)throw new Error("Unknown interface name: "+e);return t.value}return e.prototype.registerCtor=function(e,t){this._implMap[e.toLowerCase()]={ctor:t,defaultInstance:null}},e.prototype.getImpl=function(e){return this._implMap[e.toLowerCase()]},e.prototype.getFirstImpl=function(){var e=s(this._implMap,function(){return!0});return e?e.value:null},a.interfaceRegistry={ajax:new e("ajax"),modelLibrary:new e("modelLibrary"),dataService:new e("dataService"),uriBuilder:new e("uriBuilder")},a.interfaceRegistry.modelLibrary.getDefaultInstance=function(){if(!this.defaultInstance)throw new Error("Unable to locate the default implementation of the '"+this.name+"' interface.  Possible options are 'ko', 'backingStore' or 'backbone'. See the breeze.config.initializeAdapterInstances method.");return this.defaultInstance},a.setProperties=function(e){Y(e).whereParam("remoteAccessImplementation").isOptional().whereParam("trackingImplementation").isOptional().whereParam("ajaxImplementation").isOptional().applyAll(e),e.remoteAccessImplementation&&a.initializeAdapterInstance("dataService",e.remoteAccessImplementation),e.trackingImplementation&&a.initializeAdapterInstance("modelLibrary",e.trackingImplementation),e.ajaxImplementation&&a.initializeAdapterInstance("ajax",e.ajaxImplementation)},a.registerAdapter=function(e,t){Z(e,"interfaceName").isNonEmptyString().check(),Z(t,"adapterCtor").isFunction().check();var r=new t,n=r.name;if(!n)throw new Error("Unable to locate a 'name' property on the constructor passed into the 'registerAdapter' call.");var a=o(e);a.registerCtor(n,t)},a.getAdapter=function(e,t){var r=o(e);if(t){var n=r.getImpl(t);return n?n.ctor:null}return r.defaultInstance?r.defaultInstance._$impl.ctor:null},a.initializeAdapterInstances=function(e){return Y(e).whereParam("dataService").isOptional().whereParam("modelLibrary").isOptional().whereParam("ajax").isOptional().whereParam("uriBuilder").isOptional().applyAll(this,!1),g(e,a.initializeAdapterInstance)},a.initializeAdapterInstance=function(e,t,r){r=void 0===r||r,Z(e,"interfaceName").isNonEmptyString().check(),Z(t,"adapterName").isNonEmptyString().check(),Z(r,"isDefault").isBoolean().check();var n=o(e),a=n.getImpl(t);if(!a)throw new Error("Unregistered adapter.  Interface: "+e+" AdapterName: "+t);return i(n,a,r)},a.getAdapterInstance=function(e,t){var r,n=o(e),a=null==t||""==t;if(a){if(n.defaultInstance)return n.defaultInstance;r=n.getFirstImpl()}else r=n.getImpl(t);return r?r.defaultInstance?r.defaultInstance:i(n,r,a):null},a.registerFunction=function(e,t){Z(e,"fn").isFunction().check(),Z(t,"fnName").isString().check(),e.prototype._$fnName=t,a.functionRegistry[t]=e},a.getRegisteredFunction=function(e){return a.functionRegistry[e]},a._storeObject=function(e,t,r){var n=("string"==typeof t?t:t.prototype._$typeName)+"."+r;a.objectRegistry[n]=e},a._fetchObject=function(e,t){if(t){var r=("string"==typeof e?e:e.prototype._$typeName)+"."+t,n=a.objectRegistry[r];if(!n)throw new Error("Unable to locate a registered object by the name: "+r);return n}},a.registerType=function(e,t){Z(e,"ctor").isFunction().check(),Z(t,"typeName").isString().check(),e.prototype._$typeName=t,a.typeRegistry[t]=e},a.stringifyPad="",a}(),ae=ne.interfaceRegistry.modelLibrary;Q.config=ne,v.config=ne;var ie=function(){var e={};function n(e,t){e._processAdds(t),r(e,"arrayChanged",{array:e,added:t})}function a(e,t){e._processRemoves(t),r(e,"arrayChanged",{array:e,removed:t})}function r(e,t,r){var n=e._getPendingPubs();n?e._pendingArgs?function(e,t){for(var r in t)if("array"!==r&&e.hasOwnProperty(r)){var n=t[r],a=e[r];if(a){if(!Array.isArray(a))throw new Error("Cannot combine non array args");Array.prototype.push.apply(a,n)}else e[r]=n}}(e._pendingArgs,r):(e._pendingArgs=r,n.push(function(){e[t].publish(e._pendingArgs),e._pendingArgs=null})):e[t].publish(r)}return e.push=function(){if(this._inProgress)return-1;var e=this._getGoodAdds(k(arguments));if(!e.length)return this.length;this._beforeChange();var t=Array.prototype.push.apply(this,e);return n(this,e),t},e._push=function(){if(this._inProgress)return-1;var e=k(arguments);this._beforeChange();var t=Array.prototype.push.apply(this,e);return n(this,e),t},e.unshift=function(){var e=this._getGoodAdds(k(arguments));if(!e.length)return this.length;this._beforeChange();var t=Array.prototype.unshift.apply(this,e);return n(this,k(e)),t},e.pop=function(){this._beforeChange();var e=Array.prototype.pop.apply(this);return a(this,[e]),e},e.shift=function(){this._beforeChange();var e=Array.prototype.shift.apply(this);return a(this,[e]),e},e.splice=function(){var e=this._getGoodAdds(k(arguments,2)),t=k(arguments,0,2).concat(e);this._beforeChange();var r=Array.prototype.splice.apply(this,t);return a(this,r),e.length&&n(this,e),r},e.getEntityAspect=function(){return this.parent.entityAspect||this.parent.complexAspect.getEntityAspect()},e._getEventParent=function(){return this.getEntityAspect()},e._getPendingPubs=function(){var e=this.getEntityAspect().entityManager;return e&&e._pendingPubs},e._beforeChange=function(){},{mixin:e,publish:r,updateEntityState:function(e){var t=e.getEntityAspect();t.entityState.isUnchanged()&&t.setModified();t.entityState.isModified()&&!e._origValues&&(e._origValues=e.slice(0))},initializeParent:function(e,t,r){e.parent=t,e.parentProperty=r}}}(),oe=function(){var n={displayName:function(e){return e.property?e.property.resolveProperty("displayName")||e.propertyName||e.property.name:"Value"}},i=function(e,t,r){this._baseContext=r||{},this._baseContext.name=e,(r=D(Object.create(n),this._baseContext)).messageTemplate=r.messageTemplate||i.messageTemplates[e],this.name=e,this.valFn=t,this.context=r},e=i.prototype;function t(e,t,r,n){r&&(i.messageTemplates[e]=r);var a="string"==typeof t?new RegExp(t):t;return new i(e,function(e){return null==e||""===e||"string"==typeof e&&a.test(e)},n)}function r(e,r,n,t){t=t||{},void 0!==r&&(t.min=r),void 0!==n&&(t.max=n);var a=t.messageTemplate||i.messageTemplates[e];return a||(i.messageTemplates[e]=G("'%displayName%' must be an integer between the values of %1 and %2",r,n)),function(){return new i(e,function(e,t){if(null==e)return!0;"string"==typeof e&&t&&t.allowString&&(e=parseInt(e,0));return"number"==typeof e&&!isNaN(e)&&Math.floor(e)===e&&(!(null!=r&&e<r)&&!(null!=n&&n<e))},t)}}return e._$typeName="Validator",e.validate=function(e,t){var r;r=t?D(Object.create(this.context),t):this.context,this.currentContext=r;try{return this.valFn(e,r)?null:(r.value=e,new se(this,r,this.getMessage()))}catch(e){return new se(this,r,"Exception occured while executing this validator: "+this.name)}},e.getMessage=function(){try{var e=this.currentContext,t=e.message;return t?"function"==typeof t?t(e):t:e.messageTemplate?(r=e.messageTemplate,(n=e)?r.replace(/%([^%]+)%/g,function(e,t){var r;return null!=(r=a?n.hasOwnProperty(t)?n[t]:"":n[t])?K(r)?r(n):r:""}):r):"invalid value: "+(this.name||"{unnamed validator}")}catch(e){return"Unable to format error message"+e.toString()}var r,n,a},e.toJSON=function(){return this._baseContext},i.fromJSON=function(e){if(Array.isArray(e))return e.map(function(e){return i.fromJSON(e)});var t="Validator."+e.name,r=ne.getRegisteredFunction(t);if(!r)throw new Error("Unable to locate a validator named:"+e.name);return r(e)},i.register=function(e){ne.registerFunction(function(){return e},"Validator."+e.name)},i.registerFactory=function(e,t){ne.registerFunction(e,"Validator."+t)},i.messageTemplates={bool:"'%displayName%' must be a 'true' or 'false' value",creditCard:"The %displayName% is not a valid credit card number",date:"'%displayName%' must be a date",duration:"'%displayName%' must be a ISO8601 duration string, such as 'P3H24M60S'",emailAddress:"The %displayName% '%value%' is not a valid email address",guid:"'%displayName%' must be a GUID",integer:"'%displayName%' must be an integer",integerRange:"'%displayName%' must be an integer between the values of %minValue% and %maxValue%",maxLength:"'%displayName%' must be a string with %maxLength% characters or less",number:"'%displayName%' must be a number",phone:"The %displayName% '%value%' is not a valid phone number",regularExpression:"The %displayName% '%value%' does not match '%expression%'",required:"'%displayName%' is required",string:"'%displayName%' must be a string",stringLength:"'%displayName%' must be a string with between %minLength% and %maxLength% characters",url:"The %displayName% '%value%' is not a valid url"},i.required=function(e){return new i("required",function(e,t){return"string"==typeof e?!(!t||!t.allowEmptyStrings)||0<e.length:null!=e},e)},i.maxLength=function(e){return new i("maxLength",function(e,t){return null==e||"string"==typeof e&&e.length<=t.maxLength},e)},i.stringLength=function(e){return new i("stringLength",function(e,t){return!(null!=e&&("string"!=typeof e||null!=t.minLength&&e.length<t.minLength||null!=t.maxLength&&e.length>t.maxLength))},e)},i.string=function(){return new i("string",function(e){return null==e||"string"==typeof e})},i.guid=function(){return new i("guid",function(e){return null==e||z(e)})},i.duration=function(){return new i("duration",function(e){return null==e||U(e)})},i.number=i.double=i.single=function(e){return new i("number",function(e,t){if(null==e)return!0;"string"==typeof e&&t&&t.allowString&&(e=parseFloat(e,10));return"number"==typeof e&&!isNaN(e)},e)},i.integer=i.int64=function(e){return new i("integer",function(e,t){if(null==e)return!0;"string"==typeof e&&t&&t.allowString&&(e=parseInt(e,10));return"number"==typeof e&&!isNaN(e)&&Math.floor(e)===e},e)},i.int32=function(e){return r("int32",-2147483648,2147483647,e)()},i.int16=function(e){return r("int16",-32768,32767,e)()},i.byte=function(e){return r("byte",0,255,e)()},i.bool=function(){return new i("bool",function(e){return null==e||!0===e||!1===e})},i.none=function(){return new i("none",function(e){return!0})},i.date=function(){return new i("date",function(e){if(null==e)return!0;{if("string"!=typeof e)return R(e);try{return!isNaN(Date.parse(e))}catch(e){return!1}}})},i.creditCard=function(e){return new i("creditCard",function(e){return null==e||""===e||"string"==typeof e&&!(!(e=e.replace(/(\-|\s)/g,""))||/\D/.test(e))&&function(e,t,r,n,a){for(n=+e[t=e.length-1],a=0;t--;)r=+e[t],n+=++a%2?2*r%10+(4<r):r;return!(n%10)}(e)},e)},i.regularExpression=function(e){return new i("regularExpression",function(e,t){if(null==e||""===e)return!0;if("string"!=typeof e)return!1;try{var r=new RegExp(t.expression)}catch(e){throw new Error("Missing or invalid expression parameter to regExp validator")}return r.test(e)},e)},i.emailAddress=function(e){return t("emailAddress",/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,null,e)},i.phone=function(e){return t("phone",/^((\+|(0(\d+)?[-/.\s]?))[1-9]\d{0,2}[-/.\s]?)?((\(\d{1,6}\)|\d{1,6})[-/.\s]?)?(\d+[-/.\s]?)+\d+$/,null,e)},i.url=function(e){return t("url",/^(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|([a-zA-Z][\-a-zA-Z0-9]*)|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-fA-F]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/,null,e)},i.makeRegExpValidator=t,T(i,function(e,t){"function"==typeof t&&"fromJSON"!==e&&"register"!==e&&"registerFactory"!==e&&"makeRegExpValidator"!==e&&ne.registerFunction(t,"Validator."+e)}),i}(),se=(ue=function e(t,r,n,a){Z(t,"validator").isOptional().isInstanceOf(oe).check(),Z(n,"errorMessage").isNonEmptyString().check(),Z(a,"key").isOptional().isNonEmptyString().check(),this.validator=t,r=r||{},this.context=r,this.errorMessage=n,this.property=r.property,this.propertyName=r.propertyName||r.property&&r.property.name,this.key=a||e.getKey(t||n,this.propertyName),this.isServerError=!1},ue.getKey=function(e,t){return(e.name||e)+(t?":"+t:"")},ue);var ue;v.Validator=oe,v.ValidationError=se;var pe=function(){var e=function(e){r(this,e)},t=e.prototype;function r(e,t){return t&&Y(t).whereParam("validateOnAttach").isBoolean().isOptional().whereParam("validateOnSave").isBoolean().isOptional().whereParam("validateOnQuery").isBoolean().isOptional().whereParam("validateOnPropertyChange").isBoolean().isOptional().applyAll(e),e}return t._$typeName="ValidationOptions",t.using=function(e){if(!e)return this;var t=new pe(this);return r(t,e),t},t.setAsDefault=function(){return i(this,e)},e.defaultInstance=new e({validateOnAttach:!0,validateOnSave:!0,validateOnQuery:!1,validateOnPropertyChange:!0}),e}();v.ValidationOptions=pe,v.makeComplexArray=function(){var n={};function r(e,t){var r=e.complexAspect;return r.parent!==t.parent?null:(r.parent=null,r.parentProperty=null,r)}return n._getGoodAdds=function(e){return t=this,e.filter(function(e){return e.parent!==t.parent});var t},n._beforeChange=function(){ie.updateEntityState(this)},n._processAdds=function(e){var n;n=this,e.forEach(function(e){if(null!=e.parent)throw new Error("The complexObject is already attached. Either clone it or remove it from its current owner");var t,r;t=n,(r=e.complexAspect).parent!==t.parent&&(r.parent=t.parent,r.parentProperty=t.parentProperty)})},n._processRemoves=function(e){var t;t=this,e.forEach(function(e){r(e,t)})},n._rejectChanges=function(){if(this._origValues){var t=this;this.forEach(function(e){r(e,t)}),this.length=0,this._origValues.forEach(function(e){t.push(e)})}},n._acceptChanges=function(){this._origValues=null},function(e,t,r){return ie.initializeParent(e,t,r),e.arrayChanged=new re("arrayChanged",e),D(e,ie.mixin),D(e,n)}}();var ce=(le=new te("EntityAction",{isAttach:function(){return!!this.isAttach},isDetach:function(){return!!this.isDetach},isModification:function(){return!!this.isModification}}),le.Attach=le.addSymbol({isAttach:!0}),le.AttachOnQuery=le.addSymbol({isAttach:!0}),le.AttachOnImport=le.addSymbol({isAttach:!0}),le.Detach=le.addSymbol({isDetach:!0}),le.MergeOnQuery=le.addSymbol({isModification:!0}),le.MergeOnImport=le.addSymbol({isModification:!0}),le.MergeOnSave=le.addSymbol({isModification:!0}),le.PropertyChange=le.addSymbol({isModification:!0}),le.EntityStateChange=le.addSymbol(),le.AcceptChanges=le.addSymbol(),le.RejectChanges=le.addSymbol({isModification:!0}),le.Clear=le.addSymbol({isDetach:!0}),le.resolveSymbols(),le);var le;v.EntityAction=ce;var ye=function(){var e=function e(t){if(null===t){var r=e._nullInstance;if(r)return r;e._nullInstance=this}else{if(void 0===t)throw new Error("The EntityAspect ctor requires an entity as its only argument.");if(t.entityAspect)return t.entityAspect}if(!(this instanceof e))return new e(t);if(this.entity=t,this.entityGroup=null,this.entityManager=null,this.entityState=ve.Detached,this.isBeingSaved=!1,this.originalValues={},this.hasValidationErrors=!1,this._validationErrors={},this.validationErrorsChanged=new re("validationErrorsChanged",this),this.propertyChanged=new re("propertyChanged",this),null!=t){t.entityAspect=this;var n=t.entityType||t._$entityType;if(!n){var a=t.prototype._$typeName;throw a?new Error("Metadata for this entityType has not yet been resolved: "+a):new Error("This entity is not registered as a valid EntityType")}var i=n.getEntityCtor();ae.getDefaultInstance().startTracking(t,i.prototype)}},t=e.prototype;function i(r){var e=r.entityAspect||r.complexAspect,t=r.entityType||r.complexType,n=e.originalValues;for(var a in n)r.setProperty(a,n[a]);t.complexProperties.forEach(function(e){var t=r.getProperty(e.name);e.isScalar?i(t):(t._rejectChanges(),t.forEach(i))})}function o(r){var e=r.entityAspect||r.complexAspect;e.originalValues={};var t=r.entityType||r.complexType;t.complexProperties.forEach(function(e){var t=r.getProperty(e.name);e.isScalar?o(t):(t._acceptChanges(),t.forEach(o))})}function u(n,e){var a=!0,t=n.entityType||n.complexType,i=n.entityAspect||n.complexAspect,o=n.entityAspect||n.complexAspect.getEntityAspect(),s={entity:o.entity};return void 0!==e&&(s.index=e),t.getProperties().forEach(function(e){var t=n.getProperty(e.name),r=e.getAllValidators();0<r.length&&(s.property=e,s.propertyName=i.getPropertyPath(e.name),a=o._validateProperty(t,s)&&a),e.isComplexProperty&&(a=e.isScalar?u(t)&&a:t.reduce(function(e,t,r){return u(t,r)&&e},a))}),t.getAllValidators().forEach(function(e){a=p(o,e,n)&&a}),a}function s(e,t){var r=t.isDeleted();r?n(e):F(e.entityAspect.entityManager,"isLoading",!0,function(){n(e)})}function n(a){a.entityType.navigationProperties.forEach(function(e){var t=e.getInverse(),r=a.getProperty(e.name);if(e.isScalar){if(r){if(t)if(t.isScalar)r.setProperty(t.name,null);else{var n=r.getProperty(t.name);n.length&&A(n,a)}a.setProperty(e.name,null)}}else t&&r.slice(0).forEach(function(e){t.isScalar&&e.setProperty(t.name,null)}),r.length=0})}function p(e,t,r,n){var a=t.validate(r,n);if(a)return e._addValidationError(a),!1;var i=se.getKey(t,n?n.propertyName:null);return e._removeValidationError(i),!0}return re.bubbleEvent(t,function(){return this.entityManager}),t.getKey=function(e){if((e=Z(e,"forceRefresh").isBoolean().isOptional().check(!1))||!this._entityKey){var t=this.entity.entityType,r=t.keyProperties,n=r.map(function(e){return this.entity.getProperty(e.name)},this);this._entityKey=new me(t,n)}return this._entityKey},t.acceptChanges=function(){this._checkOperation("acceptChanges");var e=this.entityManager;this.entityState.isDeleted()?e.detachEntity(this.entity):this.setUnchanged(),e.entityChanged.publish({entityAction:ce.AcceptChanges,entity:this.entity})},t.rejectChanges=function(){this._checkOperation("rejectChanges");var e=this.entity,t=this.entityManager;F(t,"isRejectingChanges",!0,function(){i(e)}),this.entityState.isAdded()?(t.detachEntity(e),t._notifyStateChange(e,!1)):(this.entityState.isDeleted()&&this.entityManager._linkRelatedEntities(e),this.setUnchanged(),this.propertyChanged.publish({entity:e,propertyName:null}),this.entityManager.entityChanged.publish({entityAction:ce.RejectChanges,entity:e}))},t.getPropertyPath=function(e){return e},t.setAdded=function(){return this.setEntityState(ve.Added)},t.setUnchanged=function(){return this.setEntityState(ve.Unchanged)},t.setModified=function(){return this.setEntityState(ve.Modified)},t.setDeleted=function(){return this.setEntityState(ve.Deleted)},t.setDetached=function(){return this.setEntityState(ve.Detached)},t.setEntityState=function(e){if(this.entityState===e)return!1;if(this._checkOperation("setEntityState"),this.entityState.isDetached())throw new Error("You cannot set the 'entityState' of an entity when it is detached - except by first attaching it to an EntityManager");var t=this.entity,r=this.entityManager,n=!0;if(e===ve.Unchanged)o(t),delete this.hasTempKey,n=!1;else if(e===ve.Added)o(t);else if(e===ve.Deleted){if(this.entityState.isAdded())return this.setEntityState(ve.Detached),!0;this.entityState=ve.Deleted,s(t,ve.Deleted)}else if(e===ve.Modified);else if(e===ve.Detached){var a=this.entityGroup;if(!a)return!1;a.detachEntity(t),this.entityState=e,s(t,ve.Detached),this._detach(),r.entityChanged.publish({entityAction:ce.Detach,entity:t}),n=!1}return this.entityState=e,r._notifyStateChange(t,n),!0},t.loadNavigationProperty=function(e,t,r){var n=this.entity,a=n.entityType._checkNavProperty(e),i=Xe.fromEntityNavigation(n,a),o=n.entityAspect.entityManager.executeQuery(i),s=this;return o.then(function(e){return s._markAsLoaded(a.name),t&&t(e),Oe.resolve(e)},function(e){return r&&r(e),Oe.reject(e)})},t.markNavigationPropertyAsLoaded=function(e){var t=this.entity.entityType._checkNavProperty(e);this._markAsLoaded(t.name)},t.isNavigationPropertyLoaded=function(e){var t=this.entity.entityType._checkNavProperty(e);return!(!t.isScalar||null==this.entity.getProperty(t.name))||this._loadedNps&&0<=this._loadedNps.indexOf(t.name)},t._markAsLoaded=function(e){this._loadedNps=this._loadedNps||[],h(this._loadedNps,e)},t.validateEntity=function(){var t=!0;return this._processValidationOpAndPublish(function(e){t=u(e.entity)}),t},t.validateProperty=function(e,t){var r=this.getPropertyValue(e);return r&&r.complexAspect?u(r):((t=t||{}).entity=this.entity,"string"==typeof e?(t.property=this.entity.entityType.getProperty(e,!0),t.propertyName=e):(t.property=e,t.propertyName=e.name),this._validateProperty(r,t))},t.getValidationErrors=function(e){Z(e,"property").isOptional().isEntityProperty().or().isString().check();var t=w(this._validationErrors);if(e){var r="string"==typeof e?e:e.name;t=t.filter(function(e){return e.property&&(e.property.name===r||-1!=r.indexOf(".")&&e.propertyName==r)})}return t},t.addValidationError=function(t){Z(t,"validationError").isInstanceOf(se).check(),this._processValidationOpAndPublish(function(e){e._addValidationError(t)})},t.removeValidationError=function(e){Z(e,"validationErrorOrKey").isString().or().isInstanceOf(se).or().isInstanceOf(oe).check();var t="string"==typeof e?e:e.key;this._processValidationOpAndPublish(function(e){e._removeValidationError(t)})},t.clearValidationErrors=function(){this._processValidationOpAndPublish(function(r){T(r._validationErrors,function(e,t){t&&(delete r._validationErrors[e],r._pendingValidationResult.removed.push(t))}),r.hasValidationErrors=!B(r._validationErrors)})},t.getParentKey=function(e){var t=e.foreignKeyNames;if(0===t.length)return null;var r=this,n=t.map(function(e){return r.entity.getProperty(e)});return new me(e.entityType,n)},t.getPropertyValue=function(e){var t;if(Z(e,"property").isString().or().isEntityProperty().check(),"string"==typeof e){var r=e.trim().split("."),n=r.shift();for(t=(t=this.entity).getProperty(n);0<r.length;)n=r.shift(),t=t.getProperty(n)}else{if(!(e.parentType instanceof xe))throw new Error("The validateProperty method does not accept a 'property' parameter whose parentType is a ComplexType; Pass a 'property path' string as the 'property' parameter instead ");t=this.entity.getProperty(e.name)}return t},t._checkOperation=function(e){if(this.isBeingSaved)throw new Error("Cannot perform a '"+e+"' on an entity that is in the process of being saved");return this},t._detach=function(){this.entityGroup=null,this.entityManager=null,this.entityState=ve.Detached,this.originalValues={},this._validationErrors={},this.hasValidationErrors=!1,this.validationErrorsChanged.clear(),this.propertyChanged.clear()},t._validateProperty=function(r,n){var a=!0;return this._processValidationOpAndPublish(function(t){n.property.getAllValidators().forEach(function(e){a=p(t,e,r,n)&&a})}),a},t._processValidationOpAndPublish=function(e){if(this._pendingValidationResult)e(this);else try{this._pendingValidationResult={entity:this.entity,added:[],removed:[]},e(this),(0<this._pendingValidationResult.added.length||0<this._pendingValidationResult.removed.length)&&(this.validationErrorsChanged.publish(this._pendingValidationResult),this.entityManager&&this.entityManager.validationErrorsChanged.publish(this._pendingValidationResult))}finally{this._pendingValidationResult=void 0}},t._addValidationError=function(e){this._validationErrors[e.key]=e,this.hasValidationErrors=!0,this._pendingValidationResult.added.push(e)},t._removeValidationError=function(e){var t=this._validationErrors[e];t&&(delete this._validationErrors[e],this.hasValidationErrors=!B(this._validationErrors),this._pendingValidationResult.removed.push(t))},e}(),fe=(he=function e(t,r,n){if(!t)throw new Error("The  ComplexAspect ctor requires an entity as its only argument.");if(t.complexAspect)return t.complexAspect;if(!(this instanceof e))return new e(t,r,n);((this.complexObject=t).complexAspect=this).originalValues={},null!=r&&(this.parent=r,this.parentProperty=n);var a=t.complexType;if(!a){var i=t.prototype._$typeName;throw i?new Error("Metadata for this complexType has not yet been resolved: "+i):new Error("This entity is not registered as a valid ComplexType")}var o=a.getCtor();ae.getDefaultInstance().startTracking(t,o.prototype)},de=he.prototype,de.getEntityAspect=function(){var e=this.parent;if(!e)return new ye(null);for(var t=e.entityAspect;e&&!t;)e=e.complexAspect&&e.complexAspect.parent,t=e&&e.entityAspect;return t||new ye(null)},de.getPropertyPath=function(e){var t=this.parent;if(!t)return null;var r=t.complexAspect||t.entityAspect;return r.getPropertyPath(this.parentProperty.name+"."+e)},he);var he,de;v.EntityAspect=ye,v.ComplexAspect=fe;var me=function(){var t=":::",e=function(e,r){Z(e,"entityType").isInstanceOf(xe).check();var t=e.getSelfAndSubtypes();1<t.length&&(this._subtypes=t.filter(function(e){return!1===e.isAbstract})),Array.isArray(r)||(r=k(arguments,1)),(this.entityType=e).keyProperties.forEach(function(e,t){e.dataType===be.Guid&&(r[t]=r[t]&&r[t].toLowerCase())}),this.values=r,this._keyInGroup=n(r)};e._$typeName="EntityKey";var r=e.prototype;function n(e){return e.join(t)}return r.toJSON=function(){return{entityType:this.entityType.name,values:this.values}},e.fromJSON=function(e,t){var r=t._getEntityType(e.entityType,!0);return new me(r,e.values)},r.equals=function(e){return e instanceof me&&(this.entityType===e.entityType&&m(this.values,e.values))},r.toString=function(e){return(e||this.entityType).name+"-"+this._keyInGroup},e.equals=function(e,t){return e instanceof me&&e.equals(t)},r._isEmpty=function(){return 0===this.values.join("").length},e.createKeyString=n,e}();v.EntityKey=me;var ve=(ge={isUnchanged:function(){return this===we.Unchanged},isAdded:function(){return this===we.Added},isModified:function(){return this===we.Modified},isDeleted:function(){return this===we.Deleted},isDetached:function(){return this===we.Detached},isUnchangedOrModified:function(){return this===we.Unchanged||this===we.Modified},isAddedModifiedOrDeleted:function(){return this===we.Added||this===we.Modified||this===we.Deleted}},we=new te("EntityState",ge),we.Unchanged=we.addSymbol(),we.Added=we.addSymbol(),we.Modified=we.addSymbol(),we.Deleted=we.addSymbol(),we.Detached=we.addSymbol(),we.resolveSymbols(),we);var ge,we;function Se(e,t,r){void 0===t&&(t=null);var n=r(),a=e.dataType;if(a&&a.parse&&(t=Array.isArray(t)&&!e.isScalar?t.map(function(e){return a.parse(e,typeof e)}):a.parse(t,typeof t)),!(t===n||a&&a.normalize&&t&&n&&a.normalize(t)===a.normalize(n))){var i,o=this.entityAspect;if(o)i=e.name;else{var s=this.complexAspect;if(!s)return void r(t);o=s.getEntityAspect(),i=s.getPropertyPath(e.name)}var u=o._inProcess=o._inProcess||[];if(!(0<=u.indexOf(e))){u.push(e);try{var p={parent:this,property:e,newValue:t,oldValue:n,propertyName:i,entityAspect:o};e.isComplexProperty?function(e,t){var r=e.property,n=e.oldValue,a=e.newValue,i=r.dataType;{if(!r.isScalar)throw new Error(G("You cannot set the non-scalar complex property: '%1' on the type: '%2'.Instead get the property and use array functions like 'push' or 'splice' to change its contents.",r.name,r.parentType.name));if(!a)throw new Error(G("You cannot set the '%1' property to null because it's datatype is the ComplexType: '%2'",r.name,r.dataType.name));if(!n){var o=i.getCtor();n=new o,t(n)}i.dataProperties.forEach(function(e){var t=e.name,r=a.getProperty(t);n.setProperty(t,r)})}}(p,r):e.isDataProperty?function(e,t){var i=e.parent,r=e.property,n=e.entityAspect,a=e.oldValue,o=e.newValue,s=n.entityManager,u=i.entityType;if(!r.isScalar)throw new Error("Nonscalar data properties are readonly - items may be added or removed but the collection may not be changed.");if(n.entityState.isUnchangedOrModified()){var p=r.name,c=i.entityAspect||i.complexAspect;void 0===c.originalValues[p]&&(c.originalValues[p]=void 0!==a?a:r.defaultValue)}if(r.isPartOfKey&&s&&!s.isLoading){var l=u.keyProperties,y=l.map(function(e){return e===r?o:i.getProperty(e.name)}),f=new me(u,y);if(s.findEntityByKey(f))throw new Error("An entity with this key is already in the cache: "+f.toString());var h=i.entityAspect.getKey(),d=s._findEntityGroup(u);d._replaceKey(h,f)}var m=r.relatedNavigationProperty;if(m&&s)if(null!=o){var v=new me(m.entityType,[o]),g=s.findEntityByKey(v);g?i.setProperty(m.name,g):(s._unattachedChildrenMap.addChild(v,m,i),i.setProperty(m.name,null))}else i.setProperty(m.name,null);else if(r.inverseNavigationProperty&&s&&!s._inKeyFixup){var w=r.inverseNavigationProperty;if(null!=a&&(v=new me(w.parentType,[a]),g=s.findEntityByKey(v)))if(w.isScalar)g.setProperty(w.name,null);else{var S=g.getProperty(w.name);S.splice(S.indexOf(i),1)}null!=o&&(v=new me(w.parentType,[o]),(g=s.findEntityByKey(v))?w.isScalar?g.setProperty(w.name,i):g.getProperty(w.name).push(i):s._unattachedChildrenMap.addChild(v,w,i))}if(t(o),Ee(e),r.isPartOfKey){var E=u.keyProperties.indexOf(r);if(u.navigationProperties.forEach(function(e){var t=e.getInverse(),r=t?t.foreignKeyNames:e.invForeignKeyNames;if(0!==r.length){var n=i.getProperty(e.name);if(n){var a=r[E];e.isScalar?n.setProperty(a,o):n.forEach(function(e){e.setProperty(a,o)})}}}),s){for(var T=u.inverseForeignKeyProperties,P=u.baseEntityType;P;)T=T.concat(P.inverseForeignKeyProperties),P=P.baseEntityType;T.forEach(function(e){null==e.relatedNavigationProperty.inverse&&s._updateFkVal(e,a,o)})}n.getKey(!0)}}(p,r):function(e,t){var a=e.parent,i=e.property,r=e.entityAspect,n=e.oldValue,o=e.newValue;if(!i.isScalar)throw new Error("Nonscalar navigation properties are readonly - entities can be added or removed but the collection may not be changed.");var s=r.entityManager,u=i.getInverse();if(null!=o){var p=o.entityAspect;if(s){if(p.entityState.isDetached())s.isLoading||s.attachEntity(o,ve.Added);else if(p.entityManager!==s)throw new Error("An Entity cannot be attached to an entity in another EntityManager. One of the two entities must be detached first.")}else p&&p.entityManager&&((s=p.entityManager).isLoading||s.attachEntity(r.entity,ve.Added))}if(u)if(u.isScalar)null!=n&&n.setProperty(u.name,null),null!=o&&o.setProperty(u.name,a);else{if(null!=n){var c=n.getProperty(u.name),l=c.indexOf(a);-1!==l&&c.splice(l,1)}if(null!=o){var y=o.getProperty(u.name);y.push(a)}}else if(i.invForeignKeyNames&&s&&!s._inKeyFixup){var f=i.invForeignKeyNames;if(null!=o){var h=a.entityAspect.getKey().values;f.forEach(function(e,t){o.setProperty(e,h[t])})}else null!=n&&f.forEach(function(e){var t=n.entityType.getProperty(e);t.isPartOfKey||n.setProperty(e,null)})}if(t(o),Ee(e),i.relatedDataProperties){var d=r.entityState;if(null==o&&(d.isDetached()||n.entityAspect.entityState.isDetached()))return;if(d.isDeleted())return;var m=i.entityType.keyProperties;m.forEach(function(e,t){var r=i.relatedDataProperties[t];if(o||!r.isPartOfKey){var n=o?o.getProperty(e.name):r.defaultValue;a.setProperty(r.name,n)}})}}(p,r),l=(c=p).entityAspect,y=l.entityManager,f=l.entity,h={entity:f,parent:c.parent,property:c.property,propertyName:c.propertyName,oldValue:c.oldValue,newValue:c.newValue},y?y.isLoading||y.isRejectingChanges||(l.propertyChanged.publish(h),y.entityChanged.publish({entityAction:ce.PropertyChange,entity:f,args:h})):l.propertyChanged.publish(h)}finally{u.pop()}var c,l,y,f,h}}}function Ee(e){var t=e.entityAspect,r=t.entityManager;if(null!=r&&!r.isLoading){var n=e.property;t.entityState.isUnchanged()&&!n.isUnmapped&&t.setModified(),r.validationOptions.validateOnPropertyChange&&t._validateProperty(e.newValue,{entity:t.entity,property:n,propertyName:e.propertyName,oldValue:e.oldValue})}}v.EntityState=ve,v.makePrimitiveArray=(Pe={},Pe._getGoodAdds=function(e){return e},Pe._beforeChange=function(){var e=this.getEntityAspect();e.entityState.isUnchanged()&&e.setModified(),e.entityState.isModified()&&!this._origValues&&(this._origValues=this.slice(0))},Pe._processAdds=function(e){},Pe._processRemoves=function(e){},Pe._rejectChanges=function(){this._origValues&&(this.length=0,Array.prototype.push.apply(this,this._origValues))},Pe._acceptChanges=function(){this._origValues=null},function(e,t,r){return ie.initializeParent(e,t,r),e.arrayChanged=new re("arrayChanged",e),D(e,ie.mixin),D(e,Pe)}),v.makeRelationArray=(Te={},Te.load=function(e,t){var r=this.parentEntity,n=Xe.fromEntityNavigation(this.parentEntity,this.navigationProperty),a=r.entityAspect.entityManager;return a.executeQuery(n,e,t)},Te._getEventParent=function(){return this.parentEntity.entityAspect},Te._getPendingPubs=function(){var e=this.parentEntity.entityAspect.entityManager;return e&&e._pendingPubs},Te._getGoodAdds=function(e){return function(t,e){var r=function(r,e){var t,o=r.parentEntity,n=r.navigationProperty,a=n.getInverse();if(a)t=e.filter(function(e){if(0<=r._addsInProcess.indexOf(e))return!1;var t=e.getProperty(a.name);return t!==o});else{var s=n.invForeignKeyNames;n.baseProperty&&!s.length&&(s=n.baseProperty.invForeignKeyNames);var u=o.entityType.keyProperties;t=e.filter(function(i){return!(0<=r._addsInProcess.indexOf(i))&&s.some(function(e,t){var r=u[t].name,n=o.getProperty(r),a=i.getProperty(e);return n!==a})})}return t}(t,e);if(!r.length)return r;var n=t.parentEntity.entityAspect.entityManager;return n&&!n.isLoading&&r.forEach(function(e){if(e.entityAspect.entityState.isDetached()){t._inProgress=!0;try{n.attachEntity(e,ve.Added)}finally{t._inProgress=!1}}}),r}(this,e)},Te._processAdds=function(e){!function(e,t){var a=e.parentEntity,i=e.navigationProperty,o=e._addsInProcess,s=i.getInverse(),r=o.length;try{t.forEach(function(r){if(o.push(r),s)r.setProperty(s.name,a);else{var n=a.entityType.keyProperties;i.invForeignKeyNames.forEach(function(e,t){r.setProperty(e,a.getProperty(n[t].name))})}})}finally{o.splice(r,t.length)}}(this,e)},Te._processRemoves=function(e){var t,r;t=e,(r=this.navigationProperty.getInverse())&&t.forEach(function(e){e.setProperty(r.name,null)})},function(e,t,r){return e.parentEntity=t,e.navigationProperty=r,e.arrayChanged=new re("arrayChanged",e),e._addsInProcess=[],D(e,ie.mixin),D(e,Te)});var Te;var Pe;var be=function(){var t,e=function(){t={stringPrefix:"K_",nextNumber:-1,nextNumberIncrement:-1}};e();var r=function(){var e=t.nextNumber;return t.nextNumber+=t.nextNumberIncrement,e},n=function(){return new Date},a=function(e){for(var t=new Date,r=new Date;t.getTime()===r.getTime();)r=new Date;return r},i=function(e,t){if("string"===t){var r=e.trim();if(""===r)return null;var n=parseInt(r,10);return isNaN(n)?e:n}return"number"===t?Math.round(e):e},o=function(e,t){if("string"===t){var r=e.trim();if(""===r)return null;var n=parseFloat(r);return isNaN(n)?e:n}return e},s=function(e,t){var r;if("string"===t){var n=e.trim();return""===n?null:R(r=new Date(Date.parse(n)))?r:e}return"number"===t&&R(r=new Date(e))?r:e},u=function(e){return null==e?null:"string"==typeof e?parseInt(e,10):e},p=function(t){return function(e){return null==e?null:("string"==typeof e&&(e=parseFloat(e)),e+t)}};function c(e,t){throw e=G(e,t),new Error(e)}var l=function(e){return R(e)||(e=y.parseDateFromServer(e)),e},y=new te("DataType",{});y.String=y.addSymbol({defaultValue:"",parse:function(e,t){return null==e?e:e.toString()},fmtOData:function(e){return null==e?null:"'"+e.replace(/'/g,"''")+"'"},getNext:function(){return t.stringPrefix+r().toString()}}),y.Int64=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,quoteJsonOData:!0,parse:i,fmtOData:p("L"),getNext:r}),y.Int32=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:i,fmtOData:u,getNext:r}),y.Int16=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:i,fmtOData:u,getNext:r}),y.Byte=y.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:i,fmtOData:u}),y.Decimal=y.addSymbol({defaultValue:0,isNumeric:!0,quoteJsonOData:!0,isFloat:!0,parse:o,fmtOData:p("m"),getNext:r}),y.Double=y.addSymbol({defaultValue:0,isNumeric:!0,isFloat:!0,parse:o,fmtOData:p("d"),getNext:r}),y.Single=y.addSymbol({defaultValue:0,isNumeric:!0,isFloat:!0,parse:o,fmtOData:p("f"),getNext:r}),y.DateTime=y.addSymbol({defaultValue:new Date(1900,0,1),isDate:!0,parse:s,parseRawValue:l,normalize:function(e){return e&&e.getTime&&e.getTime()},fmtOData:function(t){if(null==t)return null;try{return"datetime'"+t.toISOString()+"'"}catch(e){c("'%1' is not a valid dateTime",t)}},getNext:n,getConcurrencyValue:a}),y.DateTimeOffset=y.addSymbol({defaultValue:new Date(1900,0,1),isDate:!0,parse:s,parseRawValue:l,normalize:function(e){return e&&e.getTime&&e.getTime()},fmtOData:function(t){if(null==t)return null;try{return"datetimeoffset'"+t.toISOString()+"'"}catch(e){c("'%1' is not a valid dateTime",t)}},getNext:n,getConcurrencyValue:a}),y.Time=y.addSymbol({defaultValue:"PT0S",fmtOData:function(e){if(null==e)return null;U(e)||c("'%1' is not a valid ISO 8601 duration",e);return"time'"+e+"'"},parseRawValue:y.parseTimeFromServer}),y.Boolean=y.addSymbol({defaultValue:!1,parse:function(e,t){if("string"===t){var r=e.trim().toLowerCase();return"false"!==r&&""!==r&&("true"===r||e)}return e},fmtOData:function(e){if(null==e)return null;return"string"==typeof e?"true"===e.trim().toLowerCase():!!e}}),y.Guid=y.addSymbol({defaultValue:"00000000-0000-0000-0000-000000000000",parse:function(e,t){if("string"===t)return e.trim().toLowerCase();return e},fmtOData:function(e){if(null==e)return null;z(e)||c("'%1' is not a valid guid",e);return"guid'"+e+"'"},getNext:function(){return E()},parseRawValue:function(e){return e.toLowerCase()},getConcurrencyValue:E}),y.Binary=y.addSymbol({defaultValue:null,fmtOData:function(e){return null==e?e:"binary'"+e+"'"},parseRawValue:function(e){e&&void 0!==e.$value&&(e=e.$value);return e}}),y.Undefined=y.addSymbol({defaultValue:void 0,fmtOData:function(e){return e}}),y.resolveSymbols(),y.getComparableFn=function(e){return e&&e.normalize?e.normalize:e===y.Time?function(e){return e&&V(e)}:function(e){return e}},y.fromEdmDataType=function(e){var t=null,r=e.split(".");if(1<r.length){var n=r[1];t="image"===n?y.Byte:2===r.length?y.fromName(n)||y.Undefined:y.String}return t},y.fromValue=function(e){if(R(e))return y.DateTime;switch(typeof e){case"string":return z(e)?y.Guid:U(e)&&3<e.length?y.Time:"string"==typeof(t=e)&&/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/.test(t)?y.DateTime:y.String;case"boolean":return y.Boolean;case"number":return y.Double}var t;return y.Undefined};var f=/.\d{3}$/;return y.parseTimeFromServer=function(e){if("string"==typeof e)return e;if(e&&"Edm.Time"===e.__edmType){var t=Math.floor(e.ms/1e3);return"PT"+t+"S"}return e},y.parseDateAsUTC=function(e){if("string"==typeof e){var t=f.test(e);e=t?e+"Z":e}return e=new Date(Date.parse(e))},y.parseDateFromServer=y.parseDateAsUTC,y.parseRawValue=function(e,t){if(void 0!==e)return e&&t&&t.parseRawValue&&(e=t.parseRawValue(e)),e},y.constants=t,y._resetConstants=e,y.getSymbols().forEach(function(e){e.validatorCtor=function(e){switch(e){case y.String:return oe.string;case y.Int64:return oe.int64;case y.Int32:return oe.int32;case y.Int16:return oe.int16;case y.Decimal:case y.Double:case y.Single:return oe.number;case y.DateTime:case y.DateTimeOffset:return oe.date;case y.Boolean:return oe.bool;case y.Guid:return oe.guid;case y.Byte:return oe.byte;case y.Binary:return oe.none;case y.Time:return oe.duration;case y.Undefined:return oe.none}}(e)}),y}();v.DataType=be;var _e=function(){var e=function(e){r(this,e)},t=e.prototype;function r(e,t){return t&&(Y(t).whereParam("serviceName").isOptional().whereParam("adapterName").isString().isOptional().whereParam("uriBuilderName").isString().isOptional().whereParam("hasServerMetadata").isBoolean().isOptional().whereParam("jsonResultsAdapter").isInstanceOf(Ne).isOptional().whereParam("useJsonp").isBoolean().isOptional().applyAll(e),e.serviceName=e.serviceName&&_e._normalizeServiceName(e.serviceName),e.adapterInstance=e.adapterName&&ne.getAdapterInstance("dataService",e.adapterName),e.uriBuilder=e.uriBuilderName&&ne.getAdapterInstance("uriBuilder",e.uriBuilderName)),e}return t._$typeName="DataService",t.using=function(e){if(!e)return this;var t=new _e(this);return r(t,e)},e.resolve=function(e){e.push({hasServerMetadata:!0,useJsonp:!1});var t=new _e(u(e,["serviceName","adapterName","uriBuilderName","hasServerMetadata","jsonResultsAdapter","useJsonp"]));if(!t.serviceName)throw new Error("Unable to resolve a 'serviceName' for this dataService");return t.adapterInstance=t.adapterInstance||ne.getAdapterInstance("dataService",t.adapterName),t.jsonResultsAdapter=t.jsonResultsAdapter||t.adapterInstance.jsonResultsAdapter,t.uriBuilder=t.uriBuilder||ne.getAdapterInstance("uriBuilder",t.uriBuilderName),t},e._normalizeServiceName=function(e){return"/"!==(e=e.trim()).substr(-1)?e+"/":e},t.toJSON=function(){return y(this,{serviceName:null,adapterName:null,uriBuilderName:null,hasServerMetadata:null,jsonResultsAdapter:function(e){return e&&e.name},useJsonp:null})},e.fromJSON=function(e){return e.jsonResultsAdapter=ne._fetchObject(Ne,e.jsonResultsAdapter),new _e(e)},t.qualifyUrl=function(e){var t=this.serviceName;return Q.stringEndsWith(t,"/")&&(t=t.substr(0,t.length-1)),e="/"+e,Q.stringEndsWith(t,e)||(t+=e),t},e}(),Ne=function(){var e=function(e){if(1!==arguments.length)throw new Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.");Y(e).whereParam("name").isNonEmptyString().whereParam("extractResults").isFunction().isOptional().withDefault(r).whereParam("extractSaveResults").isFunction().isOptional().withDefault(n).whereParam("extractKeyMappings").isFunction().isOptional().withDefault(a).whereParam("extractDeletedKeys").isFunction().isOptional().withDefault(i).whereParam("visitNode").isFunction().applyAll(this),ne._storeObject(this,t._$typeName,this.name)},t=e.prototype;function r(e){return e.results}function n(e){return e.entities||e.Entities||[]}function a(e){return e.keyMappings||e.KeyMappings||[]}function i(e){return e.deletedKeys||e.DeletedKeys||[]}return t._$typeName="JsonResultsAdapter",e}();v.DataService=_e,v.JsonResultsAdapter=Ne;var Oe=Q.requireLib("Q;q");Oe||((Oe=function(){throw new Error("Q is undefined. Are you missing Q.js? See https://github.com/kriskowal/q")}).defer=Oe.resolve=Oe.reject=Oe);v.config.setQ=function(e){v.Q=Oe=e},v.Q=Oe;var Ae=function(){var t=0,e=function(e){Y(e=e||{}).whereParam("namingConvention").isOptional().isInstanceOf(He).withDefault(He.defaultInstance).whereParam("localQueryComparisonOptions").isOptional().isInstanceOf(Ge).withDefault(Ge.defaultInstance).whereParam("serializerFn").isOptional().isFunction().applyAll(this),this.dataServices=[],this._resourceEntityTypeMap={},this._structuralTypeMap={},this._shortNameMap={},this._ctorRegistry={},this._incompleteTypeMap={},this._incompleteComplexTypeMap={},this._id=t++,this.metadataFetched=new re("metadataFetched",this)},r=e.prototype;function s(n,e){e&&e.forEach(function(e){var t=e.name;if(!t){if(!e.nameOnServer)throw new Error("Unable to complete 'importMetadata' - cannot locate a 'name' or 'nameOnServer' for one of the imported property nodes");t=n.metadataStore.namingConvention.serverPropertyNameToClient(e.nameOnServer,{})}if(e.custom){var r=n.getProperty(t,!0);r.custom=e.custom}})}function u(t,e,r){e.validators&&(r.validators=e.validators.map(oe.fromJSON)),e.dataProperties.forEach(function(e){r._addPropertyCore(Me.fromJSON(e))});var n=!e.isComplexType;n&&e.navigationProperties&&e.navigationProperties.forEach(function(e){r._addPropertyCore(ke.fromJSON(e))}),t.addEntityType(r);var a=t._deferredTypes,i=a[r.name];i&&(i.forEach(function(e){u(t,e.json,e.stype)}),delete a[r.name])}function p(e,t,r){if(Ue(t))return t;var n=e._shortNameMap[t];if(!n&&r)throw new Error("Unable to locate 'entityTypeName' of: "+t);return n}return r._$typeName="MetadataStore",re.bubbleEvent(r,null),e.ANONTYPE_PREFIX="_IB_",e.normalizeTypeName=S(function(e){return e&&qe(e).typeName}),r.setProperties=function(e){Y(e).whereParam("name").isString().isOptional().whereParam("serializerFn").isFunction().isOptional().applyAll(this)},r.addDataService=function(e,t){Z(e,"dataService").isInstanceOf(_e).check(),Z(t,"shouldOverwrite").isBoolean().isOptional().check();var r=this._getDataServiceIndex(e.serviceName);if(0<=r){if(!t)throw new Error("A dataService with this name '"+e.serviceName+"' already exists in this MetadataStore");this.dataServices[r]=e}else this.dataServices.push(e)},r._getDataServiceIndex=function(t){return f(this.dataServices,function(e){return e.serviceName===t})},r.addEntityType=function(t){if(t instanceof xe||t instanceof Fe||(t=t.isComplexType?new Fe(t):new xe(t)),!t.isComplexType){if(t.baseTypeName&&!t.baseEntityType){var e=this._getEntityType(t.baseTypeName,!0);t._updateFromBase(e)}if(0===t.keyProperties.length&&!t.isAbstract)throw new Error("Unable to add "+t.name+" to this MetadataStore.  An EntityType must have at least one property designated as a key property - See the 'DataProperty.isPartOfKey' property.")}if(t.metadataStore=this,!t.isAnonymous){if(this._structuralTypeMap[t.name])throw new Error("Type "+t.name+" already exists in this MetadataStore.");this._structuralTypeMap[t.name]=t,this._shortNameMap[t.shortName]=t.name}if(t.getProperties().forEach(function(e){t._updateNames(e),e.isUnmapped||t._mappedPropertiesCount++}),t._updateCps(),!t.isComplexType){t._updateNps();var r=t.defaultResourceName||t.baseEntityType&&t.baseEntityType.defaultResourceName;r&&!this.getEntityTypeNameForResourceName(r)&&this.setEntityTypeForResourceName(r,t.name),t.defaultResourceName=r,t.getEntityCtor()}},r.exportMetadata=function(){var e=JSON.stringify({metadataVersion:v.metadataVersion,name:this.name,namingConvention:this.namingConvention.name,localQueryComparisonOptions:this.localQueryComparisonOptions.name,dataServices:this.dataServices,structuralTypes:g(this._structuralTypeMap),resourceEntityTypeMap:this._resourceEntityTypeMap},null,ne.stringifyPad);return e},r.importMetadata=function(e,t){Z(t,"allowMerge").isOptional().isBoolean().check(),this._deferredTypes={};var r="string"==typeof e?JSON.parse(e):e;if(r.schema)return Ce.parse(this,r.schema,r.altMetadata);if(r.metadataVersion&&r.metadataVersion!==v.metadataVersion){var n=G("Cannot import metadata with a different 'metadataVersion' (%1) than the current 'breeze.metadataVersion' (%2) ",r.metadataVersion,v.metadataVersion);throw new Error(n)}var a=r.namingConvention,i=r.localQueryComparisonOptions;if(this.isEmpty())this.namingConvention=ne._fetchObject(He,a)||this.namingConvention,this.localQueryComparisonOptions=ne._fetchObject(Ge,i)||this.localQueryComparisonOptions;else{if(a&&this.namingConvention.name!==a)throw new Error("Cannot import metadata with a different 'namingConvention' from the current MetadataStore");if(i&&this.localQueryComparisonOptions.name!==i)throw new Error("Cannot import metadata with different 'localQueryComparisonOptions' from the current MetadataStore")}var o=this;r.dataServices&&r.dataServices.forEach(function(e){e=_e.fromJSON(e),o.addDataService(e,!0)});this._structuralTypeMap;return r.structuralTypes&&r.structuralTypes.forEach(function(e){!function(e,t,r){var n=Be(t.shortName,t.namespace),a=e._getEntityType(n,!0);if(a)return r&&function(e,t){t.custom&&(e.custom=t.custom);s(e,t.dataProperties),s(e,t.navigationProperties)}(a,t);var i={shortName:t.shortName,namespace:t.namespace,isAbstract:t.isAbstract,autoGeneratedKeyType:De.fromName(t.autoGeneratedKeyType),defaultResourceName:t.defaultResourceName,custom:t.custom};if(a=t.isComplexType?new Fe(i):new xe(i),t.baseTypeName){a.baseTypeName=t.baseTypeName;var o=e._getEntityType(t.baseTypeName,!0);o?u(e,t,a):x(e._deferredTypes,t.baseTypeName).push({json:t,stype:a})}else u(e,t,a)}(o,e,t)}),D(this._resourceEntityTypeMap,r.resourceEntityTypeMap),D(this._incompleteTypeMap,r.incompleteTypeMap),this},e.importMetadata=function(e){var t=new Ae;return t.importMetadata(e),t},r.hasMetadataFor=function(e){return!!this.getDataService(e)},r.getDataService=function(t){return Z(t,"serviceName").isString().check(),t=_e._normalizeServiceName(t),O(this.dataServices,function(e){return e.serviceName===t})},r.fetchMetadata=function(t,r,n){try{if(Z(t,"dataService").isString().or().isInstanceOf(_e).check(),Z(r,"callback").isFunction().isOptional().check(),Z(n,"errorCallback").isFunction().isOptional().check(),"string"==typeof t&&(t=this.getDataService(t)||new _e({serviceName:t})),t=_e.resolve([t]),this.hasMetadataFor(t.serviceName))throw new Error("Metadata for a specific serviceName may only be fetched once per MetadataStore. ServiceName: "+t.serviceName);var a=this;return t.adapterInstance.fetchMetadata(this,t).then(function(e){return a.metadataFetched.publish({metadataStore:a,dataService:t,rawMetadata:e}),r&&r(e),Oe.resolve(e)},function(e){return n&&n(e),Oe.reject(e)})}catch(e){return Oe.reject(e)}},r.trackUnmappedType=function(e,t){Z(e,"entityCtor").isFunction().check(),Z(t,"interceptor").isFunction().isOptional().check();var r=new xe(this);r._setCtor(e,t)},r.registerEntityTypeCtor=function(e,t,r,n){Z(e,"structuralTypeName").isString().check(),Z(t,"aCtor").isFunction().isOptional().check(),Z(r,"initFn").isOptional().isFunction().or().isString().check(),Z(n,"noTrackingFn").isOptional().isFunction().check();var a=p(this,e,!1),i=a||e;if(t&&(t._$typeName&&t._$typeName!=i&&console.warn("Registering a constructor for "+i+" that is already used for "+t._$typeName+"."),t._$typeName=i),this._ctorRegistry[i]={ctor:t,initFn:r,noTrackingFn:n},a){var o=this._structuralTypeMap[a];o&&o.getCtor(!0)}},r.isEmpty=function(){return B(this._structuralTypeMap)},r.getEntityType=function(e,t){return Z(e,"structuralTypeName").isString().check(),Z(t,"okIfNotFound").isBoolean().isOptional().check(!1),this._getEntityType(e,t)},r._getEntityType=function(e,t){var r=p(this,e,!1),n=this._structuralTypeMap[r];if(!n){if(t)return null;var a=G("Unable to locate a 'Type' by the name: '%1'. Be sure to execute a query or call fetchMetadata first.",e);throw new Error(a)}if(n.length){var i=n.join(",");throw new Error("There are multiple types with this 'shortName': "+i)}return n},r.getEntityTypes=function(){return function(e){var t=[];for(var r in e){var n=e[r];r===n.name&&t.push(e[r])}return t}(this._structuralTypeMap)},r.getIncompleteNavigationProperties=function(){return g(this._incompleteTypeMap,function(e,t){return t})},r.getEntityTypeNameForResourceName=function(e){return Z(e,"resourceName").isString().check(),this._resourceEntityTypeMap[e]},r.setEntityTypeForResourceName=function(e,t){var r;Z(e,"resourceName").isString().check(),Z(t,"entityTypeOrName").isInstanceOf(xe).or().isString().check(),r=t instanceof xe?t.name:p(this,t,!0),this._resourceEntityTypeMap[e]=r;var n=this._getEntityType(r,!0);n&&!n.defaultResourceName&&(n.defaultResourceName=e)},r._checkEntityType=function(e){if(!e.entityType){var t=e.prototype._$typeName;if(!t)throw new Error("This entity has not been registered. See the MetadataStore.registerEntityTypeCtor method");var r=this._getEntityType(t);r&&(e.entityType=r)}},e}(),Ce=function(){function c(t,e,r,n,a){var i=e.key?_(e.key.propertyRef).map(d("name")):[];_(e.property).forEach(function(e){p(t,e,r,i)}),_(e.navigationProperty).forEach(function(e){!function(e,t,r,n){var a=function(e,t,r){var n=S(e.relationship,t),a=n.namespace,i=O(r,function(e){return e.namespace===a});if(!i)return null;var o=n.shortTypeName,s=i.association;if(!s)return null;Array.isArray(s)||(s=[s]);return O(s,function(e){return e.name===o})}(t,r,n);if(!a)throw new Error("Unable to resolve Foreign Key Association: "+t.relationship);var i=O(a.end,function(e){return e.role===t.toRole}),o="*"!==i.multiplicity,s=S(i.type,r).typeName,u=a.referentialConstraint;if(!u&&"*"==a.end[0].multiplicity&&"*"==a.end[1].multiplicity)return;var p={nameOnServer:t.name,entityTypeName:s,isScalar:o,associationName:a.name};if(u){var c=u.principal,l=u.dependent,y=_(l.propertyRef),f=y.map(d("name"));t.fromRole===c.role?p.invForeignKeyNamesOnServer=f:p.foreignKeyNamesOnServer=f}var h=new ke(p);e._addPropertyCore(h)}(t,e,r,n)}),a.addEntityType(t),t.defaultResourceName=a._entityTypeResourceMap[t.name];var o=a._deferredTypes,s=o[t.name];s&&(s.forEach(function(e){c(e.entityType,e.csdlEntityType,r,n,a)}),delete o[t.name])}function p(e,t,r,n){var a,i,o,s,u,p,c,l,y,f,h,d,m,v,g=t.type.split(".");return"Edm"===g[0]&&2===g.length?a=w(e,t,n):(u=t,((p=r).enumType?(h=u,d=_(p.enumType),m=h.type.split("."),v=m[m.length-1],d.some(function(e){return e.name===v})):p.extensions&&(c=u,l=p.extensions.filter(function(e){return"EnumType"===e.name}),y=c.type.split("."),f=y[y.length-1],l.some(function(e){return e.attributes.some(function(e){return"Name"===e.name&&e.value===f})})))?(a=w(e,t,n))&&(a.enumType=t.type):(o=r,s=S((i=t).type,o).typeName,a=new Me({nameOnServer:i.name,complexTypeName:s,isNullable:!1}))),a&&(e._addPropertyCore(a),function(e){var t;e.isNullable||e.validators.push(oe.required());if(e.isComplexProperty)return;if(e.dataType===be.String)if(e.maxLength){var r={maxLength:e.maxLength};t=oe.maxLength(r)}else t=oe.string();else t=e.dataType.validatorCtor();e.validators.push(t)}(a)),a}function w(e,t,r){var n=be.fromEdmDataType(t.type);if(null==n)return e.warnings.push("Unable to recognize DataType for property: "+t.name+" DateType: "+t.type),null;var a="true"===t.nullable||null==t.nullable,i=null!=r&&0<=r.indexOf(t.name);i&&e.autoGeneratedKeyType===De.None&&function(e){var t=O(Object.keys(e),function(e){return 0<=e.indexOf("StoreGeneratedPattern")});{if(t)return"Identity"===e[t];var r=e.extensions;if(!r)return!1;var n=O(r,function(e){return"StoreGeneratedPattern"===e.name&&"Identity"===e.value});return!!n}}(t)&&(e.autoGeneratedKeyType=De.Identity);var o=t.maxLength;o=null==o||"Max"===o?null:parseInt(o,10);var s=new Me({nameOnServer:t.name,dataType:n,isNullable:a,isPartOfKey:i,maxLength:o,defaultValue:t.defaultValue,concurrencyMode:t.concurrencyMode});return n===be.Undefined&&(s.rawTypeName=t.type),s}function S(e,t){var r=qe(e);if(t&&t.cSpaceOSpaceMapping){var n=l(r.shortTypeName,t);n&&(r=ze(r.shortTypeName,n))}return r}function l(e,t){var r,n=t.cSpaceOSpaceMapping;if(n){var a=n[t.namespace+"."+e];if(r=a&&a.substr(0,a.length-(e.length+1)))return r}return t.entityType||"Default"!=t.namespace?t.namespace:null}return{parse:function(u,r,e){u._entityTypeResourceMap={},(r=_(r)).forEach(function(s){if(s.cSpaceOSpaceMapping){var e=JSON.parse(s.cSpaceOSpaceMapping),t={};e.forEach(function(e){t[e[0]]=e[1]}),s.cSpaceOSpaceMapping=t}s.entityContainer&&_(s.entityContainer).forEach(function(e){_(e.entitySet).forEach(function(e){var t=S(e.entityType,s).typeName;u.setEntityTypeForResourceName(e.name,t),u._entityTypeResourceMap[t]=e.name})}),s.complexType&&_(s.complexType).forEach(function(e){var t,r,n,a,i,o;r=s,n=u,a=(t=e).name,i=l(a,r),o=new Fe({shortName:a,namespace:i}),_(t.property).forEach(function(e){p(o,e,r)}),n.addEntityType(o)}),s.entityType&&_(s.entityType).forEach(function(e){!function(e,t,r,n){var a=e.name,i=l(a,t),o=new xe({shortName:a,namespace:i,isAbstract:e.abstract&&"true"===e.abstract});if(e.baseType){var s=S(e.baseType,t).typeName;o.baseTypeName=s;var u=n._getEntityType(s,!0);if(u)c(o,e,t,r,n);else{var p=n._deferredTypes[s];p||(p=[],n._deferredTypes[s]=p),p.push({entityType:o,csdlEntityType:e})}}else c(o,e,t,r,n)}(e,s,r,u)})});var t=u.getIncompleteNavigationProperties();if(0<t.length){var n=t.map(function(e){return Array.isArray(e)?e.map(function(e){return e.parentType.name+":"+e.name}).join(", "):e.parentType.name+":"+e.name}).join(", ");throw new Error("Incomplete navigation properties: "+n)}e&&u.importMetadata(e,!0);return u}}}(),xe=function(){var t=0,e=function(e){if(1<arguments.length)throw new Error("The EntityType ctor has a single argument that is either a 'MetadataStore' or a configuration object.");"MetadataStore"===e._$typeName?(this.metadataStore=e,this.shortName="Anon_"+ ++t,this.namespace="",this.isAnonymous=!0):Y(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("baseTypeName").isString().isOptional().whereParam("isAbstract").isBoolean().isOptional().withDefault(!1).whereParam("autoGeneratedKeyType").isEnumOf(De).isOptional().withDefault(De.None).whereParam("defaultResourceName").isNonEmptyString().isOptional().withDefault(null).whereParam("dataProperties").isOptional().whereParam("navigationProperties").isOptional().whereParam("serializerFn").isOptional().isFunction().whereParam("custom").isOptional().applyAll(this),this.name=Be(this.shortName,this.namespace),this.dataProperties=[],this.navigationProperties=[],this.complexProperties=[],this.keyProperties=[],this.foreignKeyProperties=[],this.inverseForeignKeyProperties=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.validators=[],this.warnings=[],this._mappedPropertiesCount=0,this.subtypes=[],$e(this,e.dataProperties,Me),$e(this,e.navigationProperties,ke)},r=e.prototype,u=be.parseRawValue;function n(e,t){return e.entityAspect||e.complexAspect?e.getProperty(t.name):e[t.name]}function p(a,i){var e=a.complexAspect.parentProperty.dataType.dataProperties,t=e.every(function(e){if(!e.isSettable)return!0;var t=a.getProperty(e.name),r=i.getProperty(e.name);if(e.isComplexProperty&&e.isScalar)return p(t,r);if(e.isComplexProperty&&!e.isScalar)return m(t,r,p);var n=e.dataType;return t===r||n&&n.normalize&&t&&r&&n.normalize(t)===n.normalize(r)});return t}function a(e){return e.filter(function(e){return null==e.baseProperty})}function i(n,a,e){var t=e+"OnServer",r=a[e];if(r&&r.length){var i=_(r).map(function(e){var t=n.clientPropertyNameToServer(e,a),r=n.serverPropertyNameToClient(t,a);if(e!==r)throw new Error("NamingConvention for this client property name does not roundtrip properly:"+e+"--\x3e"+r);return t});a[t]=Array.isArray(r)?i:i[0]}else{var o=a[t];if(!o||0===o.length)return;var s=_(o).map(function(e){var t=n.serverPropertyNameToClient(e,a),r=n.clientPropertyNameToServer(t,a);if(e!==r)throw new Error("NamingConvention for this server property name does not roundtrip properly:"+e+"--\x3e"+r);return t});a[e]=Array.isArray(o)?s:s[0]}}function o(e,t){var r=t._getEntityType(e.complexTypeName,!0);if(!r)return!1;if(!(r instanceof Fe))throw new Error("Unable to resolve ComplexType with the name: "+e.complexTypeName+" for the property: "+property.name);return e.dataType=r,e.defaultValue=null,!0}function s(e,t){if(e.entityType)return!0;var r=t._getEntityType(e.entityTypeName,!0);if(r)e.entityType=r,e._resolveNp();else{var n=x(t._incompleteTypeMap,e.entityTypeName);h(n,e)}return!!r}return r._$typeName="EntityType",e.qualifyTypeName=Be,r.setProperties=function(e){Y(e).whereParam("autoGeneratedKeyType").isEnumOf(De).isOptional().whereParam("defaultResourceName").isString().isOptional().whereParam("serializerFn").isFunction().isOptional().whereParam("custom").isOptional().applyAll(this),e.defaultResourceName&&(this.defaultResourceName=e.defaultResourceName)},r.isSubtypeOf=function(e){Z(e,"entityType").isInstanceOf(xe).check();var t=this;do{if(t===e)return!0;t=t.baseEntityType}while(t);return!1},r.getSelfAndSubtypes=function(){var r=[this];return this.subtypes.forEach(function(e){var t=e.getSelfAndSubtypes();r.push.apply(r,t)}),r},r.getAllValidators=function(){for(var e=this.validators.slice(0),t=this.baseEntityType;t;)e.push.apply(e,t.validators),t=t.baseEntityType;return e},r.addProperty=function(t){Z(t,"property").isInstanceOf(Me).or().isInstanceOf(ke).check();var e=this._addPropertyCore(t,!0);if(this.subtypes&&this.subtypes.length){var r=this;r.getSelfAndSubtypes().forEach(function(e){e!==r&&(t.isNavigationProperty?e._addPropertyCore(new ke(t),!0):e._addPropertyCore(new Me(t),!0))})}return e},r._updateFromBase=function(e){this.baseEntityType=e,this.autoGeneratedKeyType===De.None&&(this.autoGeneratedKeyType=e.autoGeneratedKeyType),e.dataProperties.forEach(function(e){var t=new Me(e);t.validators=[],t.baseProperty=e,this._addPropertyCore(t)},this),e.navigationProperties.forEach(function(e){var t=new ke(e);t.validators=[],t.baseProperty=e,this._addPropertyCore(t)},this),e.subtypes.push(this)},r._addPropertyCore=function(e,t){if(this.isFrozen)throw new Error("The '"+this.name+"' EntityType/ComplexType has been frozen. You can only add properties to an EntityType/ComplexType before any instances of that type have been created and attached to an entityManager.");var r=e.parentType;if(r){if(r!==this)throw new Error("This property: "+e.name+" has already been added to "+e.parentType.name);return this}var n=(e.parentType=this).metadataStore;if(e.isDataProperty?this._addDataProperty(e):(this._addNavigationProperty(e),t&&n&&s(e,n)),!n||e.name&&e.nameOnServer||i(n.namingConvention,e,"name"),n&&this._extra&&this._extra.alreadyWrappedProps){var a=this._ctor.prototype;ae.getDefaultInstance().initializeEntityPrototype(a)}return this},r.createEntity=function(i){if(i&&i._$eref&&!i._$eref.entityAspect.entityManager)return i._$eref;var o=this._createInstanceCore();return i&&(this.keyProperties.every(function(e){return null!=i[e.name]})&&(i._$eref=o),this._updateTargetFromRaw(o,i,n),this.navigationProperties.forEach(function(e){var t,r=i[e.name];if(null!=r){var n=e.entityType;if(e.isScalar)t=r.entityAspect?r:n.createEntity(r),o.setProperty(e.name,t);else{var a=o.getProperty(e.name);r.forEach(function(e){t=e.entityAspect?e:n.createEntity(e),a.push(t)})}}})),this._initializeInstance(o),o},r._createInstanceCore=function(){var e=this.getEntityCtor(),t=new e;return new ye(t),t},r._initializeInstance=function(r){this.baseEntityType&&this.baseEntityType._initializeInstance(r);var e=this.initFn;e&&("string"==typeof e&&(e=r[e]),e(r)),this.complexProperties&&this.complexProperties.forEach(function(t){var e=r.getProperty(t.name);Array.isArray(e)?e.forEach(function(e){t.dataType._initializeInstance(e)}):t.dataType._initializeInstance(e)}),r.entityAspect&&(r.entityAspect._initialized=!0)},r.getCtor=r.getEntityCtor=function(e){if(this._ctor&&!e)return this._ctor;var t,r=this.metadataStore._ctorRegistry,n=r[this.name]||r[this.shortName]||{},a=n.ctor||this._ctor,i=a&&a.prototype&&(a.prototype.entityType||a.prototype.complexType);if(i&&i.metadataStore!==this.metadataStore)throw new Error("Cannot register the same constructor for "+this.name+" in different metadata stores.  Please define a separate constructor for each metadata store.");if(n.ctor&&e&&(this._extra=void 0),!a){var o=ae.getDefaultInstance().createCtor;a=o?o(this):(t=this.name.replace(/\W/g,"_"),Function("return function "+t+"(){}")())}return this.initFn=n.initFn,this.noTrackingFn=n.noTrackingFn,a.prototype._$typeName=this.name,this._setCtor(a),a},r._setCtor=function(e,t){var r=e.prototype;this._extra=this._extra||{};var i,o,s,n=new e;o=n,s=(i=this).getPropertyNames(),ae.getDefaultInstance().getTrackablePropertyNames(o).forEach(function(e){if(-1===s.indexOf(e)){var t=o[e];try{"function"==typeof t&&(t=t())}catch(e){}var r=be.fromValue(t),n=new Me({name:e,dataType:r,isNullable:!0,isUnmapped:!0});n.isSettable=null==(a=c(o,e))||!(!a.writable&&!a.set),i.subtypes&&i.subtypes.length?i.getSelfAndSubtypes().forEach(function(e){e._addPropertyCore(new Me(n))}):i._addPropertyCore(n)}var a}),"EntityType"===this._$typeName?r.entityType=this:r.complexType=this,r._$interceptor=t||Se,ae.getDefaultInstance().initializeEntityPrototype(r),this._ctor=e},r.addValidator=function(e,t){Z(e,"validator").isInstanceOf(oe).check(),Z(t,"property").isOptional().isString().or().isEntityProperty().check(),t?("string"==typeof t&&(t=this.getProperty(t,!0)),t.validators.push(e)):this.validators.push(e)},r.getProperties=function(){return this.dataProperties.concat(this.navigationProperties)},r.getPropertyNames=function(){return this.getProperties().map(d("name"))},r.getDataProperty=function(e){return O(this.dataProperties,l("name",e))},r.getNavigationProperty=function(e){return O(this.navigationProperties,l("name",e))},r.getProperty=function(e,t){var r=this.getPropertiesOnPath(e,!1,t);return r?r[r.length-1]:null},r.getPropertiesOnPath=function(e,t,r){r=r||!1;var n=Array.isArray(e)?e:e.trim().split("."),a=!0,i=this,o=t?"nameOnServer":"name",s=n.map(function(e){var t=O(i.getProperties(),l(o,e));if(t)i=t.isNavigationProperty?t.entityType:t.dataType;else{if(r)throw new Error("unable to locate property: "+e+" on entityType: "+i.name);a=!1}return t});return a?s:null},r.clientPropertyPathToServer=function(e,t){var r,t=t||".";if(this.isAnonymous){var n=this.metadataStore.namingConvention.clientPropertyNameToServer;r=e.split(".").map(function(e){return n(e)})}else r=this.getPropertiesOnPath(e,!1,!0).map(function(e){return e.nameOnServer});return r.join(t)},r.getEntityKeyFromRawEntity=function(r,n){var e=this.keyProperties.map(function(e){var t=n(r,e);return u(t,e.dataType)});return new me(this,e)},r._updateTargetFromRaw=function(i,o,s){this.dataProperties.forEach(function(r){if(r.isSettable){var e=s(o,r);if(void 0!==e){var t,n=r.dataType;if(r.isComplexProperty){if(null===e)return;if(t=i.getProperty(r.name),r.isScalar)n._updateTargetFromRaw(t,e,s);else if(Array.isArray(e)){var a=e.map(function(e){var t=n._createInstanceCore(i,r);return n._updateTargetFromRaw(t,e,s),n._initializeInstance(t),t});m(t,a,p)||(t.length=0,a.forEach(function(e){t.push(e)}))}else t.length=0}else{if(r.isScalar){var a=u(e,n);i.setProperty(r.name,a)}else if(t=i.getProperty(r.name),Array.isArray(e)){var a=e.map(function(e){return u(e,n)});m(t,a)||(t.length=0,a.forEach(function(e){t.push(e)}))}else t.length=0}}}});var e=o.entityAspect||o.complexAspect;if(e){var t=i.entityAspect||i.complexAspect;e.originalValuesMap&&(t.originalValues=e.originalValuesMap),e.extraMetadata&&(t.extraMetadata=e.extraMetadata)}},r.toString=function(){return this.name},r.toJSON=function(){return y(this,{shortName:null,namespace:null,baseTypeName:null,isAbstract:!1,autoGeneratedKeyType:null,defaultResourceName:null,dataProperties:a,navigationProperties:a,validators:null,custom:null})},r._updateNames=function(e){var t=this.metadataStore.namingConvention;i(t,e,"name"),e.isNavigationProperty&&(i(t,e,"foreignKeyNames"),i(t,e,"invForeignKeyNames"))},r._checkNavProperty=function(e){if(e.isNavigationProperty){if(e.parentType!==this)throw new Error(G("The navigationProperty '%1' is not a property of entity type '%2'",e.name,this.name));return e}if("string"==typeof e){var t=this.getProperty(e);if(t&&t.isNavigationProperty)return t}throw new Error("The 'navigationProperty' parameter must either be a NavigationProperty or the name of a NavigationProperty")},r._addDataProperty=function(e){this.dataProperties.push(e),e.isPartOfKey&&this.keyProperties.push(e),e.isComplexProperty&&this.complexProperties.push(e),e.concurrencyMode&&"None"!==e.concurrencyMode&&this.concurrencyProperties.push(e),e.isUnmapped&&this.unmappedProperties.push(e)},r._addNavigationProperty=function(e){this.navigationProperties.push(e),Ue(e.entityTypeName)||(e.entityTypeName=Be(e.entityTypeName,this.namespace))},r._updateCps=function(){var t=this.metadataStore,r=t._incompleteComplexTypeMap;this.complexProperties.forEach(function(e){e.complexType||o(e,t)||x(r,e.complexTypeName).push(e)}),this.isComplexType&&((r[this.name]||[]).forEach(function(e){o(e,t)}),delete r[this.name])},r._updateNps=function(){var t=this.metadataStore;this.navigationProperties.forEach(function(e){s(e,t)});var e=t._incompleteTypeMap;(e[this.name]||[]).forEach(function(e){s(e,t)}),delete e[this.name]},e}(),Fe=(Re=function(e){if(1<arguments.length)throw new Error("The ComplexType ctor has a single argument that is a configuration object.");Y(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("dataProperties").isOptional().whereParam("isComplexType").isOptional().isBoolean().whereParam("custom").isOptional().applyAll(this),this.name=Be(this.shortName,this.namespace),this.isComplexType=!0,this.dataProperties=[],this.complexProperties=[],this.validators=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.navigationProperties=[],this.keyProperties=[],$e(this,e.dataProperties,Me)},Ke=Re.prototype,Ke.setProperties=function(e){Y(e).whereParam("custom").isOptional().applyAll(this)},Ke.getAllValidators=function(){return this.validators},Ke._createInstanceCore=function(e,t){var r=this.getCtor(),n=new r;return new fe(n,e,t),n},Ke.addProperty=function(e){return Z(e,"dataProperty").isInstanceOf(Me).check(),this._addPropertyCore(e)},Ke.getProperties=function(){return this.dataProperties},(Ke=D(Ke,xe.prototype,["addValidator","getProperty","getPropertiesOnPath","getPropertyNames","_addPropertyCore","_addDataProperty","_updateNames","_updateCps","_initializeInstance","_updateTargetFromRaw","_setCtor"])).createInstance=xe.prototype.createEntity,Ke.getCtor=xe.prototype.getEntityCtor,Ke.toJSON=function(){return y(this,{shortName:null,namespace:null,isComplexType:null,dataProperties:null,validators:null,custom:null})},Ke._$typeName="ComplexType",Re),Me=(Ve=function(e){Y(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("dataType").isEnumOf(be).isOptional().or().isString().or().isInstanceOf(Fe).whereParam("complexTypeName").isOptional().whereParam("isNullable").isBoolean().isOptional().withDefault(!0).whereParam("isScalar").isOptional().withDefault(!0).whereParam("defaultValue").isOptional().whereParam("isPartOfKey").isBoolean().isOptional().whereParam("isUnmapped").isBoolean().isOptional().whereParam("isSettable").isBoolean().isOptional().withDefault(!0).whereParam("concurrencyMode").isString().isOptional().whereParam("maxLength").isNumber().isOptional().whereParam("validators").isInstanceOf(oe).isArray().isOptional().withDefault([]).whereParam("displayName").isOptional().whereParam("enumType").isOptional().whereParam("rawTypeName").isOptional().whereParam("custom").isOptional().applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw new Error("A DataProperty must be instantiated with either a 'name' or a 'nameOnServer' property");if(this.complexTypeName)this.isComplexProperty=!0,this.dataType=null;else if("string"==typeof this.dataType){var r=be.fromName(this.dataType);if(!r)throw new Error("Unable to find a DataType enumeration by the name of: "+this.dataType);this.dataType=r}else this.dataType||(this.dataType=be.String);if(null==this.defaultValue){if(this.isNullable)this.defaultValue=null;else if(this.isComplexProperty);else if(this.dataType===be.Binary)this.defaultValue="AAAAAAAAJ3U=";else if(this.defaultValue=this.dataType.defaultValue,null==this.defaultValue)throw new Error("A nonnullable DataProperty cannot have a null defaultValue. Name: "+(this.name||this.nameOnServer))}else this.dataType.isNumeric&&"string"==typeof this.defaultValue&&(this.defaultValue=parseFloat(this.defaultValue));this.isComplexProperty&&(this.isScalar=null==this.isScalar||!0===this.isScalar)},je=Ve.prototype,je._$typeName="DataProperty",Ve.getRawValueFromServer=function(e,t){if(t.isUnmapped)return e[t.nameOnServer||t.name];var r=e[t.nameOnServer];return void 0!==r?r:t.defaultValue},Ve.getRawValueFromClient=function(e,t){var r=e[t.name];return void 0!==r?r:t.defaultValue},je.isDataProperty=!0,je.isNavigationProperty=!1,je.resolveProperty=function(e){for(var t=this[e],r=this.baseProperty;null==t&&null!=r;)t=r[e],r=r.baseProperty;return t},je.formatName=function(){return this.parentType.name+"--"+this.name},je.setProperties=function(e){Y(e).whereParam("displayName").isOptional().whereParam("custom").isOptional().applyAll(this)},je.getAllValidators=function(){for(var e=this.validators.slice(0),t=this.baseProperty;t;)e.push.apply(e,t.validators),t=t.baseProperty;return e},je.toJSON=function(){return y(this,{name:null,dataType:function(e){return e&&e.parentEnum?e.name:void 0},complexTypeName:null,isNullable:!0,defaultValue:null,isPartOfKey:!1,isUnmapped:!1,isSettable:!0,concurrencyMode:null,maxLength:null,validators:null,displayName:null,enumType:null,rawTypeName:null,isScalar:!0,custom:null})},Ve.fromJSON=function(e){return e.dataType=be.fromName(e.dataType),e.defaultValue&&e.dataType&&e.dataType.parse&&(e.defaultValue=e.dataType.parse(e.defaultValue,typeof e.defaultValue)),e.validators&&(e.validators=e.validators.map(oe.fromJSON)),new Me(e)},Ve),ke=function(){var e=function(e){Y(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("entityTypeName").isString().whereParam("isScalar").isBoolean().isOptional().withDefault(!0).whereParam("associationName").isString().isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("foreignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("validators").isInstanceOf(oe).isArray().isOptional().withDefault([]).whereParam("displayName").isOptional().whereParam("custom").isOptional().applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw new Error("A Navigation property must be instantiated with either a 'name' or a 'nameOnServer' property")},t=e.prototype;function r(e,t){throw new Error("Cannot set the inverse property for: "+e.formatName()+". "+t)}function n(e,t){throw new Error("Cannot create inverse for: "+e.formatName()+". The entityType for this navigation property "+t)}return t._$typeName="NavigationProperty",t.isDataProperty=!1,t.isNavigationProperty=!0,D(t,Me.prototype,["formatName","getAllValidators","resolveProperty"]),t.setProperties=function(e){if(!this.parentType)throw new Error("Cannot call NavigationProperty.setProperties until the parent EntityType of the NavigationProperty has been set.");var t=e.inverse;t&&delete e.inverse,Y(e).whereParam("displayName").isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("custom").isOptional().applyAll(this),this.parentType._updateNames(this),this._resolveNp(),t&&this.setInverse(t)},t.getInverse=function(){for(var e=this;!e.inverse&&e.baseProperty;)e=e.baseProperty;return e.inverse},t.setInverse=function(e){var t;if(!(t="string"==typeof e?this.entityType.getNavigationProperty(e):e))throw r(this,"Unable to find inverse property: "+invNpName);(this.inverse||t.inverse)&&r(this,"It has already been set on one side or the other."),t.entityType!=this.parentType&&r(this,t.formatName+" is not a valid inverse property for this."),this.associationName?t.associationName=this.associationName:(t.associationName||(t.associationName=this.formatName()+"_"+t.formatName()),this.associationName=t.associationName),this._resolveNp(),t._resolveNp()},t.createInverse=function(e){this.entityType||n(this,"has not yet been defined."),this.entityType.isFrozen&&n(this,"is frozen.");var t=this.entityType.metadataStore;null==t&&n(this,"has not yet been added to the metadataStore."),e.entityTypeName=this.parentEntityType.name,e.associationName=this.associationName;var r=new ke(e);return this.parentEntityType.addNavigationProperty(r),r},t.toJSON=function(){return y(this,{name:null,entityTypeName:null,isScalar:null,associationName:null,validators:null,displayName:null,foreignKeyNames:null,invForeignKeyNames:null,custom:null})},e.fromJSON=function(e){return e.validators&&(e.validators=e.validators.map(oe.fromJSON)),new ke(e)},t._resolveNp=function(){var n=this,a=n.entityType,e=O(a.navigationProperties,function(e){return e.associationName===n.associationName&&(e.name!==n.name||e.entityTypeName!==n.entityTypeName)});(n.inverse=e)||n.invForeignKeyNames.forEach(function(e){var t=a.getDataProperty(e);if(!t)throw new Error("EntityType '"+n.entityTypeName+"' has no foreign key matching '"+e+"'");var r=n.parentType;t.inverseNavigationProperty=O(r.navigationProperties,function(e){return e.invForeignKeyNames&&0<=e.invForeignKeyNames.indexOf(t.name)&&e.entityType===t.parentType}),h(a.foreignKeyProperties,t)}),function(t){var e=t.foreignKeyNames;if(0===e.length)return;var r=t.parentType,n=e.map(function(e){return r.getDataProperty(e)}),a=r.foreignKeyProperties;n.forEach(function(e){h(a,e),h((e.relatedNavigationProperty=t).entityType.inverseForeignKeyProperties,e),t.relatedDataProperties?h(t.relatedDataProperties,e):t.relatedDataProperties=[e]})}(n)},e}(),De=(Ie=new te("AutoGeneratedKeyType"),Ie.None=Ie.addSymbol(),Ie.Identity=Ie.addSymbol(),Ie.KeyGenerator=Ie.addSymbol(),Ie.resolveSymbols(),Ie);var Ie;var Ve,je;var Re,Ke;function qe(e){if(!e)return null;var t=e.split(":#");if(1<t.length)return ze(t[0],t[1]);if($(e,Ae.ANONTYPE_PREFIX)){var r=ze(e);return r.isAnonymous=!0,r}var n=e.split(",")[0],t=n.split(".");if(1<t.length){var a=t[t.length-1],i=t.slice(0,t.length-1),o=i.join(".");return ze(a,o)}return ze(e)}function ze(e,t){return{shortTypeName:e,namespace:t,typeName:Be(e,t)}}function Ue(e){return 0<=e.indexOf(":#")}function Be(e,t){return t&&0<t.length?e+":#"+t:e}function $e(e,t,r){if(t)if(Array.isArray(t))t.forEach(e._addPropertyCore.bind(e));else{if("object"!=typeof t)throw new Error("The 'dataProperties' or 'navigationProperties' values must be either an array of data/nav properties or an object where each property defines a data/nav property");for(var n in t)if(M(t,n)){var a=t[n];a.name=n;var i=new r(a);e._addPropertyCore(i)}}}(function(){var e=H.prototype;function t(e,t){return null!=t&&void 0!==t.entityType}function r(e,t){return null!=t&&(t.isDataProperty||t.isNavigationProperty)}e.isEntity=function(){return this._addContext({fn:t,msg:" must be an entity"})},e.isEntityProperty=function(){return this._addContext({fn:r,msg:" must be either a DataProperty or a NavigationProperty"})}})(),v.MetadataStore=Ae,v.EntityType=xe,v.ComplexType=Fe,v.DataProperty=Me,v.NavigationProperty=ke,v.AutoGeneratedKeyType=De;var Le=function(){var e=function(){this._tempIdMap={}},t=e.prototype;function s(e,t,r){var n=t.name+".."+t.parentType.name,a=e._tempIdMap[n];return a||r&&(a={entityType:t.parentType,propertyName:t.name,keyMap:{}},e._tempIdMap[n]=a),a}return t.generateTempKeyValue=function(e,t){var r=e.keyProperties;if(1<r.length)throw new Error("Ids can not be autogenerated for entities with multipart keys");var n,a=r[0],i=s(this,a,!0);if(null!=t&&(i.keyMap[t.toString()]||(n=t)),void 0===n){var o=a.dataType;if(!o.getNext)throw new Error("Cannot use a property with a dataType of: "+o.toString()+" for id generation");for(n=o.getNext(this);null!=i.keyMap[n.toString()];)n=o.getNext(this)}return i.keyMap[n.toString()]=!0,n},t.getTempKeys=function(){var e=[];for(var t in this._tempIdMap){var r=this._tempIdMap[t],n=r.entityType;for(var a in r.keyMap)e.push(new me(n,[a]))}return e},t.isTempKey=function(e){var t=e.entityType.keyProperties;if(1<t.length)return!1;var r=t[0],n=s(this,r);return!!n&&void 0!==n.keyMap[e.values[0].toString()]},ne.registerType(e,"KeyGenerator"),e}();v.KeyGenerator=Le;var Ge=(Je=function(e){Y(e||{}).whereParam("name").isOptional().isString().whereParam("isCaseSensitive").isOptional().isBoolean().whereParam("usesSql92CompliantStringComparison").isBoolean().applyAll(this),this.name||(this.name=E()),ne._storeObject(this,Qe._$typeName,this.name)},Qe=Je.prototype,Qe._$typeName="LocalQueryComparisonOptions",Je.caseInsensitiveSQL=new Je({name:"caseInsensitiveSQL",isCaseSensitive:!1,usesSql92CompliantStringComparison:!0}),Je.defaultInstance=new Je(Je.caseInsensitiveSQL),Qe.setAsDefault=function(){return i(this,Je)},Je);var Je,Qe;v.LocalQueryComparisonOptions=Ge;var He=(Ze=function(e){Y(e||{}).whereParam("name").isOptional().isString().whereParam("serverPropertyNameToClient").isFunction().whereParam("clientPropertyNameToServer").isFunction().applyAll(this),this.name||(this.name=E()),ne._storeObject(this,We._$typeName,this.name)},We=Ze.prototype,We._$typeName="NamingConvention",Ze.none=new Ze({name:"noChange",serverPropertyNameToClient:function(e){return e},clientPropertyNameToServer:function(e){return e}}),Ze.camelCase=new Ze({name:"camelCase",serverPropertyNameToClient:function(e){return e.substr(0,1).toLowerCase()+e.substr(1)},clientPropertyNameToServer:function(e){return e.substr(0,1).toUpperCase()+e.substr(1)}}),Ze.defaultInstance=new Ze(Ze.none),We.setAsDefault=function(){return i(this,Ze)},Ze);var Ze,We;v.NamingConvention=He;var Ye=function(){var e,t,r,n,a,i,o,s,u,p,c,l,y,f=function(){var e=function(){if(0!==arguments.length){if(1===arguments.length){var e=arguments[0];return Array.isArray(e)?1===e.length?f(e[0]):a(e):e instanceof f?e:"string"==typeof e?new h(e):o(e)}return a(Array.prototype.slice.call(arguments,0))}},t=e.prototype;function r(e,t){var r=t[0];return r instanceof f?r=k(t):Array.isArray(r)||(r=[f(k(t))]),[e].concat(r)}function i(t,e,r){var n=e.toLowerCase();r.key=n,(t[n]=r).aliases&&r.aliases.forEach(function(e){t[e.toLowerCase()]=r})}function a(e){var t={},r={};t[e[0]]=r;var n=e[1];return n=n.operator||n,3==e.length?r[n]=e[2]:r[n]=a(e.splice(2)),o(t)}function o(t){if(t instanceof f)return t;if("object"!=typeof t)throw new Error("Unable to convert to a Predicate: "+t);var e=Object.keys(t),r=e.map(function(e){return function(e,r){if(v.prototype._resolveOp(e,!0))return new v(e,r);if(d.prototype._resolveOp(e,!0))return new d(e,r);{if("object"!=typeof r||null==r||R(r))return new m("eq",e,r);if(M(r,"value"))return new m("eq",e,r)}if(Array.isArray(r))throw new Error("Unable to resolve predicate after the phrase: "+e);var n=e,t=Object.keys(r).map(function(e){if(g.prototype._resolveOp(e,!0))return new g(e,n,r[e]);if(m.prototype._resolveOp(e,!0))return new m(e,n,r[e]);if(M(r[e],"value"))return new m("eq",n,r[e]);var t=G("Unable to resolve predicate after the phrase: '%1' for operator: '%2'  and value: '%3'",n,e,r[e]);throw new Error(t)});return 1===t.length?t[0]:new v("and",t)}(e,t[e])});return 1===r.length?r[0]:new v("and",r)}return(e.create=e).and=function(){var e=new v("and",k(arguments));return e.op&&e},e.or=function(){var e=new v("or",k(arguments));return e.op&&e},e.not=function(e){return e.not()},e.extendBinaryPredicateFn=function(e,t){var a=x.binaryPredicate;for(var r in e||{}){var n=e[r];n.visitorFn=t,i(m.prototype.aliasMap,r,e[r])}x.isExtended||(x.binaryPredicate=function(e,t,r){var n=this.aliasMap[this.op.key].visitorFn;return n?n(e,t,r):a(e,t,r)},x.isExtended=!0)},t.and=function(){return new v("and",r(this,arguments))},t.or=function(){return new v("or",r(this,arguments))},t.not=function(){return new d("not",this)},t.toJSON=function(){return this.toJSONExt({entityType:this._entityType})},t.toJSONExt=function(e){return this.visit(e,F)},t.toFunction=function(e){return this.visit(e,x)},t.toString=function(){return JSON.stringify(this)},t.visit=function(e,t){if(B(e))e={entityType:null};else if(e instanceof xe)e={entityType:e};else if(!M(e,"entityType"))throw new Error("All visitor methods must be called with a context object containing at least an 'entityType' property");t?e.visitor=t:t=e.visitor;var r=t[this.visitorMethodName];if(null==r)throw new Error("Unable to locate method: "+this.visitorMethodName+" on visitor");var n=e.entityType;(this._validate&&null==n||this._entityType!==n)&&(this._validate(n,e.usesNameOnServer),this._entityType=n);Array.prototype.slice.call(arguments,1);return r.call(this,e)},t._initialize=function(e,t){this.visitorMethodName=e;var r=this.aliasMap={};for(var n in t||{})i(r,n,t[n])},t._resolveOp=function(e,t){e=e.operator||e;var r=this.aliasMap[e.toLowerCase()];if(!r&&!t)throw new Error("Unable to resolve operator: "+e);return r},e}(),h=((t=(e=function(e){this.value=e}).prototype=new f)._initialize("passthruPredicate"),t._validate=j,e),d=((n=(r=function(e,t){this.op=this._resolveOp(e),this.pred=f(t)}).prototype=new f)._initialize("unaryPredicate",{not:{aliases:["!","~"]}}),n._validate=function(e,t){this.pred._validate(e,t)},r),m=((i=(a=function(e,t,r){this.op=this._resolveOp(e),this.expr1Source=t,this.expr2Source=r}).prototype=new f)._initialize("binaryPredicate",{eq:{aliases:["==","equals"]},ne:{aliases:["!=","~=","notequals"]},lt:{aliases:["<","lessthan"]},le:{aliases:["<=","lessthanorequal"]},gt:{aliases:[">","greaterthan"]},ge:{aliases:[">=","greaterthanorequal"]},startswith:{isFunction:!0},endswith:{isFunction:!0},contains:{aliases:["substringof"],isFunction:!0},in:{}}),i._validate=function(e,t){var r={entityType:e,usesNameOnServer:t};if(this.expr1=O(this.expr1Source,r),null==this.expr1)throw new Error("Unable to validate 1st expression: "+this.expr1Source);if(this.expr1 instanceof S)throw new Error("The left hand side of a binary predicate cannot be a literal expression, it must be a valid property or functional predicate expression: "+this.expr1Source);if("in"==this.op.key&&!Array.isArray(this.expr2Source))throw new Error("The 'in' operator requires that its right hand argument be an array");var n=D(r,{isRHS:!0,dataType:this.expr1.dataType});if(this.expr2=O(this.expr2Source,n),null==this.expr2)throw new Error("Unable to validate 2nd expression: "+this.expr2Source);null==this.expr1.dataType&&(this.expr1.dataType=this.expr2.dataType)},a),v=((s=(o=function(e,t){if(this.op=this._resolveOp(e),1==t.length&&Array.isArray(t[0])&&(t=t[0]),this.preds=t.filter(function(e){return null!=e}).map(function(e){return f(e)}),0==this.preds.length&&(this.op=null),1==this.preds.length)return this.preds[0]}).prototype=new f)._initialize("andOrPredicate",{and:{aliases:["&&"]},or:{aliases:["||"]}}),s._validate=function(t,r){this.preds.every(function(e){e._validate(t,r)})},o),g=((p=(u=function(e,t,r){this.op=this._resolveOp(e),this.exprSource=t,this.pred=f(r)}).prototype=new f)._initialize("anyAllPredicate",{any:{aliases:["some"]},all:{aliases:["every"]}}),p._validate=function(e,t){this.expr=O(this.exprSource,{entityType:e,usesNameOnServer:t}),(null==e||e.isAnonymous)&&(this.expr.dataType=null),this.pred._validate(this.expr.dataType,t)},u),w=function(e){this.visitorMethodName=e,this.visit=f.prototype.visit,this._validate=j},S=(((c=function(e,t,r){(t=(t=function(e){if(null==e)return e;if(be.contains(e))return e;if(q(e)){var t=be.fromName(e);if(t)return t;throw new Error("Unable to resolve a dataType named: "+e)}throw new Error("The dataType parameter passed into this literal expression is not a 'DataType'"+e)}(t))||be.fromValue(e))&&t.parse?Array.isArray(e)?this.value=e.map(function(e){return t.parse(e,typeof e)}):this.value=t.parse(e,typeof e):this.value=e,this.dataType=t,this.hasExplicitDataType=r}).prototype=new w("litExpr")).toString=function(){return" LitExpr - value: "+this.value.toString()+" dataType: "+this.dataType.toString()},c),E=((y=(l=function(e){this.propertyPath=e}).prototype=new w("propExpr")).toString=function(){return" PropExpr - "+this.propertyPath},y._validate=function(e,t){if(null!=e&&!e.isAnonymous){var r=e.getPropertiesOnPath(this.propertyPath,t,!1);if(!r){var n=G("Unable to resolve propertyPath.  EntityType: '%1'   PropertyPath: '%2'",e.name,this.propertyPath);throw new Error(n)}var a=r[r.length-1];a.isDataProperty?this.dataType=a.dataType:this.dataType=a.entityType}},l),T=function(){var e=function(e,t){this.fnName=e,this.exprs=t;var r=n[e];if(null==r)throw new Error("Unknown function: "+e);this.localFn=r.fn,this.dataType=r.dataType},t=e.prototype=new w("fnExpr");t.toString=function(){var e=this.exprs.map(function(e){e.toString()}).toString();return"FnExpr - "+this.fnName+"("+e+")"},t._validate=function(t,r){this.exprs.forEach(function(e){e._validate(t,r)})};var n=e.funcMap={toupper:{fn:function(e){return e.toUpperCase()},dataType:be.String},tolower:{fn:function(e){return e.toLowerCase()},dataType:be.String},substring:{fn:function(e,t,r){return e.substring(t,r)},dataType:be.String},substringof:{fn:function(e,t){return 0<=t.indexOf(e)},dataType:be.Boolean},length:{fn:function(e){return e.length},dataType:be.Int32},trim:{fn:function(e){return e.trim()},dataType:be.String},concat:{fn:function(e,t){return e.concat(t)},dataType:be.String},replace:{fn:function(e,t,r){return e.replace(t,r)},dataType:be.String},startswith:{fn:function(e,t){return $(e,t)},dataType:be.Boolean},endswith:{fn:function(e,t){return L(e,t)},dataType:be.Boolean},indexof:{fn:function(e,t){return e.indexOf(t)},dataType:be.Int32},round:{fn:function(e){return Math.round(e)},dataType:be.Int32},ceiling:{fn:function(e){return Math.ceil(e)},dataType:be.Int32},floor:{fn:function(e){return Math.floor(e)},dataType:be.Int32},second:{fn:function(e){return e.getSeconds()},dataType:be.Int32},minute:{fn:function(e){return e.getMinutes()},dataType:be.Int32},day:{fn:function(e){return e.getDate()},dataType:be.Int32},month:{fn:function(e){return e.getMonth()+1},dataType:be.Int32},year:{fn:function(e){return e.getFullYear()},dataType:be.Int32}};return e}(),P=/^[a-z_][\w.$]*$/i,b=/('[^']*'|[^,]+)/g,_=/("[^"]*"|[^,]+)/g,N=String.fromCharCode(191);function O(e,t){var r=t.entityType;if(Array.isArray(e)){if(!t.isRHS)throw new Error("Array expressions are only permitted on the right hand side of a BinaryPredicate");return new S(e,t.dataType)}if(!q(e)){if(null==e||"object"!=typeof e||e.toISOString)return new S(e,t.dataType);if(void 0===e.value)throw new Error("Unable to resolve an expression for: "+e+" on entityType: "+r.name);return e.isProperty?new E(e.value):new S(e.value,e.dataType||t.dataType,!0)}if(t.isRHS)return null==r||r.isAnonymous?new S(e,t.dataType):C(e,t);for(var n,a=/\([^()]*\)/,i=[],o=0;n=a.exec(e);){var s=n[0];i.push(s);var u=N+o++;e=e.replace(s,u)}var p=A(e,i,t);return p._validate(r,t.usesNameOnServer),p}function A(e,t,r){var n=e.split(N);return 1===n.length?C(n[0],r):function(e,t,r,n){try{var a=t[0].trim().toLowerCase(),i=r[t[1]].trim();"("===i.substr(0,1)&&(i=i.substr(1,i.length-2));var o=0<=e.indexOf("'")?b:_,s=i.match(o),u=D({},n);u.dataType=be.Undefined,u.isFnArg=!0;var p=s.map(function(e){return A(e,r,u)});return new T(a,p)}catch(e){return null}}(e,n,t,r)}function C(e,t){var r=(e=e.trim()).substr(0,1),n=("'"===r||'"'===r)&&1<e.length&&e.substr(e.length-1)===r;if(n){var a=e.substr(1,e.length-2);return new S(a,t.dataType||be.String)}var i=t.entityType;if(null==i||i.isAnonymous)return new E(e);var o=P.test(e);return o&&null!=i.getPropertiesOnPath(e,t.usesNameOnServer,!1)?new E(e):new S(e,t.dataType)}var x=function(){var e={passthruPredicate:function(){throw new Error("Cannot execute an PassthruPredicate expression against the local cache: "+this.value)},unaryPredicate:function(e){var t=this.pred.visit(e);switch(this.op.key){case"not":return function(e){return!t(e)};default:throw new Error("Invalid unary operator:"+this.op.key)}},binaryPredicate:function(e){var t=this.expr1.visit(e),r=this.expr2.visit(e),n=this.expr1.dataType||this.expr2.dataType,a=e.entityType.metadataStore.localQueryComparisonOptions,i=function(e,t,r){var n,a=e.op,i=be.getComparableFn(t);switch(a.key){case"eq":n=function(e,t){return e&&"string"==typeof e?o(e,t,r):i(e)==i(t)};break;case"ne":n=function(e,t){return e&&"string"==typeof e?!o(e,t,r):i(e)!=i(t)};break;case"gt":n=function(e,t){return i(e)>i(t)};break;case"ge":n=function(e,t){return i(e)>=i(t)};break;case"lt":n=function(e,t){return i(e)<i(t)};break;case"le":n=function(e,t){return i(e)<=i(t)};break;case"startswith":n=function(e,t){return function(e,t,r){r.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase());return $(e,t)}(e,t,r)};break;case"endswith":n=function(e,t){return function(e,t,r){r.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase());return L(e,t)}(e,t,r)};break;case"contains":n=function(e,t){return function(e,t,r){r.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase());return 0<=e.indexOf(t)}(e,t,r)};break;case"in":n=function(e,t){return e=i(e),0<=(t=t.map(function(e){return i(e)})).indexOf(e)};break;default:return null}return n}(this,n,a);if(null==i)throw new Error("Invalid binaryPredicate operator:"+this.op.key);return function(e){return i(t(e),r(e))}},andOrPredicate:function(t){var n=this.preds.map(function(e){return e.visit(t)});switch(this.op.key){case"and":return function(r){var e=n.reduce(function(e,t){return e&&t(r)},!0);return e};case"or":return function(r){var e=n.reduce(function(e,t){return e||t(r)},!1);return e};default:throw new Error("Invalid boolean operator:"+op.key)}},anyAllPredicate:function(e){var t=this.expr.visit(e),r=D({},e);r.entityType=this.expr.dataType;var n=this.pred.visit(r),a=function(e){switch(e.key){case"any":return function(e,t){return e.some(function(e){return t(e)})};case"all":return function(e,t){return e.every(function(e){return t(e)})};default:throw new Error("Unknown operator: "+e.key)}}(this.op);return function(e){return a(t(e),n)}},litExpr:function(){var t=this.value;return function(e){return t}},propExpr:function(){var t=this.propertyPath,r=t.split(".");return 1===r.length?function(e){return e.getProperty(t)}:function(e){return ct(e,r)}},fnExpr:function(t){var n=this.exprs.map(function(e){return e.visit(t)}),a=this;return function(r){var e=n.map(function(e){var t=e(r);return t}),t=a.localFn.apply(null,e);return t}}};function o(e,t,r){return null!=t&&("string"!=typeof t&&(t=t.toString()),r.usesSql92CompliantStringComparison&&(e=(e||"").trim(),t=(t||"").trim()),r.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),e===t)}return e}(),F=function(){var e={passthruPredicate:function(){return this.value},unaryPredicate:function(e){var t=this.pred.visit(e),r={};return r[this.op.key]=t,r},binaryPredicate:function(e){var t=this.expr1.visit(e),r=this.expr2.visit(e),n={};if(this.expr2 instanceof E&&(r={value:r,isProperty:!0}),"eq"===this.op.key)n[t]=r;else{var a={};(n[t]=a)[this.op.key]=r}return n},andOrPredicate:function(t){var e,r=this.preds.map(function(e){return e.visit(t)});return r&&r.length?("and"!==this.op.key||2!==r.length||r.some(q)||(e=r.reduce(n)),null==e&&((e={})[this.op.key]=r),e):{}},anyAllPredicate:function(e){var t=this.expr.visit(e),r=D({},e);r.entityType=this.expr.dataType;var n=this.pred.visit(r),a={},i={};return i[this.op.key]=n,a[t]=i,a},litExpr:function(e){return this.hasExplicitDataType||e.useExplicitDataType?{value:this.value,dataType:this.dataType.name}:this.value},propExpr:function(e){return e.toNameOnServer?e.entityType.clientPropertyPathToServer(this.propertyPath):this.propertyPath},fnExpr:function(t){var e=this.exprs.map(function(e){return e.visit(t)});return this.fnName+"("+e.join(",")+")"}};function n(t,r){var e=Object.keys(r).every(function(e){if(t.hasOwnProperty(e)){if("object"!=typeof r[e])return!1;if(null==n(t[e],r[e]))return!1}else t[e]=r[e];return!0});return e?t:null}return e}();return f}();v.Predicate=Ye;var Xe=function(){var e=function(e){if(null!=e&&!q(e))return y(e,{"resourceName,from":null,"resultEntityType,toType":null,"wherePredicate,where":function(e){return e?new Ye(e):void 0},"orderByClause,orderBy":function(e){return e?new tt(e):void 0},"selectClause,select":function(e){return e?new rt(e):void 0},"expandClause,expand":function(e){return e?new nt(e):void 0},"skipCount,skip":null,"takeCount,take":null,parameters:function(e){return B(e)?void 0:e},"inlineCountEnabled,inlineCount":!1,"noTrackingEnabled,noTracking":!1,queryOptions:function(e){return e?ft.fromJSON(e):void 0}},t=this),t;var t;this.resourceName=e,this.fromEntityType=null,this.wherePredicate=null,this.orderByClause=null,this.selectClause=null,this.skipCount=null,this.takeCount=null,this.expandClause=null,this.parameters={},this.inlineCountEnabled=!1,this.noTrackingEnabled=!1,this.entityManager=null},t=e.prototype;function n(e,t,r){if(t&&e[t]===r)return e;var n=D(new Xe,e,["resourceName","fromEntityType","wherePredicate","orderByClause","selectClause","skipCount","takeCount","expandClause","inlineCountEnabled","noTrackingEnabled","usesNameOnServer","queryOptions","entityManager","dataService","resultEntityType"]);return n.parameters=D({},e.parameters),t&&(n[t]=r),n}function a(e){return Z(e,"propertyPaths").isOptional().isString().or().isArray().isString().check(),"string"==typeof e&&(e=e.split(",")),e=e.map(function(e){return e.trim()})}function u(e){var t=e.entityType.keyProperties,r=C(t,e.values,function(e,t){return Ye.create(e.name,et.Equals,t)}),n=Ye.and(r);return n}return t._$typeName="EntityQuery",t.from=function(e){return Z(e,"resourceName").isString().check(),n(this,"resourceName",e)},e.from=function(e){return Z(e,"resourceName").isString().check(),new Xe(e)},t.toType=function(e){return Z(e,"entityType").isString().or().isInstanceOf(xe).check(),n(this,"resultEntityType",e)},t.where=function(e){return null!=e&&(e=Ye.create(k(arguments)),this.fromEntityType&&e._validate(this.fromEntityType),this.wherePredicate&&(e=this.wherePredicate.and(e))),n(this,"wherePredicate",e)},t.orderBy=function(e,t){var r=null==e?null:new tt(a(e),t);return this.orderByClause&&r&&(r=new tt([this.orderByClause,r])),n(this,"orderByClause",r)},t.orderByDesc=function(e){return this.orderBy(e,!0)},t.select=function(e){var t=null==e?null:new rt(a(e));return n(this,"selectClause",t)},t.skip=function(e){return Z(e,"count").isOptional().isNumber().check(),n(this,"skipCount",null==e?null:e)},t.top=function(e){return this.take(e)},t.take=function(e){return Z(e,"count").isOptional().isNumber().check(),n(this,"takeCount",null==e?null:e)},t.expand=function(e){var t=null==e?null:new nt(a(e));return n(this,"expandClause",t)},t.withParameters=function(e){return Z(e,"parameters").isObject().check(),n(this,"parameters",e)},t.inlineCount=function(e){return Z(e,"enabled").isBoolean().isOptional().check(),n(this,"inlineCountEnabled",e=void 0===e||!!e)},t.useNameOnServer=function(e){return Z(e,"usesNameOnServer").isBoolean().isOptional().check(),n(this,"usesNameOnServer",e=void 0===e||!!e)},t.noTracking=function(e){return Z(e,"enabled").isBoolean().isOptional().check(),n(this,"noTrackingEnabled",e=void 0===e||!!e)},t.using=function(e){if(!e)return this;var t=n(this);return function r(n,a,e,t){var i=e._$typeName||e.parentEnum&&e.parentEnum.name;var o=i&&i.substr(0,1).toLowerCase()+i.substr(1);if(t&&o!=t)throw new Error("Invalid value for property: "+t);if(o){var s=a[o];if(void 0===s)throw new Error("Invalid config property: "+o);null===s?n[o]=e:s(n,e)}else T(e,function(e,t){r(n,a,t,e)})}(t,{entityManager:null,dataService:null,queryOptions:null,fetchStrategy:function(e,t){e.queryOptions=(e.queryOptions||new ft).using(t)},mergeStrategy:function(e,t){e.queryOptions=(e.queryOptions||new ft).using(t)},jsonResultsAdapter:function(e,t){e.dataService=(e.dataService||new _e).using({jsonResultsAdapter:t})}},e),t},t.execute=function(e,t){if(!this.entityManager)throw new Error("An EntityQuery must have its EntityManager property set before calling 'execute'");return this.entityManager.executeQuery(this,e,t)},t.executeLocally=function(){if(!this.entityManager)throw new Error("An EntityQuery must have its EntityManager property set before calling 'executeLocally'");return this.entityManager.executeQueryLocally(this)},t.toJSON=function(){return this.toJSONExt()},t.toJSONExt=function(t){(t=t||{}).entityType=t.entityType||this.fromEntityType,t.propertyPathFn=t.toNameOnServer?t.entityType.clientPropertyPathToServer.bind(t.entityType):r;var e=function(e){return e?e.toJSONExt(t):void 0};return y(this,{"from,resourceName":null,"toType,resultEntityType":function(e){return e?q(e)?e:e.name:void 0},"where,wherePredicate":e,"orderBy,orderByClause":e,"select,selectClause":e,"expand,expandClause":e,"skip,skipCount":null,"take,takeCount":null,parameters:function(e){return B(e)?void 0:e},"inlineCount,inlineCountEnabled":!1,"noTracking,noTrackingEnabled":!1,queryOptions:null})},e.fromEntities=function(e){Z(e,"entities").isEntity().or().isNonEmptyArray().isEntity().check(),Array.isArray(e)||(e=k(arguments));var t=e[0],r=t.entityType;if(e.some(function(e){return e.entityType!==r}))throw new Error("All 'fromEntities' must be the same type; at least one is not of type "+r.name);var n=new Xe(r.defaultResourceName),a=e.map(function(e){return r=(t=e).entityType.keyProperties.map(function(e){return Ye.create(e.name,et.Equals,t.getProperty(e.name))}),Ye.and(r);var t,r}),i=Ye.or(a);n=n.where(i);var o=t.entityAspect.entityManager;return o&&(n=n.using(o)),n},e.fromEntityKey=function(e){Z(e,"entityKey").isInstanceOf(me).check();var t=new Xe(e.entityType.defaultResourceName),r=u(e);return t=t.where(r).toType(e.entityType)},e.fromEntityNavigation=function(e,t){Z(e,"entity").isEntity().check();var r=e.entityType._checkNavProperty(t),n=new Xe(r.entityType.defaultResourceName),a=function(t,e){{if(e.isScalar){if(0===e.foreignKeyNames.length)return null;var r=e.foreignKeyNames.map(function(e){return t.getProperty(e)}),n=new me(e.entityType,r);return u(n)}var a=e.getInverse(),i=a?a.foreignKeyNames:e.invForeignKeyNames;if(0===i.length)return null;var o=t.entityAspect.getKey().values,s=C(i,o,function(e,t){return Ye.create(e,et.Equals,t)});return Ye.and(s)}}(e,r);n=n.where(a);var i=e.entityAspect.entityManager;return i?n.using(i):n},t._getFromEntityType=function(e,t){var r=this.fromEntityType;if(r)return r;var n=this.resourceName;if(!n)throw new Error("There is no resourceName for this query");if(e.isEmpty()){if(t)throw new Error("There is no metadata available for this query. Are you querying the local cache before you've fetched metadata?");return null}var a=e.getEntityTypeNameForResourceName(n);if(!(r=a?e._getEntityType(a):this._getToEntityType(e,!0))){if(t)throw new Error(G("Cannot find an entityType for resourceName: '%1'.  Consider adding an 'EntityQuery.toType' call to your query or calling the MetadataStore.setEntityTypeForResourceName method to register an entityType for this resourceName.",n));return null}return this.fromEntityType=r},t._getToEntityType=function(e,t){return this.resultEntityType instanceof xe?this.resultEntityType:this.resultEntityType?(this.resultEntityType=e._getEntityType(this.resultEntityType,!1),this.resultEntityType):t?null:!this.selectClause&&this._getFromEntityType(e,!1)},t._toUri=function(e){var t=_e.resolve([e.dataService]);return t.uriBuilder.buildUri(this,e.metadataStore)},e}(),et=(pt=new te("FilterQueryOp"),pt.Equals=pt.addSymbol({operator:"eq"}),pt.NotEquals=pt.addSymbol({operator:"ne"}),pt.GreaterThan=pt.addSymbol({operator:"gt"}),pt.LessThan=pt.addSymbol({operator:"lt"}),pt.GreaterThanOrEqual=pt.addSymbol({operator:"ge"}),pt.LessThanOrEqual=pt.addSymbol({operator:"le"}),pt.Contains=pt.addSymbol({operator:"contains"}),pt.StartsWith=pt.addSymbol({operator:"startswith"}),pt.EndsWith=pt.addSymbol({operator:"endswith"}),pt.Any=pt.addSymbol({operator:"any"}),pt.All=pt.addSymbol({operator:"all"}),pt.In=pt.addSymbol({operator:"in"}),pt.IsTypeOf=pt.addSymbol({operator:"isof"}),pt.resolveSymbols(),pt),tt=(ut=new te("BooleanQueryOp"),ut.And=ut.addSymbol({operator:"and"}),ut.Or=ut.addSymbol({operator:"or"}),ut.Not=ut.addSymbol({operator:"not"}),ut.resolveSymbols(),function(){var e=function(e,t){if(1<e.length){if(e[0]instanceof tt)return void(this.items=Array.prototype.concat.apply(e[0].items,e.slice(1).map(d("items"))));var r=e.map(function(e){return new n(e,t)})}else var r=[new n(e[0],t)];this.items=r},t=e.prototype;t.validate=function(t){null==t||t.isAnonymous||this.items.forEach(function(e){e.validate(t)})},t.getComparer=function(t){var a=this.items.map(function(e){return e.getComparer(t)});return function(e,t){for(var r=0;r<a.length;r++){var n=a[r](e,t);if(0!==n)return n}return 0}},t.toJSONExt=function(t){return this.items.map(function(e){return t.propertyPathFn(e.propertyPath)+(e.isDesc?" desc":"")})};var n=function(e,t){if("string"!=typeof e)throw new Error("propertyPath is not a string");var r=(e=e.trim()).split(" ");if(1<r.length&&!0!==t&&!1!==t&&!(t=$(r[1].toLowerCase(),"desc"))){var n=$(r[1].toLowerCase(),"asc");if(!n)throw new Error("the second word in the propertyPath must begin with 'desc' or 'asc'")}this.propertyPath=r[0],this.isDesc=t},r=n.prototype;return r.validate=function(e){null==e||e.isAnonymous||(this.lastProperty=e.getProperty(this.propertyPath,!0))},r.getComparer=function(e){if(this.lastProperty||this.validate(e),this.lastProperty)var o=this.lastProperty.dataType,s=this.lastProperty.parentType.metadataStore.localQueryComparisonOptions.isCaseSensitive;var u=this.propertyPath,p=this.isDesc;return function(e,t){var r=ct(e,u),n=ct(t,u),a=o||r&&be.fromValue(r)||be.fromValue(n);if(a===be.String)s?(r=r||"",n=n||""):(r=(r||"").toLowerCase(),n=(n||"").toLowerCase());else{var i=be.getComparableFn(a);r=i(r),n=i(n)}return r===n?0:n<r||void 0===n?p?-1:1:p?1:-1}},e}()),rt=(ot=function(e){this.propertyPaths=e,this._pathNames=e.map(function(e){return e.replace(".","_")})},st=ot.prototype,st.validate=function(t){null==t||t.isAnonymous||this.propertyPaths.forEach(function(e){t.getProperty(e,!0)})},st.toFunction=function(){var a=this;return function(r){var n={};return a.propertyPaths.forEach(function(e,t){n[a._pathNames[t]]=ct(r,e)}),n}},st.toJSONExt=function(t){return this.propertyPaths.map(function(e){return t.propertyPathFn(e)})},ot),nt=(at=function(e){this.propertyPaths=e},it=at.prototype,it.toJSONExt=function(t){return this.propertyPaths.map(function(e){return t.propertyPathFn(e)})},at);var at,it;var ot,st;var ut;var pt;function ct(e,t){var r=Array.isArray(t)?t:t.split(".");if(1===r.length)return e.getProperty(t);var n=e;return r.some(function(e){return null==(n=n.getProperty(e))}),n}v.FilterQueryOp=et,v.EntityQuery=Xe,v.OrderByClause=tt;var lt=(dt=new te("MergeStrategy"),dt.PreserveChanges=dt.addSymbol(),dt.OverwriteChanges=dt.addSymbol(),dt.SkipMerge=dt.addSymbol(),dt.Disallowed=dt.addSymbol(),dt.resolveSymbols(),dt),yt=(ht=new te("FetchStrategy"),ht.FromServer=ht.addSymbol(),ht.FromLocalCache=ht.addSymbol(),ht.resolveSymbols(),ht),ft=function(){var e=function(e){r(this,e)},t=e.prototype;function r(e,t){return t&&Y(t).whereParam("fetchStrategy").isEnumOf(yt).isOptional().whereParam("mergeStrategy").isEnumOf(lt).isOptional().whereParam("includeDeleted").isBoolean().isOptional().applyAll(e),e}return t._$typeName="QueryOptions",e.resolve=function(e){return new ft(u(e,["fetchStrategy","mergeStrategy","includeDeleted"]))},e.defaultInstance=new e({fetchStrategy:yt.FromServer,mergeStrategy:lt.PreserveChanges,includeDeleted:!1}),t.using=function(e){if(!e)return this;var t=new ft(this);return lt.contains(e)?e={mergeStrategy:e}:yt.contains(e)&&(e={fetchStrategy:e}),r(t,e)},t.setAsDefault=function(){return i(this,e)},t.toJSON=function(){return y(this,{fetchStrategy:null,mergeStrategy:null,includeDeleted:!1})},e.fromJSON=function(e){return new ft({fetchStrategy:yt.fromName(e.fetchStrategy),mergeStrategy:lt.fromName(e.mergeStrategy),includeDeleted:!0===e.includeDeleted})},e}();var ht;var dt;v.QueryOptions=ft,v.FetchStrategy=yt,v.MergeStrategy=lt;var mt=(gt=function(e,t){this.entityManager=e,this.entityType=t,this.entityType.isFrozen=!0,this._indexMap={},this._entities=[],this._emptyIndexes=[]},wt=gt.prototype,wt.attachEntity=function(e,t,r){var n=e.entityAspect;n._initialized||this.entityType._initializeInstance(e),delete n._initialized;var a=n.getKey()._keyInGroup,i=this._indexMap[a];if(0<=i){var o=this._entities[i],s=o.entityAspect.entityState,u=s.isUnchanged();if(o===e)n.entityState=t;else{if(r===lt.Disallowed)throw new Error("A MergeStrategy of 'Disallowed' does not allow you to attach an entity when an entity with the same key is already attached: "+n.getKey());if(r===lt.OverwriteChanges||r===lt.PreserveChanges&&u){var p=this.entityManager.helper.unwrapInstance(e);this.entityType._updateTargetFromRaw(o,p,Me.getRawValueFromServer),o.entityAspect.setEntityState(t)}}return o}return 0===this._emptyIndexes.length?i=this._entities.push(e)-1:(i=this._emptyIndexes.pop(),this._entities[i]=e),this._indexMap[a]=i,n.entityState=t,n.entityGroup=this,n.entityManager=this.entityManager,e},wt.detachEntity=function(e){var t=e.entityAspect,r=t.getKey()._keyInGroup,n=this._indexMap[r];if(void 0===n)throw new Error("internal error - entity cannot be found in group");return delete this._indexMap[r],this._emptyIndexes.push(n),this._entities[n]=null,e},wt.findEntityByKey=function(e){var t;t=e instanceof me?e._keyInGroup:me.createKeyString(e);var r=this._indexMap[t];return void 0!==r?this._entities[r]:null},wt.hasChanges=function(){for(var e=this._entities,t=ve.Unchanged,r=0,n=e.length;r<n;r++){var a=e[r];if(a&&a.entityAspect.entityState!==t)return!0}return!1},wt.getChanges=function(){for(var e=this._entities,t=ve.Unchanged,r=[],n=0,a=e.length;n<a;n++){var i=e[n];i&&i.entityAspect.entityState!==t&&r.push(i)}return r},wt.getEntities=function(e){var t=function(t){if(t){if(1===t.length){var r=t[0];return function(e){return!!e&&e.entityAspect.entityState===r}}return function(e){return!!e&&-1!==t.indexOf(e.entityAspect.entityState)}}return function(e){return!!e}}(e);return this._entities.filter(t)},wt._checkOperation=function(t){return this._entities.forEach(function(e){e&&e.entityAspect._checkOperation(t)}),this},wt._clear=function(){this._entities.forEach(function(e){null!=e&&e.entityAspect._detach()}),this._entities=null,this._indexMap=null,this._emptyIndexes=null},wt._updateFkVal=function(e,t,r){var n=e.name;this._entities.forEach(function(e){null!=e&&e.getProperty(n)==t&&e.setProperty(n,r)})},wt._fixupKey=function(e,t){var r=this._indexMap[e];if(void 0===r)throw new Error("Internal Error in key fixup - unable to locate entity");var n=this._entities[r],a=n.entityType.keyProperties[0].name;n.setProperty(a,t),delete n.entityAspect.hasTempKey,delete this._indexMap[e],this._indexMap[t]=r},wt._replaceKey=function(e,t){var r=this._indexMap[e._keyInGroup];delete this._indexMap[e._keyInGroup],this._indexMap[t._keyInGroup]=r},gt),vt=function(){var t=function(e){if(1<arguments.length)throw new Error("The EntityManager ctor has a single optional argument that is either a 'serviceName' or a configuration object.");0===arguments.length?e={serviceName:""}:"string"==typeof e&&(e={serviceName:e}),r(this,e,!0),this.entityChanged=new re("entityChanged",this),this.validationErrorsChanged=new re("validationErrorsChanged",this),this.hasChangesChanged=new re("hasChangesChanged",this),this.clear()},e=t.prototype;function r(e,t,r){var n=r?ft.defaultInstance:e.queryOptions,a=r?Et.defaultInstance:e.saveOptions,i=r?pe.defaultInstance:e.validationOptions,o=Y(t).whereParam("serviceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(_e).whereParam("queryOptions").isInstanceOf(ft).isOptional().withDefault(n).whereParam("saveOptions").isInstanceOf(Et).isOptional().withDefault(a).whereParam("validationOptions").isInstanceOf(pe).isOptional().withDefault(i).whereParam("keyGeneratorCtor").isFunction().isOptional();r&&(o=o.whereParam("metadataStore").isInstanceOf(Ae).isOptional().withDefault(new Ae)),o.applyAll(e),P(e.queryOptions,n),P(e.saveOptions,a),P(e.validationOptions,i),t.serviceName&&(e.dataService=new _e({serviceName:e.serviceName})),e.serviceName=e.dataService&&e.dataService.serviceName,e.keyGeneratorCtor=e.keyGeneratorCtor||Le,(r||t.keyGeneratorCtor)&&(e.keyGenerator=new e.keyGeneratorCtor)}function p(e,t){Z(t,"query").isInstanceOf(Xe).check();var r,n=e.metadataStore,a=t._getFromEntityType(n,!0),i=(r=e,a.getSelfAndSubtypes().map(function(e){return E(r,e)})),o=t.wherePredicate&&t.wherePredicate.toFunction({entityType:a}),s=ft.resolve([t.queryOptions,e.queryOptions,ft.defaultInstance]),u=!0===s.includeDeleted,p=function(e){return e&&(u||!e.entityAspect.entityState.isDeleted())&&(!o||o(e))},c=[];i.forEach(function(e){var t=e._entities.filter(p);t.length&&(c=c.length?c.concat(t):t)});var l=t.orderByClause&&t.orderByClause.getComparer(a);if(l&&c.sort(l),t.inlineCountEnabled)var y=c.length;var f=t.skipCount;f&&(c=c.slice(f));var h=t.takeCount;h&&(c=c.slice(0,h));var d=t.selectClause;if(d){var m=d.toFunction();c=c.map(m)}return{results:c,inlineCount:y}}function n(e,t){var r,n=s(e,t),a=n.entityKey,i=0!==n.remainingArgs.length&&!!n.remainingArgs[0],o=!1;return i&&(r=e.getEntityByKey(a),(o=!!r)&&!e.queryOptions.includeDeleted&&r.entityAspect.entityState.isDeleted()&&(r=null,o=e.queryOptions.mergeStrategy!==lt.OverwriteChanges)),o?Oe.resolve({entity:r,entityKey:a,fromCache:!0}):Xe.fromEntityKey(a).using(e).execute().then(function(e){return r=0===e.results.length?null:e.results[0],Oe.resolve({entity:r,entityKey:a,fromCache:!1})})}function i(t,e){return Z(e,"entityTypes").isString().isOptional().or().isNonEmptyArray().isString().or().isInstanceOf(xe).or().isNonEmptyArray().isInstanceOf(xe).check(),"string"==typeof e?e=t.metadataStore._getEntityType(e,!1):Array.isArray(e)&&"string"==typeof e[0]&&(e=e.map(function(e){return t.metadataStore._getEntityType(e,!1)})),e}function a(e,t){var r,n=o(e,t);return n.forEach(function(e){if(e){var t=e.getChanges();r=r&&r.length?r.concat(t):t}}),r||[]}function s(e,t){try{if(t[0]instanceof me)return{entityKey:t[0],remainingArgs:k(t,1)};if(2<=t.length){var r="string"==typeof t[0]?e.metadataStore._getEntityType(t[0],!1):t[0];return{entityKey:new me(r,t[1]),remainingArgs:k(t,2)}}}catch(e){}throw new Error("Must supply an EntityKey OR an EntityType name or EntityType followed by a key value or an array of key values.")}function y(e,t){e.forEach(function(e){e.entityAspect.isBeingSaved=t})}function S(e,t){var r=e[t.toString()];if(r)return r;var n=t._subtypes;if(!n)return null;for(var a=0,i=n.length;a<i;a++)if(r=e[t.toString(n[a])])return r;return null}function u(e,t,r){return e=e.then(function(e){return t&&t(e),Oe.resolve(e)},function(e){return r&&r(e),Oe.reject(e)})}function o(e,t){var r=e._entityGroupMap;return t?_(t).map(function(e){if(e instanceof xe)return r[e.name];throw new Error("The EntityManager.getChanges() 'entityTypes' parameter must be either an entityType or an array of entityTypes or null")}):w(r)}function c(n,a,e,i){try{var o,t=n.metadataStore;if(t.isEmpty()&&i.hasServerMetadata)throw new Error("cannot execute _executeQueryCore until metadataStore is populated.");if(e.fetchStrategy===yt.FromLocalCache)try{var r=p(n,a);return Oe.resolve({results:r.results,entityManager:n,inlineCount:r.inlineCount,query:a})}catch(e){return Oe.reject(e)}var s=new St({query:a,entityManager:n,dataService:i,mergeOptions:{mergeStrategy:e.mergeStrategy,noTracking:!!a.noTrackingEnabled,includeDeleted:e.includeDeleted}}),u=n.validationOptions.validateOnQuery;return i.adapterInstance.executeQuery(s).then(function(r){var e=I(function(){var e={isLoading:n.isLoading};return n.isLoading=!0,n._pendingPubs=[],e},function(e){n.isLoading=e.isLoading,n._pendingPubs.forEach(function(e){e()}),n._pendingPubs=null,n._hasChangesAction&&n._hasChangesAction(),s=a=null,e.error&&Oe.reject(e.error)},function(){var e=i.jsonResultsAdapter.extractResults(r);e=_(e),o=s.visitAndMerge(e,{nodeType:"root"}),u&&o.forEach(function(e){e.entityAspect&&e.entityAspect.validateEntity()}),s.processDeferred(),function(r,e){if(e.noTrackingEnabled)return;var t=e.expandClause;if(null==t)return;t.propertyPaths.forEach(function(e){var t=e.split(".");!function n(e,a){var i=a[0];e.forEach(function(e){var t=e.entityAspect;if(t&&(t._markAsLoaded(i),1!==a.length)){var r=e.getProperty(i);r&&(r.arrayChanged||(r=[r]),n(r,a.slice(1)))}})}(r,t)})}(o,a);var t=g(s.refMap);return{results:o,query:a,entityManager:n,httpResponse:r.httpResponse,inlineCount:r.inlineCount,retrievedEntities:t}});return Oe.resolve(e)},function(e){return e&&(e.query=a,e.entityManager=n),Oe.reject(e)})}catch(e){return e&&(e.query=a),Oe.reject(e)}}function E(e,t){var r=e._entityGroupMap[t.name];return r||(r=new mt(e,t),e._entityGroupMap[t.name]=r),r}function l(r,n){var a={},e=r.entityType||r.complexType,i=d(e),o={};return e.dataProperties.forEach(function(e){if(e.isComplexProperty)a[e.nameOnServer]=N(r.getProperty(e.name),function(e){return l(e,n)});else{var t=r.getProperty(e.name);if(void 0===(t=n?n(e,t):t))return;void 0!==(t=i?i(e,t):t)&&(e.isUnmapped?o[e.nameOnServer]=b(t):a[e.nameOnServer]=t)}}),B(o)||(a.__unmapped=o),a}function f(e,t){var r=e.getProperty(t.name);return t.isScalar?h(r):!!r._origValues||r.some(function(e){return h(e)})}function h(t){return!B(t.complexAspect.originalValues)||t.complexType.complexProperties.some(function(e){return f(t,e)})}function d(e){return e.serializerFn||e.metadataStore&&e.metadataStore.serializerFn}function m(){this.map={}}return e._$typeName="EntityManager",re.bubbleEvent(e,null),e.setProperties=function(e){r(this,e,!1)},e.createEntity=function(e,t,r,n){var a;return Z(e,"entityType").isString().or().isInstanceOf(xe).check(),Z(r,"entityState").isEnumOf(ve).isOptional().check(),Z(n,"mergeStrategy").isEnumOf(lt).isOptional().check(),"string"==typeof e&&(e=this.metadataStore._getEntityType(e)),r=r||ve.Added,F(this,"isLoading",!0,function(){a=e.createEntity(t)}),r!==ve.Detached&&(a=this.attachEntity(a,r,n)),a},t.importEntities=function(e,t){var r=new vt;return r.importEntities(e,t),r},e.acceptChanges=function(){this.getChanges().map(function(e){return e.entityAspect._checkOperation("acceptChanges")}).forEach(function(e){e.acceptChanges()})},e.exportEntities=function(e,t){Z(e,"entities").isArray().isEntity().or().isNonEmptyArray().isInstanceOf(xe).or().isNonEmptyArray().isString().or().isOptional().check(),Z(t,"config").isObject().or().isBoolean().or().isOptional().check(),null==t?t={includeMetadata:!0,asString:!0}:"boolean"==typeof t&&(t={includeMetadata:t,asString:!0}),Y(t).whereParam("asString").isBoolean().isOptional().withDefault(!0).whereParam("includeMetadata").isBoolean().isOptional().withDefault(!0).applyAll(t);var r=function(r,e){var n,t=e&&e[0];if(t)if(n={},t.entityType)e.forEach(function(e){if(e.entityAspect.entityState==ve.Detached)throw new Error("Unable to export an entity with an EntityState of 'Detached'");var t=n[e.entityType.name];t||((t={}).entityType=e.entityType,t._entities=[],n[e.entityType.name]=t),t._entities.push(e)});else{var a=i(r,e);a.forEach(function(e){var t=r._entityGroupMap[e.name];t&&t._entities.length&&(n[e.name]=t)})}else n=e&&0===e.length?{}:r._entityGroupMap;var p=[],c={};return T(n,function(e,t){var r,n,a,i,o,s,u;c[e]=(n=p,a={},i=(r=t).entityType,o=i.dataProperties,s=d(i),u=[],r._entities.forEach(function(e){if(e){var t=function a(i,e,o,t){var r,n,s,u,p,c,l={};if(e.forEach(function(e){var t=e.name,r=i.getProperty(t);if(null!=r||null!=e.defaultValue){if(r&&e.isComplexProperty){var n=e.dataType.dataProperties;r=N(r,function(e){return a(e,n,o)})}else r=o?o(e,r):r,e.isUnmapped&&(r=b(r));void 0!==r&&(l[t]=r)}}),i.entityAspect){var y=(r=i.entityAspect).entityState;n={tempNavPropNames:(s=r,u=t,c=s.entity,s.hasTempKey&&u.push(s.getKey().toJSON()),c.entityType.navigationProperties.forEach(function(e){if(e.relatedDataProperties){var t=c.getProperty(e.name);t&&t.entityAspect.hasTempKey&&(p=p||[]).push(e.name)}}),p),entityState:y.name},r.extraMetadata&&(n.extraMetadata=r.extraMetadata),(y.isModified()||y.isDeleted())&&(n.originalValuesMap=r.originalValues),l.entityAspect=n}else r=i.complexAspect,n={},r.originalValues&&!B(r.originalValues)&&(n.originalValuesMap=r.originalValues),l.complexAspect=n;return l}(e,o,s,n);u.push(t)}}),a.entities=u,a)}),{entityGroupMap:c,tempKeys:p}}(this,e),n=D({},r,["tempKeys","entityGroupMap"]);t.includeMetadata?(n=D(n,this,["dataService","saveOptions","queryOptions","validationOptions"])).metadataStore=this.metadataStore.exportMetadata():(n.metadataVersion=v.metadataVersion,n.metadataStoreName=this.metadataStore.name);var a=t.asString?JSON.stringify(n,null,ne.stringifyPad):n;return a},e.importEntities=function(e,v){Y(v=v||{}).whereParam("mergeStrategy").isEnumOf(lt).isOptional().withDefault(this.queryOptions.mergeStrategy).whereParam("metadataVersionFn").isFunction().isOptional().whereParam("mergeAdds").isBoolean().isOptional().applyAll(v);var g=this,t="string"==typeof e?JSON.parse(e):e;t.metadataStore?(this.metadataStore.importMetadata(t.metadataStore),this.dataService=t.dataService&&_e.fromJSON(t.dataService)||new _e({serviceName:t.serviceName}),this.saveOptions=new Et(t.saveOptions),this.queryOptions=ft.fromJSON(t.queryOptions),this.validationOptions=new pe(t.validationOptions)):v.metadataVersionFn&&v.metadataVersionFn({metadataVersion:t.metadataVersion,metadataStoreName:t.metadataStoreName});var r={};t.tempKeys.forEach(function(e){var t=me.fromJSON(e,g.metadataStore);r[t.toString()]=new me(t.entityType,g.keyGenerator.generateTempKeyValue(t.entityType,t.values[0]))});var w=[];return v.tempKeyMap=r,I(function(){g._pendingPubs=[]},function(e){g._pendingPubs.forEach(function(e){e()}),g._pendingPubs=null,g._hasChangesAction&&g._hasChangesAction()},function(){T(t.entityGroupMap,function(e,t){var o,r,n,s,u,p,c,l,y,f,h,d,a=g.metadataStore._getEntityType(e,!0),i=E(g,a),m=(o=i,r=t,s=(n=v).tempKeyMap,u=o.entityType,p=n.mergeStrategy,c=n.mergeAdds,l=null,y=o.entityManager,f=y.entityChanged,h=[],d=Me.getRawValueFromClient,r.entities.forEach(function(e){var t=e.entityAspect,r=u.getEntityKeyFromRawEntity(e,d),n=ve.fromName(t.entityState);if(!n||n==ve.Detached)throw new Error("Only entities with a non detached entity state may be imported.");var a=!c&&n.isAdded()&&S(s,r);if(l=a?null:o.findEntityByKey(r))if(p===lt.SkipMerge);else{if(p===lt.Disallowed)throw new Error("A MergeStrategy of 'Disallowed' prevents "+r.toString()+" from being merged");var i=l.entityAspect.entityState.isUnchanged();(p===lt.OverwriteChanges||i)&&(u._updateTargetFromRaw(l,e,d),l.entityAspect.setEntityState(n),f.publish({entityAction:ce.MergeOnImport,entity:l}))}else l=u._createInstanceCore(),u._updateTargetFromRaw(l,e,d),a&&(l.entityAspect.hasTempKey=!0,l.setProperty(u.keyProperties[0].name,a.values[0]),t.tempNavPropNames&&t.tempNavPropNames.forEach(function(e){var t=u.getNavigationProperty(e),r=t.relatedDataProperties[0].name,n=l.getProperty(r),a=new me(t.entityType,[n]),i=S(s,a);l.setProperty(r,i.values[0])})),l=o.attachEntity(l,n),f.publish({entityAction:ce.AttachOnImport,entity:l}),n.isUnchanged()||y._notifyStateChange(l,!0);h.push(l)}),h);m&&m.length&&(w=w.concat(m))}),w.forEach(function(e){e.entityAspect.entityState.isDeleted()||g._linkRelatedEntities(e)})}),{entities:w,tempKeyMapping:r}},e.clear=function(){g(this._entityGroupMap,function(e,t){return t._checkOperation()}).forEach(function(e){e._clear()}),this._entityGroupMap={},this._unattachedChildrenMap=new m,this.keyGenerator=new this.keyGeneratorCtor,this.entityChanged.publish({entityAction:ce.Clear}),this._setHasChanges(!1)},e.createEmptyCopy=function(){var e=new t(D({},this,["dataService","metadataStore","queryOptions","saveOptions","validationOptions","keyGeneratorCtor"]));return e},e.addEntity=function(e){return this.attachEntity(e,ve.Added)},e.attachEntity=function(e,t,o){if(Z(e,"entity").isRequired().check(),this.metadataStore._checkEntityType(e),t=Z(t,"entityState").isEnumOf(ve).isOptional().check(ve.Unchanged),o=Z(o,"mergeStrategy").isEnumOf(lt).isOptional().check(lt.Disallowed),e.entityType.metadataStore!==this.metadataStore)throw new Error("Cannot attach this entity because the EntityType ("+e.entityType.name+") and MetadataStore associated with this entity does not match this EntityManager's MetadataStore.");var s=e.entityAspect;if(s){if(s._inProcessEntity)return s._inProcessEntity}else s=new ye(e);var r=s.entityManager;if(r){if(r===this)return e;throw new Error("This entity already belongs to another EntityManager")}var u,p=this;return F(this,"isLoading",!0,function(){t.isAdded()&&function(e,t){var r=t.entityAspect.getKey(),n=C(t.entityType.keyProperties,r.values,function(e,t){return e.defaultValue===t?e:null}).filter(function(e){return null!==e});if(n.length)if(t.entityType.autoGeneratedKeyType!==De.None)e.generateTempKeyValue(t);else if(n.length===r.values.length)throw new Error("Cannot attach an object of type  ("+t.entityType.name+") to an EntityManager without first setting its key or setting its entityType 'AutoGeneratedKeyType' property to something other than 'None'")}(p,e),u=p._attachEntityCore(e,t,o),s._inProcessEntity=u;try{r=p,a=t,i=o,(n=e).entityType.navigationProperties.forEach(function(e){var t=n.getProperty(e.name);if(e.isScalar){if(!t)return;r.attachEntity(t,a,i)}else t.forEach(function(e){r.attachEntity(e,a,i)})})}finally{s._inProcessEntity=null}var r,n,a,i}),this.validationOptions.validateOnAttach&&u.entityAspect.validateEntity(),t.isUnchanged()||this._notifyStateChange(u,!0),this.entityChanged.publish({entityAction:ce.Attach,entity:u}),u},e.detachEntity=function(e){Z(e,"entity").isEntity().check();var t=e.entityAspect;if(!t)return!1;if(t.entityManager!==this)throw new Error("This entity does not belong to this EntityManager.");return t.setDetached()},e.fetchMetadata=function(e,t,r){"function"==typeof e?(r=t,t=e,e=null):(Z(e,"dataService").isInstanceOf(_e).isOptional().check(),Z(t,"callback").isFunction().isOptional().check(),Z(r,"errorCallback").isFunction().isOptional().check());var n=this.metadataStore.fetchMetadata(e||this.dataService);return u(n,t,r)},e.executeQuery=function(e,t,r){var n;Z(e,"query").isInstanceOf(Xe).or().isString().check(),Z(t,"callback").isFunction().isOptional().check(),Z(r,"errorCallback").isFunction().isOptional().check();var a=ft.resolve([e.queryOptions,this.queryOptions,ft.defaultInstance]),i=_e.resolve([e.dataService,this.dataService]);if(!i.hasServerMetadata||this.metadataStore.hasMetadataFor(i.serviceName))n=c(this,e,a,i);else{var o=this;n=this.fetchMetadata(i).then(function(){return c(o,e,a,i)})}return u(n,t,r)},e.executeQueryLocally=function(e){return p(this,e).results},e.saveChanges=function(e,t,r,n){Z(e,"entities").isOptional().isArray().isEntity().check(),Z(t,"saveOptions").isInstanceOf(Et).isOptional().check(),Z(r,"callback").isFunction().isOptional().check(),Z(n,"errorCallback").isFunction().isOptional().check(),t=t||this.saveOptions||Et.defaultInstance;var a=function(t,e){var r;r=e?e.filter(function(e){if(e.entityAspect.entityManager!==t)throw new Error("Only entities in this entityManager may be saved");return!e.entityAspect.entityState.isDetached()}):t.getChanges();return r}(this,e);if(0===a.length){var i={entities:[],keyMappings:[]};return r&&r(i),Oe.resolve(i)}if(!t.allowConcurrentSaves){var o=a.some(function(e){return e.entityAspect.isBeingSaved});if(o){var s=new Error("Concurrent saves not allowed - SaveOptions.allowConcurrentSaves is false");return n&&n(s),Oe.reject(s)}}a.forEach(function(e){var r=[],t=e.entityAspect;T(t._validationErrors,function(e,t){t.isServerError&&r.push(e)}),0!==r.length&&t._processValidationOpAndPublish(function(){r.forEach(function(e){t._removeValidationError(e)})})});var u=this.saveChangesValidateOnClient(a);if(u)return n&&n(u),Oe.reject(u);var p=_e.resolve([t.dataService,this.dataService]),c={entityManager:this,dataService:p,processSavedEntities:function(e){var t=e.entities,r=e.deletedKeys||[];if(0===t.length&&0==r.length)return[];var n=e.keyMappings,a=c.entityManager;return i=a,o=n,i._inKeyFixup=!0,o.forEach(function(e){var t=i._entityGroupMap[e.entityTypeName];if(!t)throw new Error("Unable to locate the following fully qualified EntityType name: "+e.entityTypeName);t._fixupKey(e.tempValue,e.realValue)}),i._inKeyFixup=!1,F(a,"isLoading",!0,function(){var e=new St({query:null,entityManager:a,mergeOptions:{mergeStrategy:lt.OverwriteChanges},dataService:p});t=e.visitAndMerge(t,{nodeType:"root"})}),r.forEach(function(e){var t=a.metadataStore._getEntityType(e.entityTypeName),r=new me(t,e.keyValues),n=a.findEntityByKey(r);n&&n.entityAspect.setDetached()}),t;var i,o},resourceName:t.resourceName||this.saveOptions.resourceName||"SaveChanges"},l={entities:a,saveOptions:t};try{return function(e){var t=e.filter(function(e){return e.entityAspect.isBeingSaved=!0,e.entityAspect.entityState.isModified()&&0<e.entityType.concurrencyProperties.length});if(0===t.length)return;t.forEach(function(t){t.entityType.concurrencyProperties.forEach(function(e){!function(e,t){if(e.entityAspect.originalValues[t.name])return;var r=e.getProperty(t.name);r||(r=t.dataType.defaultValue);if(t.dataType.isNumeric)e.setProperty(t.name,r+1);else{if(!t.dataType.getConcurrencyValue){if(t.dataType===be.Binary)return;throw new Error("Unable to update the value of concurrency property before saving: "+t.name)}var n=t.dataType.getConcurrencyValue(r);e.setProperty(t.name,n)}}(t,e)})})}(a),p.adapterInstance.saveChanges(c,l).then(function(e){var t=c.entityManager;y(a,!1);e.entities=c.processSavedEntities(e);t._setHasChanges(null),r&&r(e);return Oe.resolve(e)}).then(null,function(e){y(a,!1),function(e,t){var r=t.entityErrors;if(r){var u=e.entityManager,p=u.metadataStore;t.entityErrors=r.map(function(e){var t=null;if(e.keyValues){var r=p._getEntityType(e.entityTypeName),n=new me(r,e.keyValues);t=u.findEntityByKey(n)}if(t){var a=e.propertyName?{propertyName:e.propertyName,property:r.getProperty(e.propertyName)}:{},i=se.getKey(e.errorName||e.errorMessage,e.propertyName),o=new se(null,a,e.errorMessage,i);o.isServerError=!0,t.entityAspect.addValidationError(o)}var s=D({entity:t,isServerError:!0},e,["errorName","errorMessage","propertyName"]);return s})}}(c,e),n&&n(e);return Oe.reject(e)})}catch(s){return y(a,!1),n&&n(s),Oe.reject(s)}},e.saveChangesValidateOnClient=function(e){if(this.validationOptions.validateOnSave){var t=e.filter(function(e){var t=e.entityAspect,r=t.entityState.isDeleted()||t.validateEntity();return!r});if(0<t.length){var r=new Error("Client side validation errors encountered - see the entityErrors collection on this object for more detail");return r.entityErrors=(a=[],t.forEach(function(n){T(n.entityAspect._validationErrors,function(e,t){var r=D({entity:n,errorName:t.validator.name},t,["errorMessage","propertyName","isServerError"]);a.push(r)})}),a),r}}var a;return null},e._findEntityGroup=function(e){return this._entityGroupMap[e.name]},e.getEntityByKey=function(){var r=s(this,arguments).entityKey,e=r._subtypes||[r.entityType],n=null;return e.some(function(e){var t=this._findEntityGroup(e);return n=t&&t.findEntityByKey(r)},this),n},e.fetchEntityByKey=function(){var e=_e.resolve([this.dataService]);if(!e.hasServerMetadata||this.metadataStore.hasMetadataFor(e.serviceName))return n(this,arguments);var t=this,r=arguments;return this.fetchMetadata(e).then(function(){return n(t,r)})},e.findEntityByKey=function(e){return this.getEntityByKey(e)},e.generateTempKeyValue=function(e){Z(e,"entity").isEntity().check();var t=e.entityType,r=this.keyGenerator.generateTempKeyValue(t),n=t.keyProperties[0];return e.setProperty(n.name,r),e.entityAspect.hasTempKey=!0,r},e.hasChanges=function(e){return!!this._hasChanges&&(void 0===e?this._hasChanges:this._hasChangesCore(e))},e._hasChangesCore=function(e){var t=o(this,e=i(this,e));return t.some(function(e){return e&&e.hasChanges()})},e.getChanges=function(e){return a(this,e=i(this,e))},e.rejectChanges=function(){if(!this._hasChanges)return[];var e=a(this,null),t=e.map(function(e){return e.entityAspect._checkOperation("rejectChanges")});return this._hasChanges=!1,t.forEach(function(e){e.rejectChanges()}),this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}),e},e.getEntities=function(e,t){var r,n,a;return e=i(this,e),Z(t,"entityStates").isOptional().isEnumOf(ve).or().isNonEmptyArray().isEnumOf(ve).check(),t=t&&((r=t)?((r=_(r)).forEach(function(e){if(!ve.contains(e))throw new Error("The EntityManager.getChanges() 'entityStates' parameter must either be null, an entityState or an array of entityStates")}),r):null),n=t,o(this,e).forEach(function(e){if(e){var t=e.getEntities(n);a=a&&a.length?a.concat(t):t}}),a||[]},e._notifyStateChange=function(e,t){var r={entityAction:ce.EntityStateChange,entity:e};if(t)this._hasChanges||this._setHasChanges(!0);else if(this._hasChanges){if(this.isLoading)return void(this._hasChangesAction=this._hasChangesAction||function(){this._setHasChanges(null),this.entityChanged.publish(r)}.bind(this));this._setHasChanges(null)}this.entityChanged.publish(r)},e._setHasChanges=function(e){null==e&&(e=this._hasChangesCore());var t=this._hasChanges;(this._hasChanges=e)!=t&&this.hasChangesChanged.publish({entityManager:this,hasChanges:e}),this._hasChangesAction=null},e._linkRelatedEntities=function(p){var i=this,a=p.entityAspect;F(i,"isLoading",!0,function(){for(var s=i._unattachedChildrenMap,e=a.getKey(),t=e.entityType;t;){var u=e.toString(t),r=s.getTuplesByString(u);r&&r.length&&r.slice(0).forEach(function(e){var t,r,n=e.children.filter(function(e){return e.entityAspect.entityState!==ve.Detached}),a=e.navigationProperty;if(a.getInverse())if((r=(t=a).getInverse()).isScalar){var i=n[0];p.setProperty(r.name,i),i.setProperty(t.name,p)}else{var o=p.getProperty(r.name);n.forEach(function(e){o.push(e),e.setProperty(t.name,p)})}else if(a.isScalar)t=a,n.forEach(function(e){e.setProperty(t.name,p)});else{r=a;var o=p.getProperty(r.name);n.forEach(function(e){o._push(e)})}s.removeChildrenByString(u,t)}),t=t.baseEntityType}p.entityType.navigationProperties.forEach(function(e){if(e.isScalar){var t=p.getProperty(e.name);if(t)return}var r=a.getParentKey(e);if(r){if(r._isEmpty())return;var n=i.findEntityByKey(r);n?p.setProperty(e.name,n):s.addChild(r,e,p)}}),p.entityType.foreignKeyProperties.forEach(function(e){var t=e.inverseNavigationProperty;if(t){var r=p.getProperty(e.name),n=new me(t.parentType,[r]),a=i.findEntityByKey(n);a?t.isScalar?a.setProperty(t.name,p):i.isLoading?a.getProperty(t.name)._push(p):a.getProperty(t.name).push(p):s.addChild(n,t,p)}})})},e._attachEntityCore=function(e,t,r){var n=E(this,e.entityType),a=n.attachEntity(e,t,r);return this._linkRelatedEntities(a),a},e._updateFkVal=function(e,t,r){var n=this._entityGroupMap[e.parentType.name];n&&n._updateFkVal(e,t,r)},e.helper={unwrapInstance:l,unwrapOriginalValues:function a(i,o,s){var n=i.entityType||i.complexType;var e=i.entityAspect||i.complexAspect;var u=o.namingConvention.clientPropertyNameToServer;var p={};T(e.originalValues,function(e,t){var r=n.getProperty(e);void 0!==(t=s?s(r,t):t)&&(p[u(e,r)]=t)});n.complexProperties.forEach(function(e){var t=i.getProperty(e.name);if(e.isScalar){var r=a(t,o,s);B(r)||(p[u(e.name,e)]=r)}else{var n=t.map(function(e){return a(e,o,s)});p[u(e.name,e)]=n}});return p},unwrapChangedValues:function(a,e,i){var o=a.entityType,s=d(o),u=e.namingConvention.clientPropertyNameToServer,p={};return T(a.entityAspect.originalValues,function(e,t){var r=o.getProperty(e),n=a.getProperty(e);void 0!==(n=i?i(r,n):n)&&void 0!==(n=s?s(r,n):n)&&(p[u(e,r)]=n)}),o.complexProperties.forEach(function(e){if(f(a,e)){var t=a.getProperty(e.name);p[u(e.name,e)]=N(t,function(e){return l(e,i)})}}),p}},m.prototype.addChild=function(e,t,r){var n=this.getTuple(e,t);n||(n={navigationProperty:t,children:[]},x(this.map,e.toString()).push(n)),n.children.push(r)},m.prototype.removeChildrenByString=function(e,t){var r=this.map[e];r&&(A(r,function(e){return e.navigationProperty===t}),r.length||delete this.map[e])},m.prototype.getTuple=function(e,t){var r=this.getTuples(e);if(!r)return null;var n=O(r,function(e){return e.navigationProperty===t});return n},m.prototype.getTuples=function(e){var t=[],r=this.map[e.toString()];r&&(t=t.concat(r));for(var n=e.entityType;n.baseEntityType;){n=n.baseEntityType;var a=e.toString(n);(r=this.map[a])&&(t=t.concat(r))}return t.length?t:void 0},m.prototype.getTuplesByString=function(e){return this.map[e]},t}();var gt,wt;v.EntityManager=vt;var St=function(){var e=function(e){D(this,e,["query","entityManager","dataService","mergeOptions"]),this.refMap={},this.deferredFns=[],this.jsonResultsAdapter=this.dataService.jsonResultsAdapter,this.metadataStore=this.entityManager.metadataStore,this.rawValueFn=Me.getRawValueFromServer},t=e.prototype,i=be.parseRawValue;function u(e,t,r,n){if(r.ignore||null==t)return null;if(r.nodeRefId){var a=(c=e,l=r.nodeRefId,void 0===(y=c.refMap[l])?function(){return c.refMap[l]}:y);return"function"==typeof a&&null!=n?void e.deferredFns.push(function(){n(a)}):a}if(r.entityType){var i=r.entityType;return e.mergeOptions.noTracking?(t=f(e,i,t),i.noTrackingFn&&(t=i.noTrackingFn(t,i)),r.nodeId&&(e.refMap[r.nodeId]=t),t):i.isComplexType?f(e,i,t):function(e,t,r){t._$meta=r;var n=e.entityManager,a=r.entityType;"string"==typeof a&&(a=e.metadataStore._getEntityType(a,!1));t.entityType=a;var i=e.mergeOptions.mergeStrategy,o=null==e.query,s=a.getEntityKeyFromRawEntity(t,e.rawValueFn),u=n.findEntityByKey(s);if(u){if(o&&u.entityAspect.entityState.isDeleted())return n.detachEntity(u),u;var p=u.entityAspect.entityState;if(i===lt.Disallowed)throw new Error("A MergeStrategy of 'Disallowed' prevents "+s.toString()+" from being merged");if(i===lt.SkipMerge)m(e,u,t);else if(i===lt.OverwriteChanges||p.isUnchanged()){v(e,u,t),u.entityAspect.wasLoaded=!0,r.extraMetadata&&(u.entityAspect.extraMetadata=r.extraMetadata),u.entityAspect.entityState=ve.Unchanged,d(u),u.entityAspect.propertyChanged.publish({entity:u,propertyName:null});var c=o?ce.MergeOnSave:ce.MergeOnQuery;n.entityChanged.publish({entityAction:c,entity:u}),p.isUnchanged()||n._notifyStateChange(u,!1)}else{if(p==ve.Deleted&&!e.mergeOptions.includeDeleted)return null;m(e,u,t)}}else u=a._createInstanceCore(),v(e,u,t),r.extraMetadata&&(u.entityAspect.extraMetadata=r.extraMetadata),n._attachEntityCore(u,ve.Unchanged,i),u.entityAspect.wasLoaded=!0,n.entityChanged.publish({entityAction:ce.AttachOnQuery,entity:u});return u}(e,t,r)}return r.passThru||"object"!=typeof t||R(t)||(s=t,u=(o=e).metadataStore.namingConvention.serverPropertyNameToClient,p={},T(s,function(e,t){var r=u(e);h(t,o,{nodeType:"anonProp",propertyName:r},p,r)}),t=p),r.nodeId&&(e.refMap[r.nodeId]=t),t;var o,s,u,p,c,l,y}function f(r,e,n){var a={};return e.dataProperties.forEach(function(t){t.isComplexProperty?a[t.name]=N(n[t.nameOnServer],function(e){return f(r,t.dataType,e)}):a[t.name]=i(n[t.nameOnServer],t.dataType)}),e.navigationProperties&&e.navigationProperties.forEach(function(e){var t={nodeType:"navProp",navigationProperty:e};h(n[e.nameOnServer],r,t,a,e.name)}),a}function h(e,r,n,a,i){var o=r.jsonResultsAdapter,s=o.visitNode(e,r,n)||{};if(e=s.node||e,!s.ignore)return s.passThru?e:void(Array.isArray(e)?(n.nodeType=n.nodeType+"Item",a[i]=e.map(function(e,t){return s=o.visitNode(e,r,n)||{},e=s.node||e,u(r,e,s,function(e){a[i][t]=e()})})):a[i]=u(r,e,s,function(e){a[i]=e()}))}function a(e,t,r){var n=r._$meta.nodeId;!n&&r._$meta.extraMetadata&&(n=r._$meta.extraMetadata.uriKey),null!=n&&(e.refMap[n]=t)}function d(r){var e=r.entityAspect||r.complexAspect;e.originalValues={};var t=r.entityType||r.complexType;t.complexProperties.forEach(function(e){var t=r.getProperty(e.name);e.isScalar?d(t):(t._acceptChanges(),t.forEach(d))})}function m(t,e,r){a(t,e,r),r.entityType.navigationProperties.forEach(function(e){e.isScalar?o(t,r,e):s(t,r,e)})}function v(t,r,n){a(t,r,n);var e=r.entityType;e._updateTargetFromRaw(r,n,t.rawValueFn),e.navigationProperties.forEach(function(e){e.isScalar?function(e,t,r,n){var a=o(e,n,t);if(null==a)return;"function"==typeof a?e.deferredFns.push(function(){p(a=a(),r,t)}):p(a,r,t)}(t,e,r,n):function(t,e,r,n){var a=s(t,n,e);if(null==a)return;var i=e.getInverse();if(!i)return;var o=r.getProperty(e.name);o.wasLoaded=!0,a.forEach(function(e){"function"==typeof e?t.deferredFns.push(function(){e=e(),c(t,e,o,r,i)}):c(t,e,o,r,i)})}(t,e,r,n)})}function o(e,t,r){var n=t[r.nameOnServer];if(!n)return null;var a=e.visitAndMerge(n,{nodeType:"navProp",navigationProperty:r});return a}function s(e,t,r){var n=t[r.nameOnServer];if(!n)return null;if(!Array.isArray(n)&&!(n=n.results))return null;var a=e.visitAndMerge(n,{nodeType:"navPropItem",navigationProperty:r});return a}function p(e,t,r){if(e){var n=r.name,a=t.getProperty(n);if(a!==e){t.setProperty(n,e);var i=r.getInverse();if(!i)return;if(i.isScalar)e.setProperty(i.name,t);else{var o=e.getProperty(i.name);o.push(t)}}}}function c(e,t,r,n,a){if(t){if(t.entityAspect.entityState===ve.Modified&&e.mergeOptions.mergeStrategy===lt.PreserveChanges){var i=t.entityAspect.originalValues,o=a.relatedDataProperties.some(function(e){return null!=i[e.name]});if(o)return}var s=t.getProperty(a.name);s!==n&&(r.push(t),t.setProperty(a.name,n))}}return t._$typeName="MappingContext",t.getUrl=function(){var e,t=this.query;if(!t)throw new Error("query cannot be empty");if("string"==typeof t)e=t;else{if(!(t instanceof Xe))throw new Error("unable to recognize query parameter as either a string or an EntityQuery");e=this.dataService.uriBuilder.buildUri(t,this.metadataStore)}return this.dataService.qualifyUrl(e)},t.visitAndMerge=function(e,r){var n=this.query,a=this.jsonResultsAdapter;r=r||{};var i=this;return N(e,function(e){if(null==n&&e.entityAspect)return e.entityAspect.entityState.isDeleted()?i.entityManager.detachEntity(e):e.entityAspect.acceptChanges(),e;var t=a.visitNode(e,i,r)||{};return e=t.node||e,n&&"root"===r.nodeType&&!t.entityType&&(t.entityType=n._getToEntityType&&n._getToEntityType(i.metadataStore)),u(i,e,t)},this.mergeOptions.includeDeleted)},t.processDeferred=function(){0<this.deferredFns.length&&this.deferredFns.forEach(function(e){e()})},e}(),Et=function(){var e=function(e){r(this,e)},t=e.prototype;function r(e,t){return t&&Y(t).whereParam("resourceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(_e).whereParam("allowConcurrentSaves").isBoolean().isOptional().whereParam("tag").isOptional().applyAll(e),e}return t._$typeName="SaveOptions",t.setAsDefault=function(){return i(this,e)},t.using=function(e){return r(this,e)},e.defaultInstance=new e({allowConcurrentSaves:!1}),e}();v.SaveOptions=Et,v.AbstractDataServiceAdapter=function(){var p,e=function(){},a=e.prototype;function u(e,t){this.getRequest=function(e,t,r){return e},this.done=function(e){}}function c(e,t,r){var n=function(e){var t=new Error;t.httpResponse=e,t.status=e.status;var r=e.data;if(!r)return t.message=e.error&&e.error.toString(),t;if("string"==typeof r)try{r=JSON.parse(r)}catch(e){return t.message=r,t}var n,a,i=e.saveContext;if(o=r.Message||r.ExceptionMessage||r.EntityErrors||r.Errors){for(var o=r;n=o.ExceptionMessage||o.Message,o=o.InnerException;);a=(a=r.Errors||r.EntityErrors)&&a.map(function(e){return{errorName:e.ErrorName,entityTypeName:Ae.normalizeTypeName(e.EntityTypeName),keyValues:e.KeyValues,propertyName:e.PropertyName,errorMessage:e.ErrorMessage}})}else n=r.message,a=r.errors||r.entityErrors;if(i&&a){var s=i.entityManager.metadataStore.namingConvention.serverPropertyNameToClient;a.forEach(function(e){e.propertyName=e.propertyName&&s(e.propertyName)}),t.entityErrors=a}return t.message=n||"Server side errors encountered - see the entityErrors collection on this object for more detail",t}(t);return a._catchNoConnectionError(n),r&&(n.message=r+"; "+n.message),e.reject(n)}return a.checkForRecomposition=function(e){"ajax"===e.interfaceName&&e.isDefault&&this.initialize()},a.initialize=function(){if(!(p=v.config.getAdapterInstance("ajax"))||!p.ajax)throw new Error("Unable to find ajax adapter for dataservice adapter '"+(this.name||"")+"'.")},a.fetchMetadata=function(a,i){var o=i.serviceName,s=i.qualifyUrl("Metadata"),u=Oe.defer();return p.ajax({type:"GET",url:s,dataType:"json",success:function(t){if(a.hasMetadataFor(o))return u.resolve("already fetched");var e=t.data;try{var r="string"==typeof e?JSON.parse(e):e;a.importMetadata(r)}catch(e){var n="Unable to either parse or import metadata: "+e.message;return c(u,t,"Metadata query failed for: "+s+". "+n)}return a.hasMetadataFor(o)||a.addDataService(i),u.resolve(r)},error:function(e){c(u,e,"Metadata query failed for: "+s)}}),u.promise},a.executeQuery=function(e){e.adapter=this;var a=Oe.defer(),t={type:"GET",url:e.getUrl(),params:e.query.parameters,dataType:"json",success:function(t){var e=t.data;try{var r,n=e&&(e.results||e.Results);r=n?{results:n,inlineCount:e.inlineCount||e.InlineCount,httpResponse:t}:{results:e,httpResponse:t},a.resolve(r)}catch(e){e instanceof Error?a.reject(e):c(a,t)}},error:function(e){c(a,e)}};return e.dataService.useJsonp&&(t.dataType="jsonp",t.crossDomain=!0),p.ajax(t),a.promise},a.saveChanges=function(n,e){var a=n.adapter=this,i=Oe.defer();e=a._prepareSaveBundle(n,e);var t=JSON.stringify(e),r=n.dataService.qualifyUrl(n.resourceName);return p.ajax({type:"POST",url:r,dataType:"json",contentType:"application/json",data:t,success:function(e){e.saveContext=n;var t=e.data;if(t.Errors||t.errors)c(i,e);else{var r=a._prepareSaveResult(n,t);r.httpResponse=e,i.resolve(r)}},error:function(e){e.saveContext=n,c(i,e)}}),i.promise},a._prepareSaveBundle=function(){throw new Error("Need a concrete implementation of _prepareSaveBundle")},a.changeRequestInterceptor=u,a._createChangeRequestInterceptor=function(e,t){var r=e.adapter,n=r.changeRequestInterceptor,a=K;if(a(n)){var i=r.name+" DataServiceAdapter's ChangeRequestInterceptor",o=" is missing or not a function.",s=new n(e,t);if(!a(s.getRequest))throw new Error(i+".getRequest"+o);if(!a(s.done))throw new Error(i+".done"+o);return s}return new u(e,t)},a._prepareSaveResult=function(){throw new Error("Need a concrete implementation of _prepareSaveResult")},a.jsonResultsAdapter=new Ne({name:"noop",visitNode:function(){return{}}}),a._catchNoConnectionError=function(e){0==e.status&&null==e.message&&(e.message="HTTP response status 0 and no message.  Likely did not or could not reach server. Is the server running?")},e}(),Ct=function(e){var p=e.core,t=function(){this.name="angular",this.defaultSettings={},this.requestInterceptor=null},r=t.prototype;r.initialize=function(){var r,n,e=p.requireLib("angular");e&&(e.injector(["ng"]).invoke(["$http","$rootScope",function(e,t){r=e,n=t}]),this.$http=r,this.$rootScope=n)},r.setHttp=function(e){this.$http=e,this.$rootScope=null},r.ajax=function(o){if(!this.$http)throw new Error("Unable to locate angular for ajax adapter");var e={method:o.type,url:o.url,dataType:o.dataType,contentType:o.contentType,crossDomain:o.crossDomain,headers:o.headers||{}};if(o.params){var t=0<=e.url.indexOf("?")?"&":"?";e.url=e.url+t+function e(t){var r,n,a="";for(var i in t){var o=t[i];if(o instanceof Array)for(var s=0;s<o.length;++s)r=o[s],(n={})[i+"["+s+"]"]=r,a+=e(n)+"&";else if(o&&o.toISOString)a+=encodeURIComponent(i)+"="+encodeURIComponent(o.toISOString())+"&";else if(o instanceof Object)for(var u in o)r=o[u],(n={})[i+"["+u+"]"]=r,a+=e(n)+"&";else null===o?a+=encodeURIComponent(i)+"=&":void 0!==o&&(a+=encodeURIComponent(i)+"="+encodeURIComponent(o)+"&")}return a.length?a.substr(0,a.length-1):a}(o.params)}if(o.data&&(e.data=o.data),!p.isEmpty(this.defaultSettings)){var r=p.extend({},this.defaultSettings);e=p.extend(r,e);var n=p.extend({},this.defaultSettings.headers);e.headers=p.extend(n,e.headers)}var a={adapter:this,config:e,dsaConfig:o,success:s,error:u,responseSuccess:function(e){return s(e.data,e.status,e.headers,e.config,e.statusText)},responseError:function(e){return u(e.data,e.status,e.headers,e.config,e.statusText)}};if(p.isFunction(this.requestInterceptor)&&(this.requestInterceptor(a),this.requestInterceptor.oneTime&&(this.requestInterceptor=null)),a.config){var i=this.$http(a.config);i.success?i.success(a.success).error(a.error):i.then(a.responseSuccess).catch(a.responseError),this.$rootScope&&this.$rootScope.$digest()}function s(e,t,r,n,a){"null"===e&&(e=null);var i={config:o,data:e,getHeaders:r,ngConfig:n,status:t,statusText:a};o.success(i)}function u(e,t,r,n,a){0===t&&null==e&&(e="timeout");var i={config:o,data:e,getHeaders:r,ngConfig:n,status:t,statusText:a};o.error(i)}},e.config.registerAdapter("ajax",t)},"object"==typeof v?Ct(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?Ct(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],Ct),At=function(e){var i,o=e.core,t=function(){this.name="jQuery",this.defaultSettings={},this.requestInterceptor=null},r=t.prototype;function s(t){return 0===t.status?function(e){return e&&0<e.length?"":{}}:function(e){return e&&0<e.length?t.getResponseHeader(e):t.getAllResponseHeaders()}}r.initialize=function(){i=o.requireLib("jQuery;jquery")},r.ajax=function(a){if(!i)throw new Error("Unable to locate jQuery");var e={type:a.type,url:a.url,data:a.params||a.data,dataType:a.dataType,contentType:a.contentType,crossDomain:a.crossDomain,headers:a.headers||{}};if(!o.isEmpty(this.defaultSettings)){var t=o.extend({},this.defaultSettings);e=o.extend(t,e);var r=o.extend({},this.defaultSettings.headers);e.headers=o.extend(r,e.headers)}var n={adapter:this,config:e,dsaConfig:a,success:function(e,t,r){var n={config:a,data:e,getHeaders:s(r),status:r.status,statusText:t};a.success(n),r.onreadystatechange=null,r.abort=null},error:function(e,t,r){var n={config:a,data:e.responseText,error:r,getHeaders:s(e),status:e.status,statusText:t};a.error(n),e.onreadystatechange=null,e.abort=null}};o.isFunction(this.requestInterceptor)&&(this.requestInterceptor(n),this.requestInterceptor.oneTime&&(this.requestInterceptor=null)),n.config&&(n.jqXHR=i.ajax(n.config).done(n.success).fail(n.error))},e.config.registerAdapter("ajax",t)},"object"==typeof v?At(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?At(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],At),Ot=function(g){var w,S=g.core,c=g.MetadataStore,e=g.JsonResultsAdapter,E=g.DataProperty,r=g.DataType,T=g.AutoGeneratedKeyType,t=function(){this.name="OData"},u=t.prototype;u.initialize=function(){(w=S.requireLib("OData","Needed to support remote OData services")).jsonHandler.recognizeDates=!0};var n=g.AbstractDataServiceAdapter.prototype;function P(e,t){if(!e.isUnmapped)return e.dataType===r.DateTimeOffset?t=t&&new Date(t.getTime()-6e4*t.getTimezoneOffset()):e.dataType.quoteJsonOData&&(t=null!=t?t.toString():t),t}function b(e,t,r){var n,a=t.extraMetadata;null==a?(n=function(t){var e=t.entity.entityType,r=e.defaultResourceName,n=e.keyProperties,a=r+"(";if(1===n.length)a=a+o(n[0],t)+")";else{var i="";n.forEach(function(e){a=a+i+e.nameOnServer+"="+o(e,t),i=","}),a+=")"}return a}(t),t.extraMetadata={uriKey:n}):(n=a.uriKey,a.etag&&(e.headers["If-Match"]=a.etag)),e.requestUri=0<n.indexOf("//")?n:r+n}function o(e,t){return e.dataType.fmtOData(t.getPropertyValue(e.name))}function _(e,t){var r,n,a=new Error,i=e&&e.response;if(!i)return a.message=e,a.statusText=e,a;if(a.message=i.statusText,a.statusText=i.statusText,a.status=i.statusCode,t&&(a.url=t),a.body=i.body,i.body)try{var o=JSON.parse(i.body);(a.body=o)["odata.error"]&&(o=o["odata.error"]);for(var s="";(r=o.error||o.innererror)||(s+=("string"==typeof(n=o.message||"")?n:n.value)+"; "),o=(r=r||o.internalexception)||o,r;);0<s.length&&(a.message=s)}catch(e){}return u._catchNoConnectionError(a),a}u._catchNoConnectionError=n._catchNoConnectionError,u.changeRequestInterceptor=n.changeRequestInterceptor,u._createChangeRequestInterceptor=n._createChangeRequestInterceptor,u.headers={DataServiceVersion:"2.0"},u.getAbsoluteUrl=function(e,t){var r=e.qualifyUrl(""),n=S.stringStartsWith(t,r)?"":r;return window&&r.indexOf("//")<0&&(n=window.location.protocol+"//"+window.location.host+(S.stringStartsWith(r,"/")?"":"/")+n),n+t},u.getRoutePrefix=function(e){var t;"object"==typeof document?(t=document.createElement("a")).href=e.serviceName:t=url.parse(e.serviceName);var r=t.pathname;return"/"===r[0]&&(r=r.substr(1)),"/"!==r.substr(-1)&&(r+="/"),r},u.executeQuery=function(e){var t,a=g.Q.defer();if(t=!0===this.relativeUrl?e.getUrl():S.isFunction(this.relativeUrl)?this.relativeUrl(e.dataService,e.getUrl()):this.getAbsoluteUrl(e.dataService,e.getUrl()),!S.isEmpty(e.query.parameters)){var r=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}(e.query.parameters),n=t.indexOf("?")<0?"?":"&";t=t+n+r}return w.read({requestUri:t,headers:S.extend({},this.headers)},function(e,t){var r,n;return e.__count&&(r=parseInt(e.__count,10)),n=e.results?e.results:e,a.resolve({results:n,inlineCount:r,httpResponse:t})},function(e){return a.reject(_(e,t))}),a.promise},u.fetchMetadata=function(n,a){var i,o=g.Q.defer(),s=a.serviceName;i=!0===this.relativeUrl?a.qualifyUrl("$metadata"):S.isFunction(this.relativeUrl)?this.relativeUrl(a,"$metadata"):this.getAbsoluteUrl(a,"$metadata");var e=S.extend({},this.headers);return e.Accept="application/*; odata.metadata=full",w.read({requestUri:i,headers:e},function(e){if(!e||!e.dataServices){var t=new Error("Metadata query failed for: "+i);return o.reject(t)}var r=e.dataServices;if(!n.hasMetadataFor(s)){try{n.importMetadata(r)}catch(e){return o.reject(new Error("Metadata query failed for "+i+"; Unable to process returned metadata: "+e.message))}n.addDataService(a)}return o.resolve(r)},function(e){var t=_(e,i);return t.message="Metadata query failed for: "+i+"; "+(t.message||""),o.reject(t)},w.metadataHandler),o.promise},u.saveChanges=function(e,t){var y,r=e.adapter=this,f=g.Q.defer();!0===this.relativeUrl?(e.routePrefix=r.getRoutePrefix(e.dataService),y=e.dataService.qualifyUrl("$batch")):(S.isFunction(r.relativeUrl)?e.routePrefix=r.relativeUrl(e.dataService,""):e.routePrefix=r.getAbsoluteUrl(e.dataService,""),y=e.routePrefix+"$batch");var n,a,i,o,s,u,p,c,l,h,d=(a=t,i=(n=e).adapter._createChangeRequestInterceptor(n,a),o=[],s=[],u=[],p=n.entityManager,c=p.helper,l=0,h=n.routePrefix,a.entities.forEach(function(e,t){var r=e.entityAspect,n={headers:{"Content-ID":l+=1,DataServiceVersion:"2.0"}};if(u[l]=e,r.entityState.isAdded())n.requestUri=h+e.entityType.defaultResourceName,n.method="POST",n.data=c.unwrapInstance(e,P),s[l]=r.getKey();else if(r.entityState.isModified())b(n,r,h),n.method="MERGE",n.data=c.unwrapChangedValues(e,p.metadataStore,P);else{if(!r.entityState.isDeleted())return;b(n,r,h),n.method="DELETE"}n=i.getRequest(n,e,t),o.push(n)}),n.contentKeys=u,n.tempKeys=s,i.done(o),{__batchRequests:[{__changeRequests:o}]}),m=e.tempKeys,v=e.contentKeys;return w.request({headers:S.extend({},this.headers),requestUri:y,method:"POST",data:d},function(e,t){var c=[],l=[],r={entities:c,keyMappings:l};return e.__batchResponses.forEach(function(e){e.__changeResponses.forEach(function(e){var t=(e.response||e).statusCode;if(!t||400<=t)f.reject(_(e,y));else{var r=e.headers["Content-ID"];r||(r=e.headers["Content-Id"]);var n=e.data;if(n){var a=m[r];if(a){var i=a.entityType;if(i.autoGeneratedKeyType!==T.None){var o=a.values[0],s=i.getEntityKeyFromRawEntity(n,E.getRawValueFromServer),u={entityTypeName:i.name,tempValue:o,realValue:s.values[0]};l.push(u)}}c.push(n)}else{var p=v[r];c.push(p)}}})}),f.resolve(r)},function(e){return f.reject(_(e,y))},w.batchHandler),f.promise},u.jsonResultsAdapter=new e({name:"OData_default",visitNode:function(e,t,r){var n={};if(null==e)return n;var a=e.__metadata;if(null!=a){var i=c.normalizeTypeName(a.type),o=i&&t.entityManager.metadataStore.getEntityType(i,!0);if(o&&o._mappedPropertiesCount<=Object.keys(e).length-1){n.entityType=o;var s=a.uri||a.id;if(s){var u=new RegExp("^"+t.dataService.serviceName,"i");s=s.replace(u,"")}n.extraMetadata={uriKey:s,etag:a.etag}}}e.results&&(n.node=e.results);var p=r.propertyName;return n.ignore=null!=e.__deferred||"__metadata"===p||"EntityKey"===p&&e.$type&&S.stringStartsWith(e.$type,"System.Data"),n}}),g.config.registerAdapter("dataService",t);var a=function(){this.name="webApiOData"};g.core.extend(a.prototype,u),g.config.registerAdapter("dataService",a);var i=function(){this.name="webApiOData4"};g.core.extend(i.prototype,a.prototype),i.prototype.initialize=function(){var e=S.requireLib("datajs","Needed to support remote OData v4 services");(w=e.V4.oData).json.jsonHandler.recognizeDates=!0},i.prototype.headers={"OData-Version":"4.0"},g.config.registerAdapter("dataService",i)},"object"==typeof v?Ot(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?Ot(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],Ot),Nt=function(u){var s=u.MetadataStore,e=u.JsonResultsAdapter,t=u.AbstractDataServiceAdapter,r=function(){this.name="webApi"},n=r.prototype=new t;n._prepareSaveBundle=function(e,t){var i=this._createChangeRequestInterceptor(e,t),r=e.entityManager,o=r.metadataStore,s=r.helper;return t.entities=t.entities.map(function(e,t){var r=s.unwrapInstance(e),n=null;e.entityType.autoGeneratedKeyType!==u.AutoGeneratedKeyType.None&&(n={propertyName:e.entityType.keyProperties[0].nameOnServer,autoGeneratedKeyType:e.entityType.autoGeneratedKeyType.name});var a=s.unwrapOriginalValues(e,o);return r.entityAspect={entityTypeName:e.entityType.name,defaultResourceName:e.entityType.defaultResourceName,entityState:e.entityAspect.entityState.name,originalValuesMap:a,autoGeneratedKey:n},r=i.getRequest(r,e,t)}),t.saveOptions={tag:t.saveOptions.tag},i.done(t.entities),t},n._prepareSaveResult=function(e,t){var r=e.dataService.jsonResultsAdapter||this.jsonResultsAdapter,n=r.extractSaveResults(t)||[],a=r.extractKeyMappings(t)||[],i=r.extractDeletedKeys&&r.extractDeletedKeys(t)||[];return a.length&&(a=a.map(function(e){return e.entityTypeName?e:{entityTypeName:s.normalizeTypeName(e.EntityTypeName),tempValue:e.TempValue,realValue:e.RealValue}})),i.length&&(i=i.map(function(e){return e.entityTypeName?e:{entityTypeName:s.normalizeTypeName(e.EntityTypeName),keyValues:e.KeyValue}})),{entities:n,keyMappings:a,deletedKeys:i}},n.jsonResultsAdapter=new e({name:"webApi_default",visitNode:function(e,t,r){if(null==e)return{};var n=s.normalizeTypeName(e.$type),a=n&&t.entityManager.metadataStore._getEntityType(n,!0),i=r.propertyName,o=i&&"$"===i.substr(0,1);return{entityType:a,nodeId:e.$id,nodeRefId:e.$ref,ignore:o}}}),u.config.registerAdapter("dataService",r)},"object"==typeof v?Nt(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?Nt(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],Nt),_t=function(s){var u=s.core,e=function(){this.name="backingStore"},t=e.prototype;function p(e,r){var n=r.name,t=e._pendingBackingStores;t||(t=[],e._pendingBackingStores=t);var a={get:function(){return(this._backingStore||c(this))[n]},set:function(e){var t=i(this._backingStore||o(this),n);this._$interceptor(r,e,t)},enumerable:!0,configurable:!0};return a.set.rawSet=function(e){i(this._backingStore||o(this),n)(e)},a}function i(e,t){return function(){return 0===arguments.length?e[t]:void(e[t]=arguments[0])}}function c(e){var t,r=Object.getPrototypeOf(e);(t=r._pendingBackingStores)&&(t.forEach(function(e){e.entity._backingStore=e.backingStore}),t.length=0);var n=e._backingStore;return n||(n={},e._backingStore=n),n}function o(t){var e=Object.getPrototypeOf(t)._pendingBackingStores,r=u.arrayFirst(e,function(e){return e.entity===t});if(r)return r.backingStore;var n={};return e.push({entity:t,backingStore:n}),n}t.initialize=function(){},t.getTrackablePropertyNames=function(e){var t=[];for(var r in e)if("entityType"!==r&&"_$typeName"!==r&&"_pendingSets"!==r&&"_backingStore"!==r){var n=e[r];u.isFunction(n)||t.push(r)}return t},t.initializeEntityPrototype=function(e){var n,t,r,a;e.getProperty=function(e){return this[e]},e.setProperty=function(e,t){return this[e]=t,this},t=(n=e).entityType||n.complexType,r=t._extra,a=r.alreadyWrappedProps||{},t.getProperties().forEach(function(e){var t,r=e.name;a[r]||(null!=(t=r in n?function e(t,r){if(!t.hasOwnProperty(r.name)){var n=Object.getPrototypeOf(t);return e(n,r)}var a=Object.getOwnPropertyDescriptor(t,r.name);if(a.configurable&&!a.value&&a.set){var i={get:function(){return a.get.bind(this)()},set:function(e){var t;this._$interceptor(r,e,(t=this,function(){if(0===arguments.length)return a.get.bind(t)();for(var e=a.set;e.rawSet;)e=e.rawSet;e.bind(t)(arguments[0])}))},enumerable:a.enumerable,configurable:!0};return i.set.rawSet=a.set,i}}(n,e):p(n,e))&&Object.defineProperty(n,r,t),a[r]=!0)}),r.alreadyWrappedProps=a},t.startTracking=function(n,e){var a,t,i,o=(t=c(a=n),((i=Object.getPrototypeOf(a)).entityType||i.complexType).getProperties().forEach(function(e){var t=e.name;if(e.isUnmapped&&!u.getPropertyDescriptor(i,t)){var r=p(i,e);Object.defineProperty(i,t,r)}if(a.hasOwnProperty(t)){var n=a[t];delete a[t],a[t]=n}}),t);(n.entityType||n.complexType).getProperties().forEach(function(e){var t=e.name,r=n[t];if(e.isDataProperty)e.isComplexProperty?r=e.isScalar?e.dataType._createInstanceCore(n,e):s.makeComplexArray([],n,e):e.isScalar?void 0===r&&(r=e.defaultValue):r=s.makePrimitiveArray([],n,e);else{if(!e.isNavigationProperty)throw new Error("unknown property: "+t);if(void 0!==r)throw new Error("Cannot assign a navigation property in an entity ctor.: "+t);r=e.isScalar?null:s.makeRelationArray([],n,e)}(e.isSettable||e.isNavigationProperty)&&(o[t]=r)})},s.config.registerAdapter("modelLibrary",e)},"object"==typeof v?_t(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?_t(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],_t),bt=function(y){var f,i=y.core,n=i.__isES5Supported,e=function(){this.name="ko"},t=e.prototype;function o(e,t){if(!n)return null;if(e.hasOwnProperty(t))return Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e,t);var r=Object.getPrototypeOf(e);return r?o(r,t):null}function h(e){e._koObj._suppressBreeze=!0}function d(e){var t=e.array._koObj;t._suppressBreeze?t._suppressBreeze=!1:t.valueHasMutated()}t.initialize=function(){(f=i.requireLib("ko;knockout","The Knockout library")).extenders.intercept=function(t,e){var r=e.instance,n=e.property;return t.splice?f.computed({read:t}):f.computed({read:t,write:function(e){return r._$interceptor(n,e,t),r}})}},t.getTrackablePropertyNames=function(e){var t=[];for(var r in e)if("entityType"!==r&&"_$typeName"!==r){var n=o(e,r);if(n&&n.get)t.push(r);else{var a=e[r];f.isObservable(a)?t.push(r):i.isFunction(a)||t.push(r)}}return t},t.initializeEntityPrototype=function(e){e.getProperty=function(e){return this[e]()},e.setProperty=function(e,t){return this[e](t),this},n&&function(r){var e=r.entityType||r.complexType,n={};if(e.getProperties().forEach(function(e){var t=o(r,e.name);t&&(n[e.name]=t)}),!i.isEmpty(n)){var t=e._extra;t.es5Descriptors=n,e._koDummy=f.observable(null)}}(e)},t.startTracking=function(p,e){var c=p.entityType||p.complexType,l=c._extra.es5Descriptors||{};c.getProperties().sort(function(e,t){return(e.isUnmapped?1:0)-(t.isUnmapped?1:0)}).forEach(function(t){var e,r=t.name,n=p[r],a=l[r];if(a){var i=a.get.bind(p);if(a.set){var o=a.set.bind(p),s=function(e){0!==arguments.length?o(e):i()};e=f.computed({read:function(){return c._koDummy(),i()},write:function(e){return p._$interceptor(t,e,s),c._koDummy.valueHasMutated(),p}})}else e=f.computed({read:i,write:function(){}})}else if(f.isObservable(n)){if(t.isNavigationProperty)throw new Error("Cannot assign a navigation property in an entity ctor.: "+r);e=n}else n=function(e,t,r){if(t.isDataProperty)t.isComplexProperty?r=t.isScalar?t.dataType._createInstanceCore(e,t):y.makeComplexArray([],e,t):t.isScalar?void 0===r&&(r=t.defaultValue):r=y.makePrimitiveArray([],e,t);else{if(!t.isNavigationProperty)throw new Error("unknown property: "+t.name);if(void 0!==r)throw new Error("Cannot assign a navigation property in an entity ctor.: "+t.name);r=t.isScalar?null:y.makeRelationArray([],e,t)}return r}(p,t,n),e=t.isScalar?f.observable(n):f.observableArray(n);if(t.isScalar)if(a)Object.defineProperty(p,r,{enumerable:!0,configurable:!0,writable:!0,value:e});else{var u=e.extend({intercept:{instance:p,property:t}});p[r]=u}else(n._koObj=e).subscribe(h,null,"beforeChange"),n.arrayChanged.subscribe(d),e.equalityComparer=function(){throw new Error("Collection navigation properties may NOT be set.")},p[r]=e})},y.config.registerAdapter("modelLibrary",e)},"object"==typeof v?bt(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?bt(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],bt),Pt=function(e){var o=e.EntityType,t=function(){this.name="json"},r=t.prototype;r.initialize=function(){},r.buildUri=function(e,t){var r=e._getFromEntityType(t,!1);r||(r=new o(t));var n=e.toJSONExt({entityType:r,toNameOnServer:!0});n.from=void 0,n.queryOptions=void 0;var a=JSON.stringify(n),i=encodeURIComponent(a);return e.resourceName+"?"+i},e.config.registerAdapter("uriBuilder",t)},"object"==typeof v?Pt(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?Pt(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],Pt),Tt=function(o){var p,c=o.EntityType,e=function(){this.name="odata"},t=e.prototype;t.initialize=function(){},t.buildUri=function(e,t){var r=e._getFromEntityType(t,!1);r||(r=new c(t));var n,a,i,o,s={};s.$filter=(n=e.wherePredicate)?n.visit({entityType:r},p):void 0,s.$orderby=(a=e.orderByClause)?(a.validate(r),a.items.map(function(e){return r.clientPropertyPathToServer(e.propertyPath,"/")+(e.isDesc?" desc":"")}).join(",")):void 0,e.skipCount&&(s.$skip=e.skipCount),null!=e.takeCount&&(s.$top=e.takeCount),s.$expand=(i=e.expandClause)?i.propertyPaths.map(function(e){return r.clientPropertyPathToServer(e,"/")}).join(","):void 0,s.$select=(o=e.selectClause)?(o.validate(r),o.propertyPaths.map(function(e){return r.clientPropertyPathToServer(e,"/")}).join(",")):void 0,e.inlineCountEnabled&&(s.$inlinecount="allpages");var u=function(e){var t=[];for(var r in e){var n=e[r];void 0!==n&&(n instanceof Array?n.forEach(function(e){t.push(r+"="+encodeURIComponent(e))}):t.push(r+"="+encodeURIComponent(n)))}return 0<t.length?"?"+t.join("&"):""}(s);return e.resourceName+u},o.Predicate.prototype.toODataFragment=function(e){return this.visit(e,p)},p=function(){var r={contains:"substringof"};function i(e){var t=e.op.key;return r[t]||t}return{passthruPredicate:function(){return this.value},unaryPredicate:function(e){var t=this.pred.visit(e);return i(this)+" ("+t+")"},binaryPredicate:function(e){var t=this.expr1.visit(e),r=this.expr2.visit(e),n=e.prefix;n&&(t=n+"/"+t);var a=i(this);return"in"===this.op.key?r.map(function(e){return"("+t+" eq "+e+")"}).join(" or "):this.op.isFunction?"substringof"===a?a+"("+r+","+t+") eq true":a+"("+t+","+r+") eq true":t+" "+a+" "+r},andOrPredicate:function(t){return this.preds.map(function(e){return"("+e.visit(t)+")"}).join(" "+i(this)+" ")},anyAllPredicate:function(e){var t=this.expr.visit(e);if(!this.pred.op)return t+"/"+i(this)+"()";var r=e.prefix;r?(t=r+"/"+t,r="x"+(parseInt(r.substring(1))+1)):r="x1";var n=o.core.extend({},e);n.entityType=this.expr.dataType,n.prefix=r;var a=this.pred.visit(n);return t+"/"+i(this)+"("+r+": "+a+")"},litExpr:function(){return Array.isArray(this.value)?this.value.map(function(e){return this.dataType.fmtOData(e)},this):this.dataType.fmtOData(this.value)},propExpr:function(e){var t=e.entityType;return t?t.clientPropertyPathToServer(this.propertyPath,"/"):this.propertyPath},fnExpr:function(t){var e=this.exprs.map(function(e){return e.visit(t)});return this.fnName+"("+e.join(",")+")"}}}(),o.config.registerAdapter("uriBuilder",e)},"object"==typeof v?Tt(v):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?Tt(require("breeze-client")):"function"==typeof define&&define.amd&&define(["breeze-client"],Tt),v.config.initializeAdapterInstances({dataService:"webApi",ajax:"jQuery",uriBuilder:"odata"}),p("ko")?v.config.initializeAdapterInstance("modelLibrary","ko"):v.config.initializeAdapterInstance("modelLibrary","backingStore");var Tt;var Pt;var bt;var _t;var Nt;var Ot;var At;var Ct;return v}(e)};"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):breeze=r()}(this);