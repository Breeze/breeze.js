<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../src/a60_abstractDataServiceAdapter.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.5.1/build/cssgrids/cssgrids-min.css">
<!-- commenting out until beta goes live	<link rel="stylesheet" href="http://breezejs.com/sites/all/themes/omega/alpha/css/apha-reset.css"> 
-->    
	<link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.5.1/build/yui/yui-min.js"></script>
	<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34729465-1']);
  _gaq.push(['_setDomainName', 'breezejs.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body class="yui3-skin-sam">
<script type="text/javascript">
  var uvOptions = {};
  (function() {
    var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
    uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/GHug452CgVREu58xjoDg.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
  })();
</script>
<div id="wrap">

<div id="doc">
<div class="header">
<div class="logo">
	<a href="http://www.breezejs.com/home"><img src="http://www.breezejs.com/sites/all/themes/breeze/images/breeze_large.png" /></a>
	</div>

    <div class="primary-nav">
<ul>
		
		<li>
			<a href="http://www.breezejs.com/documentation/download" target="_blank">Download</a></li>
		<li>
			<a href="http://learn.breezejs.com/" target="_blank">Tutorials</a></li>	
		<li>
			<a href="http://www.breezejs.com/documentation/introduction">Docs</a></li>
		<li>
			<a href="http://www.breezejs.com/samples">Samples</a></li>
		<li>
			<a href="http://www.breezejs.com/sites/all/apidocs/index.html" target="_blank">API</a></li>
		<li>
			<a href="http://www.breezejs.com/support" target="_blank">Support</a></li>
		<li>
			<a href="http://www.breezejs.com/blog" target="_blank">Blog</a></li>				
		
	</ul>
</div>
</div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AutoGeneratedKeyType.html">AutoGeneratedKeyType</a></li>
            
                <li><a href="../classes/ComplexAspect.html">ComplexAspect</a></li>
            
                <li><a href="../classes/ComplexType.html">ComplexType</a></li>
            
                <li><a href="../classes/config.html">config</a></li>
            
                <li><a href="../classes/DataProperty.html">DataProperty</a></li>
            
                <li><a href="../classes/DataService.html">DataService</a></li>
            
                <li><a href="../classes/DataType.html">DataType</a></li>
            
                <li><a href="../classes/EntityAction.html">EntityAction</a></li>
            
                <li><a href="../classes/EntityAspect.html">EntityAspect</a></li>
            
                <li><a href="../classes/EntityKey.html">EntityKey</a></li>
            
                <li><a href="../classes/EntityManager.html">EntityManager</a></li>
            
                <li><a href="../classes/EntityQuery.html">EntityQuery</a></li>
            
                <li><a href="../classes/EntityState.html">EntityState</a></li>
            
                <li><a href="../classes/EntityType.html">EntityType</a></li>
            
                <li><a href="../classes/Enum.html">Enum</a></li>
            
                <li><a href="../classes/EnumSymbol.html">EnumSymbol</a></li>
            
                <li><a href="../classes/Event.html">Event</a></li>
            
                <li><a href="../classes/FetchStrategy.html">FetchStrategy</a></li>
            
                <li><a href="../classes/FilterQueryOp.html">FilterQueryOp</a></li>
            
                <li><a href="../classes/HttpResponse.html">HttpResponse</a></li>
            
                <li><a href="../classes/JsonResultsAdapter.html">JsonResultsAdapter</a></li>
            
                <li><a href="../classes/LocalQueryComparisonOptions.html">LocalQueryComparisonOptions</a></li>
            
                <li><a href="../classes/MergeStrategy.html">MergeStrategy</a></li>
            
                <li><a href="../classes/MetadataStore.html">MetadataStore</a></li>
            
                <li><a href="../classes/NamingConvention.html">NamingConvention</a></li>
            
                <li><a href="../classes/NavigationProperty.html">NavigationProperty</a></li>
            
                <li><a href="../classes/Predicate.html">Predicate</a></li>
            
                <li><a href="../classes/Promise.html">Promise</a></li>
            
                <li><a href="../classes/QueryOptions.html">QueryOptions</a></li>
            
                <li><a href="../classes/SaveOptions.html">SaveOptions</a></li>
            
                <li><a href="../classes/ValidationError.html">ValidationError</a></li>
            
                <li><a href="../classes/ValidationOptions.html">ValidationOptions</a></li>
            
                <li><a href="../classes/Validator.html">Validator</a></li>
            
                <li><a href="../classes/ↈ_ajax_interface.html">ↈ_ajax_interface</a></li>
            
                <li><a href="../classes/ↈ_complexArray_.html">ↈ_complexArray_</a></li>
            
                <li><a href="../classes/ↈ_keyGenerator_interface.html">ↈ_keyGenerator_interface</a></li>
            
                <li><a href="../classes/ↈ_primitiveArray_.html">ↈ_primitiveArray_</a></li>
            
                <li><a href="../classes/ↈ_relationArray_.html">ↈ_relationArray_</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/breeze.html">breeze</a></li>
            
                <li><a href="../modules/core.html">core</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ../../src/a60_abstractDataServiceAdapter.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
﻿breeze.AbstractDataServiceAdapter = (function () {
    
    var ajaxImpl;
    
    var ctor = function () { };

    var proto = ctor.prototype; // minifies better (as seen in jQuery)

    proto.checkForRecomposition = function (interfaceInitializedArgs) {
        if (interfaceInitializedArgs.interfaceName === &quot;ajax&quot; &amp;&amp; interfaceInitializedArgs.isDefault) {
            this.initialize();
        }
    };
    
    proto.initialize = function () {
        ajaxImpl = breeze.config.getAdapterInstance(&quot;ajax&quot;);

        // don&#x27;t cache &#x27;ajax&#x27; because then we would need to &quot;.bind&quot; it, and don&#x27;t want to because of brower support issues. 
        if (ajaxImpl &amp;&amp; ajaxImpl.ajax) { return; }
        throw new Error(&quot;Unable to find ajax adapter for dataservice adapter &#x27;&quot;+(this.name||&#x27;&#x27;)+&quot;&#x27;.&quot;);
    };

    proto.fetchMetadata = function (metadataStore, dataService) {
        var serviceName = dataService.serviceName;
        var url = dataService.makeUrl(&quot;Metadata&quot;);
        
        var deferred = Q.defer();

        ajaxImpl.ajax({
            type: &quot;GET&quot;,
            url: url,
            dataType: &#x27;json&#x27;,
            success: function (httpResponse) {
                
                // might have been fetched by another query
                if (metadataStore.hasMetadataFor(serviceName)) {
                    return deferred.resolve(&quot;already fetched&quot;);
                }
                var data = httpResponse.data;
                try {
                    var metadata = typeof (data) === &quot;string&quot; ? JSON.parse(data) : data;
                    metadataStore.importMetadata(metadata);
                } catch(e) {
                    var errMsg = &quot;Unable to either parse or import metadata: &quot; + e.message;
                    return handleHttpError(deferred, httpResponse, &quot;Metadata query failed for: &quot; + url + &quot;. &quot; + errMsg);
                }

                // import may have brought in the service.
                if (!metadataStore.hasMetadataFor(serviceName)) {
                    metadataStore.addDataService(dataService);
                }

                return deferred.resolve(metadata);
                
            },
            error: function (httpResponse) {
                handleHttpError(deferred, httpResponse, &quot;Metadata query failed for: &quot; + url);
            }
        });
        return deferred.promise;
    };

    proto.executeQuery = function (mappingContext) {

        var deferred = Q.defer();
        var url = mappingContext.getUrl();

        var params = {
            type: &quot;GET&quot;,
            url: url,
            params: mappingContext.query.parameters,
            dataType: &#x27;json&#x27;,
            success: function (httpResponse) {
                var data = httpResponse.data;
                try {
                    var rData;
                    if (data &amp;&amp; data.Results) {
                        rData = { results: data.Results, inlineCount: data.InlineCount, httpResponse: httpResponse };
                    } else {
                        rData = { results: data, httpResponse: httpResponse };
                    }
                    
                    deferred.resolve(rData);
                } catch (e) {
                    if (e instanceof Error) {
                        deferred.reject(e);
                    } else {
                        handleHttpError(httpResponse);
                    }
                }

            },
            error: function(httpResponse) {
                handleHttpError(deferred, httpResponse);
            }
        };
        if (mappingContext.dataService.useJsonp) {
            params.dataType = &#x27;jsonp&#x27;;
            params.crossDomain = true;
        }
        ajaxImpl.ajax(params);
        return deferred.promise;
    };

    proto.saveChanges = function (saveContext, saveBundle) {
        var adapter = saveContext.adapter = this;     
        var deferred = Q.defer();
        saveBundle = adapter._prepareSaveBundle(saveContext, saveBundle);
        var bundle = JSON.stringify(saveBundle);
        
        var url = saveContext.dataService.makeUrl(saveContext.resourceName);

        ajaxImpl.ajax({
            type: &quot;POST&quot;,
            url: url,
            dataType: &#x27;json&#x27;,
            contentType: &quot;application/json&quot;,
            data: bundle,
            success: function (httpResponse) {
                var data = httpResponse.data;
                httpResponse.saveContext = saveContext;
                var entityErrors = data.Errors || data.errors;
                if (entityErrors) {
                    handleHttpError(deferred, httpResponse);
                } else {
                    var saveResult = adapter._prepareSaveResult(saveContext, data);
                    saveResult.httpResponse = httpResponse;
                    deferred.resolve(saveResult);
                }
                
            },
            error: function (httpResponse) {
                httpResponse.saveContext = saveContext;
                handleHttpError(deferred, httpResponse);
            }
        });

        return deferred.promise;
    };

    proto._prepareSaveBundle = function(/*saveContext, saveBundle*/) {
        // The implementor should call _createChangeRequestInterceptor
        throw new Error(&quot;Need a concrete implementation of _prepareSaveBundle&quot;);
    };

    /**
    Returns a constructor function for a &quot;ChangeRequestInterceptor&quot;
    that can tweak the saveBundle both as it is built and when it is completed
    by a concrete DataServiceAdapater.

    Initialized with a default, no-op implementation that developers can replace with a
    substantive implementation that changes the individual entity change requests 
    or aspects of the entire &#x27;saveBundle&#x27; without having to write their own DataService adapters.

    @example
    var adapter = breeze.config.getAdapterInstance(&#x27;dataService&#x27;);
    adapter.changeRequestInterceptor = function (saveContext, saveBundle) {
        this.getRequest = function (request, entity, index) {
            // alter the request that the adapter prepared for this entity
            // based on the entity, saveContext, and saveBundle
            // e.g., add a custom header or prune the originalValuesMap
            return request;
        };
        this.done = function (requests) {
            // alter the array of requests representing the entire change-set 
            // based on the saveContext and saveBundle
        };
    }
    @method changeRequestInterceptor
    @param saveContext {Object} The BreezeJS &quot;context&quot; for the save operation.
    @param saveBundle {Object} Contains the array of entities-to-be-saved (AKA, the entity change-set).
    @return {Function} Constructor for a &quot;ChangeRequestInterceptor&quot;.
    **/
    proto.changeRequestInterceptor = DefaultChangeRequestInterceptor;

    //This is a default, no-op implementation that developers can replace.
    function DefaultChangeRequestInterceptor(saveContext, saveBundle) {
        /**
        Prepare and return the save data for an entity change-set. 
        
        The adapter calls this method for each entity in the change-set,
        after it has prepared a &quot;change request&quot; for that object.

        The method can do anything to the request but it must return a valid, non-null request.
        @example
        this.getRequest = function (request, entity, index) {
            // alter the request that the adapter prepared for this entity
            // based on the entity, saveContext, and saveBundle
            // e.g., add a custom header or prune the originalValuesMap
            return request;
        };
        @method getRequest
        @param request {Object} The object representing the adapter&#x27;s request to save this entity.       
        @param entity {Entity} The entity-to-be-save as it is in cache
        @param index {Integer} The zero-based index of this entity in the change-set array
        @return {Function} The potentially revised request.
        **/
        this.getRequest = function (request, entity, index){return request;};

        /**
        Last chance to change anything about the &#x27;requests&#x27; array
        after it has been built with requests for all of the entities-to-be-saved. 
        
        The &#x27;requests&#x27; array is the same as &#x27;saveBundle.entities&#x27; in many implementations

        This method can do anything to the array including add and remove requests.
        It&#x27;s up to you to ensure that server will accept the requests array data as valid.

        Returned value is ignored.
        @example
        this.done = function (requests) {
            // alter the array of requests representing the entire change-set 
            // based on the saveContext and saveBundle
        };
        @method done
        @param requests {Array of Object} The adapter&#x27;s array of request for this changeset.       
        **/
        this.done = function(requests) {};    
    }

    proto._createChangeRequestInterceptor = function(saveContext, saveBundle){
        var adapter = saveContext.adapter;
        var isFn = __isFunction;
        var CRI = adapter.changeRequestInterceptor;
        var pre = adapter.name + &quot; DataServiceAdapter&#x27;s ChangeRequestInterceptor&quot;;
        var post = &quot; is missing or not a function.&quot;;
        if (isFn(CRI)) {
            var interceptor = new CRI(saveContext, saveBundle);
            if (!isFn(interceptor.getRequest)) {
                throw new Error(pre + &#x27;.getRequest&#x27; + post);
            }
            if (!isFn(interceptor.done)) {
                throw new Error(pre + &#x27;.done&#x27; + post);
            }
            return interceptor;
        } else {
            return new DefaultChangeRequestInterceptor(saveContext, saveBundle);
        }
    }

    proto._prepareSaveResult = function (/* saveContext, data */) {
        throw new Error(&quot;Need a concrete implementation of _prepareSaveResult&quot;);
    };
    
    proto.jsonResultsAdapter = new JsonResultsAdapter( {
        name: &quot;noop&quot;,
        
        visitNode: function (/* node, mappingContext, nodeContext */) {
            return {};
        }

    });
   
    function handleHttpError(deferred, httpResponse, messagePrefix) {
        var err = createHttpError(httpResponse);
        if (messagePrefix) {
            err.message = messagePrefix + &quot;; &quot; + err.message;
        }
        return deferred.reject(err);
    };

    function createHttpError(httpResponse) {
        var err = new Error();
        err.httpResponse = httpResponse;
        err.status = httpResponse.status;
        var errObj = httpResponse.data;
        // some ajax providers will convert errant result into an object ( angular), others will not (jQuery)
        // if not do it here.
        if (typeof errObj === &quot;string&quot;) {
            try {
                errObj = JSON.parse(errObj);
            } catch (e) { };
        }
        
        if (errObj) {
            var entityErrors = errObj.EntityErrors || errObj.entityErrors || errObj.Errors || errObj.errors;
            if (entityErrors &amp;&amp; httpResponse.saveContext) {
                processEntityErrors(err, entityErrors, httpResponse.saveContext);
            } else {
                err.message = extractInnerMessage(errObj);
            }
        } else {
            err.message = httpResponse.error &amp;&amp; httpResponse.error.toString();
        }
        proto._catchNoConnectionError(err);
        return err;
    };

    // Put this at the bottom of your http error analysis
    proto._catchNoConnectionError = function (err){
        if (err.status == 0 &amp;&amp; err.message == null){
            err.message = &quot;HTTP response status 0 and no message. &quot; +
            &quot;Likely did not or could not reach server. Is the server running?&quot;;
        }
    }

    function extractInnerMessage(errObj) {
        while (errObj.InnerException) {
            errObj = errObj.InnerException;
        }
        return errObj.ExceptionMessage || errObj.Message || errObj.toString();
    }

    function processEntityErrors(err, entityErrors, saveContext) {
        err.message = &quot;Server side errors encountered - see the entityErrors collection on this object for more detail&quot;;
        var propNameFn = saveContext.entityManager.metadataStore.namingConvention.serverPropertyNameToClient;
        err.entityErrors = entityErrors.map(function (e) {
            return {
                errorName: e.ErrorName,
                entityTypeName: MetadataStore.normalizeTypeName(e.EntityTypeName),
                keyValues: e.KeyValues,
                propertyName: e.PropertyName &amp;&amp; propNameFn(e.PropertyName),
                errorMessage: e.ErrorMessage
            };
        });

    }
    
    return ctor;

})();

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="primary-nav-foot">
	<ul>
		<li>
			<a href="http://www.breezejs.com/documentation/download" target="_blank">Download</a></li>
		<li>
			<a href="http://learn.breezejs.com/" target="_blank">Tutorials</a></li>	
		<li>
			<a href="http://www.breezejs.com/documentation/introduction">Docs</a></li>
		<li>
			<a href="http://www.breezejs.com/samples">Samples</a></li>
		<li>
			<a href="http://www.breezejs.com/sites/all/apidocs/index.html" target="_blank">API</a></li>
		<li>
			<a href="http://stackoverflow.com/questions/tagged/breeze?sort=newest" target="_blank">Forum</a></li>
		<li>
			<a href="http://www.breezejs.com/support" target="_blank">Support</a></li>
	</ul>
</div>
</div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
